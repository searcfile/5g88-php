<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Notice Panel</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: gold;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 100%;
      max-width: 600px;
      background-color: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #333;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #333;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 20px;
      color: white;
    }

    .btn-create {
      background-color: gold;
      color: black;
      padding: 8px 12px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 15px 0 auto;
    }

    .notice-scroll {
      padding: 15px;
      overflow-y: auto;
      flex-grow: 1;
    }

    .notice-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 15px;
    }

    .notice-row input.title {
      padding: 6px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #222;
      color: gold;
    }

    .notice-row textarea {
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: #111;
      color: gold;
      resize: vertical;
      min-height: 40px;
    }

    .notice-row .actions {
      display: flex;
      gap: 6px;
    }

    .notice-row button {
      padding: 6px 10px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
      white-space: nowrap;
    }

    .btn-send { background-color: #1668dc; }
    .btn-edit { background-color: #999; }
    .btn-save { background-color: green; }
    .btn-delete { background-color: red; }

    .main {
      flex-grow: 1;
      padding: 20px;
    }

    .main textarea {
      width: 100%;
      height: 700px;
      background-color: #222;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      padding: 10px;
      border: 1px solid #1668dc;
    }

    .main button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #1668dc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .main h2 {
      color: white;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <h3>Instant Messages</h3>
  </div>
  <button class="btn-create" onclick="createNotice()">+ Create</button>
  <div id="noticeList" class="notice-scroll"></div>
</div>

<div class="main">
  <h2>FLY NOTICE</h2>
  <textarea id="pesan" placeholder="Type Your Notice HERE..." onkeydown="handleKeyPress(event)"></textarea><br>
  <button onclick="kirimPesan()">FLY NOTICE!</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBTeofEXBlzZmELtVAVZ-dctZmOGvf0Y34",
    authDomain: "notice-83ae5.firebaseapp.com",
    databaseURL: "https://notice-83ae5-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "notice-83ae5",
    storageBucket: "notice-83ae5.appspot.com",
    messagingSenderId: "268106877488",
    appId: "1:268106877488:web:798beadfe45104297e7bf5"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const noticeList = document.getElementById('noticeList');
  const encodedAllowedEmail = "NWc4OC5vZmZpY2FsQGdtYWlsLmNvbQ==";
  const allowedAdmin = atob(encodedAllowedEmail);
  const urlParams = new URLSearchParams(window.location.search);
  const adminEmail = atob(urlParams.get("admin") || "");

  let isCreating = false;

  function renderNotices(snapshot) {
    const data = snapshot.val() || {};
    noticeList.innerHTML = '';
    Object.entries(data).reverse().forEach(([id, item]) => {
      const row = document.createElement('div');
      row.className = 'notice-row';

      const titleInput = document.createElement('input');
      titleInput.className = 'title';
      titleInput.value = item.title || '';
      titleInput.disabled = true;

      const textarea = document.createElement('textarea');
      textarea.value = item.content || '';
      textarea.disabled = true;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn-send';
      sendBtn.textContent = 'Send';
      sendBtn.onclick = () => {
        document.getElementById("pesan").value = textarea.value;
        kirimPesan();
      };

      const editBtn = document.createElement('button');
      editBtn.className = 'btn-edit';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => {
        titleInput.disabled = false;
        textarea.disabled = false;
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
      };

      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn-save';
      saveBtn.textContent = 'Save';
      saveBtn.style.display = 'none';
      saveBtn.onclick = () => {
        const newTitle = titleInput.value.trim();
        const newContent = textarea.value.trim();
        if (!newContent) return;
        db.ref(`notifikasi/templates/${id}`).set({ title: newTitle, content: newContent, timestamp: Date.now() });
      };

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-delete';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => db.ref(`notifikasi/templates/${id}`).remove();

      actions.append(sendBtn, editBtn, saveBtn, delBtn);
      row.append(titleInput, textarea, actions);
      noticeList.appendChild(row);
    });
  }

  function createNotice() {
    if (isCreating) return;
    isCreating = true;

    const row = document.createElement('div');
    row.className = 'notice-row';

    const titleInput = document.createElement('input');
    titleInput.className = 'title';
    titleInput.placeholder = 'Enter title...';

    const textarea = document.createElement('textarea');
    textarea.placeholder = 'Type new message...';

    const actions = document.createElement('div');
    actions.className = 'actions';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn-save';
    saveBtn.textContent = 'Save';
    saveBtn.onclick = () => {
      const title = titleInput.value.trim();
      const content = textarea.value.trim();
      if (!content) return;
      const id = db.ref().child('notifikasi/templates').push().key;
      db.ref(`notifikasi/templates/${id}`).set({ title, content, timestamp: Date.now() });
      isCreating = false;
    };

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn-delete';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = () => {
      isCreating = false;
      row.remove();
    };

    actions.append(saveBtn, cancelBtn);
    row.append(titleInput, textarea, actions);
    noticeList.prepend(row);
  }

  function kirimPesan() {
    if (!adminEmail || adminEmail.toLowerCase() !== allowedAdmin.toLowerCase()) return;
    const teks = document.getElementById("pesan").value.trim();
    if (!teks) return;
    db.ref("notifikasi/pesanTerbaru").set({ message: teks, timestamp: Date.now() });
    document.getElementById("pesan").value = "";
  }

  function handleKeyPress(event) {
    if (event.key === "Enter" && !event.ctrlKey) {
      event.preventDefault();
      kirimPesan();
    } else if (event.key === "Enter" && event.ctrlKey) {
      const textarea = document.getElementById("pesan");
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(cursorPos);
      textarea.value = textBefore + "\n" + textAfter;
      textarea.selectionStart = textarea.selectionEnd = cursorPos + 1;
      event.preventDefault();
    }
  }

  db.ref("notifikasi/templates").on("value", renderNotices);
</script>
</body>
</html>
