<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User LiveChat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #111;
      color: #eee;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      padding: 10px 20px;
      background: #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
      color: gold;
    }
    button {
      background: gold;
      border: none;
      color: black;
      font-weight: bold;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px 20px;
      background: #222;
      overflow: hidden;
    }
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #111;
      margin-bottom: 10px;
      color: white;
    }
    .message {
      margin-bottom: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .mine {
      align-self: flex-end;
      background: #006400;
      border-radius: 15px 15px 0 15px;
      padding: 8px 12px;
      color: #fff;
    }
    .theirs {
      align-self: flex-start;
      background: #444;
      border-radius: 15px 15px 15px 0;
      padding: 8px 12px;
      color: #fff;
    }
    .bubble img {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 5px;
      display: block;
    }
    .time {
      font-size: 0.75rem;
      color: #ccc;
      margin-top: 3px;
      text-align: right;
    }
    .send-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #msg {
      flex: 1;
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
      font-size: 1rem;
    }
    .file-label {
      background: gold;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      color: black;
      font-weight: bold;
    }
    .file-label input[type="file"] {
      display: none;
    }
    #logoutBtn {
      margin-top: 10px;
      align-self: flex-end;
      background: #b22222;
      color: white;
    }
    #user-info, #userEmail {
      font-weight: bold;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      position: fixed;
      top: 10px;
      z-index: 9999;
    }
    #user-info {
      right: 300px;
    }
    #userEmail {
      right: 120px;
    }
    #user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      vertical-align: middle;
    }
    /* Dark mode toggle */
    body.dark-theme {
      background: #eee;
      color: #222;
    }
    body.dark-theme header {
      background: #ddd;
    }
    body.dark-theme .chat-box {
      background: #fff;
      color: #222;
      border-color: #ccc;
    }
    body.dark-theme .mine {
      background: #4caf50;
      color: white;
    }
    body.dark-theme .theirs {
      background: #ddd;
      color: #222;
    }
    body.dark-theme .send-box #msg {
      background: #fff;
      color: #222;
    }
    body.dark-theme .file-label {
      background: #ffcc00;
      color: #222;
    }
    body.dark-theme button {
      background: #ffcc00;
      color: #222;
    }
    body.dark-theme #logoutBtn {
      background: #a94442;
      color: #fff;
    }
  </style>
</head>
<body>

  <header>
    <h1>User LiveChat</h1>
    <button id="themeToggleBtn">Toggle Theme</button>
  </header>

  <main>
    <div class="chat-box" id="chatBox">Loading chat...</div>

    <div class="send-box">
      <input type="text" id="msg" placeholder="Type your message" autocomplete="off" />
      <label class="file-label" for="fileInput">
        Upload Image
        <input type="file" id="fileInput" accept="image/*" />
      </label>
      <button type="button" disabled id="sendBtn">Send</button>
    </div>

    <button id="logoutBtn">Logout</button>
  </main>

  <div style="position: fixed; top: 20px; right: 60px; z-index: 9999; display: flex; gap: 15px;">
    <div id="user-info"></div>
    <div id="userEmail"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <script>
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCKmrlS4qrZCrMNRIfIRCWCbNgZT1uQ3ZI",
      authDomain: "blurphp.firebaseapp.com",
      databaseURL: "https://blurphp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "blurphp",
      storageBucket: "blurphp.appspot.com",
      messagingSenderId: "593904200464",
      appId: "1:593904200464:web:cea7bc1360532c20d99395"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const storage = firebase.storage();

    let currentUserEmail = null;

    // Sanitize email for Firebase paths
    function sanitizeEmail(email) {
      return email.replace(/\./g, '_').replace(/@/g, '_at_').replace(/,/g, '_');
    }

    function getChatPath(email) {
      return 'chats/' + sanitizeEmail(email);
    }

    // Toggle dark/light theme
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
    }
    document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

    // Logout function
    function logout() {
      firebase.auth().signOut().then(() => {
        localStorage.clear();
        window.location.href = "https://searcfile.github.io/5g88-php/livechatloginphp/";
      });
    }
    document.getElementById('logoutBtn').addEventListener('click', logout);

    // Enable/disable send button based on input or file
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const fileInput = document.getElementById('fileInput');

    function updateSendButton() {
      sendBtn.disabled = !msgInput.value.trim() && !fileInput.files.length;
    }

    msgInput.addEventListener('input', updateSendButton);
    fileInput.addEventListener('change', updateSendButton);

    // Send message function
    async function sendMessage(userEmail) {
      if (!userEmail) {
        alert("âŒ Gagal mengirim pesan: email tidak valid.");
        logout();
        return;
      }

      const msg = msgInput.value.trim();
      const file = fileInput.files[0];

      if (!msg && !file) return;

      const userName = localStorage.getItem("username") || "User";
      const time = Date.now();
      const chatRef = db.ref(getChatPath(userEmail));

      try {
        // Upload image if available
        if (file) {
          const fileRef = storage.ref(`chat_images/${sanitizeEmail(userEmail)}/${time}_${file.name}`);
          const snapshot = await fileRef.put(file);
          const url = await snapshot.ref.getDownloadURL();
          await chatRef.push({
            from: 'user',
            name: userName,
            email: userEmail,
            image: url,
            time
          });
        }

        if (msg) {
          await chatRef.push({
            from: 'user',
            name: userName,
            email: userEmail,
            text: msg,
            time
          });
          msgInput.value = '';
        }

        fileInput.value = '';
        sendBtn.disabled = true;
      } catch (error) {
        console.error("Error sending message:", error);
        alert("âŒ Gagal mengirim pesan.");
      }
    }

    sendBtn.addEventListener('click', () => sendMessage(currentUserEmail));

    // Enter key to send message
    msgInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(currentUserEmail);
      }
    });

    // Listen for auth state changes
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        const userName = localStorage.getItem("username") || user.displayName || "User";
        const userEmail = localStorage.getItem("useremail") || user.email;
        const userPhoto = localStorage.getItem("userphoto") || user.photoURL || "";

        if (!userEmail) {
          alert("ðŸš« User email not found. Please login again.");
          logout();
          return;
        }

        localStorage.setItem("username", userName);
        localStorage.setItem("useremail", userEmail);
        localStorage.setItem("userphoto", userPhoto);

        currentUserEmail = userEmail;

        // Update UI user info
        document.getElementById("user-info").innerHTML = `
          <img src="${userPhoto}" alt="User Photo" />
          <span>${userName}</span>
        `;
        document.getElementById("userEmail").textContent = userEmail;

        listenToChat(currentUserEmail);
        updateSendButton();
      } else {
        alert("ðŸš« Not logged in. Redirecting to login page...");
        window.location.href = "https://searcfile.github.io/5g88-php/livechatloginphp/";
      }
    });

    // Listen chat messages realtime
    function listenToChat(userEmail) {
      const chatBox = document.getElementById('chatBox');
      const chatRef = db.ref(getChatPath(userEmail));

      chatRef.off(); // Remove previous listeners

      chatRef.on('value', snapshot => {
        chatBox.innerHTML = '';
        const chats = snapshot.val();

        if (chats) {
          Object.values(chats).forEach(c => {
            const div = document.createElement('div');
            div.className = 'message ' + (c.from === 'user' ? 'mine' : 'theirs');

            const date = new Date(c.time);
            const formattedTime = date.toLocaleTimeString('en-US', {
              hour: '2-digit', minute: '2-digit', hour12: true
            });

            let senderLabel = "Unknown";
            if (c.email === currentUserEmail) {
              senderLabel = "Me";
            } else if (c.name && c.name.toLowerCase().includes("admin")) {
              senderLabel = "Admin";
            } else {
              senderLabel = c.name || "Unknown";
            }

            div.innerHTML = c.image ? `
              <div class="bubble">
                <strong>${senderLabel}</strong>:<br>
                <img src="${c.image}" alt="Chat Image" />
                <div class="time">(${formattedTime})</div>
              </div>` : `
              <div class="bubble">
                <strong>${senderLabel}</strong>: ${c.text}
                <div class="time">(${formattedTime})</div>
              </div>`;

            chatBox.appendChild(div);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        } else {
          chatBox.innerHTML = '<p style="text-align:center; color:gray;">No messages yet.</p>';
        }
      });
    }
  </script>
</body>
</html>
