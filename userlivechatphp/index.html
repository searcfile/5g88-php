<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LiveChat - User</title>
  <style>
    :root {
  --bg-color: #111111;
  --text-color: #ffffff;
  --primary-color: #facc15;
}
body {
  background: var(--bg-color);
  color: #000;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

body::-webkit-scrollbar {
  display: none;
}

  header {
    background-color: #1668dc;
    padding: 0px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--bg-color);
    height: 90px;
  }

  h1 {
    color: white;
    margin: 0;
    font-size: 30px;
  }

  .chat-container {
    max-width: 700px;
    margin: 2rem auto;
    border: 2px solid gold;
    border-radius: 10px;
    overflow: hidden;
    background-color: #000;
    display: flex;
    flex-direction: column;
    height: 85vh;
    box-shadow: 0 0 12px rgba(255, 215, 0, 0.2);
  }

  .chat-header {
    display: flex;
    align-items: center;
    gap: 15px;
    background: #222;
    padding: 10px 14px;
    color: gold;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }

  .chat-header .profile {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chat-header .profile img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: 2px solid gold;
  }

  #searchChat {
    flex-grow: 1;
    padding: 8px 10px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
  }

  .chat-box {
  flex-grow: 1;
  overflow-y: auto;
  padding: 15px;
  background: #000;
  scrollbar-width: none;
  -ms-overflow-style: none;
  height: 60vh;
     border-radius: 10px;
    border: 1px solid #3c89e8;
}

.chat-box::-webkit-scrollbar {
  display: none;
}
  .message {
    padding: 0.5rem 0.75rem;
    margin: 0.5rem 0;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
  }

  .mine {
    margin-left: auto;
    background: linear-gradient(to bottom, #1668dc, white);
    color: black;
    font-weight: bold;
  }

  .theirs {
    margin-right: auto;
    background: linear-gradient(to bottom, #1668dc, #d7e9ff, #c5ff4a);
  }

  .send-box {
  display: flex;
  gap: 10px;
  padding: 1rem;
  border: 1px solid #3c89e8;
  background: #111;
  border-radius: 10px;
  align-items: stretch;
}

  #msg {
  flex: 2;
  min-height: 40px;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: 2px solid #3c89e8;
  resize: vertical;
  box-sizing: border-box;
}

  .file-label {
  flex-shrink: 0;
  background: #1668dc;
  color: white;
  padding: 0 16px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  font-weight: bold;
  white-space: nowrap;
}


  input[type="file"] {
    display: none;
  }

  .send-box button {
  flex: 1;
  background: #1668dc;
  color: white;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  height: 100%;
}
.send-box button:active,
.file-label:active {
  color:white;
  background: #1554ad !important;
}
.send-box button:hover,
.file-label:hover {
  color:white;
  background: #3c89e8;
}
 
  .msg-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 2px;
    font-weight: bold;
  }

  .msg-header small {
    font-size: 0.75rem;
    color: #0b6906;
  }

  .msg-text {
    margin: 0;
    padding: 0;
    font-weight: bold;
  }

  .date-label {
    text-align: center;
    margin: 20px 0;
  }

  .date-label-inner {
    display: inline-block;
    background-color: lightgreen;
    padding: 2px 30px;
    border-radius: 20px;
    font-size: 14px;
    color: #333;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .date-label-inner .day-label {
    font-weight: bold;
  }

  .date-label-inner .full-date-label {
    font-size: 12px;
    color: #555;
  }

  #logoutBtn {
    background-color: #141414;
    color: white;
    padding: 0px 15px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    border-color: #ffffff;
    transition: 0.3s;
    font-size: 14px;
    height: 32px;
    width: 100%;
  }

  #logoutBtn:hover {
    border-color: #3c89e8;
    background-color: #141414;
    color: #3c89e8;
  }
    #logoutBtn:active {
    border-color: #3c89e8;
    background-color: #141414;
    color: #1554ad;
  }

  @media (max-width: 600px) {
    .chat-header {
      flex-direction: column;
      align-items: flex-start;
    }

    #searchChat {
      width: 100%;
    }

    .send-box {
      flex-direction: column;
    }

    #msg {
      width: 100%;
    }
  }
  .chat-wrapper {
  background: white;
  max-width: 640px;
  margin: 1rem auto 30px auto;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  height: 85vh; /* Tambah ini */
  overflow: hidden;
  box-shadow: 0 0 10px #1668dc;
  border: 1px solid #1668dc;
    padding: 15px;
}

.chat-header {
  background: linear-gradient(to right,#1668dc, #c5ff4a);
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #fff3;
    border-radius: 10px;
      font-size: 1rem;
      color: white;
  margin-bottom: 10px;
  justify-content: space-between;
}

.chat-header .profile {
  display: flex;
  align-items: center;
  gap: 10px;
}

.chat-header .profile img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid white;
}

.chat-header .profile span {
  font-weight: bold;
  font-size: 16px;
  color: black;
}

.search-wrapper {
  flex-grow: 1;
  display: flex;
  justify-content: flex-end;
}

#searchChat {
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  min-width: 200px;
  max-width: 300px;
}
.msg-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  margin-right: 6px;
  object-fit: cover;
  border: 1px solid white;
background-color:black;
}
#startMessage {
  transition: opacity 0.5s ease;
  font-size: 16px;
}
.chat-box { min-height: 0; }

/* jaga composer selalu terlihat nempel di bawah */
.send-box {
  position: sticky;
  bottom: 0;
  z-index: 5;
}

/* iPhone safe-area (opsional) */
@supports (padding: env(safe-area-inset-bottom)) {
  .send-box { padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
}

/* --- HP <= 600px --- */
@media (max-width: 600px) {
  /* tetap SATU BARIS supaya tombol tidak â€œhilangâ€ */
  .send-box {
    flex-direction: row !important;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
  }

  /* textarea lebih ringkas tapi fleksibel */
  #msg {
    flex: 1 1 auto;
    width: auto;
    min-width: 0;              /* cegah overflow */
    height: 40px;
    min-height: 40px;
    max-height: 120px;         /* masih bisa di-resize vertikal */
    font-size: 15px;
  }

  /* tombol upload & send selalu tampil */
  .file-label,
  .send-box button {
    flex: 0 0 auto;
    height: 40px;
    line-height: 40px;
    padding: 0 12px;
    box-sizing: border-box;
    white-space: nowrap;       /* teks tombol nggak turun baris */
  }
}

/* --- layar sangat kecil <= 400px --- */
@media (max-width: 400px) {
  #msg { font-size: 14px; }
  .file-label,
  .send-box button { padding: 0 8px; }
}
/* === SEARCH highlight === */
mark.__hit{ background:#ffe58a; padding:0 2px; border-radius:3px; }

/* === Tombol scroll ke bawah (gaya bulat dengan ring) === */
#toBottomBtn{
  position:absolute; right:12px; bottom:12px;
  width:44px; height:44px; border-radius:9999px;
  background:rgba(16,16,16,.92);
  border:1px solid rgba(255,255,255,.18);
  box-shadow:0 4px 14px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.06);
  display:none; align-items:center; justify-content:center;
  cursor:pointer; outline:none;
  -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px);
  transition: transform .1s ease, background .15s ease, border-color .15s ease;
}
#toBottomBtn svg{ width:22px; height:22px; stroke:#fff; stroke-width:2; fill:none; display:block; }
#toBottomBtn:hover{ background:rgba(28,28,28,.96); border-color:rgba(255,255,255,.28); }
#toBottomBtn:active{ transform: translateY(1px); }
@media (max-width:520px){
  #toBottomBtn{ width:40px; height:40px; right:10px; bottom:10px; }
  #toBottomBtn svg{ width:20px; height:20px; }
}
.chat-wrapper{ position: relative; }   /* supaya absolute nempel ke wrapper */
#toBottomBtn.show{ display:flex; }  
</style>
<body>
  <!-- Header Atas -->
 <header>
  <div style="display: flex; align-items: center; gap: 10px;">
    <h1>USER LIVECHAT</h1>
    <div id="notifDot" style="width: 12px; height: 12px; background: red; border-radius: 50%; display: none;"></div>
  </div>
</header>


<main>
  <div class="chat-wrapper">
    <!-- CHAT HEADER -->
    <div class="chat-header">
      <div class="profile">
        <img id="headerUserPhoto" src="https://i.pravatar.cc/40" alt="User" />
        <div>
          <span id="headerUserName">5G 88</span><br />
          <small id="typingStatus" style="font-size: 12px; font-weight: normal; color: white;">Offline</small>
        </div>
      </div>
      <div class="search-wrapper">
        <input type="text" id="searchChat" placeholder="ðŸ” Search messages..." />
      </div>
    </div>

<div class="chat-box" id="chatBox">
  <div id="startMessage" style="text-align:center; color:white; opacity:0.6; margin-top:10px; font-size:14px;">
    No messages yet. Start the conversation!
  </div>
</div>

<button id="toBottomBtn" aria-label="Scroll to latest" title="Go to latest">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M6 10l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</button>
<div id="noResults" style="display:none;position:absolute;top:62px;right:16px;background:#222;color:#fff;border:1px solid #444;border-radius:8px;padding:6px 10px;font-size:12px;">
  No data
</div>
    <!-- SEND BOX -->
    <div class="send-box">
      <textarea id="msg" placeholder="Type your message" rows="2"></textarea>
      <label class="file-label">
        Upload Image
        <input type="file" id="fileInput" accept="image/*">
      </label>
      <button type="button" disabled>Send</button>
    </div>
  </div>
</main>
<audio id="notifSound" src="https://searcfile.github.io/5G88-audio/notifsound/notification.wav" preload="auto"></audio>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script>
const IS_EMBEDDED = window.top !== window.self;
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
let chatInitialized = false;
let currentUserEmail = null;
let currentActiveId  = null;
let currentIsGuest   = false;
let presenceBoundFor = null;

function sanitizeEmail(email) {
  return String(email || '').toLowerCase().replace(/\./g, "_");
}
function getChatPath(){ return currentActiveId ? 'chats/' + currentActiveId : null; }
function getUserPath(){ return currentActiveId ? 'users/' + currentActiveId : null; }
function getNotifPath(){ return currentActiveId ? 'notifications/' + currentActiveId : null; }
  
const firebaseConfig = {
  apiKey: "AIzaSyCKmrlS4qrZCrMNRIfIRCWCbNgZT1uQ3ZI",
  authDomain: "blurphp.firebaseapp.com",
  databaseURL: "https://blurphp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "blurphp",
  storageBucket: "blurphp.appspot.com",
  messagingSenderId: "593904200464",
  appId: "1:593904200464:web:cea7bc1360532c20d99395"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

function getOrCreateLocalGuestId(){
  let id = localStorage.getItem('guest.uid');
  if (!id){
    id = 'g_' + Array.from(crypto.getRandomValues(new Uint32Array(4))).join('');
    localStorage.setItem('guest.uid', id);
  }
  return id;
}

async function ensureGuestLocalIdentity(){
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    if (!auth.currentUser) await auth.signInAnonymously();
    const u = auth.currentUser;
    if (!u) throw new Error('no-user');
    currentIsGuest = true;
    currentUserEmail = null;
    currentActiveId = String(u.uid);
  }catch(e){
    // Fallback TANPA Auth â†’ tetap bikin ID unik per device
    if (e?.code === 'auth/admin-restricted-operation' || e?.code === 'auth/operation-not-allowed'){
      console.warn('Anonymous disabled â€” using local guest id');
      currentIsGuest   = true;
      currentUserEmail = null;
      currentActiveId  = getOrCreateLocalGuestId();
    } else {
      throw e;
    }
  }

  // default nama/foto & lanjut init
  if (!localStorage.getItem("username")){
    const code = (currentActiveId || '').slice(-5).toUpperCase();
    localStorage.setItem("username", `Guest-${code}`);
  }
  if (!localStorage.getItem("userphoto")) localStorage.setItem("userphoto", "");

  updateUserHeader();
  writeUserProfile();       // pastikan rules RTDB mengizinkan path ini
  bindPresenceAndNotif();
  initChatWithUserData();
  notifyRead();
}
  
function bindPresenceAndNotif(){
  if (!currentActiveId) return;
  if (presenceBoundFor === currentActiveId) return;      // jangan dobel
  presenceBoundFor = currentActiveId;

  const userPath  = getUserPath();
  const notifPath = getNotifPath();
  if (!userPath) return;

  const connectedRef = firebase.database().ref(".info/connected");
  const userRef      = firebase.database().ref(userPath);

  // pastikan tidak dobel listener
  connectedRef.off();
  userRef.off();

  connectedRef.on("value", (snap) => {
    if (snap.val() === true) {
      userRef.update({ online: true });
      userRef.onDisconnect().update({ online: false, lastLoginTime: Date.now() });
    }
  });

  // update offline saat tab ditutup
  window.addEventListener("beforeunload", () => {
    firebase.database().ref(userPath).update({ online: false, lastLoginTime: Date.now() });
  });

  // notifikasi admin -> user
  if (notifPath){
    const nr = firebase.database().ref(notifPath);
    nr.off();
    nr.on("value", (snapshot) => {
      const notif = snapshot.val();
      if (notif && notif.unread) {
        playNotificationSound();
        notifyUnread();
        setTimeout(() => { nr.child("unread").set(false); }, 2000);
      } else {
        notifyRead();
      }
    });
  }
}
  function writeUserProfile(){
  const upath = getUserPath();
  if (!upath) return;
  const data = {
    name:     localStorage.getItem("username") || (currentIsGuest ? "Guest" : "User"),
    email:    currentUserEmail || null,
    photoURL: localStorage.getItem("userphoto") || null
  };
  db.ref(upath).update(data).catch(()=>{});
}
// ===== parent origins yang diizinkan =====
const ALLOWED_PARENTS = [
  "https://5g88-login.vercel.app",
  "https://5g88-main.vercel.app"
];

// deteksi origin parent dari referrer (fallback "*")
function getParentOrigin(){
  try { return new URL(document.referrer).origin; } catch { return "*"; }
}
const PARENT_ORIGIN = getParentOrigin();

// PATCH START: postMessage handler
window.addEventListener("message", (e) => {
  if (!ALLOWED_PARENTS.includes(e.origin)) return;

  const data = e.data || {};
  if (data.type === "user-login" && data.user){
    const { name, email, photo, uid, isGuest } = data.user;

    localStorage.setItem("username", name || (isGuest ? "Guest" : "User"));
    localStorage.setItem("userphoto", photo || "");

    if (isGuest && uid) {
      currentIsGuest   = true;
      currentActiveId  = String(uid);          // gunakan UID guest
      currentUserEmail = null;
      localStorage.removeItem("useremail");
    } else if (email) {
      currentIsGuest   = false;
      currentUserEmail = email;
      currentActiveId  = sanitizeEmail(email); // email_sanitized
      localStorage.setItem("useremail", email);
    } else {
      return; // identitas tak valid
    }

    updateUserHeader();
    writeUserProfile(); 
    bindPresenceAndNotif();
    initChatWithUserData();
    notifyRead();
  }

  // opsional status dari parent
  if (data.action === "panel-open")  notifyRead();
  if (data.action === "panel-close") {/* no-op */}
});
  

let userHasInteracted = false;

function cleanDuplicateName(name) {
  const parts = name.trim().split(/\s+/);
  const half = parts.length / 2;
  if (parts.length % 2 === 0) {
    const firstHalf = parts.slice(0, half).join(' ');
    const secondHalf = parts.slice(half).join(' ');
    if (firstHalf === secondHalf) return firstHalf;
  }
  return name;
}
function nameOnly(s){
  if (!s) return 'User';
  s = String(s).trim();
  const at = s.indexOf('@');
  if (at > -1) s = s.slice(0, at);
  return s.replace(/\./g, ' ');
}
function updateUserHeader() {
  let userName = localStorage.getItem("username") || "User";  // GANTI const â†’ let
  const userPhoto = localStorage.getItem("userphoto") || "https://i.pravatar.cc/40";
  const nameEl = document.getElementById("headerUserName");
  const photoEl = document.getElementById("headerUserPhoto");

  userName = cleanDuplicateName(userName);  // âœ… Tidak error lagi
  if (nameEl) nameEl.textContent = userName;
  if (photoEl) photoEl.src = userPhoto;
}

// PATCH START: initChatWithUserData universal
function initChatWithUserData() {
  if (chatInitialized) return;

  // wajib ada activeId (uid guest atau email_sanitized)
  if (!currentActiveId) return;

  const msgInput    = document.getElementById('msg');
  const sendBtn     = document.querySelector('.send-box button');
  const fileInput   = document.getElementById('fileInput');
  const searchInput = document.getElementById('searchChat');
  const chatBox     = document.getElementById('chatBox');
  const typingEl    = document.getElementById('typingStatus');

  if (!msgInput || !sendBtn || !fileInput || !searchInput || !chatBox) return;

  chatInitialized = true;
  updateUserHeader();
  if (typingEl) typingEl.textContent = 'Online';

  let typingTimer;
  const typingDelay = 2000;

  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
      e.preventDefault();
      sendMessage(); // tanpa arg
    }
  });

  msgInput.addEventListener('input', () => {
    sendBtn.disabled = !msgInput.value.trim() && !fileInput.files.length;
    if (typingEl) {
      typingEl.textContent = msgInput.value.trim() ? 'Typing...' : 'Online';
      clearTimeout(typingTimer);
      if (msgInput.value.trim()) {
        typingTimer = setTimeout(() => { if (typingEl) typingEl.textContent = 'Online'; }, typingDelay);
      }
    }
  });

  sendBtn.addEventListener('click', () => sendMessage());
  sendBtn.disabled = true;

  // mulai dengarkan chat saya
  listenToChat(); // tanpa arg
}

async function sendMessage() {
  if (!currentActiveId) return;

  const msgInput = document.getElementById('msg');
  const fileInput = document.getElementById('fileInput');
  const msg  = (msgInput.value || '').trim();
  const file = fileInput.files[0];

  if (!msg && !file) return;

  const userName  = localStorage.getItem("username") || (currentIsGuest ? "Guest" : "User");
  const userPhoto = localStorage.getItem("userphoto") || "";
  const time = Date.now();

  const chatPath = getChatPath();
  if (!chatPath) return;
  const chatRef = db.ref(chatPath);

  let imageUrl = null;

  try {
    if (file) {
      const fileRef = storage.ref(`chat_images/${currentActiveId}/${time}_${file.name}`);
      const snapshot = await fileRef.put(file);
      imageUrl = await snapshot.ref.getDownloadURL();
    }

    await chatRef.push({
      from: 'user',
      name: userName,
      email: currentUserEmail || null,
      photoURL: userPhoto || null,
      text: msg || null,
      image: imageUrl || null,
      time,
      readByAdmin: false
    });

    // ðŸ‘‰ paksa scroll ke bawah setelah pesan kita terkirim
    setTimeout(() => onNewMessageRendered({ forceToBottom: true }), 0);

    msgInput.value = '';
    fileInput.value = '';
    document.querySelector('.send-box button').disabled = true;

  } catch (error) {
    console.error("Error sending message:", error);
    alert("âŒ Gagal mengirim pesan.");
  }
}

// PATCH START: listenToChat universal
function listenToChat() {
  if (!currentActiveId) return;

  const chatBox = document.getElementById('chatBox');
  const chatPath = getChatPath();
  if (!chatBox || !chatPath) return;

  const chatRef = db.ref(chatPath);
  chatRef.off();
  const lastSeenKey = `lastSeenByUser_${currentActiveId}`;
  const startMsg = document.getElementById("startMessage");

  chatRef.on('value', snapshot => {
    const wasAtBottom = isAtBottom(chatBox);
    const chats = snapshot.val();

    // bersihkan pesan lama (kecuali startMessage)
    const oldMessages = chatBox.querySelectorAll(".message, .date-label");
    oldMessages.forEach(el => el.remove());

    if (!chats || Object.keys(chats).length === 0) {
      if (startMsg) startMsg.style.display = "block";
      notifyRead();
      return;
    }
    if (startMsg) startMsg.style.display = "none";

    const lastSeenTime = parseInt(localStorage.getItem(lastSeenKey) || '0', 10);
    let latestAdminMsgTime = 0;

    const chatArray = Object.values(chats).sort((a, b) => (a.time || 0) - (b.time || 0));
    const today = new Date(); today.setHours(0,0,0,0);
    const pastChats = [], todayChats = [];

    chatArray.forEach(c => {
      const t = Number(c.time) || 0;
      const msgDateOnly = new Date(t); msgDateOnly.setHours(0,0,0,0);
      (msgDateOnly.getTime() === today.getTime() ? todayChats : pastChats).push(c);
      if (c.from === 'admin' && t > latestAdminMsgTime) latestAdminMsgTime = t;
    });

    const latestTime = chatArray[chatArray.length - 1]?.time || 0;
    localStorage.setItem(lastSeenKey, String(latestTime));

    if (latestAdminMsgTime > lastSeenTime) {
      playNotificationSound();
      notifyUnread();
    } else {
      notifyRead();
    }

    renderChats(pastChats, today);
    renderChats(todayChats, today);
    const lastMsg = (Array.isArray(chatArray) && chatArray[chatArray.length - 1]) || {};
    const mustForce = wasAtBottom || lastMsg.from === 'user';
    onNewMessageRendered({ forceToBottom: mustForce });
  });
}
// ====== SEARCH ======
const chatBody   = document.getElementById('chatBox');
const searchBox  = document.getElementById('searchChat');
let lastQuery    = '';
let searchHits   = [];
let hitIndex     = 0;

function clearSearchMarks(){
  chatBody.querySelectorAll('mark.__hit').forEach(m=>{
    const p = m.parentNode; m.replaceWith(document.createTextNode(m.textContent)); p.normalize();
  });
}
function doSearch(q){
  q = (q||'').trim();
  const noResults = document.getElementById('noResults');
  if (noResults) noResults.style.display = 'none';

  // reset highlight dulu
  clearSearchMarks();
  searchHits = []; hitIndex = 0;

  // jika kosong â†’ tampilkan semua bubble
  if (!q){
    chatBody.querySelectorAll('.message').forEach(b => b.style.display = '');
    return;
  }

  lastQuery = q.toLowerCase();
  let matches = 0;

  chatBody.querySelectorAll('.message').forEach(bubble=>{
    const nameEl = bubble.querySelector('.msg-info');
    const textEl = bubble.querySelector('.msg-text');
    const nameTxt = (nameEl?.textContent || '');
    const msgTxt  = (textEl?.textContent || '');
    const isMatch = (nameTxt + ' ' + msgTxt).toLowerCase().includes(lastQuery);

    // filter tampilan
    bubble.style.display = isMatch ? '' : 'none';
    if (!isMatch) return;
    matches++;

    // highlight di elemen nama & teks
    [nameEl, textEl].forEach(el=>{
      if (!el) return;
      const raw = el.textContent;
      const low = raw.toLowerCase();
      const frag = document.createDocumentFragment();
      let i=0, m;
      while ((m = low.indexOf(lastQuery, i)) !== -1){
        if (m>i) frag.appendChild(document.createTextNode(raw.slice(i,m)));
        const mark = document.createElement('mark');
        mark.className='__hit';
        mark.textContent = raw.slice(m, m+q.length);
        frag.appendChild(mark); searchHits.push(mark);
        i = m + q.length;
      }
      if (i < raw.length) frag.appendChild(document.createTextNode(raw.slice(i)));
      el.replaceChildren(frag);
    });
  });

  if (matches){
    (searchHits[0] || chatBody.firstElementChild)?.scrollIntoView({behavior:'smooth', block:'center'});
  }else{
    if (noResults) noResults.style.display = 'block';
  }
}
let searchTimer;
searchBox.addEventListener('input', e=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=> doSearch(e.target.value), 120);
});
searchBox.addEventListener('keydown', e=>{
  if (e.key === 'Enter' && searchHits.length){
    e.preventDefault();
    hitIndex = (hitIndex + 1) % searchHits.length;
    searchHits[hitIndex].scrollIntoView({behavior:'smooth', block:'center'});
  }
});
// refresh highlight bila DOM pesan berubah
function renderChats(chatGroup, today) {
  const chatBox = document.getElementById('chatBox');
  if (!chatBox) return;

  let lastDateKey = '';
  const list = Array.isArray(chatGroup) ? chatGroup : [];

  list.forEach((c) => {
    if (!c || !c.time || isNaN(new Date(c.time).getTime())) return;

    const msgDate = new Date(c.time);
    const timeFormatted = msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    const dateKey = msgDate.toDateString();

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const dayLabel = (dateKey === today.toDateString())
      ? 'Today'
      : (dateKey === yesterday.toDateString())
        ? 'Yesterday'
        : msgDate.toLocaleDateString('en-GB', { weekday: 'long' });

    const fullDateLabel = msgDate.toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric'
    });

    // â€”â€”â€” header tanggal (jika ganti hari) â€”â€”â€”
    if (dateKey !== lastDateKey) {
      const dateLabelDiv = document.createElement('div');
      dateLabelDiv.className = 'date-label';
      dateLabelDiv.innerHTML = `
        <div class="date-label-inner">
          <div class="day-label">${escapeHTML(dayLabel)}</div>
          <div class="full-date-label">${escapeHTML(fullDateLabel)}</div>
        </div>
      `;
      chatBox.appendChild(dateLabelDiv);
      lastDateKey = dateKey;
    }

    // â€”â€”â€” bubble pesan â€”â€”â€”
    const div = document.createElement('div');
    div.className = 'message ' + (c.from === 'user' ? 'mine' : 'theirs');

    const rawName = (c.from === 'user') ? (c.name || 'You') : (c.name || 'Admin');
    const senderLabel = nameOnly(cleanDuplicateName(rawName));
    const senderPhoto = c.photoURL || 'https://i.pravatar.cc/40';

    // header bubble tanpa src (src diset via property biar aman)
    div.innerHTML = `
      <div class="msg-header">
        <img class="msg-avatar" alt="user" />
        <span class="msg-info">${escapeHTML(senderLabel)}</span>
        <small>${escapeHTML(timeFormatted)}</small>
      </div>
    `;

    // set avatar via property (hindari attribute injection)
    const avatarEl = div.querySelector('.msg-avatar');
    if (avatarEl) avatarEl.src = senderPhoto;

    // konten: text atau image
    if (typeof c.text === 'string' && c.text.trim() !== '') {
      const p = document.createElement('p');
      p.className = 'msg-text';
      // dukung newline; tetap aman karena di-escape dulu
      p.innerHTML = escapeHTML(c.text).replace(/\n/g, '<br>');
      div.appendChild(p);
    } else if (c.image) {
      const img = document.createElement('img');
      img.alt = 'Image';
      img.style.maxWidth = '100%';
      img.style.borderRadius = '8px';
      img.style.marginTop = '4px';
      img.src = c.image; // set via property
      div.appendChild(img);
    }

    chatBox.appendChild(div);
  });
}
['click','keydown','scroll','touchstart'].forEach(event =>
  document.addEventListener(event, () => userHasInteracted = true, { once: true })
);
// ===== Scroll-To-Bottom =====
const toBottomBtn = document.getElementById('toBottomBtn');

function isAtBottom(el, pad=10){
  return el && (el.scrollTop + el.clientHeight >= el.scrollHeight - pad);
}
function scrollToBottom(smooth=true){
  if (!chatBody) return;
  chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
}
if (toBottomBtn){
  toBottomBtn.addEventListener('click', ()=> scrollToBottom(true));
}
if (chatBody){
  chatBody.addEventListener('scroll', ()=>{
    if (!toBottomBtn) return;
    toBottomBtn.classList.toggle('show', !isAtBottom(chatBody));
  });
}

// panggil setiap selesai render/append pesan
function onNewMessageRendered({forceToBottom=false} = {}){
  if (forceToBottom || isAtBottom(chatBody)) scrollToBottom(true);
  if (lastQuery) doSearch(lastQuery);
}
function notifyUnread(){
  const target = ALLOWED_PARENTS.includes(PARENT_ORIGIN) ? PARENT_ORIGIN : "*";
  window.parent.postMessage({ action: "show-livechat-notif" }, target);
}
function notifyRead(){
  const target = ALLOWED_PARENTS.includes(PARENT_ORIGIN) ? PARENT_ORIGIN : "*";
  window.parent.postMessage({ action: "hide-livechat-notif" }, target);
}
function playNotificationSound() {
  const audio = document.getElementById("notifSound");
  if (audio && userHasInteracted) {
    audio.currentTime = 0;
    audio.play().catch(e => console.warn("ðŸ”‡ Audio autoplay blocked:", e));
  }
}

window.addEventListener("DOMContentLoaded", async () => {
  // 1) kalau sebelumnya sudah login email, pakai dulu
  const email = localStorage.getItem("useremail");
  if (!currentActiveId && email){
    currentIsGuest   = false;
    currentUserEmail = email;
    currentActiveId  = sanitizeEmail(email);
  }

  if (IS_EMBEDDED) {
    // 2) di iframe: tunggu parent. kalau 2.5s masih belum ada ID, pakai ID lokal
    if (!currentActiveId) {
      setTimeout(() => {
        if (!currentActiveId) {
          const id = getOrCreateLocalGuestId();
          currentIsGuest  = true;
          currentActiveId = id;
          if (!localStorage.getItem("username")) {
            localStorage.setItem("username", "Guest-" + id.slice(-5).toUpperCase());
          }
          updateUserHeader();
          bindPresenceAndNotif();
          initChatWithUserData();
        }
      }, 2500);
    } else {
      // sudah ada ID dari email/parent â†’ langsung jalan
      updateUserHeader();
      bindPresenceAndNotif();
      initChatWithUserData();
    }
  } else {
    if (!currentActiveId) {
      await ensureGuestLocalIdentity();
    } else {
      updateUserHeader();
      bindPresenceAndNotif();
      initChatWithUserData();
    }
  }
  updateUserHeader();
});
</script>
</body>
</html>
