<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LiveChat - User</title>
  <style>
:root {
  --bg-color:#111111;
  --text-color:#ffffff;
  --primary-color:#facc15;
}

/* Base */
html,body{height:100%;}
body{
  background:var(--bg-color);
  color:#000;
  font-family:'Segoe UI',sans-serif;
  margin:0;
  padding:0;
  scrollbar-width:none;
  -ms-overflow-style:none;
}
body::-webkit-scrollbar{display:none;}

header{
  background-color:#1668dc;
  padding:0 10px;
  display:flex;justify-content:space-between;align-items:center;
  color:var(--bg-color);height:90px;
}
h1{color:#fff;margin:0;font-size:30px;}

/* ===== CONTAINER (grid biar composer nempel bawah) ===== */
.chat-wrapper,
.chat-container{
  background:#fff;
  max-width:640px;
  margin:1rem auto 30px;
  border-radius:12px;
  box-shadow:0 0 10px #1668dc;
  border:1px solid #1668dc;
  padding:12px;

  display:grid;
  grid-template-rows:auto 1fr auto;   /* header | messages | composer */
  height:100dvh;                      /* layar mobile modern */
  height:100svh;                      /* iOS */
  overflow:hidden;                    /* hanya chat-box yg scroll */
}

/* Header */
.chat-header{
  background:linear-gradient(to right,#1668dc,#c5ff4a);
  padding:12px 18px;
  display:flex;align-items:center;gap:10px;
  border-bottom:1px solid #fff3;border-radius:10px;
  font-size:1rem;color:#fff;margin-bottom:10px;
  justify-content:space-between;
}
.chat-header .profile{display:flex;align-items:center;gap:10px;}
.chat-header .profile img{
  width:36px;height:36px;border-radius:50%;
  border:2px solid #fff;object-fit:cover;
}
.chat-header .profile span{font-weight:bold;font-size:16px;color:#000;}
.search-wrapper{flex-grow:1;display:flex;justify-content:flex-end;}
#searchChat{
  padding:8px 12px;font-size:14px;border-radius:6px;border:1px solid #ccc;
  min-width:200px;max-width:300px;flex-grow:1;
}

/* ===== CHAT LIST ===== */
.chat-box,#chatBox{
  flex:1 1 auto;min-height:0;        /* PENTING agar area ini yg scroll */
  overflow-y:auto;padding:15px;
  background:#000;scrollbar-width:none;-ms-overflow-style:none;
  border-radius:10px;border:1px solid #3c89e8;
}
.chat-box::-webkit-scrollbar,#chatBox::-webkit-scrollbar{display:none;}

.message{
  padding:.5rem .75rem;margin:.5rem 0;border-radius:12px;
  max-width:85%;word-wrap:break-word;word-break:break-word;
  box-shadow:0 2px 4px rgba(0,0,0,.4);
}
.mine{
  margin-left:auto;background:linear-gradient(to bottom,#1668dc,#fff);
  color:#000;font-weight:bold;
}
.theirs{
  margin-right:auto;background:linear-gradient(to bottom,#1668dc,#d7e9ff,#c5ff4a);
}
.msg-header{display:flex;align-items:center;gap:6px;margin-bottom:2px;font-weight:bold;}
.msg-header small{font-size:.75rem;color:#0b6906;}
.msg-text{margin:0;padding:0;font-weight:bold;}
.msg-avatar{
  width:24px;height:24px;border-radius:50%;margin-right:6px;object-fit:cover;
  border:1px solid #fff;background-color:#000;
}

/* Tanggal */
.date-label{text-align:center;margin:20px 0;}
.date-label-inner{
  display:inline-block;background-color:lightgreen;padding:2px 30px;
  border-radius:20px;font-size:14px;color:#333;box-shadow:0 2px 4px rgba(0,0,0,.1);
}
.date-label-inner .day-label{font-weight:bold;}
.date-label-inner .full-date-label{font-size:12px;color:#555;}
#startMessage{transition:opacity .5s ease;font-size:16px;}

/* ===== COMPOSER (selalu terlihat) ===== */
.send-box{
  position:sticky;bottom:0;z-index:5;
  display:flex;align-items:center;gap:10px;
  padding:10px;border:1px solid #3c89e8;background:#111;border-radius:10px;
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
#msg{
  flex:1 1 auto;min-width:0;min-height:40px;height:44px;
  padding:10px;font-size:16px;border-radius:6px;border:2px solid #3c89e8;
  resize:none;box-sizing:border-box;line-height:1.25;
}
.file-label{
  flex:0 0 auto;background:#1668dc;color:#fff;padding:0 16px;border-radius:8px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  height:44px;font-weight:bold;white-space:nowrap;
}
input[type="file"]{display:none;}
.send-box button{
  flex:0 0 auto;background:#1668dc;color:#fff;font-weight:bold;border:none;
  border-radius:8px;cursor:pointer;height:44px;padding:0 14px;white-space:nowrap;
}
.send-box button:active,.file-label:active{color:#fff;background:#1554ad!important;}
.send-box button:hover,.file-label:hover{color:#fff;background:#3c89e8;}

/* Logout */
#logoutBtn{
  background:#141414;color:#fff;padding:0 15px;border-radius:6px;font-weight:bold;
  cursor:pointer;border-color:#fff;transition:.3s;font-size:14px;height:32px;width:100%;
}
#logoutBtn:hover{border-color:#3c89e8;background:#141414;color:#3c89e8;}
#logoutBtn:active{border-color:#3c89e8;background:#141414;color:#1554ad;}

/* ===== RESPONSIVE ===== */
@media (max-width:600px){
  .chat-header{flex-direction:column;align-items:flex-start;gap:8px;}
  #searchChat{min-width:0;width:100%;max-width:none;}

  /* tetap baris supaya tombol tidak ‚Äúhilang‚Äù */
  .send-box{flex-direction:row !important;gap:8px;}
  #msg{height:40px;font-size:15px;}
  .file-label,.send-box button{height:40px;padding:0 10px;}

  .message{max-width:92%;}
}
@media (max-width:400px){
  .chat-header{padding:10px 12px;}
  .chat-header .profile span{font-size:14px;}
  #searchChat{font-size:13px;}

  /* kompres tombol kirim */
  .send-box button{padding:0 10px;}
}
</style>

<body>
  <!-- Header Atas -->
 <header>
  <div style="display: flex; align-items: center; gap: 10px;">
    <h1>USER LIVECHAT</h1>
    <div id="notifDot" style="width: 12px; height: 12px; background: red; border-radius: 50%; display: none;"></div>
  </div>
</header>


<main>
  <div class="chat-wrapper">
    <!-- CHAT HEADER -->
    <div class="chat-header">
      <div class="profile">
        <img id="headerUserPhoto" src="https://i.pravatar.cc/40" alt="User" />
        <div>
          <span id="headerUserName">5G 88</span><br />
          <small id="typingStatus" style="font-size: 12px; font-weight: normal; color: white;">Offline</small>
        </div>
      </div>
      <div class="search-wrapper">
        <input type="text" id="searchChat" placeholder="üîç Search messages..." />
      </div>
    </div>

 <div class="chat-box" id="chatBox">
  <div id="startMessage" style="text-align:center; color:white; opacity:0.6; margin-top:10px; font-size:14px;">
    No messages yet. Start the conversation!
  </div>
</div>

    <!-- SEND BOX -->
    <div class="send-box">
      <textarea id="msg" placeholder="Type your message" rows="2"></textarea>
      <label class="file-label">
        Upload Image
        <input type="file" id="fileInput" accept="image/*">
      </label>
      <button type="button" disabled>Send</button>
    </div>
  </div>
</main>
<audio id="notifSound" src="https://searcfile.github.io/5G88-audio/notifsound/notification.wav" preload="auto"></audio>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
document.addEventListener("contextmenu", e => e.preventDefault());
  document.onkeydown = function (e) {
    if (e.key === "F12" || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase()))) {
      return false;
    }
  };
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
let chatInitialized = false;

function sanitizeEmail(email) {
  return email.toLowerCase().replace(/\./g, "_");
}
function getChatPath(email) {
  return 'chats/' + sanitizeEmail(email);
}
const firebaseConfig = {
  apiKey: "AIzaSyCKmrlS4qrZCrMNRIfIRCWCbNgZT1uQ3ZI",
  authDomain: "blurphp.firebaseapp.com",
  databaseURL: "https://blurphp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "blurphp",
  storageBucket: "blurphp.appspot.com",
  messagingSenderId: "593904200464",
  appId: "1:593904200464:web:cea7bc1360532c20d99395"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// ===== parent origins yang diizinkan =====
const ALLOWED_PARENTS = [
  "https://5g88-login.vercel.app",
  "https://5g88-main.vercel.app"
];

// deteksi origin parent dari referrer (fallback "*")
function getParentOrigin(){
  try { return new URL(document.referrer).origin; } catch { return "*"; }
}
const PARENT_ORIGIN = getParentOrigin();

// ===== SATU-SATUNYA message handler di child =====
window.addEventListener("message", (e) => {
  if (!ALLOWED_PARENTS.includes(e.origin)) return;       // keamanan wajib

  const data = e.data || {};
  if (data.type === "user-login" && data.user){
    const { name, email, photo } = data.user;
    if (email){
      localStorage.setItem("username", name || "User");
      localStorage.setItem("useremail", email);
      localStorage.setItem("userphoto", photo || "");
      updateUserHeader();
      initChatWithUserData();          // mulai chat untuk user ini
      notifyRead();                    // anggap terbaca saat panel dibuka
    }
  }

  // (opsional, kalau parent nanti mau kirim status)
  if (data.action === "panel-open")  notifyRead();
  if (data.action === "panel-close") {/* no-op */}
});
  
let currentUserEmail = null;
let userHasInteracted = false;

function cleanDuplicateName(name) {
  const parts = name.trim().split(/\s+/);
  const half = parts.length / 2;
  if (parts.length % 2 === 0) {
    const firstHalf = parts.slice(0, half).join(' ');
    const secondHalf = parts.slice(half).join(' ');
    if (firstHalf === secondHalf) return firstHalf;
  }
  return name;
}

function updateUserHeader() {
  let userName = localStorage.getItem("username") || "User";  // GANTI const ‚Üí let
  const userPhoto = localStorage.getItem("userphoto") || "https://i.pravatar.cc/40";
  const nameEl = document.getElementById("headerUserName");
  const photoEl = document.getElementById("headerUserPhoto");

  userName = cleanDuplicateName(userName);  // ‚úÖ Tidak error lagi
  if (nameEl) nameEl.textContent = userName;
  if (photoEl) photoEl.src = userPhoto;
}

function initChatWithUserData() {
  if (chatInitialized) return;
  const userEmail   = localStorage.getItem("useremail");
  const msgInput    = document.getElementById('msg');
  const sendBtn     = document.querySelector('.send-box button');
  const fileInput   = document.getElementById('fileInput');
  const searchInput = document.getElementById('searchChat');
  const chatBox     = document.getElementById('chatBox');
  const typingEl    = document.getElementById('typingStatus');

  // Guard: kalau belum lengkap, jangan lanjut
  if (!userEmail || !msgInput || !sendBtn || !fileInput || !searchInput || !chatBox) return;

  chatInitialized   = true;
  currentUserEmail  = userEmail;

  updateUserHeader();
  if (typingEl) typingEl.textContent = 'Online';

  let typingTimer;
  const typingDelay = 2000;

  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
      e.preventDefault();
      sendMessage(currentUserEmail);
    }
  });

  msgInput.addEventListener('input', () => {
    sendBtn.disabled = !msgInput.value.trim() && !fileInput.files.length;
    if (typingEl) {
      typingEl.textContent = msgInput.value.trim() ? 'Typing...' : 'Online';
      clearTimeout(typingTimer);
      if (msgInput.value.trim()) {
        typingTimer = setTimeout(() => { if (typingEl) typingEl.textContent = 'Online'; }, typingDelay);
      }
    }
  });

  sendBtn.addEventListener('click', () => sendMessage(currentUserEmail));
  sendBtn.disabled = true;

  searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    chatBox.querySelectorAll('.message').forEach(msg => {
      msg.style.display = msg.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
  });

  listenToChat(currentUserEmail);
}

async function sendMessage(userEmail) {
  if (!userEmail) return;

  const msgInput = document.getElementById('msg');
  const fileInput = document.getElementById('fileInput');
  const msg = msgInput.value.trim();
  const file = fileInput.files[0];

  if ((!msg || msg === "") && !file) return;

  const userName = localStorage.getItem("username") || "User";
  const userPhoto = localStorage.getItem("userphoto") || "";
  const time = Date.now();
  const chatRef = db.ref(getChatPath(userEmail));

  let imageUrl = null;

  try {
    if (file) {
      const fileRef = storage.ref(`chat_images/${sanitizeEmail(userEmail)}/${time}_${file.name}`);
      const snapshot = await fileRef.put(file);
      imageUrl = await snapshot.ref.getDownloadURL();
    }

    await chatRef.push({
      from: 'user',
      name: userName,
      email: userEmail,
      photoURL: userPhoto,
      text: msg || null,
      image: imageUrl || null,
      time,
      readByAdmin: false // ‚úÖ WAJIB agar dot merah muncul
    });

    msgInput.value = '';
    fileInput.value = '';
    document.querySelector('.send-box button').disabled = true;

  } catch (error) {
    console.error("Error sending message:", error);
    alert("‚ùå Gagal mengirim pesan.");
  }
}

function listenToChat(userEmail) {
  const chatBox = document.getElementById('chatBox');
  const chatRef = db.ref(getChatPath(userEmail));
  const lastSeenKey = `lastSeenByUser_${sanitizeEmail(userEmail)}`;
  const startMsg = document.getElementById("startMessage");

  chatRef.on('value', snapshot => {
    const chats = snapshot.val();

    // bersihkan pesan lama (kecuali startMessage)
    const oldMessages = chatBox.querySelectorAll(".message, .date-label");
    oldMessages.forEach(el => el.remove());

    // jika belum ada chat
    if (!chats || Object.keys(chats).length === 0) {
      if (startMsg) startMsg.style.display = "block";
      notifyRead();          // tidak ada unread
      return;
    }
    if (startMsg) startMsg.style.display = "none";

    const lastSeenTime = parseInt(localStorage.getItem(lastSeenKey) || '0', 10);
    let latestAdminMsgTime = 0;

    const chatArray = Object.values(chats).sort((a, b) => a.time - b.time);
    const today = new Date(); today.setHours(0,0,0,0);
    const pastChats = [], todayChats = [];

    chatArray.forEach(c => {
      const msgDateOnly = new Date(c.time); msgDateOnly.setHours(0,0,0,0);
      (msgDateOnly.getTime() === today.getTime() ? todayChats : pastChats).push(c);
      if (c.from === 'admin' && c.time > latestAdminMsgTime) latestAdminMsgTime = c.time;
    });

    // simpan waktu terakhir lihat (pakai timestamp pesan terakhir)
    const latestTime = chatArray[chatArray.length - 1]?.time || 0;
    localStorage.setItem(lastSeenKey, String(latestTime));

    // kirim sinyal notif ke parent
    if (latestAdminMsgTime > lastSeenTime) {
      playNotificationSound();
      notifyUnread();   // tampilkan dot di parent
    } else {
      notifyRead();     // sembunyikan dot di parent
    }

    renderChats(pastChats, today);
    renderChats(todayChats, today);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}
function renderChats(chatGroup, today) {
  const chatBox = document.getElementById('chatBox');
  if (!chatBox) return;

  let lastDateKey = '';
  const list = Array.isArray(chatGroup) ? chatGroup : [];

  list.forEach((c) => {
    if (!c || !c.time || isNaN(new Date(c.time).getTime())) return;

    const msgDate = new Date(c.time);
    const timeFormatted = msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    const dateKey = msgDate.toDateString();

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const dayLabel = (dateKey === today.toDateString())
      ? 'Today'
      : (dateKey === yesterday.toDateString())
        ? 'Yesterday'
        : msgDate.toLocaleDateString('en-GB', { weekday: 'long' });

    const fullDateLabel = msgDate.toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric'
    });

    // ‚Äî‚Äî‚Äî header tanggal (jika ganti hari) ‚Äî‚Äî‚Äî
    if (dateKey !== lastDateKey) {
      const dateLabelDiv = document.createElement('div');
      dateLabelDiv.className = 'date-label';
      dateLabelDiv.innerHTML = `
        <div class="date-label-inner">
          <div class="day-label">${escapeHTML(dayLabel)}</div>
          <div class="full-date-label">${escapeHTML(fullDateLabel)}</div>
        </div>
      `;
      chatBox.appendChild(dateLabelDiv);
      lastDateKey = dateKey;
    }

    // ‚Äî‚Äî‚Äî bubble pesan ‚Äî‚Äî‚Äî
    const div = document.createElement('div');
    div.className = 'message ' + (c.from === 'user' ? 'mine' : 'theirs');

    const rawName = (c.from === 'user') ? (c.name || 'You') : (c.name || 'Admin');
    const senderLabel = cleanDuplicateName(rawName);
    const senderPhoto = c.photoURL || 'https://i.pravatar.cc/40';

    // header bubble tanpa src (src diset via property biar aman)
    div.innerHTML = `
      <div class="msg-header">
        <img class="msg-avatar" alt="user" />
        <span class="msg-info">${escapeHTML(senderLabel)}</span>
        <small>${escapeHTML(timeFormatted)}</small>
      </div>
    `;

    // set avatar via property (hindari attribute injection)
    const avatarEl = div.querySelector('.msg-avatar');
    if (avatarEl) avatarEl.src = senderPhoto;

    // konten: text atau image
    if (typeof c.text === 'string' && c.text.trim() !== '') {
      const p = document.createElement('p');
      p.className = 'msg-text';
      // dukung newline; tetap aman karena di-escape dulu
      p.innerHTML = escapeHTML(c.text).replace(/\n/g, '<br>');
      div.appendChild(p);
    } else if (c.image) {
      const img = document.createElement('img');
      img.alt = 'Image';
      img.style.maxWidth = '100%';
      img.style.borderRadius = '8px';
      img.style.marginTop = '4px';
      img.src = c.image; // set via property
      div.appendChild(img);
    }

    chatBox.appendChild(div);
  });
}
['click','keydown','scroll','touchstart'].forEach(event =>
  document.addEventListener(event, () => userHasInteracted = true, { once: true })
);
function notifyUnread(){
  const target = ALLOWED_PARENTS.includes(PARENT_ORIGIN) ? PARENT_ORIGIN : "*";
  window.parent.postMessage({ action: "show-livechat-notif" }, target);
}
function notifyRead(){
  const target = ALLOWED_PARENTS.includes(PARENT_ORIGIN) ? PARENT_ORIGIN : "*";
  window.parent.postMessage({ action: "hide-livechat-notif" }, target);
}
function playNotificationSound() {
  const audio = document.getElementById("notifSound");
  if (audio && userHasInteracted) {
    audio.currentTime = 0;
    audio.play().catch(e => console.warn("üîá Audio autoplay blocked:", e));
  }
}

window.addEventListener("DOMContentLoaded", () => {
  const email = localStorage.getItem("useremail");
  if (email) {
    updateUserHeader();
    initChatWithUserData();

    const sanitized = sanitizeEmail(email);
    const connectedRef = firebase.database().ref(".info/connected");
    const userRef = firebase.database().ref("users/" + sanitized);

    connectedRef.on("value", (snap) => {
      if (snap.val() === true) {
        userRef.update({ online: true });
        userRef.onDisconnect().update({
          online: false,
          lastLoginTime: Date.now()
        });
      }
    });

    window.addEventListener("beforeunload", () => {
      userRef.update({
        online: false,
        lastLoginTime: Date.now()
      });
    });

const notifRef = firebase.database().ref("notifications/" + sanitized);
notifRef.on("value", (snapshot) => {
  const notif = snapshot.val();
  if (notif && notif.unread) {
    playNotificationSound();
    notifyUnread(); // üëâ kasih tau parent
    setTimeout(() => {
      firebase.database().ref("notifications/" + sanitized + "/unread").set(false);
    }, 2000);
  } else {
    notifyRead();
  }
});
  }
});
</script>
</body>
</html>
