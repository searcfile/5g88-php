<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<title>Monthly Bonus Recorder</title>
<style>
:root{
  --bg:#0a0a0a; --card:#121212; --text:#e6e6e6; --sub:#a7a7a7;
  --gold:#ffd166; --gold-2:#ffcf4d; --red:#ff0000; --green:#008000; --cyan:#60a5fa; --ring:rgba(255,209,102,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; background:#000; color:var(--text);font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;}
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: #141414; }
::-webkit-scrollbar-thumb {
  background: #424242;
  border-radius: 8px;
  border: 2px solid transparent;
  background-clip: content-box;
}
:root{--picker-blue: #1668dc;--picker-blue-ghost: rgba(22,104,220,.25);}
span.flatpickr-weekday {
  cursor: default;
  font-size: 90%;
  background: #141414 !important;
  color: #9BC2FF !important;
  line-height: 1;
  margin: 0;
  text-align: center;
  display: block;
  -webkit-box-flex: 1;
  -webkit-flex: 1;
      -ms-flex: 1;
          flex: 1;
  font-weight: bolder;
}
/* KECILKAN & GANTI WARNA TEKS JUDUL BULAN/TAHUN */
.flatpickr-calendar .flatpickr-current-month{
  font-size: 12px !important;      /* ubah ukuran header (default ~14–16px) */
  line-height: 1.2 !important;
}

.flatpickr-calendar .flatpickr-current-month .cur-month{color: #9BC2FF !important;font-weight: 700 !important;}
.flatpickr-calendar .flatpickr-current-month .numInputWrapper input.cur-year{color: #9BC2FF !important; font-weight: 700 !important;font-size: 12px !important;background: transparent !important;border: none !important;box-shadow: none !important;}
.flatpickr-calendar .flatpickr-weekday{font-size: 11px !important;color: #B7C7E8 !important;}
.flatpickr-calendar,
.flatpickr-calendar .flatpickr-months,
.flatpickr-calendar .flatpickr-months .flatpickr-month,
.flatpickr-calendar .flatpickr-weekdays,
.flatpickr-calendar .flatpickr-days,
.flatpickr-calendar .dayContainer{background:#141414 !important;}
.flatpickr-calendar{border:1px solid #2a2a2a !important;box-shadow:0 20px 60px rgba(0,0,0,.55) !important;}
.flatpickr-calendar .flatpickr-days .dayContainer + .dayContainer{border-left:1px solid #2a2a2a !important;}
.flatpickr-calendar .flatpickr-current-month,
.flatpickr-calendar .flatpickr-months .flatpickr-month,
.flatpickr-calendar .flatpickr-weekday{color:#e6e6e6 !important;}
.flatpickr-calendar .flatpickr-day{background:transparent !important;border-color:transparent !important;color:#e6e6e6 !important;}
.flatpickr-calendar .flatpickr-day:hover{background:#1d1d1d !important;border-color:#1d1d1d !important;}
.flatpickr-calendar .flatpickr-day.prevMonthDay,
.flatpickr-calendar .flatpickr-day.nextMonthDay{ color:#767676 !important; }
.flatpickr-calendar .flatpickr-day.flatpickr-disabled{ color:#555 !important; }
.flatpickr-calendar .flatpickr-day.today:not(.selected):not(.startRange):not(.endRange){border-color: var(--picker-blue) !important;}
.flatpickr-calendar .flatpickr-day.selected,
.flatpickr-calendar .flatpickr-day.startRange,
.flatpickr-calendar .flatpickr-day.endRange,
.flatpickr-calendar .flatpickr-day.selected:hover,
.flatpickr-calendar .flatpickr-day.startRange:hover,
.flatpickr-calendar .flatpickr-day.endRange:hover{background: var(--picker-blue) !important;border-color: var(--picker-blue) !important;color:#fff !important;box-shadow:none !important;}
.flatpickr-calendar .flatpickr-day.inRange{background: var(--picker-blue-ghost) !important;border-color: transparent !important;border-radius: 0 !important;box-shadow:-5px 0 0 var(--picker-blue-ghost) inset,5px 0 0 var(--picker-blue-ghost) inset !important;color:#fff;}
.flatpickr-calendar .flatpickr-day.startRange{border-radius:999px 0 0 999px !important;}
.flatpickr-calendar .flatpickr-day.endRange{border-radius:0 999px 999px 0 !important;}
.flatpickr-calendar .flatpickr-day.startRange + .flatpickr-day.endRange,
.flatpickr-calendar .flatpickr-day.startRange + .flatpickr-day.endRange:hover{background: var(--picker-blue) !important;border-color: var(--picker-blue) !important;box-shadow:none !important;color:#fff !important;}
.flatpickr-calendar .flatpickr-prev-month,
.flatpickr-calendar .flatpickr-next-month{color: var(--picker-blue) !important;fill:  var(--picker-blue) !important; background:transparent !important;}
.flatpickr-calendar .flatpickr-prev-month:hover,
.flatpickr-calendar .flatpickr-next-month:hover{filter:brightness(1.2);}

.header{position:sticky; top:0; z-index:200;background:linear-gradient(180deg,#0063ab,#001c31);border-bottom:1px solid #242424; padding:12px 14px;display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
.brand{display:flex; gap:10px; align-items:center; font-weight:700;padding:6px 10px; border-radius:10px; background:#0f0f0f; border:1px solid #222;}
.input {height:36px; border-radius:8px; outline:none; border:1px solid #424242; background:#141414; color:var(--text);padding:6px 10px; transition: all 0.2s;}
.input:hover { border-color:#3c89e8; }
.input:focus { border-color:#1668dc; }
.brand .dot{width:8px; height:8px; border-radius:50%; background:var(--gold); box-shadow:0 0 12px var(--gold)}
.spacer{flex: 1 1 auto !important;min-width: 12px;}
.select {height:36px; border-radius:8px; border:1px solid #424242; outline:none; background:#141414; color:rgba(255,255,255,0.85);padding:6px 10px; transition: all 0.2s;}
.select:hover{border-color:#3c89e8;color:#3c89e8}
.select:focus{border-color:#1668dc; box-shadow:0 0 0 4px #1668dc}
.btn{background:#1668dc;white-space:nowrap;color:white;border:none;padding:6px 10px;height:36px;font-size: 14px; cursor:pointer;transition: all 0.2s;border-radius:6px;}
.btn:hover{background:#3c89e8;} .btn:active{background:#1554ad;}
.btn-cancel{background:#141414;height:36px;padding:6px 10px;font-size: 14px;cursor:pointer; color:rgba(255, 255, 255, 0.85); border-radius:6px;border: 1px solid#424242;transition: all 0.2s;}.btn-cancel:hover{background:#141414;color:#3c89e8;border-color:#3c89e8}.btn-cancel:active{background:#141414;color:#1554ad;border-color:#1554ad}
.btn-unclaim {height:36px; border-radius:8px; border:1px solid #424242; background:#141414; color:rgba(255,255,255,0.85);padding:6px 10px; transition: all 0.2s;}
.btn-unclaim:hover{border-color:#3c89e8;color:#3c89e8;}.btn-unclaim:active{border-color:#1554ad;color:#1554ad;}
.btn-exp {height:36px; border-radius:8px; border:1px solid #424242; background:#141414; color:rgba(255,255,255,0.85);padding:6px 10px; transition: all 0.2s;}
.btn-exp:hover{border-color:#3c89e8;color:#3c89e8;}.btn-exp:active{border-color:#1554ad;color:#1554ad;}
.hint{color:#1668dc; font-size:12px}

/* Full width container */
.wrap{ width:100%; max-width:none; margin:16px 0; padding:0 14px 60px; }
.cards-row,.toolbar,.table-scroller{scrollbar-width: thin;scrollbar-color: #424242 #141414;}
.cards-row::-webkit-scrollbar,
.toolbar::-webkit-scrollbar,
.table-scroller::-webkit-scrollbar{height: 10px;width: 10px;}                     

.cards-row::-webkit-scrollbar-track,
.toolbar::-webkit-scrollbar-track,
.table-scroller::-webkit-scrollbar-track{background: #141414;}

.cards-row::-webkit-scrollbar-thumb,
.toolbar::-webkit-scrollbar-thumb,
.table-scroller::-webkit-scrollbar-thumb{
  background: #424242;
  border-radius: 8px;
  border: 2px solid transparent;
  background-clip: content-box;
}
/* Summary rows */
.cards-row{display:flex; gap:10px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin;min-width:0;}
.card{background:#141414;border:1px solid #424242; border-radius:14px; padding:12px;min-width:120px; flex:1 1 220px;}
.card h4{margin:0 0 2px; font-size:12px; color:rgba(255,255,255,0.85); font-weight:600}
.card .val{font-size:14px; font-weight:700}

/* Ellipsis khusus kartu */
.card .val{display:block;max-width:100%;overflow:hidden;white-space:nowrap;color:#008000;}
.val.red{color:var(--red)} .val.green{color:var(--green)} .val.cyan{color:#008000;}

/* Toolbar di atas tabel */
.toolbar .btn,
.toolbar .select{
  flex: 0 0 auto;               /* lebar natural, tidak grow */
  max-width: 180px;             /* batasi kalau font membesar */
  white-space: nowrap;
}

/* 5) Jaga jarak antar tombol */
.toolbar{
  display:flex;
  gap:8px;
  align-items:center;
  margin:10px 0 6px;
  z-index:100;
  flex-wrap:nowrap !important;
  white-space:nowrap;
  overflow-x:auto;   /* biar bisa geser ke samping */
  overflow-y:visible;
  padding-bottom:2px;
  position:relative;
}
.badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#111; color:#ccc; font-size:12px}

/* Mini-cards (Month & Site) di kiri tombol */
.mini-cards{display:inline-flex; gap:8px; min-width:0;flex: 0 0 auto;}
.mini-card{
  height:36px; display:flex; align-items:center; gap:8px;
  padding:0 12px; border-radius:8px;
  border:1px solid #2a2a2a; background:#141414; min-width:160px;flex: 0 0 auto;white-space: nowrap;
}
.mini-label{font-size:12px; color:#1668dc}
.mini-value{
  font-weight:700; min-width:0; overflow:hidden; white-space:nowrap;flex: 1 1 auto;color: var(--text);
}

/* ====== TABLE ====== */
.table{background:#101010; border:1px solid #222; border-radius:14px;position: relative;overflow:hidden; }
.table-scroller{max-height:560px;overflow:auto;scrollbar-gutter: stable;}
.table-scroller::-webkit-scrollbar{ width:10px; }
.table-scroller::-webkit-scrollbar-track{ background:#141414; }
.table-scroller::-webkit-scrollbar-thumb{background:#424242; border-radius:8px;border:2px solid transparent; background-clip:content-box;}
.table thead{background:linear-gradient(180deg,#161616,#131313)}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #303030;white-space:nowrap; overflow:hidden;vertical-align:middle;text-align:center;color:#008000;max-width:140px;}

/* Kolom khusus */
.table th:first-child, .table td:first-child,
.table th:last-child,  .table td:last-child { text-align:center; }
.table th:first-child, .table td:first-child { max-width:180px }
.table th:last-child,  .table td:last-child  { max-width:180px }

/* Footer */
.table tfoot td { background:#0f0f0f; font-weight:800 }

/* Layout fixed + batas kolom */
.table table { table-layout: fixed; width: 100% }
.table th, .table td { max-width: 140px }
.table th:first-child, .table td:first-child { max-width: 180px;color:rgba(255, 255, 255, 0.85); }
.table th:last-child,  .table td:last-child  { max-width: 180px }

/* Tengah‑kan angka (kolom 3–12) */
.table thead th:nth-child(n+3):nth-child(-n+12),
.table tbody td:nth-child(n+3):nth-child(-n+12),
.table tfoot td:nth-child(n+3):nth-child(-n+12){ text-align:center; }

/* Angka rapi */
.table td:nth-child(n+3):nth-child(-n+12){
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum";
}

/* Guard .num */
.table td.num{ display:table-cell !important; }
.table td .num{ display:inline !important; }

/* Warna angka */
.num.red { color: var(--red) }
.num.green { color: var(--green) }
.num.cyan { color:#008000;}

/* Aksi */
.actions { display:flex; gap:8px; justify-content:center }
.iconbtn { height:28px; padding:0 10px; border-radius:6px;transition: all 0.2s; border:1px solid #1668dc; background:#141414; color:#1668dc; cursor:pointer;}
.iconbtn:hover { border-color:#3c89e8;color:#3c89e8;}.iconbtn:active { border-color:#1554ad;color:#1554ad;}
.iconbtn-del { height:28px; padding:0 10px; border-radius:6px;transition: all 0.2s; border:1px solid #dc4446; background:#191111; color:#dc4446; cursor:pointer;}
.iconbtn-del:hover {border-color:#e86e6b; color:#e86e6b;}.iconbtn-del:active {border-color:#ad393a; color:#ad393a;}

/* Pill */
.pill { padding: 2px 8px; border-radius:999px; border:1px solid #2d2d2d; background:#121212;}
.pill.site-5g88 { color:#1668dc; background:#000; border-color:#1668dc;font-size:13px;}
.pill.site-spm888 { color:#ff2638; background:#000; border-color:#bf0010;font-size:13px; }

/* Empty state */
.empty {
  padding:24px; text-align:center; color:#9f9f9f;
  border-top:1px solid #222;
  background:repeating-linear-gradient(45deg,#0e0e0e 0 8px,#0c0c0c 8px 16px)
}

/* DataTable guard */
#dataTable{
  table-layout:fixed;
  width:100%;
  min-width:1700px;    /* paksa lebih lebar dari viewport → muncul scroll di .table-scroller */
  border-spacing:0;
  border-collapse:separate !important;
}
#dataTable th, #dataTable td { padding: 10px 12px; }
#dataTable td:last-child .actions { justify-content:center !important; }
#dataTable tfoot td{position: sticky;bottom: 0;z-index: 1;background:#0f0f0f;text-align:center !important;}
#dataTable thead th{position: sticky;top: 0;z-index: 2;background: linear-gradient(180deg,#161616,#131313);}
/* Sejajarkan kolom Actions */
#dataTable thead th:last-child { text-align: center !important; }
#dataTable tbody td:last-child { text-align: center !important; }
#dataTable td:last-child .actions{display:flex; width:100%; justify-content:center !important; align-items:center;}
#dataTable tfoot td:first-child {text-align: center !important; vertical-align: middle !important;font-weight: bold; letter-spacing: 0.3px; color: white;}
#dataTable thead th{ box-shadow: 0 2px 0 rgba(0,0,0,.35);color:white;}
#dataTable tfoot td{ box-shadow: 0 -2px 0 rgba(0,0,0,.35);}
#dataTable tbody td{transition: background-color .15s ease;}
#dataTable tbody tr:hover > td{background:#1d1d1d;border-color: transparent;}
#dataTable{border-collapse: separate;border-spacing: 0;}
/* Modal */
.modal{
  position: fixed; inset: 0; z-index: 2147483646;
  display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
  pointer-events: auto!important;
  isolation:isolate;
}
.modal.show{display:flex}
.modal[aria-hidden="true"]{ display:none !important; }
.modal .overlay{
  position:absolute; inset:0;
  background: rgba(0,0,0,.55);
  z-index: 2147483646;
  pointer-events: auto
}
.modal .dialog{
  position: relative;
  z-index: 2147483647;
  width: min(980px, calc(100% - 24px));
  background:#141414; border:1px solid #424242; border-radius:16px; padding:14px;
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
  max-height: 85vh; overflow: auto;
  display: flex; flex-direction: column;
  pointer-events: auto !important; /* isi dialog bisa diklik/fokus */
}
.dialog h3{margin:0 0 10px; font-size:18px}
.modal-close{
  position:absolute; top:10px; right:12px;
  background:transparent; border:none; cursor:pointer;
  color: rgb(255 255 255 / 45%); font-size:22px; z-index: 2147483647;
}
.modal-close:hover {color:white;z-index: 2147483647;}
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
@media (max-width:680px){ .grid{grid-template-columns:1fr} }
.group{display:flex; flex-direction:column; gap:6px}
.group label{font-size:12px; color:#1668dc;font-weight:bold;}
.input[type="number"]{text-align:left}
.dialog .foot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

/* Tier editor */
.tier-head{font-weight:700; margin-top:8px; margin-bottom:4px}
.tier-list{
  border:1px solid #2a2a2a; border-radius:10px; padding:0 8px; background:#101010;
  max-height:150px; overflow:auto; padding-right:6px;padding-bottom: 5px;
}
.tier-list .tier-row:first-child{
  position:sticky; top:0; z-index:1; background:#101010;
  border-bottom:1px solid #2a2a2a; margin-bottom:6px; padding-top:8px; padding-bottom:6px;
}
.tier-row{display:grid; grid-template-columns:1fr 1fr auto; gap:8px; margin-bottom:6px}
.tier-row:last-child{margin-bottom:0}
.tier-row .rm{border:1px solid #dc4446; background:#191111; color:#dc4446; border-radius:8px; height:36px; padding:0 10px; cursor:pointer}.tier-row .rm:hover {border:1px solid #e86e6b; color:#e86e6b;}.tier-row .rm:active {border:1px solid#ad393a; color:#ad393a;}
.addline{margin-top:8px}

/* Scrollbar tipis */
.tier-list::-webkit-scrollbar{height:8px; width:8px}
.tier-list::-webkit-scrollbar-thumb{background:#2a2a2a; border-radius:6px}
.cards-row::-webkit-scrollbar{height:8px}
.cards-row::-webkit-scrollbar-thumb{background:#2a2a2a; border-radius:6px}

/* Unclaim list styles */
.uc-item > :nth-child(3){
  overflow:hidden; white-space:nowrap;
}
.uc-claimed{ white-space:nowrap; overflow:visible; }
.uc-item > *{ min-width:0; }
.uc-list{
  display:flex; flex-direction:column; gap:8px;
  max-height:60vh; padding-right:6px;
  overflow-y:auto; overflow-x:hidden;
}
.uc-item{
  display:grid;
  grid-template-columns:150px 90px minmax(0,1fr) 110px max-content auto;
  gap:8px; align-items:center;
  border:1px solid #424242; background:#0f0f0f; padding:8px; border-radius:10px;
  min-height:44px;
}
.uc-item .uc-amt{font-weight:700;color:#008000;}
.uc-item .uc-amt.red{color:var(--red)}
.uc-tabs{display:flex; gap:8px; margin:6px 0 10px}
.uc-tab{height:32px;transition: all 0.2s;padding:0 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#ddd; cursor:pointer}
.uc-tab.active{border-color:#1668dc; color:#1668dc;}.uc-tab:hover{border:1px solid #3c89e8;color:#3c89e8;}.uc-tab:active{border:1px solid #1554ad;color:#1554ad;}
.dialog .uc-list {flex: 1 1 auto; min-height: 0; }
.clipnum{cursor: pointer;white-space: nowrap;}
/* tombol delete di Unclaim Center */
.btn-del{background:#191111; color:#dc4446;border:1px solid #dc4446; border-radius:8px;height:32px; padding:0 10px; cursor:pointer;transition:filter .2s, border-color .2s, background .2s;}
.btn-del:hover{ background:#210f0f; border-color:#6b3434; }
.btn-del:active{ background:#160b0b; }
.uc-actions{ display:flex; gap:8px; justify-content:flex-end; }
/* buang spinner number input (Chrome/Edge/Safari) */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{-webkit-appearance: none;margin: 0;}
input[type="number"]{-moz-appearance: textfield;appearance: textfield;}

/* tombol Edit di baris tier */
.tier-row .edit{border:1px solid #424242; background:#141414; color:rgba(255,255,255,0.85);border-radius:8px; height:36px; padding:0 10px; cursor:pointer;transition:filter 0.2s, border-color .2s;margin-right:6px;}
.tier-row .edit:hover{ border-color:#3c89e8;color:white;background:#3c89e8;transition:all 0.2s;}
.tier-row .edit:active{ border-color:#1554ad;color:white;background:#1554ad;transition:all 0.2s;}
.tier-row .edit.active{background:#1668dc;color:white;border:1px solid #1668dc;}
.bg-inert {
  pointer-events: none !important;
  user-select: none !important;
  -webkit-user-select: none !important;
  touch-action: none !important;
  filter: none !important;          /* jaga-jaga polyfill yang aneh */
}
.btn:disabled { opacity:.5; cursor:not-allowed; }
.input:disabled, .select:disabled { opacity:.7;cursor: not-allowed;}
/* ==== Date Range styles (kanan "Site") ==== */
/* ==== Date Range styles (kanan "Site") ==== */
.range-wrap{
  position: relative;                /* untuk menu absolute */
  display: inline-flex;
  align-items: center;
  gap: 6px;
  flex: 0 0 auto;
  white-space: nowrap;
}
.range-wrap .range{
  height:36px;
  background:#111;
  border:1px solid #424242;
  color:var(--text);
  border-radius:8px;
  padding:0 8px;
  outline:none;
  text-align:center;
  min-width:260px;
  font-variant-numeric: tabular-nums;
  letter-spacing:.2px;
}
.range-wrap .range:hover { border-color:#3c89e8; }
.range-wrap .range:focus { border-color:#1668dc; }
#rangeVis::placeholder{ text-align:center }

/* tombol kecil dropdown */
.range-quick-btn{height:36px;padding:0 8px;border-radius:8px;border:1px solid #424242;background:#141414;color:rgba(255,255,255,.85);cursor:pointer;transition:all .2s;}
.range-quick-btn:hover{ border-color:#3c89e8; color:#3c89e8; }.range-quick-btn:active{ border-color:#1554ad; color:#1554ad;}
.range-quick-menu{position:absolute;left:50%;transform:translateX(-50%);right:auto;top:calc(100% + 6px);background:#111;border:1px solid #424242;border-radius:8px;padding:6px;display:none;z-index:2147483646;box-shadow:0 12px 32px rgba(0,0,0,.45);flex-wrap:nowrap;gap:6px;white-space:nowrap;overflow-x:auto;overflow-y:hidden;min-width:fit-content;max-width:90vw;}
.range-quick-menu.show{ display:flex; } 
.range-quick-menu button{flex:0 0 auto;width:auto;background:transparent;border:0;color:rgba(255,255,255,.9);padding:8px 12px;border-radius:8px;cursor:pointer;white-space:nowrap;text-align:center;}
.range-quick-menu button:hover{ background:transparent; color:#3c89e8; }.range-quick-menu button:active{ background:transparent; color:#1554ad; }
.range-quick-menu button.active{background: transparent !important;color:#1668dc !important;}
.range-quick-menu hr{display: none;}
#rangeWrap{
  position: relative;
  z-index: 101;
}
.range-quick-menu.up{
  top:auto;
  bottom:calc(100% + 6px);
  left:50%;
  transform:translateX(-50%);
}
.quick-anchor{ position:relative; display:inline-block; } /* lebar = lebar tombol */
@media (max-width: 380px){
  .range-quick-menu{ min-width: 300px; }
}
#toastHost{
  position: fixed;
  bottom: 20px;
  left: 50%;                 /* tengah horizontal */
  transform: translateX(-50%);
  right: auto;
  display: flex;
  flex-direction: column;
  align-items: center;        /* setiap toast di-center */
  gap: 8px;
  z-index: 2147483647;
  pointer-events: none;
}
.toast{
  pointer-events: auto;
  min-width: auto;
  max-width: min(460px, 90vw);
  background: #1f2937;
  border: 1px solid #2a3646;
  color: #e5e7eb;
  padding: 10px 12px;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
  align-items: center;
  font-weight: 600;
  animation: toast-in .22s ease-out;
  column-gap: 5px;
  display: grid;
  grid-template-columns: 20px auto auto; /* icon | teks | X (semua size = konten) */
  column-gap: 5px;                       /* jarak antar kolom = 5px */
  justify-content: start; 
}
.toast .icon{ width:20px; height:20px; display:grid; place-items:center; }
.toast .icon svg{ width:18px; height:18px; display:block; }
.toast .close{
  background: transparent;
  border: 0;
  color: #9ca3af;
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  transition: color .15s ease, transform .12s ease;
}
.toast .msg{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.toast .close:hover{ color:#fff; }
.toast .close:active{ transform: scale(.92); }
.toast.success{ --ico:#1e824c; }
.toast.info   { --ico:#1668dc; }
.toast.warn   { --ico:#a36a00; }
.toast.error  { --ico:#b91c1c; }

/* animasi */
@keyframes toast-in{ from{opacity:0; transform:translateY(16px)} to{opacity:1; transform:translateY(0)} }
@keyframes toast-out{ to{opacity:0; transform:translateY(8px)} }
/* ===== Notes (Personal) ===== */
.notes-bar{display:flex;gap:8px;align-items:center;margin:8px 0 10px}
.notes-bar .btn,.notes-bar .btn-cancel,.notes-bar .select{height:32px}

.note-table-wrap{
  border:1px solid #2a2a2a; border-radius:10px; background:#101010;
  overflow:auto; max-height:60vh;
}
.notes-table{
  width: 100%;           /* dari fixed 900px -> penuh container */
  min-width: 900px;      /* still boleh scroll bila sempit */
  table-layout: fixed;
  border-collapse: separate;
  border-spacing: 0;
}
.notes-table th,.notes-table td{
  padding:8px 10px; border-bottom:1px solid #303030;
  text-align:center; white-space:nowrap; color:var(--text);
}
.notes-table thead th{
  background: linear-gradient(180deg, #1668dc, #1668dc);
  border-bottom: 0 !important;  /* hilangkan 1px border hitam */
  box-shadow: none;             /* kalau tak nak garis shadow */
}
.notes-table thead th:first-child{ border-top-left-radius: 10px; }
.notes-table thead th:last-child { border-top-right-radius: 10px; }
.notes-table input{
  width:100%; height:32px; border-radius:6px;
  border:1px solid #424242; background:#141414; color:var(--text);
  padding:4px 8px;
}
.notes-table input:disabled{opacity:.75}
.notes-table .actions{display:flex;gap:8px;justify-content:center}
/* Rename Columns editor */
.hdr-editor{
  display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 6px;
}
.hdr-editor .input{
  width:150px; height:34px;
}
/* === User dropdown === */
.userbox{ position:relative; flex:0 0 auto; }
.userbtn{
  height:36px; border-radius:8px; border:1px solid #424242;
  background:#141414; color:rgba(255,255,255,.85);
  display:inline-flex; align-items:center; gap:8px; padding:0 10px; cursor:pointer;transition: all 0.2s;
}
.userbtn:hover{ border-color:#3c89e8; color:#3c89e8; }.userbtn:active{ border-color:#1554ad; color:#1554ad; }
.userbtn .avatar{
  width:18px; height:18px; display:grid; place-items:center;
  border-radius:6px; background:#141414; border:1px solid #424242; font-size:12px;
}

.user-menu{
  position:absolute; right:0; left: auto;top:calc(100% + 8px);
  width: min(240px, 90vw); background:#141414; border:1px solid #424242; border-radius:6px;
  padding:10px; box-shadow:0 20px 50px rgba(0,0,0,.55); display:none;
  z-index:2147483645;max-height: 70vh; overflow: auto;transition: all 0.2s;
}
.user-menu.show{ display:block; }
.ud-head{ font-size:12px; color:#9ca3af; margin-bottom:6px; }
.ud-sep{ height:1px; background:#2a2a2a; margin:8px 0; }
.ud-item{
  display:grid;
  grid-template-columns: 16px 1fr 16px;
  align-items:center;
  gap:8px;
  width:100%;
  min-height:36px;
  background:#141414; border:1px solid #424242;
  border-radius:6px; padding:8px 10px; cursor:pointer;color:rgba(255, 255, 255, 0.85);transition: all 0.2s;
}
.ud-item:hover{ border-color:#3c89e8; color:#3c89e8; }.ud-item:active{ border-color:#1554ad; color:#1554ad; }
.ud-item.danger{ border-color:#424242; color:rgba(255, 255, 255, 0.85); background:#141414; }
.ud-item.danger:hover{ border-color:#3c89e8;; color:#3c89e8; }.ud-item.danger:active{ border-color:#1554ad;; color:#1554ad; }
#userMenu,
#userMenu #userMenuName {
  white-space: nowrap;
  overflow: visible;
  text-overflow: clip !important;
}
#userMenu .signed-row{
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
#userMenu .ud-item .label,
#userMenu .ud-item span{
  white-space: normal;
}
#userMenu button,
#userMenu .menu-btn,
#userMenu .ud-item{ /* tambahkan ud-item ke rule centering */
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  text-align:center;transition: all 0.2s;
}

#userMenu .ico{width:16px; height:16px; display:inline-flex;}
#userMenu .ico svg{ width:16px; height:16px; display:block; }
#cpModal .cp-row{
  display:grid;
  row-gap:6px;            /* pakai row-gap, bukan gap umum */
  margin:8px 0;
}
#cpModal .cp-row span{ color:#c9c9c9; font-size:14px; }

/* Input gelap + lebih tinggi */
#cpModal .dlg-body input{
  width:100%;
  background:#141414;
  border:1px solid #424242;
  color:#e8e8e8;
  height:40px;            /* lebih tinggi */
  padding:10px 12px;
  border-radius:8px;
  outline:none;
}
#cpModal .dlg-body input:focus{
  border-color:#5a87ff;
  box-shadow:0 0 0 2px rgba(90,135,255,.15);
}
#cpModal .dlg-body input::placeholder{ color:#9a9a9a; }

/* Header + tombol X */
#cpModal .dlg-head{
  position:relative;      /* biar X nempel ke header */
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding-right:40px;     /* ruang aman untuk X */
}
#cpModal .close-x{
  position:absolute;
  top:10px; right:10px;
  width:32px; height:32px;
  border:0; background:transparent;
  color:#bdbdbd;
  font-size:20px; line-height:32px;
  border-radius:6px; cursor:pointer;
}
#cpModal .close-x:hover{ background:#1f1f1f; color:#fff; }

/* Tombol aksi rata kanan */
#cpModal .dlg-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:12px;
}

/* (opsional) ukuran dialog */
#cpModal .dialog.small{ max-width:560px; }
</style>
</head>
<body>
  <!-- Header filters -->
  <div class="header">
    <div class="brand"><span class="dot"></span><span>Bonus Recorder</span></div>
    <select id="siteFilter" class="select"><option value="ALL">All Sites</option><option value="5G88">5G88</option><option value="SPM888">SPM888</option></select>
    <select id="monthFilter" class="select"></select>

    <!-- NEW: Unclaim button -->
    <button id="unclaimBtn" class="btn-unclaim" title="Kelola Unclaim">Unclaim</button>

    <div class="spacer"></div>
    <button id="viewBtn" class="btn-exp">View</button>
    <button id="exportBtn" class="btn-exp">Export CSV</button>
   <!-- USER DROPDOWN (di kanan tombol Export CSV) -->
<div id="userBox" class="userbox">
  <button id="userBtn" class="userbtn" aria-haspopup="true" aria-expanded="false" title="Account">
    <span class="avatar" aria-hidden="true">👤</span>
    <span id="userBtnLabel">—</span>
    <span aria-hidden="true">▾</span>
  </button>

  <div id="userMenu" class="user-menu" role="menu" aria-hidden="true">
    <div class="ud-head">Signed in as<br><b id="userMenuName">user</b></div>
    <div class="ud-sep"></div>
    <button id="udChangePw" class="ud-item">Change Password</button>
    <button id="udForgot"   class="ud-item">Forgot / Reset…</button>
    <div class="ud-sep"></div>
    <button id="udLogout"   class="ud-item danger">Logout</button>
  </div>
</div>
  </div>

  <div class="wrap">
    <div class="cards-row" id="summaryRowTop"></div>
    <div class="cards-row" id="summaryRowBottom" style="margin-top:8px;"></div>
    <!-- Toolbar above table -->
    <div class="toolbar">
      <div id="miniInfo" class="mini-cards">
        <div class="mini-card">
          <span class="mini-label">Month</span>
          <span id="miniMonth" class="mini-value"></span>
        </div>
        <div class="mini-card">
          <span class="mini-label">Site</span>
          <span id="miniSite" class="mini-value"></span>
        </div>
      </div>

<div id="rangeWrap" class="range-wrap" title="Filter by date">
  <input id="rangeVis" class="input range" type="text" readonly>

  <!-- ⬇️ anchor untuk pusatkan menu -->
  <div class="quick-anchor">
    <button id="quickBtn" class="range-quick-btn"
            aria-haspopup="true" aria-expanded="false"
            title="Quick ranges">▾</button>

    <div id="quickMenu" class="range-quick-menu" role="menu" aria-hidden="true">
      <button type="button" data-q="today">Today</button>
      <button type="button" data-q="yesterday">Yesterday</button>
      <button type="button" data-q="thisweek">This Week</button>
      <button type="button" data-q="lastweek">Last Week</button>
      <button type="button" data-q="thismonth">This Month</button>
      <button type="button" data-q="lastmonth">Last Month</button>
    </div>
  </div>

  <input id="rangeFrom" type="hidden">
  <input id="rangeTo"   type="hidden">
</div>
      <div class="spacer"></div>

      <button id="targetBtn" class="btn">Set Target</button>
      <button id="createBtn" class="btn">Create</button>
    </div>

    <div id="archiveBanner" class="badge" style="display:none; margin:8px 0">Anda sedang melihat bulan <b id="bannerMonth" style="margin-left:6px"></b></div>

<!-- Table -->
<div class="table">
  <div class="table-scroller">
  <table id="dataTable">
<colgroup>
  <col style="width:150px"><!-- Date/Time -->
  <col style="width:92px"><!-- Site -->
  <col style="width:120px"><!-- Deposit -->
  <col style="width:120px"><!-- Withdrawal -->
  <col style="width:120px"><!-- Resit In -->
  <col style="width:120px"><!-- Bonus -->
  <col style="width:110px"><!-- Forfeit -->
  <col style="width:110px"><!-- Member -->
  <col style="width:120px"><!-- Sales -->
  <col style="width:120px"><!-- Unclaim (NEW) -->
  <col style="width:120px"><!-- Bonus Deposit -->
  <col style="width:120px"><!-- Bonus Resit -->
  <col style="width:180px"><!-- Actions -->
</colgroup>

<thead>
  <tr>
    <th>Date & Time</th>
    <th>Site</th>
    <th>Deposit</th>
    <th>Withdrawal</th>
    <th>Resit In</th>
    <th>Bonus</th>
    <th>Forfeit</th>
    <th>Member</th>
    <th>Sales</th>
    <th>Unclaim</th>
    <th>Bonus Deposit</th>
    <th>Bonus Resit</th>
    <th>Actions</th>
  </tr>
</thead>

    <tbody id="tbody"></tbody>

 <tfoot>
  <tr>
    <td>TOTAL (Filtered)</td>
    <td></td>
    <td id="ft_deposit">0</td>
    <td id="ft_withdrawal">0</td>
    <td id="ft_resit">0</td>
    <td id="ft_bonus">0</td>
    <td id="ft_forfeit">0</td>
    <td id="ft_member">0</td>
    <td id="ft_sales">0</td>
    <td id="ft_unclaim">0</td>
    <td id="ft_bonDep">0</td>
    <td id="ft_bonRes">0</td>
    <td></td>
  </tr>
</tfoot>
  </table>

  <div id="emptyState" class="empty" style="display:none">
    <b>No Data.</b>
  </div>
</div>
</div>

  <!-- Modal Create/Edit -->
  <div id="modal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
    <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
    <h3 id="modalTitle">Create Record</h3>
      <div class="grid">
        <div class="group"><label for="m_site">Site</label>
          <select id="m_site" class="select"><option value="" selected disabled>Select Site…</option><option value="5G88">5G88</option><option value="SPM888">SPM888</option>
        </select>
        </div>
        <div class="group"><label for="m_dt">Date & Time</label><input id="m_dt" class="input" type="datetime-local" step="1"></div>
        <div class="group"><label for="m_deposit">Total Deposit</label><input id="m_deposit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_withdrawal">Total Withdrawal</label><input id="m_withdrawal" class="input" type="number" step="0.01"></div>
        <div class="group"><label for="m_bonus">Total Bonus</label><input id="m_bonus" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_forfeit">Total Forfeit</label><input id="m_forfeit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_member">Total Member</label><input id="m_member" class="input" type="number" step="1" min="0"></div>
        <div class="group"><label for="m_resit">Total Resit In</label><input id="m_resit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_sales">Total Sales (auto)</label><input id="m_sales" class="input" type="number" step="0.01" readonly title="Auto = Deposit − Withdrawal"></div>
        <div class="group"><label>&nbsp;</label><div class="hint">Sales auto: <b>Deposit − Withdrawal</b></div></div>

        <!-- NEW: Unclaim Amount (disimpan pending) -->
        <div class="group"><label for="m_unclaim">Unclaim Amount</label><input id="m_unclaim" class="input" type="number" step="0.01" min="0" placeholder="0.00"></div>
        <div class="group"><label>&nbsp;</label><div class="hint">Unclaim tidak langsung masuk Deposit; akan tampil di popup Unclaim & kolom Unclaim.</div></div>
      </div>
      <div class="foot"><button class="btn-cancel" onclick="closeModal()">Cancel</button><button id="saveBtn" class="btn">Save</button></div>
    </div>
  </div>

  <!-- Modal Set Target -->
 <div id="targetModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeTargetModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="targetTitle" tabindex="-1">
    <button class="modal-close" onclick="closeTargetModal()" aria-label="Close">&times;</button>
    <h3 id="targetTitle">Set Target Bonus (Multi-Tier)</h3>

      <div class="tier-head">Deposit Tiers</div>
      <div id="depTierList" class="tier-list"></div>
      <button class="btn addline" id="addDepTier">+ Add Deposit Tier</button>

      <div class="tier-head" style="margin-top:12px">Resit Tiers</div>
      <div id="resTierList" class="tier-list"></div>
      <button class="btn addline" id="addResTier">+ Add Resit Tier</button>

      <div class="tier-head" style="margin-top:12px">Sales Tiers</div>
      <div id="salesTierList" class="tier-list"></div>
      <button class="btn addline" id="addSalesTier">+ Add Sales Tier</button>

      <div class="foot"><button class="btn-cancel" onclick="closeTargetModal()">Cancel</button><button id="saveTargetBtn" class="btn">Save Target</button></div>
    </div>
  </div>

  <!-- NEW: Modal Unclaim Center -->
  <div id="unclaimModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeUnclaimModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="unclaimTitle" tabindex="-1">
    <button class="modal-close" onclick="closeUnclaimModal()" aria-label="Close">&times;</button>
    <h3 id="unclaimTitle">Unclaim Center</h3>
      <div class="uc-tabs">
        <button class="uc-tab active" id="tabPending">Pending</button>
        <button class="uc-tab" id="tabHistory">History</button>
      </div>
      <div id="ucList" class="uc-list"></div>
      <div class="foot"><button class="btn-cancel" onclick="closeUnclaimModal()">Cancel</button></div>
    </div>
  </div>

<!-- Notes (Personal) -->
<div id="notesModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeNotesModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="notesTitle" tabindex="-1">
    <button class="modal-close" onclick="closeNotesModal()" aria-label="Close">&times;</button>
    <h3 id="notesTitle">Notes</h3>

    <div class="notes-bar">
      <select id="noteSelect" class="select"></select>
      <button id="addNoteBtn" class="btn">+ New</button>
      <button id="renameNoteBtn" class="btn">Rename</button>
      <button id="editHdrBtn" class="btn">Rename Columns</button>
      <button id="delNoteBtn" class="btn-cancel">Delete</button>
      <div class="spacer"></div>
      <button id="saveNoteBtn" class="btn">Save</button>
      <button id="cancelNoteBtn" class="btn-cancel">Cancel</button>
    </div>

    <div class="note-table-wrap">
      <table id="notesTable" class="notes-table">
        <colgroup>
          <col style="width:120px"><!-- SALES -->
          <col style="width:120px"><!-- SALES AMOUNT -->
          <col style="width:120px"><!-- DEPOSIT -->
          <col style="width:120px"><!-- DEPOSIT AMOUNT/2 -->
          <col style="width:120px"><!-- RESIT -->
          <col style="width:120px"><!-- RESIT AMOUNT/2 -->
          <col style="width:140px"><!-- Actions -->
        </colgroup>
        <thead>
          <tr>
            <th>SALES</th><th>AMOUNT</th>
            <th>DEPOSIT</th><th>AMOUNT /2</th>
            <th>RESIT</th><th>AMOUNT /2</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="notesTBody"></tbody>
      </table>
    </div>

    <div class="foot" style="justify-content:flex-start">
      <button id="addRowBtn" class="btn">+ Add Row</button>
    </div>
  </div>
</div>

<!-- Modal: Rename Notes Columns -->
<div id="hdrModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeHdrModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="hdrTitle" tabindex="-1" style="max-width:560px">
    <button class="modal-close" onclick="closeHdrModal()" aria-label="Close">&times;</button>
    <h3 id="hdrTitle">Rename Columns</h3>

    <div class="hdr-editor">
      <input id="hdr_0" class="input" type="text" placeholder="SALES">
      <input id="hdr_1" class="input" type="text" placeholder="AMOUNT">
      <input id="hdr_2" class="input" type="text" placeholder="DEPOSIT">
      <input id="hdr_3" class="input" type="text" placeholder="AMOUNT /2">
      <input id="hdr_4" class="input" type="text" placeholder="RESIT">
      <input id="hdr_5" class="input" type="text" placeholder="AMOUNT /2">
    </div>

    <div class="foot">
      <button id="hdrCancel" class="btn-cancel">Cancel</button>
      <button id="hdrSave"   class="btn">Save</button>
    </div>
  </div>
</div>

<!-- Modal: Note Name (Create/Rename) -->
<div id="noteNameModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeNoteNameModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="noteNameTitle" tabindex="-1" style="max-width:420px">
    <button class="modal-close" onclick="closeNoteNameModal()" aria-label="Close">&times;</button>
    <h3 id="noteNameTitle">New Note</h3>

    <div class="group">
      <label for="noteNameInput">Note name</label>
      <input id="noteNameInput" class="input" type="text" placeholder="New Note">
    </div>

    <div class="foot">
      <button id="noteNameCancel" class="btn-cancel">Cancel</button>
      <button id="noteNameOk" class="btn">Save</button>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div id="cpModal" class="modal" aria-hidden="true">
  <div class="overlay"></div>
  <div class="dialog small">
   <div class="dlg-head">
  <h3>Change Password</h3>
  <button id="cpCloseX" class="dlg-x" aria-label="Close" type="button">×</button>
</div>

    <div class="dlg-body">
      <label class="cp-row">
        <span>Current Password</span>
        <input id="cpCurrent" type="password" autocomplete="current-password">
      </label>
      <label class="cp-row">
        <span>New Password</span>
        <input id="cpNew" type="password" autocomplete="new-password" minlength="6">
      </label>
      <label class="cp-row">
        <span>Confirm New Password</span>
        <input id="cpNew2" type="password" autocomplete="new-password" minlength="6">
      </label>
      <div class="hint">Min. 6 karakter.</div>
    </div>

    <div class="dlg-actions">
      <button id="cpOk" class="btn">Change</button>
      <button id="cpCancel" type="button" class="btn ghost">Cancel</button>
    </div>
  </div>
</div>
<!-- Toast host -->
<div id="toastHost" aria-live="polite" aria-atomic="true"></div>

<!-- Reusable Confirm -->
<div id="confirmModal" class="modal" aria-hidden="true">
  <div class="overlay"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" tabindex="-1" style="max-width:420px">
    <h3 id="confirmTitle">Confirm</h3>
    <div id="confirmMsg" style="margin:8px 0 14px"></div>
    <div class="foot">
      <button id="confirmNo"  class="btn-cancel">No</button>
      <button id="confirmYes" class="btn">Yes</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>html.auth-wait body{visibility:hidden}</style>
<script>document.documentElement.classList.add('auth-wait');</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAvuHrjMwlz3cnTa9eTqDQaAPasjtFa4us",
    authDomain: "bonus-5c5e0.firebaseapp.com",
    projectId: "bonus-5c5e0",
    appId: "1:781993203912:web:704d36f814c6247bf62dfd",
    databaseURL: "https://bonus-5c5e0-default-rtdb.asia-southeast1.firebasedatabase.app"
  };
  const LOGIN_URL = "https://searcfile.github.io/5g88-php/bonuslogin/"; // halaman login kamu

  // 4) Init + Guard
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  // === Realtime Database ===
const db = firebase.database();
let BOOTING = true;
// Ambil semua state dari localStorage
function __readLocalState(){
  return {
    records:  readStore?.()    || [],
    unclaims: readUnclaims?.() || [],
    targets:  JSON.parse(localStorage.getItem(LS_TARGET) || 'null'),
    notes:    JSON.parse(localStorage.getItem('bonusNotes.v1') || 'null'),
    updatedAt: getUpdatedAt(),   // ⬅️ pakai nilai persisten
  };
}

// Tulis semua state ke localStorage
function __writeLocalState(s){
  if (!s) return;
  if (Array.isArray(s.records))  writeStore(s.records);
  if (Array.isArray(s.unclaims)) writeUnclaims(s.unclaims);
  if (s.targets) localStorage.setItem(LS_TARGET, JSON.stringify(s.targets));
  if (s.notes)   localStorage.setItem('bonusNotes.v1', JSON.stringify(s.notes));
  // simpan timestamp cloud yg dipakai
  localStorage.setItem(LS_UPDATED, String(Number(s.updatedAt || Date.now())));
}

async function syncUp(){
  const u = auth.currentUser;
  if (!u) return;
  const userKey = getUsername(u);
  const payload = __readLocalState();
  if (!payload.updatedAt){ bumpUpdated(); payload.updatedAt = getUpdatedAt(); }

  try{
    await db.ref(`users/${userKey}/state`).set(payload);
    console.log('[syncUp OK]', userKey, 'updatedAt=', payload.updatedAt);
  }catch(e){
    console.error('[syncUp FAIL]', e);
  }
}

// ⬇️ letak dekat util user/auth
const USER_DOMAIN = '@5g88.local';
const RTDB_FORBIDDEN = /[.#$/\[\]\/]/g;

function getUsername(u){
  const e = u?.email || '';
  let base;
  if (e.endsWith(USER_DOMAIN)) base = e.slice(0, -USER_DOMAIN.length);
  else base = 'user_' + (u?.uid || '').slice(-8);
  return base.replace(RTDB_FORBIDDEN, '_'); // penting untuk path RTDB
}


function __hasLocalData(){
  try{
    const a = readStore?.() || [];
    const b = readUnclaims?.() || [];
    const t = localStorage.getItem(LS_TARGET);
    const n = localStorage.getItem('bonusNotes.v1');
    return (a.length > 0) || (b.length > 0) || !!t || !!n;
  }catch{ return false; }
}

async function syncDown(){
  const u = auth.currentUser;
  if (!u) return;
  const userKey = getUsername(u);

  try{
    let snap = await db.ref(`users/${userKey}/state`).get();
    if (!snap || !snap.exists()){
      // Cloud kosong. JANGAN push kosong.
      // Biarkan saja; nanti setelah user menyimpan sesuatu, safeSyncUp() akan jalan.
      console.log('[syncDown] no cloud state yet; keeping local until first save');
      return;
    }

    const cloud  = snap.val();
    const local  = __readLocalState();
    const tCloud = Number(cloud?.updatedAt || 0);
    const tLocal = Number(local.updatedAt || 0);

    if (tCloud >= tLocal){
      __writeLocalState(cloud);
      console.log('[syncDown → LOCAL from CLOUD]', {tCloud, tLocal});
    } else {
      // Hanya kalau benar-benar ada data lokal yang lebih baru
      if (__hasLocalData()){
        await db.ref(`users/${userKey}/state`).set(local);
        console.log('[syncDown → CLOUD from LOCAL]', {tCloud, tLocal});
      } else {
        // Local kosong tapi timestamp kebetulan lebih besar — abaikan, pakai cloud
        __writeLocalState(cloud);
        console.log('[syncDown → force CLOUD]', {tCloud, tLocal});
      }
    }
  }catch(e){
    console.error('[syncDown FAIL]', e);
  }
}
// ==== AUTH STATE ====
auth.onAuthStateChanged(async (user) => {
  if (!user) { location.replace(LOGIN_URL); return; }

  try {
    setUserUI(getUsername(user));
    await syncDown();                 // tarik state dari Cloud dulu
  } catch (e) {
    console.error('syncDown error', e);
  } finally {
    BOOTING = false;                  // LEPAS guard boot supaya safeSyncUp boleh jalan
  }

  // (opsional tapi disarankan) pastikan Notes ada, lalu dorong ke Cloud
  if (typeof ensureNotes === 'function') ensureNotes();
  if (typeof safeSyncUp  === 'function') safeSyncUp();

  document.documentElement.classList.remove('auth-wait');
  if (typeof render === 'function') render();
});
// ==== LOGOUT ====
window.doLogout = async ()=>{
  await auth.signOut();
  location.href = LOGIN_URL;
};

// ==== AUTO SYNC SAAT TUTUP TAB ====
let __syncTimer = null;
function safeSyncUp() {
  if (!auth.currentUser || BOOTING) return; // ⬅️ tahan saat boot
  clearTimeout(__syncTimer);
  __syncTimer = setTimeout(syncUp, 300);
}
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') safeSyncUp();
});
window.addEventListener('beforeunload', () => { safeSyncUp(); });
  const $ = s => document.querySelector(s);
  const fmtNum = n => (Number.isFinite(n)?n:parseFloat(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtInt = n => (parseInt(n||0,10)).toLocaleString();
  const fmtNumNoGroup = (n) => {const v = Number.isFinite(n) ? n : parseFloat(n || 0);if (!Number.isFinite(v)) return '0';const isWhole = Math.abs(v - Math.round(v)) < 1e-10;return v.toLocaleString(undefined, {useGrouping: false,minimumFractionDigits: isWhole ? 0 : 2,maximumFractionDigits: isWhole ? 0 : 2,});};
  const fmtIntNoGroup = (n) =>(parseInt(n || 0, 10)).toLocaleString(undefined, { useGrouping: false });
  const pad2 = n => String(n).padStart(2,'0');
  const toYYYYMM = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const parseLocalDT = v => v? new Date(v.replace('T',' ')) : new Date();
  const dt24 = d =>new Date(d).toLocaleString(undefined, {year: 'numeric',month: '2-digit',day: '2-digit',hour: '2-digit',minute: '2-digit',second: '2-digit',hour12: false,hourCycle: 'h23',});
  const safe = v => Number.isFinite(+v) ? +v : 0;
  const two = n => String(n).padStart(2,'0');
  const fmtDMYHMS = d => {
  const x = new Date(d);return `${two(x.getDate())}/${two(x.getMonth()+1)}/${x.getFullYear()} ` +`${two(x.getHours())}:${two(x.getMinutes())}:${two(x.getSeconds())}`;};
  const fmtDMY = d => {const x = new Date(d);return `${two(x.getDate())}/${two(x.getMonth()+1)}/${x.getFullYear()}`;};
  const RANGE_SEP = ' \u2192 ';
  const LS_KEY='bonusRecords.v1';
  const LS_LAST_MONTH='bonusRecords.lastOpenedMonth';
  const LS_LAST_SITE = 'bonusRecords.lastSite';
  const LS_TARGET='bonusTargets.v3';
  const LS_UNCLAIM='bonusUnclaims.v1';   // NEW

  const readStore=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]}};
  const writeStore=a=>localStorage.setItem(LS_KEY,JSON.stringify(a));

  const readUnclaims=()=>{try{return JSON.parse(localStorage.getItem(LS_UNCLAIM))||[]}catch{return[]}};
  const writeUnclaims=a=>localStorage.setItem(LS_UNCLAIM,JSON.stringify(a));
  const LS_DR_FROM = 'bonusRecords.rangeFrom';
const LS_DR_TO   = 'bonusRecords.rangeTo';
const toISODateLocal = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

const LS_UPDATED = 'bonusState.updatedAt';
const getUpdatedAt = () => Number(localStorage.getItem(LS_UPDATED) || 0);
const bumpUpdated = () => {
  if (BOOTING) return;                // tahan saat boot
  localStorage.setItem(LS_UPDATED, String(Date.now()));
};
function monthStartEnd(yyyyMM){
  const [y,m] = yyyyMM.split('-').map(Number);
  const start = new Date(y, m-1, 1);
  const end   = new Date(y, m, 0); // hari terakhir bulan
  return {start, end};
}
function jumpPickerToMonth(yyyyMM){
  if (!fpRange) return;
  const [y,m] = yyyyMM.split('-').map(Number);
  fpRange.jumpToDate(new Date(y, m-1, 1));
}
const WEEK_START = 1; 

function setRangeAndRefresh(fs, ts, updatePicker = true){
  // simpan hidden + LS
  $('#rangeFrom').value = fs;
  $('#rangeTo').value   = ts;
  localStorage.setItem(LS_DR_FROM, fs);
  localStorage.setItem(LS_DR_TO,   ts);

  // sinkron ke flatpickr (biar tidak overwrite tampilan kita)
  if (fpRange && updatePicker) {
    fpRange.setDate([fs, ts], false);   // jangan trigger render di sini
  }

  // update tampilan input (SELALU setelah setDate)
  const vis = $('#rangeVis');
  const s = `${fs} \u2192 ${ts}`;
  vis.value = s;
  vis.dataset.last = s;
  vis.dataset.lastFrom = fs;
  vis.dataset.lastTo   = ts;

  // sinkron dropdown bulan + mini label
  syncMonthToRange(fs, ts);
  setMiniMonthLabel();
  setActiveQuick(keyForRange(fs, ts));
  render();
}

function iso(d){ // YYYY-MM-DD lokal
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function startOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function endOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);
}
function weekRangeOf(date, startDow = WEEK_START){
  const d = new Date(date);
  d.setHours(0,0,0,0);
  const dow = d.getDay();                       // 0..6
  const offset = ((dow - startDow) + 7) % 7;    // jarak dari awal minggu
  const start = new Date(d);
  start.setDate(d.getDate() - offset);          // hari pertama minggu
  const end = new Date(start);
  end.setDate(start.getDate() + 6);             // hari terakhir minggu
  return { start, end };
}
function monthRangeOf(date){
  const y = date.getFullYear(), m = date.getMonth();
  const start = new Date(y, m, 1);
  const end   = new Date(y, m+1, 0);
  return { start, end };
}
function forceCurrentMonth(){
  const cur = toYYYYMM(new Date());   // contoh: "2025-09"
  const { start, end } = monthStartEnd(cur);
  const today = new Date();
  const fs = toISODateLocal(start);
  const ts = toISODateLocal(new Date(Math.min(+today, +end)));

  // Header month
  $('#monthFilter').value = cur;
  localStorage.setItem(LS_LAST_MONTH, cur);

  // Sinkronkan range + tampilan input
  $('#rangeFrom').value = fs;
  $('#rangeTo').value   = ts;
  localStorage.setItem(LS_DR_FROM, fs);
  localStorage.setItem(LS_DR_TO,   ts);

  const s = `${fs} → ${ts}`;
  const vis = $('#rangeVis');
  if (vis){
    vis.value = s;
    vis.dataset.last = s;
  }

  if (fpRange) fpRange.setDate([fs, ts], false); // jangan trigger render di sini
}
function setActiveQuick(key){
  document.querySelectorAll('#quickMenu [data-q]').forEach(b=>{
    const on = (b.dataset.q === key);
    b.classList.toggle('active', on);
    b.setAttribute('aria-pressed', on);
  });
}
function keyForRange(fs, ts){
  const now = new Date();
  const iso0 = d => iso(startOfDay(d));

  if (fs === iso0(now) && ts === iso0(now)) return 'today';

  const y = new Date(now); y.setDate(y.getDate()-1);
  if (fs === iso0(y) && ts === iso0(y)) return 'yesterday';

  { // this week
    const { start, end } = weekRangeOf(now, WEEK_START);
    const fullStart  = iso(start);
    const fullEnd    = iso(end);
    const clampedEnd = iso(new Date(Math.min(+end, +now)));

    // anggap thisweek kalau full 7 hari ATAU versi clamp
    if (fs === fullStart && (ts === fullEnd || ts === clampedEnd)) {
      return 'thisweek';
    }
  }

  { // last week
    const { start } = weekRangeOf(now, WEEK_START);
    const lastStart = new Date(start); lastStart.setDate(start.getDate()-7);
    const lastEnd   = new Date(lastStart); lastEnd.setDate(lastStart.getDate()+6);
    if (fs === iso(lastStart) && ts === iso(lastEnd)) return 'lastweek';
  }

  { // this month
    const { start, end } = monthRangeOf(now);
    const fullStart  = iso(start);
    const fullEnd    = iso(end);
    const clampedEnd = iso(new Date(Math.min(+end, +now)));

    // anggap thismonth jika full bulan ATAU versi clamp
    if ((fs === fullStart && ts === fullEnd) ||
        (fs === fullStart && ts === clampedEnd)) {
      return 'thismonth';
    }
  }

  { // last month
    const lmStart = new Date(now.getFullYear(), now.getMonth()-1, 1);
    const lmEnd   = new Date(now.getFullYear(), now.getMonth(), 0);
    if (fs === iso(lmStart) && ts === iso(lmEnd)) return 'lastmonth';
  }

  return null;
}
function applyQuickRange(kind){
  const now = new Date();
  let f, t;

  switch(kind){
    case 'today': {
      const s = startOfDay(now);
      f = iso(s); t = iso(s); break;
    }
    case 'yesterday': {
      const y = startOfDay(now); y.setDate(y.getDate()-1);
      f = iso(y); t = iso(y); break;
    }
   case 'thisweek': {
  const { start, end } = weekRangeOf(now, WEEK_START);
  // FULL 7 hari (Sen–Min kalau WEEK_START = 1)
  f = iso(start);
  t = iso(end);
  break;
}
    case 'lastweek': {
      const { start } = weekRangeOf(now, WEEK_START);
      const lastStart = new Date(start); lastStart.setDate(start.getDate()-7);
      const lastEnd   = new Date(lastStart); lastEnd.setDate(lastStart.getDate()+6);
      f = iso(lastStart); t = iso(lastEnd); break;
    }
    case 'thismonth': {
      const { start, end } = monthRangeOf(now);
      f = iso(start);
      t = iso(end);
      break;
    }
    case 'lastmonth': {
      const y = now.getFullYear(), m = now.getMonth();
      const start = new Date(y, m-1, 1);
      const end   = new Date(y, m, 0);
      f = iso(start); t = iso(end); break;
    }
    default: return;
  }

  setRangeAndRefresh(f, t, true); // update range + render
}

function initQuickMenu(){
  const quickBtn  = document.getElementById('quickBtn');
  const quickMenu = document.getElementById('quickMenu');
  if (!quickBtn || !quickMenu) return;

  // hitung & pasang posisi menu (fixed) relatif ke tombol
  let reposer = null;
  const positionMenu = () => {
    const r = quickBtn.getBoundingClientRect();
    const approxH = Math.min(260, quickMenu.scrollHeight || 260);
    const spaceBelow = window.innerHeight - r.bottom;
    const openUp = spaceBelow < approxH;

    quickMenu.style.position = 'fixed';
    quickMenu.style.left = (r.left + r.width/2) + 'px';
    quickMenu.style.transform = 'translateX(-50%)';

    if (!openUp) {
      quickMenu.style.top = (r.bottom + 6) + 'px';
      quickMenu.style.bottom = '';
      quickMenu.classList.remove('up');
    } else {
      quickMenu.style.top = '';
      quickMenu.style.bottom = (window.innerHeight - r.top + 6) + 'px';
      quickMenu.classList.add('up');
    }
  };

  const clearInline = () => {
    quickMenu.style.position = '';
    quickMenu.style.left = '';
    quickMenu.style.top = '';
    quickMenu.style.bottom = '';
    quickMenu.style.transform = '';
  };

  const toggleQuickMenu = (show)=>{
    const willShow = (typeof show === 'boolean') ? show : !quickMenu.classList.contains('show');

    if (willShow) {
      positionMenu();
      quickMenu.classList.add('show');
      quickBtn.setAttribute('aria-expanded', 'true');
      quickMenu.setAttribute('aria-hidden',  'false');

      reposer = () => positionMenu();
      window.addEventListener('resize', reposer);
      window.addEventListener('scroll', reposer, true); // termasuk scroll parent
    } else {
      if (quickMenu.contains(document.activeElement)) quickBtn.focus();
      quickMenu.setAttribute('aria-hidden','true');
      quickMenu.classList.remove('show');
      quickBtn.setAttribute('aria-expanded', 'false');

      window.removeEventListener('resize', reposer);
      window.removeEventListener('scroll', reposer, true);
      clearInline();
    }
  };

  quickBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleQuickMenu(); });
  quickMenu.addEventListener('click', (e)=> e.stopPropagation());
  quickMenu.querySelectorAll('[data-q]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      toggleQuickMenu(false);
      applyQuickRange(btn.dataset.q);
    });
  });
  document.addEventListener('click', ()=> quickMenu.classList.contains('show') && toggleQuickMenu(false));
  document.addEventListener('keydown', (e)=> e.key === 'Escape' && toggleQuickMenu(false));

  setActiveQuick(
    keyForRange(
      document.getElementById('rangeFrom').value,
      document.getElementById('rangeTo').value
    )
  );
}
function setMiniMonthLabel(){
  const m = $('#monthFilter').value;
  const { start, end } = monthStartEnd(m);
  const f = $('#rangeFrom').value;
  const t = $('#rangeTo').value;

  const fullStart = toISODateLocal(start);
  const fullEnd   = toISODateLocal(end);

  const label = (f === fullStart && t === fullEnd)
    ? prettyMonth(m)            // full bulan → nama bulan
    : prettyRange(f, t);        // selain itu → rentang tanggal

  $('#miniMonth').textContent = label;
}
// — NEW: pastikan container & hidden inputs sentiasa ada —
function ensureRangeWrapAndInputs(){
  let wrap = document.querySelector('#rangeWrap');
  if (!wrap){
    wrap = document.createElement('div');
    wrap.id = 'rangeWrap';
    wrap.className = 'range-wrap';

    // letak dalam .toolbar, tepat di kiri .spacer (kanan mini-cards)
    const toolbar = document.querySelector('.toolbar');
    const before  = toolbar?.querySelector('.spacer') || null;
    (toolbar || document.body).insertBefore(wrap, before);
  }

  // hidden inputs untuk filter sebenar
  if (!document.querySelector('#rangeFrom')){
    const rf = document.createElement('input');
    rf.type = 'hidden'; rf.id = 'rangeFrom';
    wrap.appendChild(rf);
  }
  if (!document.querySelector('#rangeTo')){
    const rt = document.createElement('input');
    rt.type = 'hidden'; rt.id = 'rangeTo';
    wrap.appendChild(rt);
  }
  return wrap;
}
function monthOf(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }

function syncMonthToRange(fs, ts){
  const newMonth = monthOf(new Date(fs));
  const sel = document.querySelector('#monthFilter');
  if (!sel) return;

  // Pastikan option untuk newMonth ada
  if (![...sel.options].some(o => o.value === newMonth)){
    const opt = document.createElement('option');
    opt.value = newMonth;
    opt.textContent = prettyMonth(newMonth);

    // Masukkan sambil jaga urutan desc (2025-10, 2025-09, dst)
    const ops = [...sel.options, opt].sort((a,b) => b.value.localeCompare(a.value));
    sel.innerHTML = '';
    ops.forEach(o => sel.appendChild(o));
  }

  if (sel.value !== newMonth){
    sel.value = newMonth;
    localStorage.setItem(LS_LAST_MONTH, newMonth);
  }
}
let fpRange = null;

function initDateRangePicker(){
  const month = $('#monthFilter').value;
  const {start, end} = monthStartEnd(month);

  const today   = new Date();
  const defFrom = toISODateLocal(start);
  const defTo   = toISODateLocal(new Date(Math.min(+today, +end)));

  const savedFrom = localStorage.getItem(LS_DR_FROM) || defFrom;
  const savedTo   = localStorage.getItem(LS_DR_TO)   || defTo;

  // set nilai awal
  const vis = $('#rangeVis');
  vis.removeAttribute('placeholder');           // jangan pakai placeholder
  const initial = `${savedFrom} → ${savedTo}`;
  vis.value = initial;
  vis.dataset.last = initial;                   // simpan “nilai terakhir”

  $('#rangeFrom').value = savedFrom;
  $('#rangeTo').value   = savedTo;

  if (fpRange) fpRange.destroy();

 fpRange = flatpickr('#rangeVis', {
  mode: 'range',
  dateFormat: 'Y-m-d',
  showMonths: 2,
  defaultDate: [savedFrom, savedTo],
  locale: { rangeSeparator: ' → ' },
  clickOpens: true,
  allowInput: false,

  // simpan kondisi terakhir saat dibuka
  onOpen(_, __, inst) {
    const f = $('#rangeFrom').value || savedFrom;
    const t = $('#rangeTo').value   || savedTo;
    vis.dataset.lastFrom = f;
    vis.dataset.lastTo   = t;
    vis.dataset.last     = `${f} → ${t}`;
  },

  // update ketika 2 tanggal terpilih
onChange(selectedDates, dateStr, inst){
  if (selectedDates.length === 2){
    const fs = toISODateLocal(selectedDates[0]);
    const ts = toISODateLocal(selectedDates[1]);

    $('#rangeFrom').value = fs;
    $('#rangeTo').value   = ts;
    localStorage.setItem(LS_DR_FROM, fs);
    localStorage.setItem(LS_DR_TO,   ts);

    const s = `${fs} → ${ts}`;
    vis.value        = s;
    vis.dataset.last = s;
    vis.dataset.lastFrom = fs;
    vis.dataset.lastTo   = ts;

    // ⬇️ penting: buat header month & mini-card ikut pindah
    syncMonthToRange(fs, ts);
    setMiniMonthLabel();
    setActiveQuick(keyForRange(fs, ts));
    render();
  }
},

onClose(selectedDates, dateStr, inst){
  if (selectedDates.length < 2){
    const lf = vis.dataset.lastFrom || $('#rangeFrom').value || savedFrom;
    const lt = vis.dataset.lastTo   || $('#rangeTo').value   || savedTo;
    inst.setDate([lf, lt], false);
    vis.value = `${lf} → ${lt}`;
  }
  const curF = $('#rangeFrom').value || savedFrom;
  const curT = $('#rangeTo').value   || savedTo;
  setActiveQuick(keyForRange(curF, curT));
  render();
}
});
}
function clampRangeToMonthWithPicker(){
  const {start, end} = monthStartEnd($('#monthFilter').value);

  let f = new Date($('#rangeFrom').value || start);
  let t = new Date($('#rangeTo').value   || end);

  if (f < start) f = start;
  if (f > end)   f = end;
  if (t < start) t = start;
  if (t > end)   t = end;
  if (f > t) [f, t] = [t, f];

  const fs = toISODateLocal(f), ts = toISODateLocal(t);
  $('#rangeFrom').value = fs;
  $('#rangeTo').value   = ts;
  localStorage.setItem(LS_DR_FROM, fs);
  localStorage.setItem(LS_DR_TO,   ts);

  if (fpRange) fpRange.setDate([fs, ts], true);

const vis = $('#rangeVis');
vis.value = `${fs} → ${ts}`;
vis.dataset.last = vis.value;   // sudah ada
vis.dataset.lastFrom = fs;      // ⬅️ tambah
vis.dataset.lastTo   = ts;      // ⬅️ tambah
syncMonthToRange(fs, ts);
setMiniMonthLabel();
setActiveQuick(keyForRange(fs, ts));
}
// Fallback bila flatpickr tak ada
function basicRangeChanged(){
  const {start, end} = monthStartEnd($('#monthFilter').value);

  let f = $('#rangeFrom').value ? new Date($('#rangeFrom').value) : start;
  let t = $('#rangeTo').value   ? new Date($('#rangeTo').value)   : end;

  if (f < start) f = start;
  if (f > end)   f = end;
  if (t < start) t = start;
  if (t > end)   t = end;
  if (f > t) [f, t] = [t, f];

  const fs = toISODateLocal(f), ts = toISODateLocal(t);
  $('#rangeFrom').value = fs;
  $('#rangeTo').value   = ts;
  localStorage.setItem(LS_DR_FROM, fs);
  localStorage.setItem(LS_DR_TO,   ts);

const vis = $('#rangeVis');
vis.value = `${fs} → ${ts}`;
vis.dataset.last = vis.value;
vis.dataset.lastFrom = fs;
vis.dataset.lastTo   = ts;
syncMonthToRange(fs, ts);   // ⬅️ tambah
setMiniMonthLabel();
setActiveQuick(keyForRange(fs, ts));
}
function resetToCurrentOnLoad(){
  const now = new Date();
  const curMonth = toYYYYMM(now);                 // "YYYY-MM"
  const { start, end } = monthStartEnd(curMonth); // 1..akhir bulan
  const fs = toISODateLocal(start);               // 01-<bulan>
  const ts = toISODateLocal(new Date(Math.min(+now, +end))); // 01..hari-ini

  // 1) Paksa header Month ke bulan sekarang
  const monthSel = document.querySelector('#monthFilter');
  if (monthSel) monthSel.value = curMonth;
  localStorage.setItem(LS_LAST_MONTH, curMonth);

  // 2) Simpan & sinkronkan range
  localStorage.setItem(LS_DR_FROM, fs);
  localStorage.setItem(LS_DR_TO,   ts);

  const fromEl = document.querySelector('#rangeFrom');
  const toEl   = document.querySelector('#rangeTo');
  if (fromEl) fromEl.value = fs;
  if (toEl)   toEl.value   = ts;

  // 3) Perbarui tampilan input teks
  const vis = document.querySelector('#rangeVis');
  if (vis){
    const s = `${fs} \u2192 ${ts}`;
    vis.removeAttribute('placeholder');
    vis.value = s;
    vis.dataset.last = s;
  }
}
// Paksa range ke 1..akhir bulan yang dipilih + sync ke UI & LS
function setMonthAndRange(yyyyMM){
  const { start, end } = monthStartEnd(yyyyMM);
  const today = new Date();
  const endClamped = new Date(Math.min(+end, +today)); // ⬅️ clamp ke hari ini utk bulan berjalan

  const fs = toISODateLocal(start);
  const ts = toISODateLocal(endClamped);

  $('#rangeFrom').value = fs;
  $('#rangeTo').value   = ts;
  localStorage.setItem(LS_DR_FROM, fs);
  localStorage.setItem(LS_DR_TO,   ts);

  const vis = $('#rangeVis');
  if (vis) vis.value = `${fs} → ${ts}`;

  if (window.fpRange){
    fpRange.setDate([fs, ts], true);   // trigger onChange -> render + setActiveQuick
  } else {
    // kalau mau aman tanpa flatpickr
    setActiveQuick(keyForRange(fs, ts));
    render();
  }
}
function readTarget(){
  try {
    const t = JSON.parse(localStorage.getItem(LS_TARGET));
    if (t && Array.isArray(t.depositTiers) && Array.isArray(t.resitTiers) && Array.isArray(t.salesTiers)) {
      return t;
    }
  } catch {}

  // migrasi v2 -> v3 (tanpa bump/sync)
  try {
    const old = JSON.parse(localStorage.getItem('bonusTargets.v2'));
    if (old) {
      const upgraded = {
        depositTiers: old.depositTiers || [{threshold:8000, bonus:20}],
        resitTiers:   old.resitTiers   || [{threshold:250,  bonus:30}],
        salesTiers:   old.salesTiers   || [{threshold:30000, bonus:300}],
      };
      localStorage.setItem(LS_TARGET, JSON.stringify(upgraded));
      return upgraded;
    }
  } catch {}

  // default sekali (tanpa bump/sync)
  const def = {
    depositTiers:[{threshold:8000, bonus:20},{threshold:10000, bonus:25}],
    resitTiers:[{threshold:250, bonus:30},{threshold:500, bonus:60}],
    salesTiers:[{threshold:30000, bonus:300}]
  };
  localStorage.setItem(LS_TARGET, JSON.stringify(def));
  return def;
}
  const writeTarget=t=>localStorage.setItem(LS_TARGET, JSON.stringify(t));
  const pickTierBonus=(v,tiers)=>Array.isArray(tiers)?tiers.reduce((m,t)=>v>=+t.threshold?Math.max(m,+t.bonus||0):m,0):0;

  let editingId = null;
  let ucActiveTab = 'pending';
  window.NumberClipper = window.NumberClipper || { clip(){}, apply(){} };
  window.addEventListener('DOMContentLoaded', () => {
  ensureRangeWrapAndInputs();
  buildMonthOptions();          // bangun opsi bulan dari data
  resetToCurrentOnLoad();       // ⬅️ paksa kembali ke bulan & range sekarang
  initDateRangePicker();        // flatpickr akan pakai nilai dari LS
  const savedSite = localStorage.getItem(LS_LAST_SITE);
  $('#siteFilter').value = (savedSite === '5G88' || savedSite === 'SPM888' || savedSite === 'ALL') ? savedSite : 'ALL';

  render();
  // listeners
  $('#createBtn').addEventListener('click', () => openModal());
  $('#exportBtn').addEventListener('click',  exportCSV);
  $('#siteFilter').addEventListener('change', () => {
    localStorage.setItem(LS_LAST_SITE, $('#siteFilter').value);
    render();
  });

  $('#monthFilter').addEventListener('change', () => {
    const m = $('#monthFilter').value;
    localStorage.setItem(LS_LAST_MONTH, m);
    jumpPickerToMonth(m);
    setMonthAndRange(m);  // set 1..akhir bulan + render()
    setMiniMonthLabel();  // label "Month" di mini-card
  });

  $('#targetBtn').addEventListener('click', openTargetModal);
  $('#unclaimBtn').addEventListener('click', openUnclaimModal);
  $('#tabPending').addEventListener('click', () => switchUcTab('pending'));
  $('#tabHistory').addEventListener('click', () => switchUcTab('history'));
  initQuickMenu();
});

  function buildMonthOptions(){
    const sel=$('#monthFilter'); sel.innerHTML='';
    const months=new Set(readStore().map(r=>r.month)); months.add(toYYYYMM(new Date()));
    [...months].sort().reverse().forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=prettyMonth(m);sel.appendChild(o);});
    const last=localStorage.getItem(LS_LAST_MONTH);
    sel.value=(last && months.has(last))? last : toYYYYMM(new Date());
  }
  function autoSwitchToCurrentMonth(){
    const cur=toYYYYMM(new Date()); const last=localStorage.getItem(LS_LAST_MONTH);
    if(last!==cur){ $('#monthFilter').value=cur; localStorage.setItem(LS_LAST_MONTH,cur); }
  }
  const prettyMonth=yyyyMM=>{const [y,m]=yyyyMM.split('-').map(Number);return new Date(y,m-1,1).toLocaleDateString(undefined,{month:'long',year:'numeric'})};

// ===== D. Create/Edit Modal (id="modal") =====
function openModal(rec = null) {
  editingId = rec?.id ?? null;
  $('#modalTitle').textContent = editingId ? 'Edit Record' : 'Create Record';

  if (editingId) {
    $('#m_site').value = rec.site;
  } else {
    $('#m_site').value = ''; // kosongkan untuk create
  }

  const dt = rec ? new Date(rec.datetime) : new Date();
  $('#m_dt').value = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}` +
                     `T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;

  $('#m_deposit').value    = rec?.deposit ?? '';
  $('#m_withdrawal').value = rec?.withdrawal ?? '';
  $('#m_bonus').value      = rec?.bonus ?? '';
  $('#m_forfeit').value    = rec?.forfeit ?? '';
  $('#m_member').value     = rec?.member ?? '';
  $('#m_resit').value      = rec?.resit ?? '';
  $('#m_unclaim').value    = '';

  const autoCalc = () => {
    $('#m_sales').value = (
      parseFloat($('#m_deposit').value || 0) -
      parseFloat($('#m_withdrawal').value || 0)
    ).toFixed(2);
  };
  $('#m_deposit').oninput = autoCalc;
  $('#m_withdrawal').oninput = autoCalc;
  autoCalc();
  lockFormBySite();                      
  $('#m_site').onchange = lockFormBySite;
  openModalA11y('#modal', false);       
  $('#saveBtn').onclick = saveModal;
}
const closeModal = () => closeModalA11y('#modal', '#createBtn');

function lockFormBySite() {
  const hasSite = !!$('#m_site').value;
  // Ambil semua kontrol dalam modal KECUALI #m_site
  const ctrls = Array.from(document.querySelectorAll('#modal .dialog input, #modal .dialog select, #modal .dialog textarea'))
    .filter(el => el.id !== 'm_site');

  ctrls.forEach(el => {
    // sales readonly tetap readonly; hanya ubah disabled
    if (el.id !== 'm_sales') el.disabled = !hasSite;
    else el.disabled = !hasSite; // biar konsisten (dia memang readonly)
  });

  // tombol Save juga ikut
  $('#saveBtn').disabled = !hasSite;
}

  function collectModal(){
    const dt=parseLocalDT($('#m_dt').value);
    return{
      id: editingId ?? ('id_'+Date.now()+Math.random().toString(36).slice(2,7)),
      site: $('#m_site').value,
      datetime: dt.toISOString(), month: toYYYYMM(dt),
      deposit:+($('#m_deposit').value||0), withdrawal:+($('#m_withdrawal').value||0),
      bonus:+($('#m_bonus').value||0), forfeit:+($('#m_forfeit').value||0),
      member:parseInt($('#m_member').value||0,10), resit:+($('#m_resit').value||0),
      sales:+($('#m_sales').value||0),
      // NOTE: unclaim disimpan terpisah di LS_UNCLAIM
    };
  }

  function saveModal(){
    if (!$('#m_site').value) return;
    const rec=collectModal();
    const arr=readStore(); const i=arr.findIndex(x=>x.id===rec.id);
    if(i>=0) arr[i]=rec; else arr.push(rec);
    writeStore(arr);
    toast(editingId ? 'Record updated' : 'Record created', 'success');

    // NEW: jika user isi Unclaim Amount -> simpan pending item
    const ucAmt = safe($('#m_unclaim').value);
    if (ucAmt > 0) {
      const uc = readUnclaims();
      uc.push({
        id: 'uc_'+Date.now()+Math.random().toString(36).slice(2,6),
        recordId: rec.id,
        site: rec.site,
        month: rec.month,
        createdAt: new Date().toISOString(),
        amount: ucAmt,
        claimed: false,
        claimedAt: null
      });
      writeUnclaims(uc);
    }

    buildMonthOptions();
    if(rec.month===toYYYYMM(new Date())){ $('#monthFilter').value=rec.month; localStorage.setItem(LS_LAST_MONTH,rec.month); }
    closeModal(); render();
    bumpUpdated(); 
    safeSyncUp();
  }
// ===== A. Helper inert background + toggle modal =====
function setBackgroundInert(enable, exceptTarget){
  const except = (exceptTarget instanceof Element)
    ? exceptTarget
    : document.querySelector(exceptTarget);

  document.querySelectorAll('body > *').forEach(el => {
    // jangan matikan toast & confirm, dan tentu saja modal yang dibuka
    if (el === except || el.id === 'toastHost' || el.id === 'confirmModal') return;
    if (enable) el.classList.add('bg-inert');
    else        el.classList.remove('bg-inert');
  });
}

function openModalA11y(modalSel, focusSel) {
  const m = document.querySelector(modalSel);
  if (!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
  setBackgroundInert(true, m);

  // hanya auto-focus kalau focusSel bukan false
  if (focusSel !== false) {
    const first = m.querySelector(
      (typeof focusSel === 'string' && focusSel)
        ? focusSel
        : 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );
    first?.focus();
  }
}
// ===== Note Name Modal (Create/Rename) =====
let noteNameMode = 'create';     // 'create' | 'rename'
let noteNameReturnFocus = '#addNoteBtn';

function openNoteNameModal(mode='create', defaultName='New Note', returnFocus='#addNoteBtn'){
  noteNameMode = mode;
  noteNameReturnFocus = returnFocus;

  const title = (mode === 'rename') ? 'Rename Note' : 'New Note';
  const okTxt = (mode === 'rename') ? 'Rename' : 'Create';

  document.getElementById('noteNameTitle').textContent = title;
  document.getElementById('noteNameOk').textContent = okTxt;

  const inp = document.getElementById('noteNameInput');
  inp.value = defaultName || '';
  openModalA11y('#noteNameModal', '#noteNameInput');
  inp.select();

  // wiring tombol
  document.getElementById('noteNameCancel').onclick = closeNoteNameModal;
  document.getElementById('noteNameOk').onclick = submitNoteNameModal;
  inp.onkeydown = (e)=>{ if (e.key === 'Enter') submitNoteNameModal(); };
}
function closeNoteNameModal(){
  closeModalA11y('#noteNameModal', noteNameReturnFocus);
}
function submitNoteNameModal(){
  const val = (document.getElementById('noteNameInput').value || '').trim();
  if (!val){ toast('Name cannot be empty','error'); return; }

  if (noteNameMode === 'create'){
    // buat note baru
    notesState.notes.push({
      id: 'n_' + Date.now() + Math.random().toString(36).slice(2,6),
      name: val,
      hdr: DEF_HDR.slice(),
      rows: []
    });
    writeNotesPersist(notesState.notes);
    notesState.idx = notesState.notes.length - 1;

    // perbarui dropdown & table tanpa menutup modal Notes
    const sel = document.getElementById('noteSelect');
    const opt = document.createElement('option');
    opt.value = String(notesState.idx);
    opt.textContent = val;
    sel.appendChild(opt);
    sel.value = String(notesState.idx);
    renderNotesTable();
    applyHdr();
    toast('Note added','success');

  } else { // rename
    const note = notesState.notes[notesState.idx];
    if (note){
      note.name = val;
      writeNotesPersist(notesState.notes);
      const sel = document.getElementById('noteSelect');
      if (sel && sel.selectedIndex >= 0) sel.options[sel.selectedIndex].textContent = val;
      toast('Renamed','info');
    }
  }
  closeNoteNameModal();
}
function closeModalA11y(modalSel, returnFocusSel) {
  const m = document.querySelector(modalSel);
  if (!m) return;

  // 1) Jika fokus masih di dalam modal → blur dulu supaya tidak "aria-hidden with focused descendant"
  const act = document.activeElement;
  if (act && m.contains(act)) {
    try { act.blur(); } catch {}
  }

  // 2) Tutup visual
  m.classList.remove('show');

  // 3) Tandakan aria-hidden selepas fokus dialihkan
  m.setAttribute('aria-hidden', 'true');

  // 4) Pulihkan interaksi pada latar
  setBackgroundInert(false, m);

  // 5) Pulangkan fokus ke pemanggil (fallback ke body jika tidak ada)
  const ret = returnFocusSel ? document.querySelector(returnFocusSel) : null;
  if (ret && typeof ret.focus === 'function') {
    ret.focus();
  } else {
    // fallback: pastikan ada elemen yang bisa fokus
    document.body.setAttribute('tabindex', '-1');
    document.body.focus();
    document.body.removeAttribute('tabindex');
  }
}
function openTargetModal(){
  const t = readTarget();
  renderTierEditor('#depTierList', t.depositTiers, 'Bonus Deposit');
  renderTierEditor('#resTierList', t.resitTiers, 'Bonus Resit');
  renderTierEditor('#salesTierList', t.salesTiers, 'Bonus Sales');
  $('#addDepTier').onclick = () => addTierRow('#depTierList');
  $('#addResTier').onclick = () => addTierRow('#resTierList');
  $('#addSalesTier').onclick = () => addTierRow('#salesTierList');
  $('#saveTargetBtn').onclick = saveTarget;
  openModalA11y('#targetModal', '#addDepTier');
}
function closeTargetModal(){
  closeModalA11y('#targetModal', '#targetBtn');
}

function renderTierEditor(sel, tiers, label){
  const box = $(sel); box.innerHTML = '';
  const head = document.createElement('div');
  head.className = 'tier-row';
  head.innerHTML = `
    <div class="hint" style="align-self:center">Threshold (≥)</div>
    <div class="hint" style="align-self:center">${label}</div>
    <div></div>
  `;
  box.appendChild(head);

  (tiers || []).forEach(t => addTierRow(sel, t.threshold, t.bonus));
}
function addTierRow(sel, threshold = '', bonus = ''){
  const box = $(sel);
  const row = document.createElement('div');
  row.className = 'tier-row';

  row.innerHTML = `
    <input type="number" min="0" step="0.01" class="input" placeholder="e.g. 30000" value="${threshold}" disabled>
    <input type="number" min="0" step="1"    class="input" placeholder="e.g. 300"    value="${bonus}"     disabled>
    <div style="display:flex; gap:6px; justify-content:flex-end">
      <button type="button" class="edit">Edit</button>
      <button type="button" class="rm">Remove</button>
    </div>
  `;

  const [th, bo] = row.querySelectorAll('input');
  const btnEdit  = row.querySelector('.edit');
  const btnRm    = row.querySelector('.rm');
  th.disabled = true; bo.disabled = true;
  btnEdit.textContent = 'Edit';
  btnEdit.classList.remove('active');
  btnEdit.onclick = () => {
    const willEnable = th.disabled;
    th.disabled = bo.disabled = !willEnable;

    if (willEnable){
      // masuk mode edit
      btnEdit.textContent = 'Save';
      btnEdit.classList.add('active');
      th.focus(); th.select?.();
    } else {
      // keluar mode edit (lock)
      btnEdit.textContent = 'Edit';
      btnEdit.classList.remove('active');
      toast('Row saved (locked). Click "Save" in Target modal to apply.', 'info', 1400);
    }
  };

  btnRm.onclick = async () => {
    if (await askConfirm('Remove this tier?', {okText:'Yes', cancelText:'No'})) {
      row.remove();
      toast('Tier removed (pending). Click "Save" to apply.', 'warn', 1600);
    }
  };

  box.appendChild(row);
}
function readRowsFromEditor(sel){
  const rows = [...document.querySelectorAll(sel+' .tier-row')].slice(1); // skip header
  const out = [];
  for(const r of rows){
    const [th, bo] = r.querySelectorAll('input');
    const thr = +th.value || 0;
    const bon = +bo.value || 0;
    if (thr > 0 && bon > 0) out.push({ threshold: thr, bonus: bon });
  }
  out.sort((a,b)=>a.threshold - b.threshold);
  return out;
}

// Simpan langsung ke localStorage (tanpa tutup modal)
function saveTiersLive(){
  const t = {
    depositTiers: readRowsFromEditor('#depTierList'),
    resitTiers:   readRowsFromEditor('#resTierList'),
    salesTiers:   readRowsFromEditor('#salesTierList'),
  };
  // fallback minimal agar tidak kosong total
  if(!t.depositTiers.length) t.depositTiers=[{threshold:8000,bonus:20}];
  if(!t.resitTiers.length)   t.resitTiers=[{threshold:250, bonus:30}];
  if(!t.salesTiers.length)   t.salesTiers=[{threshold:30000, bonus:300}];
  writeTarget(t);
  bumpUpdated();  
  safeSyncUp();
}
  function saveTarget(){
    const readRows=sel=>{
      const rows=[...document.querySelectorAll(sel+' .tier-row')].slice(1);
      const out=[]; for(const r of rows){ const [th,bo]=r.querySelectorAll('input'); const thr=+th.value||0; const bon=+bo.value||0; if(thr>0&&bon>0) out.push({threshold:thr,bonus:bon}); }
      out.sort((a,b)=>a.threshold-b.threshold); return out;
    };
    const t={depositTiers:readRows('#depTierList'), resitTiers:readRows('#resTierList'), salesTiers:readRows('#salesTierList')};
    if(!t.depositTiers.length) t.depositTiers=[{threshold:8000,bonus:20}];
    if(!t.resitTiers.length)   t.resitTiers=[{threshold:250, bonus:30}];
    if(!t.salesTiers.length)   t.salesTiers=[{threshold:30000, bonus:300}];
    writeTarget(t);
    toast('Target saved', 'success');
    closeTargetModal();
    render();
    bumpUpdated(); 
    safeSyncUp();
  }

function prettyRange(f, t){
  if (!f || !t) return '';
  const fd = new Date(f), td = new Date(t);
  const same = fd.getFullYear()===td.getFullYear() && fd.getMonth()===td.getMonth();
  const optD = { day:'2-digit' }, optMY = { month:'short', year:'numeric' };
  return same
    ? `${fd.toLocaleDateString(undefined,optD)}–${td.toLocaleDateString(undefined,{...optD,...optMY})}`
    : `${fd.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'})} → ${td.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'})}`;
}

function render(){
  const site   = $('#siteFilter').value;
  const month  = $('#monthFilter').value;          // hanya untuk jump & label
  const targets= readTarget();

  // batas waktu dari input (00:00:00 s/d 23:59:59)
  const fromStr = $('#rangeFrom')?.value;
  const toStr   = $('#rangeTo')?.value;
  const fromTS  = fromStr ? new Date(fromStr + 'T00:00:00').getTime() : -Infinity;
  const toTS    = toStr   ? new Date(toStr   + 'T23:59:59').getTime() :  Infinity;

  // ❗ Hapus filter r.month === month
  const data = readStore()
    .filter(r => site === 'ALL' ? true : r.site === site)
    .filter(r => {
      const ts = new Date(r.datetime).getTime();
      return ts >= fromTS && ts <= toTS;
    })
    .sort((a,b) => new Date(b.datetime) - new Date(a.datetime));

  // Map unclaim yang TERKAIT dengan record yang tampil
  const dataIds = new Set(data.map(r => r.id));
  const uc = readUnclaims();
  const ucByRecord = {};
  for (const u of uc) {
    if (!dataIds.has(u.recordId)) continue;
    if (!ucByRecord[u.recordId]) ucByRecord[u.recordId] = { pending:0, claimed:0 };
    if (u.claimed) ucByRecord[u.recordId].claimed += safe(u.amount);
    else           ucByRecord[u.recordId].pending += safe(u.amount);
  }

  // archive banner: sembunyikan ketika range lintas bulan
  $('#archiveBanner').style.display = 'none';
  $('#bannerMonth').textContent = prettyMonth(month);

  const tb = $('#tbody'); tb.innerHTML = '';
  let totals = { d:0,w:0,b:0,f:0,m:0,r:0,s:0, bd:0, br:0, bsBase:0, uDisp:0, uPending:0, uClaimed:0, uAll:0 };

  for (const r of data){
    const dt = fmtDMYHMS(r.datetime);

    const bonusDep       = pickTierBonus(safe(r.deposit), targets.depositTiers);
    const bonusRes       = pickTierBonus(safe(r.resit),   targets.resitTiers);
    const bonusSalesBase = pickTierBonus(safe(r.sales),   targets.salesTiers);

    const ucs = ucByRecord[r.id] || { pending:0, claimed:0 };
    const unclaimDisplay = safe(ucs.claimed) > 0 ? -safe(ucs.claimed) : safe(ucs.pending);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dt}</td>
      <td style="text-align:center"><span class="pill ${r.site==='5G88'?'site-5g88':'site-spm888'}">${r.site}</span></td>
      <td class="${r.deposit < 0 ? 'num red' : 'num green'}">${fmtNum(r.deposit)}</td>
      <td class="num ${r.withdrawal === 0 ? '' : 'red'}">
        ${ r.withdrawal === 0 ? fmtNum(0) : ('-' + fmtNum(Math.abs(r.withdrawal))) }
      </td>
      <td>${fmtNumNoGroup(r.resit)}</td>
      <td class="num cyan">${fmtNum(r.bonus)}</td>
      <td>${fmtNum(r.forfeit)}</td>
      <td>${fmtIntNoGroup(r.member)}</td>
      <td class="${r.sales < 0 ? 'num red' : 'num green'}">${fmtNum(r.sales)}</td>
      <td class="num ${unclaimDisplay<0?'red':''}">${fmtNum(unclaimDisplay)}</td>
      <td>${bonusDep.toLocaleString()}</td>
      <td>${bonusRes.toLocaleString()}</td>
      <td>
        <div class="actions">
          <button class="iconbtn" onclick="window.__edit('${r.id}')">Edit</button>
          <button class="iconbtn-del" onclick="window.__del('${r.id}')">Delete</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);

    totals.uPending += safe(ucs.pending);
    totals.uClaimed += safe(ucs.claimed);
    totals.uAll     += safe(ucs.pending) + safe(ucs.claimed);

    totals.d  += safe(r.deposit);
    totals.w  += safe(r.withdrawal);
    totals.b  += safe(r.bonus);
    totals.f  += safe(r.forfeit);
    totals.m  += safe(r.member);
    totals.r  += safe(r.resit);
    totals.s  += safe(r.sales);

    totals.bd += safe(bonusDep);
    totals.br += safe(bonusRes);
    totals.bsBase += safe(bonusSalesBase);
  }

  $('#emptyState').style.display = data.length ? 'none' : 'block';
  totals.uDisp = safe(totals.uPending);

  // footer
  $('#ft_deposit').textContent    = fmtNum(totals.d);
  const wdTotalAbs = Math.abs(totals.w);
  $('#ft_withdrawal').textContent = wdTotalAbs === 0 ? fmtNum(0) : `-${fmtNum(wdTotalAbs)}`;
  $('#ft_bonus').textContent      = fmtNum(totals.b);
  $('#ft_forfeit').textContent    = fmtNum(totals.f);
  $('#ft_member').textContent     = fmtIntNoGroup(totals.m);
  $('#ft_resit').textContent      = fmtNumNoGroup(totals.r);
  $('#ft_sales').textContent      = fmtNum(totals.s);
  $('#ft_unclaim').textContent    = fmtNum(totals.uDisp);
  $('#ft_bonDep').textContent     = totals.bd.toLocaleString();
  $('#ft_bonRes').textContent     = totals.br.toLocaleString();

  const ftW = $('#ft_withdrawal');
  ftW.className = ''; ftW.classList.add('num'); if (wdTotalAbs > 0) ftW.classList.add('red');
  const ftS = $('#ft_sales');
  ftS.className = ''; ftS.classList.add('num'); if (totals.s < 0) ftS.classList.add('red'); else if (totals.s > 0) ftS.classList.add('green');

  // mini-cards: tampilkan range
  setMiniMonthLabel();
  $('#miniSite').textContent  = (site === 'ALL' ? 'All Sites' : site);

  renderSummaryRows(totals, data.length, site, month);
  applyNumberTitles();
  window.NumberClipper?.clip('#dataTable tbody td:nth-child(n+3):nth-child(-n+12)');
  window.NumberClipper?.clip('#dataTable tfoot td:nth-child(n+3):nth-child(-n+12)');
  window.NumberClipper?.clip('.card .val');
  applyTableScrollLimit();
}
function applyTableScrollLimit() {
  const scroller = document.querySelector('.table-scroller');
  const head  = document.querySelector('#dataTable thead');
  const rows  = document.querySelectorAll('#dataTable tbody tr');
  const foot  = document.querySelector('#dataTable tfoot');

  if (!scroller || !head) return;

  // ≤ 10 baris → biar tanpa scroll paksa
  if (rows.length <= 10) {
    scroller.style.maxHeight = '';
    scroller.style.overflowY = 'visible';
    return;
  }

  const rowH  = (rows[0]?.getBoundingClientRect().height) || 44;
  const headH = head.getBoundingClientRect().height || 44;
  const footH = foot?.getBoundingClientRect().height || 0;

  scroller.style.maxHeight = (headH + (rowH * 10) + footH) + 'px';
  scroller.style.overflowY = 'auto';
}

function renderSummaryRows(t, count, site, month){
  setMiniMonthLabel();
  $('#miniSite').textContent  = (site === 'ALL' ? 'All Sites' : site);

  const top = $('#summaryRowTop');
  top.innerHTML = '';

  [
    { title: 'Total Deposit',        val: fmtNum(t.d),                                   cls: 'green' },
    { title: 'Total Withdrawal',     val: t.w === 0 ? fmtNum(0) : `-${fmtNum(Math.abs(t.w))}`, cls: 'red' },
    { title: 'Total Bonus',          val: fmtNum(t.b),                                   cls: 'cyan' },
    { title: 'Total Sales',          val: fmtNum(t.s),                                   cls: t.s < 0 ? 'red' : 'green' },
    { title: 'Total Forfeit',        val: fmtNum(t.f) },
    { title: 'Total Resit In',       val: fmtNumNoGroup(t.r) },     // ⬅️ no grouping
    { title: 'Total Unclaim (Σ)',    val: fmtNum(t.uDisp) },
    { title: 'Total Member',         val: fmtIntNoGroup(t.m) },     // ⬅️ no grouping
    { title: 'Records',              val: count.toLocaleString() },
  ].forEach(c => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls || ''}">${c.val}</div>`;
    top.appendChild(d);
  });

  const bottom = $('#summaryRowBottom');
  bottom.innerHTML = '';

  const halfDep   = t.bd / 2;
  const halfRes   = t.br / 2;
  const salesOnly = t.bsBase;
  const totalAmt  = halfDep + halfRes + salesOnly;

  const items = [
    { title: 'Unclaim Σ',             val: fmtNum(t.uAll),        cls: t.uAll > 0 ? 'green' : '' },
    { title: 'Claimed Σ',             val: fmtNum(t.uClaimed) },
    { title: 'Bonus Deposit ½ Σ',     val: halfDep.toLocaleString() },
    { title: 'Bonus Resit ½ Σ',       val: halfRes.toLocaleString() },
    { title: 'Bonus Sales Σ',         val: salesOnly.toLocaleString() },
    { title: 'Total Bonus Σ',         val: totalAmt.toLocaleString() },
  ];

  items.forEach(c => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls || ''}">${c.val}</div>`;
    bottom.appendChild(d);
  });
}

 async function delRecord(id){
  if(!(await askConfirm('Delete this record?', {okText:'Yes', cancelText:'No'}))) return;
  writeStore(readStore().filter(r=>r.id!==id));
  writeUnclaims(readUnclaims().filter(u=>u.recordId!==id));
  render();
  toast('Record deleted', 'warn');
   bumpUpdated(); 
  safeSyncUp();
}

  function exportCSV(){
  const site = $('#siteFilter').value;
  const t    = readTarget();

  const fromStr = $('#rangeFrom')?.value;
  const toStr   = $('#rangeTo')?.value;
  const fromTS  = fromStr ? new Date(fromStr + 'T00:00:00').getTime() : -Infinity;
  const toTS    = toStr   ? new Date(toStr   + 'T23:59:59').getTime() :  Infinity;

  const data = readStore()
    .filter(r => site==='ALL' ? true : r.site===site)
    .filter(r => {
      const ts = new Date(r.datetime).getTime();
      return ts >= fromTS && ts <= toTS;
    })
    .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));

  const header=['datetime','site','deposit','withdrawal','bonus','forfeit','member','resit_in','sales','bonus_deposit','bonus_resit','bonus_sales_base'];
  const rows=[header.join(',')];

  for(const r of data){
    const bDep=pickTierBonus(r.deposit, t.depositTiers);
    const bRes=pickTierBonus(r.resit,   t.resitTiers);
    const bSales=pickTierBonus(r.sales, t.salesTiers);
    rows.push([
      new Date(r.datetime).toISOString(), r.site, r.deposit, r.withdrawal, r.bonus, r.forfeit,
      r.member, r.resit, r.sales, bDep, bRes, bSales
    ].join(','));
  }
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`bonus-${fromStr}_to_${toStr}-${site}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

 // ===== C. Unclaim Modal =====
function openUnclaimModal(){
  openModalA11y('#unclaimModal', '#tabPending');
  switchUcTab(ucActiveTab);
}
function closeUnclaimModal(){ closeModalA11y('#unclaimModal', '#unclaimBtn'); }

  function switchUcTab(which){
    ucActiveTab = which;
    $('#tabPending').classList.toggle('active', which==='pending');
    $('#tabHistory').classList.toggle('active', which==='history');
    renderUnclaimList(which);
  }

function renderUnclaimList(which = 'pending'){
  const site = $('#siteFilter').value;
  const ucAll = readUnclaims().filter(x => (site === 'ALL' || x.site === site));
  const records = Object.fromEntries(readStore().map(r => [r.id, r]));
  const items = (which === 'history' ? ucAll.filter(x => x.claimed) : ucAll.slice())
  .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  // 3) Render
  const list = $('#ucList');
  list.innerHTML = '';

  if (!items.length){
    const e = document.createElement('div');
    e.className = 'empty';
    e.textContent = (which === 'history') ? 'Belum ada riwayat claim.' : 'Belum ada Unclaim.';
    list.appendChild(e);
    return;
  }

  for (const u of items){
    const rec       = records[u.recordId];
    const recDt     = rec ? fmtDMYHMS(rec.datetime) : '-';
    const created   = fmtDMYHMS(u.createdAt);
    const claimedAt = u.claimedAt ? fmtDMYHMS(u.claimedAt) : '-';

    const isHistoryView   = (which === 'history');
    const showClaimBtn    = (!u.claimed && !isHistoryView);
    const showClaimedLine = (u.claimed && isHistoryView);

    const displayAmount = (u.claimed && isHistoryView) ? ('-' + fmtNum(u.amount)) : fmtNum(u.amount);
    const amtCls = (u.claimed && isHistoryView) ? 'uc-amt red' : 'uc-amt';

    const row = document.createElement('div');
    row.className = 'uc-item';
    row.innerHTML = `
      <div>${created}</div>
      <div><span class="pill ${u.site==='5G88' ? 'site-5g88' : 'site-spm888'}">${u.site}</span></div>
      <div>Record Date: ${recDt} <span class="hint" style="margin-left:6px">(Origin: ${prettyMonth(u.month)})</span></div>
      <div class="${amtCls}">${displayAmount}</div>
      <div class="uc-claimed">${showClaimedLine ? ('Claimed: ' + claimedAt) : ''}</div>
      <div class="uc-actions">
        ${showClaimBtn ? `
          <button class="btn-del" onclick="deleteUnclaim('${u.id}')">Delete</button>
          <button class="btn" onclick="claimUnclaim('${u.id}')">Claim</button>` : ''
        }
      </div>
    `;
    list.appendChild(row);
  }
}
// Claim logic: BUAT RECORD BARU DI BULAN SEKARANG + pindahkan unclaim ke bulan sekarang
function claimUnclaim(ucId){
  const ucAll = readUnclaims();
  const idx = ucAll.findIndex(x => x.id === ucId);
  if (idx < 0) return;

  const item = ucAll[idx];
  if (item.claimed) return;

  // ambil record asal (buat dapat site asal)
  const recs = readStore();
  const recOld = recs.find(r => r.id === item.recordId);

  // waktu sekarang (tanggal & bulan klaim)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const dd = String(now.getDate()).padStart(2,'0');
  const HH = String(now.getHours()).padStart(2,'0');
  const MM = String(now.getMinutes()).padStart(2,'0');
  const SS = String(now.getSeconds()).padStart(2,'0');
  const nowISO = new Date(`${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}`).toISOString();
  const nowMonth = `${yyyy}-${mm}`;

  // 1) BUAT RECORD BARU (masuk bulan sekarang)
  //    Deposit = amount klaim, Withdrawal = 0, Sales = Deposit - Withdrawal
  const newRec = {
    id: 'id_' + Date.now() + Math.random().toString(36).slice(2,7),
    site: (recOld?.site || item.site || '5G88'),
    datetime: nowISO,
    month: nowMonth,
    deposit: safe(item.amount),
    withdrawal: 0,
    bonus: 0,
    forfeit: 0,
    member: 0,
    resit: 0,
    sales: safe(item.amount) - 0
  };
  recs.push(newRec);
  writeStore(recs);
  item.claimed   = true;
  item.claimedAt = nowISO;
  item.recordId  = newRec.id;
  item.month     = nowMonth;              // ⬅️ penting agar muncul di bulan sekarang
  item.site      = newRec.site || item.site;
  ucAll[idx]     = item;
  writeUnclaims(ucAll);

  // 3) Pindahkan tampilan ke bulan sekarang (opsional tapi sesuai permintaan)
  $('#monthFilter').value = nowMonth;
  localStorage.setItem(LS_LAST_MONTH, nowMonth);
  setMonthAndRange(nowMonth);
  render();
  toast('Unclaim claimed', 'success');
  bumpUpdated(); 
  safeSyncUp();

  // Jika Unclaim modal lagi terbuka, langsung switch ke History & scroll atas
  if ($('#unclaimModal').classList.contains('show')) {
    switchUcTab('history');
    const list = $('#ucList');
    if (list) list.scrollTop = 0;
  }
}

async function deleteUnclaim(ucId){
  const ucAll = readUnclaims();
  const idx = ucAll.findIndex(x => x.id === ucId);
  if (idx < 0) return;

  const item = ucAll[idx];
  if (item.claimed){ toast('Item sudah claimed dan tidak bisa dihapus.', 'info'); return; }

  if(!(await askConfirm('Hapus unclaim pending ini?', {okText:'Yes', cancelText:'No'}))) return;

  ucAll.splice(idx, 1);
  writeUnclaims(ucAll);
  render();
  if ($('#unclaimModal').classList.contains('show')) switchUcTab('pending');
  toast('Unclaim deleted', 'warn');
  bumpUpdated(); 
  safeSyncUp();
}
window.deleteUnclaim = deleteUnclaim;
function applyNumberTitles() {
  document.querySelectorAll('#dataTable td, #dataTable th, .card .val')
    .forEach(el => { const t = (el.textContent||'').trim(); if (t) el.title = t; });
}
const MAX_DISPLAY = 15;

// Util kecil
const makeShort = (text, maxLen = MAX_DISPLAY) => {
  const s = String(text || '').trim();
  if (s.length <= maxLen) return s;
  return s.slice(0, maxLen) + '...';
};

// Terapkan ke satu elemen
function clipApply(el, raw){
  const full = String(raw ?? el.textContent ?? '').trim();
  const short = makeShort(full);
  el.classList.add('clipnum');
  el.dataset.full = full;
  el.dataset.short = short;
  el.dataset.state = (full.length > MAX_DISPLAY) ? 'short' : 'full';
  el.textContent = (el.dataset.state === 'short') ? short : full;
  el.title = (el.dataset.state === 'short') ? full : '';
  el.onclick = () => {
    const state = el.dataset.state === 'short' ? 'full' : 'short';
    el.dataset.state = state;
    el.textContent = (state === 'short') ? el.dataset.short : el.dataset.full;
    el.title = (state === 'short') ? el.dataset.full : '';
  };
}

/* Ikon ceklis: lingkaran + centang (path dari kamu) */
const CHECK_CIRCLE_PATH = "M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12z";
const CHECK_MARK_PATH   = "M11 17l-5-5.299 1.399-1.43 3.574 3.736 6.572-7.007 1.455 1.403-8 8.597z";

function svgCheckCircle(){
  return `
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <path d="${CHECK_CIRCLE_PATH}" fill="var(--ico)"></path>
    <path d="${CHECK_MARK_PATH}"   fill="#ffffff"></path>
  </svg>`;
}

function toast(msg, type='success', ms=2600){
  const host = document.getElementById('toastHost');
  if(!host){ console.warn('toastHost missing'); return; }

  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const iconHTML = (type==='success') ? svgCheckCircle()
                  : `<svg viewBox="0 0 24 24" aria-hidden="true">
                       <circle cx="12" cy="12" r="12" fill="var(--ico)"></circle>
                       <text x="12" y="16" text-anchor="middle" font-size="14" fill="#fff">${type==='info'?'i':'!'}</text>
                     </svg>`;

  el.innerHTML = `
    <span class="icon">${iconHTML}</span>
    <span class="msg">${msg}</span>
    <button class="close" aria-label="Dismiss">×</button>
  `;
  host.appendChild(el);

  const close = () => {
    el.style.animation = 'toast-out .16s ease-in forwards';
    setTimeout(() => el.remove(), 160);
  };
  el.querySelector('.close').onclick = close;
  const timer = setTimeout(close, ms);
  el.addEventListener('mouseenter', () => clearTimeout(timer), {once:true});
}

function askConfirm(message, {okText='Yes', cancelText='No'} = {}){
  return new Promise(resolve=>{
    const m  = document.getElementById('confirmModal');
    const no = document.getElementById('confirmNo');
    const yes= document.getElementById('confirmYes');
    document.getElementById('confirmMsg').textContent = message;
    yes.textContent = okText; no.textContent = cancelText;

    openModalA11y('#confirmModal', '#confirmNo');

    const done = (val)=>{
      closeModalA11y('#confirmModal');
      no.onclick = yes.onclick = null;
      const ov = m.querySelector('.overlay');
      if (ov) ov.onclick = null;
      resolve(val);
    };
    no.onclick = ()=> done(false);
    yes.onclick= ()=> done(true);
    const ov = m.querySelector('.overlay');
    if (ov) ov.onclick = ()=> done(false);
  });
}

const LS_NOTES = 'bonusNotes.v1';
const readNotes = () => {
  try { return JSON.parse(localStorage.getItem(LS_NOTES)) || []; }
  catch { return []; }
};

const writeNotes = (a) => {
  localStorage.setItem(LS_NOTES, JSON.stringify(a));
};
const writeNotesPersist = (a) => {
  writeNotes(a);
  if (typeof bumpUpdated === 'function') bumpUpdated();
  if (typeof safeSyncUp === 'function') safeSyncUp();
};
function ensureNotes(){
  const raw = localStorage.getItem(LS_NOTES);

  // FIRST-RUN → seed sekali (sertakan hdr default per-note)
  if (raw === null){
    const seed=[{
      id:'n_'+Date.now(),
      name:'Default',
      hdr: DEF_HDR.slice(),   // ⬅️ penting: header disimpan per note
      rows:[
        {s:30000, sa:300,  d: 8000, da:20, r:250,  ra:30},
        {s:40000, sa:350,  d:10000, da:25, r:300,  ra:40},
        {s:50000, sa:400,  d:12000, da:30, r:350,  ra:50},
        {s:60000, sa:450,  d:15000, da:35, r:400,  ra:60},
        {s:70000, sa:500,  d:20000, da:40, r:450,  ra:70},
        {s:80000, sa:800,  d:25000, da:50, r:'',   ra:''},
        {s:120000,sa:900,  d:'',    da:'', r:'',   ra:''},
      ]
    }];
    localStorage.setItem(LS_NOTES, JSON.stringify(seed));
    return seed;
  }

  // BUKAN first-run → parse & normalisasi TANPA membuang hdr
  let notes;
  try { notes = JSON.parse(raw) || []; } catch { notes = []; }

  let changed = false;
  const clean = (Array.isArray(notes) ? notes : []).map((n, i) => {
    const id   = (n && typeof n.id   === 'string') ? n.id   : ('n_'+Date.now()+'_'+i);
    const name = (n && typeof n.name === 'string') ? n.name : ('Note '+(i+1));
    const rows = Array.isArray(n?.rows) ? n.rows : [];
    // pertahankan hdr; kalau belum ada, isi default
    const hdr  = (Array.isArray(n?.hdr) && n.hdr.length === 6) ? n.hdr.slice(0,6) : DEF_HDR.slice();

    // tandai bila ada perbedaan struktur
    if (!n || n.id !== id || n.name !== name || !Array.isArray(n.rows) || !Array.isArray(n.hdr)) changed = true;

    return { id, name, rows, hdr };
  });

  // Hanya tulis balik kalau memang ada perubahan struktur
  if (changed) localStorage.setItem(LS_NOTES, JSON.stringify(clean));
  return clean;
}
let notesState = { notes: [], idx: 0, dirty: false };
/* ===== Rename Headers (Notes) ===== */
const LS_NOTE_HDR = 'bonusNotes.headers.v1';
const DEF_HDR = ['SALES','AMOUNT','DEPOSIT','AMOUNT /2','RESIT','AMOUNT /2'];

// baca header untuk note aktif (migrate sekali dari global)
function readHdr(){
  const n = notesState.notes?.[notesState.idx];
  if (Array.isArray(n?.hdr) && n.hdr.length===6) return n.hdr;

  let g=null; try{ g=JSON.parse(localStorage.getItem(LS_NOTE_HDR)); }catch{}
  const hdr = (Array.isArray(g) && g.length===6) ? g : DEF_HDR.slice();

  if (n){ n.hdr = hdr.slice(); writeNotesPersist(notesState.notes); }
  localStorage.removeItem(LS_NOTE_HDR); // buang global selepas migrate
  return hdr;
}

function writeHdrForCurrent(hdrArr){
  const n = notesState.notes?.[notesState.idx];
  if (!n) return;
  n.hdr = hdrArr.slice(0,6);
  writeNotesPersist(notesState.notes);
}

function applyHdr(){
  const h = readHdr();
  document.querySelectorAll('#notesTable thead th:nth-child(-n+6)')
    .forEach((th,i)=> th.textContent = h[i] || DEF_HDR[i]);
}
function closeHdrModal(){
  closeModalA11y('#hdrModal', '#editHdrBtn');
}
function openHdrModal(){
  const h = readHdr();
  for (let i=0;i<6;i++) document.getElementById('hdr_'+i).value = h[i] ?? '';
  openModalA11y('#hdrModal', '#hdr_0'); document.getElementById('hdr_0')?.select();
}

function saveHdrModal(){
  const vals = [];
  for (let i=0;i<6;i++){
    vals.push((document.getElementById('hdr_'+i)?.value || '').trim() || DEF_HDR[i]);
  }
  writeHdrForCurrent(vals);
  applyHdr();
  toast('Column names updated for this note only','success');
  closeHdrModal();
}

// wiring tombol
document.getElementById('editHdrBtn')?.addEventListener('click', openHdrModal);
document.getElementById('hdrCancel') ?.addEventListener('click', closeHdrModal);
document.getElementById('hdrSave')   ?.addEventListener('click', saveHdrModal);
  
function openNotesModal(){
  notesState.notes = ensureNotes();

  const sel = document.getElementById('noteSelect');
  sel.innerHTML = '';
  notesState.notes.forEach((n,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent=n.name || ('Note ' + (i+1));
    sel.appendChild(o);
  });

  if (!Number.isInteger(notesState.idx)) notesState.idx = 0;
  notesState.idx = Math.min(Math.max(0, notesState.idx), notesState.notes.length-1);
  sel.value = String(notesState.idx);

  notesState.dirty=false;
  renderNotesTable();
  applyHdr();
  openModalA11y('#notesModal', '#noteSelect');
}
function closeNotesModal(){ closeModalA11y('#notesModal', '#viewBtn'); }

function renderNotesTable(){
  const note = notesState?.notes?.[notesState?.idx] || { rows: [] };
  const rows = Array.isArray(note.rows) ? note.rows : [];
  const tb = document.getElementById('notesTBody');
  if (!tb) return;
  tb.innerHTML = '';

  // util kecil: lock/unlock semua baris lain masa editing
  const setRowsLocked = (locked, exceptTr = null) => {
    tb.querySelectorAll('tr').forEach(tr => {
      if (tr === exceptTr) return;
      tr.querySelectorAll('input,button').forEach(el => {
        // kekalkan butang Delete aktif ketika tidak mengedit apa-apa
        const isDel = el.classList && el.classList.contains('del');
        if (locked) el.disabled = (el.tagName === 'INPUT' || !isDel);
        else if (!tr.dataset.editing) el.disabled = false;
      });
    });
  };

  rows.forEach((row, ri) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${row?.s  ?? ''}"  disabled></td>
      <td><input type="text" value="${row?.sa ?? ''}" disabled></td>
      <td><input type="text" value="${row?.d  ?? ''}"  disabled></td>
      <td><input type="text" value="${row?.da ?? ''}" disabled></td>
      <td><input type="text" value="${row?.r  ?? ''}"  disabled></td>
      <td><input type="text" value="${row?.ra ?? ''}" disabled></td>
      <td class="actions">
        <button class="iconbtn edit">Edit</button>
        <button class="iconbtn-del del">Delete</button>
      </td>
    `;
    const inputs = [...tr.querySelectorAll('input')];
    const btnEdit = tr.querySelector('.edit');
    const btnDel  = tr.querySelector('.del');

    // ====== EDIT / SAVE toggle ======
    btnEdit.onclick = () => {
      const enteringEdit = inputs[0].disabled;     // kalau disabled -> nak masuk edit
      if (enteringEdit) {
        // simpan nilai asal untuk Esc/cancel
        tr.dataset.original = JSON.stringify(inputs.map(i => i.value));
        tr.dataset.editing = '1';
        inputs.forEach(i => i.disabled = false);
        btnEdit.textContent = 'Save';
        btnEdit.classList.add('active');
        setRowsLocked(true, tr);
        inputs[0].focus(); inputs[0].select?.();

        // shortcut: Enter = Save, Esc = Cancel
        const onKey = (e) => {
          if (e.key === 'Enter') { btnEdit.click(); }
          else if (e.key === 'Escape') {
            try {
              const orig = JSON.parse(tr.dataset.original || '[]');
              inputs.forEach((i, idx) => i.value = (orig[idx] ?? ''));
            } catch {}
            // keluar tanpa simpan
            inputs.forEach(i => i.disabled = true);
            tr.dataset.editing = '';
            btnEdit.textContent = 'Edit';
            btnEdit.classList.remove('active');
            setRowsLocked(false);
          }
        };
        tr.__keyHandler && tr.removeEventListener('keydown', tr.__keyHandler);
        tr.__keyHandler = onKey;
        tr.addEventListener('keydown', onKey);

      } else {
        // keluar edit -> SIMPAN
        const [s, sa, d, da, r, ra] = inputs.map(i => (i.value ?? '').trim());
        note.rows[ri] = { s, sa, d, da, r, ra };   // simpan apa adanya (string)
        notesState.dirty = true;
        writeNotesPersist(notesState.notes);
        inputs.forEach(i => i.disabled = true);
        tr.dataset.editing = '';
        btnEdit.textContent = 'Edit';
        btnEdit.classList.remove('active');
        setRowsLocked(false);
        toast('Row updated','info');
      }
    };

    // ====== DELETE ======
    btnDel.onclick = async () => {
      // Jangan padam ketika baris lain sedang edit
      const anyEditing = tb.querySelector('tr[data-editing="1"]');
      if (anyEditing && anyEditing !== tr) return;

      if (await askConfirm('Delete this line?', {okText:'Yes', cancelText:'No'})) {
        note.rows.splice(ri, 1);
        notesState.dirty = true;
        writeNotesPersist(notesState.notes);
        renderNotesTable();                // re-render
        toast('Line deleted','warn');
      }
    };

    tb.appendChild(tr);
  });
}

// buttons & actions
document.getElementById('addRowBtn')?.addEventListener('click', () => {
  const note = notesState.notes[notesState.idx];
  note.rows.push({s:'',sa:'',d:'',da:'',r:'',ra:''});
  renderNotesTable();
  document.querySelector('#notesTBody tr:last-child .edit')?.click(); // langsung mode edit
});

document.getElementById('saveNoteBtn')?.addEventListener('click', () => {
  writeNotesPersist(notesState.notes);
  notesState.dirty=false;
  toast('Note saved','success');
  closeNotesModal(); 
});
document.getElementById('cancelNoteBtn')?.addEventListener('click', () => {
  const curIdx = notesState.idx;
  notesState.notes = ensureNotes();            // reload dari LS
  notesState.idx   = Math.min(curIdx, notesState.notes.length-1);
  document.getElementById('noteSelect').value = String(notesState.idx);
  renderNotesTable();
  notesState.dirty=false;
  closeNotesModal();
});

document.getElementById('noteSelect')?.addEventListener('change', (e)=>{
  notesState.idx = +e.target.value;
  renderNotesTable();
  applyHdr(); 
});
document.getElementById('addNoteBtn')?.addEventListener('click', () => {
  openNoteNameModal('create', 'New Note', '#addNoteBtn');
});
document.getElementById('renameNoteBtn')?.addEventListener('click', () => {
  const cur = notesState.notes[notesState.idx]?.name || 'Untitled';
  openNoteNameModal('rename', cur, '#renameNoteBtn');
});
document.getElementById('delNoteBtn')?.addEventListener('click', async () => {
  if(!(await askConfirm('Delete this note?', {okText:'Yes', cancelText:'No'}))) return;
  notesState.notes.splice(notesState.idx, 1);
  writeNotesPersist(notesState.notes);
  notesState.idx = Math.max(0, notesState.notes.length - 1);
  const sel = document.getElementById('noteSelect');
  sel.innerHTML = '';
  notesState.notes.forEach((n,i)=>{
    const o=document.createElement('option');
    o.value=i; o.textContent=n.name || ('Note '+(i+1));
    sel.appendChild(o);
  });
  if (notesState.notes.length) sel.value = String(notesState.idx);
  renderNotesTable();
  applyHdr();
  toast('Note deleted','warn');
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('notesModal')?.classList.contains('show')) {
    closeNotesModal();
  }
});

// Klik overlay (area gelap) untuk tutup — kalau ada elemen .overlay di modal Notes
document.querySelector('#notesModal .overlay')?.addEventListener('click', () => {
  closeNotesModal();
})
// buka modal dari tombol View
document.getElementById('viewBtn')?.addEventListener('click', openNotesModal);
function clipMany(selector){
  const nodes = (typeof selector === 'string') ? document.querySelectorAll(selector) : selector;
  nodes.forEach(el => clipApply(el));
}

// Ekspor (kalau mau dipanggil manual sesudah update)
window.NumberClipper = { clip: clipMany, apply: clipApply };
  // SAFE edit/delete (hindari JSON di onclick)
window.__edit = (id) => {
  const rec = readStore().find(x => x.id === id);
  if (rec) openModal(rec);
};
window.__del  = (id) => delRecord(id);
  // helpers exposed
  window.openModal=openModal; window.closeModal=closeModal; window.delRecord=delRecord;
  window.openTargetModal=openTargetModal; window.closeTargetModal=closeTargetModal;
  window.openUnclaimModal=openUnclaimModal; window.closeUnclaimModal=closeUnclaimModal;
  window.claimUnclaim=claimUnclaim;
  // ===== Change Password (Firebase Auth - compat) =====
function openChangePwModal(){
  ['cpCurrent','cpNew','cpNew2'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
  openModalA11y('#cpModal', '#cpCurrent');
}
function closeChangePwModal(){
  closeModalA11y('#cpModal', '#udChangePw');
}

async function doChangePassword(){
  const cur = document.getElementById('cpCurrent').value.trim();
  const npw = document.getElementById('cpNew').value.trim();
  const npw2= document.getElementById('cpNew2').value.trim();

  if (!cur || !npw || !npw2) { toast('Isi semua field dulu', 'error'); return; }
  if (npw !== npw2)          { toast('Konfirmasi password tidak sama', 'error'); return; }
  if (npw.length < 6)        { toast('Password minimal 6 karakter', 'error'); return; }

  const btn = document.getElementById('cpOk');
  btn.disabled = true; btn.textContent = 'Changing...';

  try{
    const user = auth.currentUser;
    if (!user || !user.email) throw new Error('Not signed in');

    // Re-auth pakai password lama
    const cred = firebase.auth.EmailAuthProvider.credential(user.email, cur);
    await user.reauthenticateWithCredential(cred);

    // Update password
    await user.updatePassword(npw);

    toast('Password updated', 'success');
    closeChangePwModal();
  }catch(e){
    let msg = e?.message || 'Failed to change password';
    switch (e?.code){
      case 'auth/wrong-password':          msg = 'Password lama salah.'; break;
      case 'auth/weak-password':           msg = 'Password baru terlalu lemah (≥ 6 karakter).'; break;
      case 'auth/requires-recent-login':   msg = 'Sesi kadaluarsa. Silakan login ulang lalu coba lagi.'; break;
      case 'auth/too-many-requests':       msg = 'Terlalu banyak percobaan. Coba lagi nanti.'; break;
      case 'auth/network-request-failed':  msg = 'Jaringan bermasalah. Periksa koneksi.'; break;
    }
    toast(msg, 'error', 4000);
  }finally{
    btn.disabled = false; btn.textContent = 'Change';
  }
}

// Wiring tombol pada modal
document.getElementById('cpCancel')?.addEventListener('click', closeChangePwModal);
document.getElementById('cpOk')?.addEventListener('click', doChangePassword);
// Enter = submit, Esc / klik overlay = tutup
document.querySelector('#cpModal')?.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') doChangePassword();
  if (e.key === 'Escape') closeChangePwModal();
});
document.querySelector('#cpModal .overlay')?.addEventListener('click', closeChangePwModal);
document.getElementById('cpCloseX')?.addEventListener('click', closeChangePwModal);

// ==== User dropdown logic ====
function setUserUI(name){
  const lab = document.getElementById('userBtnLabel');
  const nm  = document.getElementById('userMenuName');
  if (lab) lab.textContent = name || 'user';
  if (nm)  nm.textContent  = name || 'user';
}

(() => {
  const userBtn  = document.getElementById('userBtn');
  const userMenu = document.getElementById('userMenu');
  if (!userBtn || !userMenu) return;

  // --------------------- TWEAKS (DOM + CSS) ---------------------
  function applyUserMenuTweaks(){
    // (1) Gabungkan header jadi 1 baris: "Signed in as : <name>"
    (function fixHeaderRow(){
      // cari elemen teks "Signed in as" (sering pakai .ud-head)
      let head = userMenu.querySelector('.ud-head');
      // fallback: kalau tidak ada, cari elemen pertama di menu
      if (!head) head = userMenu.firstElementChild;
      // nama user ambil dari #userMenuName (atau label tombol)
      const curName = (document.getElementById('userMenuName')?.textContent
                       || document.getElementById('userBtnLabel')?.textContent
                       || 'user').trim();

      // kalau sudah single-line, skip
      if (head && head.classList.contains('signed-row')) return;

      if (head){
        const row = document.createElement('div');
        row.className = 'signed-row';
        row.innerHTML = `Signed in as : <strong id="userMenuName">${curName}</strong>`;
        head.replaceWith(row);
      }
    })();

    // (2) Hapus "Forgot / Reset"
    userMenu.querySelector('#udForgot')?.closest('button, .ud-item, .item, li, a, div')?.remove();

    // (3) Siapkan label span, buang "..." di akhir, pasang ikon kiri + spacer kanan
    const ensureLabelSpan = (btn) => {
      if (!btn) return null;
      let lab = btn.querySelector('.label');
      if (!lab){
        const txt = (btn.textContent || '').trim();
        btn.textContent = '';
        lab = document.createElement('span');
        lab.className = 'label';
        lab.textContent = txt;
        btn.appendChild(lab);
      }
      return lab;
    };
    const stripDots = (span) => {
      if (!span) return;
      span.textContent = (span.textContent || '').replace(/\.\.\.$/, '');
    };

    const ICON_LOCK = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="4" y="10" width="16" height="10" rx="2" ry="2"></rect>
        <path d="M8 10V7a4 4 0 1 1 8 0v3"></path>
      </svg>`;
    const ICON_LOGOUT = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M15 12H3"></path>
        <path d="M11 8l-4 4 4 4"></path>
        <path d="M21 3h-6v18h6"></path>
      </svg>`;

    function decorateBtn(btn, svg){
      if (!btn) return;
      const lab = ensureLabelSpan(btn);
      stripDots(lab);

      // ikon kiri
      if (!btn.querySelector('.ico')){
        btn.insertAdjacentHTML('afterbegin', `<span class="ico">${svg}</span>`);
      }
      // spacer kanan agar label benar-benar center
      if (!btn.querySelector('.spacer')){
        btn.insertAdjacentHTML('beforeend', `<span class="spacer" aria-hidden="true"></span>`);
      }
    }

    decorateBtn(document.getElementById('udChangePw'), ICON_LOCK);
    decorateBtn(document.getElementById('udLogout'),   ICON_LOGOUT);

    // (4) Inject CSS override (ikon kiri + label center, header nowrap, tanpa ellipsis)
    if (!document.getElementById('userMenuTweaks')){
      const st = document.createElement('style');
      st.id = 'userMenuTweaks';
      st.textContent = `
        /* header 1 baris */
        #userMenu .signed-row{ display:flex; align-items:center; gap:6px; white-space:nowrap; }

        /* tombol: grid 3 kolom = [ikon kiri][label center][spacer kanan] */
        #udChangePw, #udLogout{
          display:grid !important;
          grid-template-columns:16px 1fr 16px;
          align-items:center;
          gap:8px;
          text-align:center;
          overflow:visible;           /* jangan potong isi */
        }
        #udChangePw .label, #udLogout .label{
          justify-self:center;
          white-space:nowrap;
          overflow:visible;
          text-overflow:clip;
        }
        #udChangePw .ico, #udLogout .ico{ width:16px; height:16px; display:inline-flex; }
        #udChangePw .ico svg, #udLogout .ico svg{ width:16px; height:16px; display:block; }
      `;
      document.head.appendChild(st);
    }
  }
  // jalankan sekali saat init
  applyUserMenuTweaks();

  // --------------------- MENU OPEN/CLOSE ---------------------
  userMenu.addEventListener('click', e => e.stopPropagation());

  function placeMenu(){
    const r = userBtn.getBoundingClientRect();
    const wasHidden = !userMenu.classList.contains('show');
    if (wasHidden) { userMenu.style.visibility = 'hidden'; userMenu.classList.add('show'); }

    const mw = userMenu.offsetWidth;
    const mh = userMenu.offsetHeight;
    const spaceBelow = window.innerHeight - r.bottom;

    userMenu.style.position = 'fixed';
    const left = Math.min(Math.max(r.right - mw, 8), window.innerWidth - mw - 8);
    userMenu.style.left = left + 'px';

    if (spaceBelow >= mh + 10) {
      userMenu.style.top = (r.bottom + 8) + 'px';
      userMenu.style.bottom = '';
    } else {
      userMenu.style.top = '';
      userMenu.style.bottom = (window.innerHeight - r.top + 8) + 'px';
    }

    if (wasHidden) { userMenu.classList.remove('show'); userMenu.style.visibility = ''; }
  }

  function openMenu(){
    placeMenu();
    applyUserMenuTweaks(); // jaga kalau DOM render ulang
    userMenu.classList.add('show');
    userBtn.setAttribute('aria-expanded','true');
    userMenu.setAttribute('aria-hidden','false');
    window.addEventListener('resize', placeMenu);
    window.addEventListener('scroll', placeMenu, true);
    document.addEventListener('click', onDocClick);
    document.addEventListener('keydown', onEsc);
  }

  function closeMenu(){
    userMenu.classList.remove('show');
    userBtn.setAttribute('aria-expanded','false');
    userMenu.setAttribute('aria-hidden','true');
    window.removeEventListener('resize', placeMenu);
    window.removeEventListener('scroll', placeMenu, true);
    document.removeEventListener('click', onDocClick);
    document.removeEventListener('keydown', onEsc);
  }

  function onDocClick(e){
    if (e.target !== userBtn && !userMenu.contains(e.target)) closeMenu();
  }
  function onEsc(e){ if (e.key === 'Escape') closeMenu(); }

  userBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if (userMenu.classList.contains('show')) closeMenu();
    else openMenu();
  });

  // actions
  // actions (GANTI JADI INI)
document.getElementById('udChangePw')?.addEventListener('click', (e)=>{
  e.preventDefault();
  closeMenu();            // tutup dropdown dulu
  openChangePwModal();    // lalu buka popup
});
document.getElementById('udLogout')?.addEventListener('click', (e)=>{
  e.preventDefault();
  closeMenu();
  doLogout();
});
})();
</script>
</body>
</html>
