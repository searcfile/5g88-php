<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monthly Bonus Recorder | 5G88</title>
<style>
  :root{
    --bg:#0a0a0a; --card:#121212; --muted:#1d1d1d;
    --text:#e6e6e6; --sub:#a7a7a7; --gold:#ffd166; --gold-2:#ffcf4d;
    --red:#f87171; --green:#22c55e; --cyan:#60a5fa; --ring:rgba(255,209,102,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text);
    font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;}
  .header{position:sticky; top:0; z-index:50; background:linear-gradient(180deg,#111,#0c0c0c);
    border-bottom:1px solid #242424; padding:12px 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .brand{display:flex; align-items:center; gap:10px; font-weight:700; padding:6px 10px; border-radius:10px;
    background:#0f0f0f; border:1px solid #222;}
  .brand .dot{width:8px; height:8px; border-radius:50%; background:var(--gold); box-shadow:0 0 12px var(--gold);}
  .spacer{flex:1}
  .select,.input,.btn{height:36px; border-radius:8px; border:1px solid #2a2a2a; background:#121212; color:var(--text);
    padding:0 10px; outline:none; transition:border .15s ease, box-shadow .2s ease;}
  .select:hover,.input:hover{border-color:#3a3a3a}
  .select:focus,.input:focus{border-color:var(--gold); box-shadow:0 0 0 4px var(--ring)}
  .btn{background:linear-gradient(180deg,var(--gold),var(--gold-2)); border:1px solid #8a6b1a; color:#000; font-weight:700;
    cursor:pointer; box-shadow:0 6px 18px rgba(255,209,102,.25);}
  .btn:hover{filter:brightness(1.04)} .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#141414; color:var(--text); border:1px solid #2d2d2d; box-shadow:none;}
  .btn.ghost:hover{border-color:#3a3a3a}
  .hint{color:var(--sub); font-size:12px}

  .wrap{max-width:1200px; margin:16px auto; padding:0 14px 60px}
  .cards{display:grid; grid-template-columns:repeat(6,1fr); gap:10px}
  @media (max-width:1100px){ .cards{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:640px){ .cards{grid-template-columns:repeat(2,1fr)} }
  .card{background:linear-gradient(180deg,#141414,#0e0e0e); border:1px solid #232323; border-radius:14px; padding:12px;}
  .card h4{margin:0 0 2px; font-size:12px; color:#cfcfcf; font-weight:600}
  .card .val{font-size:18px; font-weight:800}
  .val.red{color:var(--red)} .val.green{color:var(--green)} .val.cyan{color:var(--cyan)}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2a;
    background:#111; color:#ccc; font-size:12px;}

  .table{margin-top:14px; background:#101010; border:1px solid #222; border-radius:14px; overflow:hidden;}
  .table thead{background:linear-gradient(180deg,#161616,#131313)}
  .table th,.table td{padding:10px 10px; border-bottom:1px dashed #222; text-align:right; white-space:nowrap}
  .table th:first-child,.table td:first-child{text-align:left}
  .table th:nth-child(2), .table td:nth-child(2){text-align:center}
  .table tfoot td{background:#0f0f0f; font-weight:800}
  .pill{padding:2px 8px; border-radius:999px; border:1px solid #2d2d2d; background:#121212; font-weight:700}
  .pill.site-5g88{color:#111; background:var(--gold); border-color:#8a6b1a}
  .pill.site-spm888{color:#eee; background:#273142; border-color:#3a4b66}
  .num.red{color:var(--red)} .num.green{color:var(--green)}
  .actions{display:flex; gap:8px; justify-content:flex-end}
  .iconbtn{height:28px; padding:0 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#ddd; cursor:pointer; font-weight:600;}
  .iconbtn:hover{border-color:#3a3a3a} .iconbtn.del{border-color:#3a2222; background:#191111; color:#ffb4b4}
  .empty{padding:24px; text-align:center; color:#9f9f9f; border-top:1px dashed #222; background:repeating-linear-gradient(45deg,#0e0e0e 0 8px,#0c0c0c 8px 16px);}

  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px)}
  .modal.show{display:flex}
  .overlay{position:absolute; inset:0; background:rgba(0,0,0,.55)}
  .dialog{position:relative; z-index:1; width:min(920px,calc(100% - 24px)); background:#111; border:1px solid #2a2a2a;
    border-radius:16px; padding:14px; box-shadow:0 30px 80px rgba(0,0,0,.55);}
  .dialog h3{margin:0 0 10px; font-size:18px}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  @media (max-width:680px){ .grid{grid-template-columns:1fr} }
  .group{display:flex; flex-direction:column; gap:6px}
  .group label{font-size:12px; color:#cfcfcf}
  /* ðŸ‘‰ angka di kiri (popup) */
  .input[type="number"]{text-align:left}

  .dialog .foot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
  .banner{margin:12px 0 -2px; padding:10px; border:1px dashed #2a2a2a; border-radius:10px; background:#0e0e0e; color:#cfcfcf; display:flex; align-items:center; gap:10px;}
</style>
</head>
<body>
  <div class="header">
    <div class="brand"><span class="dot"></span> <span>Bonus Recorder</span></div>

    <select id="siteFilter" class="select" title="Site">
      <option value="ALL">All Sites</option>
      <option value="5G88">5G88</option>
      <option value="SPM888">SPM888</option>
    </select>

    <select id="monthFilter" class="select" title="Month"></select>

    <div class="spacer"></div>

    <button id="createBtn" class="btn">Create</button>
    <button id="exportBtn" class="btn ghost">Export CSV</button>
  </div>

  <div class="wrap">
    <div id="archiveBanner" class="banner" style="display:none">
      <span class="badge">Archive</span>
      <span>Anda sedang melihat bulan <b id="bannerMonth"></b>. Data default otomatis pindah ke bulan berjalan.</span>
    </div>

    <div class="cards" id="summaryRow"></div>

    <div class="table">
      <table id="dataTable" style="width:100%; border-collapse:collapse">
        <thead>
          <tr>
            <th style="width:150px">Date/Time</th>
            <th style="width:92px">Site</th>
            <!-- ðŸ‘‰ Deposit dulu baru Withdrawal -->
            <th>Deposit</th>
            <th>Withdrawal</th>
            <th>Bonus</th>
            <th>Forfeit</th>
            <th>Member</th>
            <th>Resit In</th>
            <th>Sales</th>
            <th style="width:180px; text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td colspan="2">TOTAL (Filtered)</td>
            <td id="ft_deposit" style="text-align:right">0</td>
            <td id="ft_withdrawal" style="text-align:right">0</td>
            <td id="ft_bonus" style="text-align:right">0</td>
            <td id="ft_forfeit" style="text-align:right">0</td>
            <td id="ft_member" style="text-align:right">0</td>
            <td id="ft_resit" style="text-align:right">0</td>
            <td id="ft_sales" style="text-align:right">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div id="emptyState" class="empty" style="display:none">Belum ada data untuk filter ini. Klik <b>Create</b> untuk tambah data baru.</div>
    </div>
    <div class="hint" style="margin-top:8px">Semua data disimpan lokal di browser (localStorage). Silakan eksport CSV untuk backup.</div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="overlay" onclick="closeModal()"></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Create Record</h3>
      <div class="grid">
        <div class="group">
          <label for="m_site">Site</label>
          <select id="m_site" class="select">
            <option value="5G88">5G88</option>
            <option value="SPM888">SPM888</option>
          </select>
        </div>
        <div class="group">
          <label for="m_dt">Date & Time</label>
          <input id="m_dt" class="input" type="datetime-local">
        </div>

        <!-- ðŸ‘‰ Deposit dulu, baru Withdrawal; angka kiri -->
        <div class="group"><label for="m_deposit">Total Deposit</label>
          <input id="m_deposit" class="input" type="number" step="0.01" min="0" placeholder="0.00">
        </div>
        <div class="group"><label for="m_withdrawal">Total Withdrawal</label>
          <input id="m_withdrawal" class="input" type="number" step="0.01" min="0" placeholder="0.00">
        </div>

        <div class="group"><label for="m_bonus">Total Bonus</label>
          <input id="m_bonus" class="input" type="number" step="0.01" min="0" placeholder="0.00">
        </div>
        <div class="group"><label for="m_forfeit">Total Forfeit</label>
          <input id="m_forfeit" class="input" type="number" step="0.01" min="0" placeholder="0.00">
        </div>

        <div class="group"><label for="m_member">Total Member</label>
          <input id="m_member" class="input" type="number" step="1" min="0" placeholder="0">
        </div>
        <div class="group"><label for="m_resit">Total Resit In</label>
          <input id="m_resit" class="input" type="number" step="0.01" min="0" placeholder="0.00">
        </div>

        <!-- ðŸ‘‰ Sales auto: Deposit âˆ’ Withdrawal (readonly) -->
        <div class="group"><label for="m_sales">Total Sales (auto)</label>
          <input id="m_sales" class="input" type="number" step="0.01" readonly placeholder="0.00" title="Auto = Deposit âˆ’ Withdrawal">
        </div>
        <div class="group">
          <label>&nbsp;</label>
          <div class="hint">Sales auto dihitung: <b>Deposit âˆ’ Withdrawal</b>. (Readonly)</div>
        </div>
      </div>
      <div class="foot">
        <button class="btn ghost" onclick="closeModal()">Cancel</button>
        <button id="saveBtn" class="btn">Save</button>
      </div>
    </div>
  </div>

<script>
  const $ = sel => document.querySelector(sel);
  const fmtNum = (n) => (Number.isFinite(n)?n:parseFloat(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtInt = (n) => (parseInt(n||0,10)).toLocaleString();
  const pad2 = (n)=> String(n).padStart(2,'0');
  const toYYYYMM = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const parseLocalDT = (value) => value? new Date(value.replace('T',' ') ): new Date();

  const LS_KEY = 'bonusRecords.v1';
  const LS_LAST_MONTH = 'bonusRecords.lastOpenedMonth';
  const readStore = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; } catch{ return []; } };
  const writeStore = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

  let editingId = null;

  window.addEventListener('DOMContentLoaded', () => {
    buildMonthOptions();
    applyAutoMonthSwitch();
    render();
    $('#createBtn').addEventListener('click', () => openModal());
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#siteFilter').addEventListener('change', render);
    $('#monthFilter').addEventListener('change', ()=>{ saveLastOpenedMonth(); render(); });
  });

  function buildMonthOptions(){
    const sel = $('#monthFilter');
    sel.innerHTML = '';
    const data = readStore();
    const months = new Set(data.map(r => r.month));
    months.add(toYYYYMM(new Date()));
    const sorted = Array.from(months).sort().reverse();
    for(const m of sorted){
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = prettyMonth(m);
      sel.appendChild(opt);
    }
    const last = localStorage.getItem(LS_LAST_MONTH);
    sel.value = (last && [...months].includes(last)) ? last : toYYYYMM(new Date());
  }
  function saveLastOpenedMonth(){ localStorage.setItem(LS_LAST_MONTH, $('#monthFilter').value); }
  function applyAutoMonthSwitch(){
    const curMonth = toYYYYMM(new Date());
    const last = localStorage.getItem(LS_LAST_MONTH);
    if (last !== curMonth){ $('#monthFilter').value = curMonth; localStorage.setItem(LS_LAST_MONTH, curMonth); }
  }
  function prettyMonth(yyyyMM){ const [y,m]=yyyyMM.split('-').map(Number); return new Date(y,m-1,1).toLocaleDateString(undefined,{month:'long',year:'numeric'}); }

  function openModal(record=null){
    editingId = record?.id ?? null;
    $('#modalTitle').textContent = editingId? 'Edit Record' : 'Create Record';
    $('#m_site').value = record?.site || ($('#siteFilter').value === 'ALL' ? '5G88' : $('#siteFilter').value);
    const dt = record ? new Date(record.datetime) : new Date();
    $('#m_dt').value = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;

    // set values
    $('#m_deposit').value    = record?.deposit    ?? '';
    $('#m_withdrawal').value = record?.withdrawal ?? '';
    $('#m_bonus').value      = record?.bonus      ?? '';
    $('#m_forfeit').value    = record?.forfeit    ?? '';
    $('#m_member').value     = record?.member     ?? '';
    $('#m_resit').value      = record?.resit      ?? '';

    // auto calc sales (deposit - withdrawal)
    const autoCalc = ()=> {
      const dep = parseFloat($('#m_deposit').value||0);
      const wit = parseFloat($('#m_withdrawal').value||0);
      const sales = dep - wit;
      $('#m_sales').value = Number.isFinite(sales)? sales.toFixed(2) : '0.00';
    };
    ['input','change'].forEach(ev=>{
      $('#m_deposit').oninput = autoCalc;
      $('#m_withdrawal').oninput = autoCalc;
    });
    autoCalc();

    $('#modal').classList.add('show');
    $('#saveBtn').onclick = saveModal;
  }
  function closeModal(){ $('#modal').classList.remove('show'); }

  function collectModal(){
    const dt = parseLocalDT($('#m_dt').value);
    return {
      id: editingId ?? ('id_'+Date.now()+Math.random().toString(36).slice(2,7)),
      site: $('#m_site').value,
      datetime: dt.toISOString(),
      month: toYYYYMM(dt),
      deposit: parseFloat($('#m_deposit').value||0),
      withdrawal: parseFloat($('#m_withdrawal').value||0),
      bonus: parseFloat($('#m_bonus').value||0),
      forfeit: parseFloat($('#m_forfeit').value||0),
      member: parseInt($('#m_member').value||0,10),
      resit: parseFloat($('#m_resit').value||0),
      sales: parseFloat($('#m_sales').value||0), // auto-filled
    };
  }

  function saveModal(){
    const rec = collectModal();
    const store = readStore();
    const idx = store.findIndex(x => x.id === rec.id);
    if (idx >= 0) store[idx] = rec; else store.push(rec);
    writeStore(store);
    buildMonthOptions();
    const cur = toYYYYMM(new Date());
    if (rec.month === cur) { $('#monthFilter').value = cur; saveLastOpenedMonth(); }
    closeModal();
    render();
  }

  function render(){
    const site = $('#siteFilter').value;
    const month = $('#monthFilter').value;
    const data = readStore()
      .filter(r => r.month === month)
      .filter(r => site === 'ALL' ? true : r.site === site)
      .sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));

    const curMonth = toYYYYMM(new Date());
    const isArchive = month !== curMonth;
    $('#archiveBanner').style.display = isArchive? 'flex':'none';
    $('#bannerMonth').textContent = prettyMonth(month);

    $('#emptyState').style.display = data.length ? 'none':'block';

    const tb = $('#tbody'); tb.innerHTML = '';
    for(const r of data){
      const dt = new Date(r.datetime).toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${dt}</td>
        <td style="text-align:center"><span class="pill ${r.site==='5G88'?'site-5g88':'site-spm888'}">${r.site}</span></td>
        <td class="num green">${fmtNum(r.deposit)}</td>
        <td class="num red">${fmtNum(r.withdrawal)}</td>
        <td class="num cyan">${fmtNum(r.bonus)}</td>
        <td>${fmtNum(r.forfeit)}</td>
        <td>${fmtInt(r.member)}</td>
        <td>${fmtNum(r.resit)}</td>
        <td>${fmtNum(r.sales)}</td>
        <td>
          <div class="actions">
            <button class="iconbtn" onclick='openModal(${JSON.stringify(r)})'>Edit</button>
            <button class="iconbtn del" onclick='delRecord("${r.id}")'>Delete</button>
          </div>
        </td>`;
      tb.appendChild(tr);
    }

    const totals = data.reduce((a,r)=>({
      d:a.d + r.deposit, w:a.w + r.withdrawal, b:a.b + r.bonus, f:a.f + r.forfeit,
      m:a.m + r.member, rsi:a.rsi + r.resit, s:a.s + r.sales
    }),{d:0,w:0,b:0,f:0,m:0,rsi:0,s:0});

    $('#ft_deposit').textContent = fmtNum(totals.d);
    $('#ft_withdrawal').textContent = fmtNum(totals.w);
    $('#ft_bonus').textContent = fmtNum(totals.b);
    $('#ft_forfeit').textContent = fmtNum(totals.f);
    $('#ft_member').textContent = fmtInt(totals.m);
    $('#ft_resit').textContent = fmtNum(totals.rsi);
    $('#ft_sales').textContent = fmtNum(totals.s);

    renderSummary(totals, data.length, site, month);
  }

  function renderSummary(t, count, site, month){
    const row = $('#summaryRow'); row.innerHTML = '';
    const cards = [
      {title:'Month', val: prettyMonth(month)},
      {title:'Site', val: site==='ALL'?'All Sites':site},
      {title:'Total Deposit', val: fmtNum(t.d), cls:'green'},
      {title:'Total Withdrawal', val: fmtNum(t.w), cls:'red'},
      {title:'Total Bonus', val: fmtNum(t.b), cls:'cyan'},
      {title:'Total Sales', val: fmtNum(t.s), cls:'green'},
      {title:'Total Forfeit', val: fmtNum(t.f)},
      {title:'Total Resit In', val: fmtNum(t.rsi)},
      {title:'Total Member', val: fmtInt(t.m)},
      {title:'Records', val: fmtInt(count)},
    ];
    for(const c of cards){
      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls||''}">${c.val}</div>`;
      row.appendChild(div);
    }
  }

  function delRecord(id){
    if (!confirm('Delete this record?')) return;
    writeStore(readStore().filter(r => r.id !== id));
    render();
  }

  function exportCSV(){
    const site = $('#siteFilter').value;
    const month = $('#monthFilter').value;
    const data = readStore()
      .filter(r => r.month === month)
      .filter(r => site === 'ALL' ? true : r.site === site)
      .sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));

    const header = ['datetime','site','deposit','withdrawal','bonus','forfeit','member','resit_in','sales'];
    const rows = [header.join(',')];
    for(const r of data){
      rows.push([
        new Date(r.datetime).toISOString(),
        r.site,
        r.deposit, r.withdrawal, r.bonus, r.forfeit, r.member, r.resit, r.sales
      ].join(','));
    }
    const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `bonus-${month}-${site}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  window.openModal = openModal;
  window.closeModal = closeModal;
  window.delRecord = delRecord;
</script>
</body>
</html>
