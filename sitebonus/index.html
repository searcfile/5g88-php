<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monthly Bonus Recorder</title>
<style>
:root{
  --bg:#0a0a0a; --card:#121212; --text:#e6e6e6; --sub:#a7a7a7;
  --gold:#ffd166; --gold-2:#ffcf4d; --red:#ff0000; --green:#008000; --cyan:#60a5fa; --ring:rgba(255,209,102,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; background:#000; color:var(--text);font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;}
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: #141414; }
::-webkit-scrollbar-thumb {
  background: #424242;
  border-radius: 8px;
  border: 2px solid transparent;
  background-clip: content-box;
}
/* Header */
.header{position:sticky; top:0; z-index:50;background:linear-gradient(180deg,#0063ab,#001c31);border-bottom:1px solid #242424; padding:12px 14px;display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
.brand{display:flex; gap:10px; align-items:center; font-weight:700;padding:6px 10px; border-radius:10px; background:#0f0f0f; border:1px solid #222;}
/* efek hover untuk satu baris penuh */
#dataTable tbody td{transition: background-color .15s ease;}
#dataTable tbody tr:hover > td{background:#1d1d1d;border-color: transparent;}
#dataTable{border-collapse: separate;border-spacing: 0;}
.input {height:36px; border-radius:8px; outline:none; border:1px solid #424242; background:#141414; color:var(--text);padding:6px 10px; transition: all 0.2s;}
.input:hover { border-color:#3c89e8; }
.input:focus { border-color:#1668dc; }
.brand .dot{width:8px; height:8px; border-radius:50%; background:var(--gold); box-shadow:0 0 12px var(--gold)}
.spacer{flex:1}
.select {height:36px; border-radius:8px; border:1px solid #424242; outline:none; background:#141414; color:rgba(255,255,255,0.85);padding:6px 10px; transition: all 0.2s;}
.select:hover{border-color:#3c89e8;color:#3c89e8}
.select:focus{border-color:#1668dc; box-shadow:0 0 0 4px #1668dc}
.btn{background:#1668dc;white-space:nowrap;color:white;border:none;padding:6px 10px;height:36px;font-size: 14px; cursor:pointer;transition: all 0.2s;border-radius:6px;}
.btn:hover{background:#3c89e8;} .btn:active{background:#1554ad;}
.btn-cancel{background:#141414;height:36px;padding:6px 10px;font-size: 14px;cursor:pointer; color:rgba(255, 255, 255, 0.85); border-radius:6px;border: 1px solid#424242;transition: all 0.2s;}.btn-cancel:hover{background:#141414;color:#3c89e8;border-color:#3c89e8}.btn-cancel:active{background:#141414;color:#1554ad;border-color:#1554ad}
.btn-unclaim {height:36px; border-radius:8px; border:1px solid #424242; background:#141414; color:rgba(255,255,255,0.85);padding:6px 10px; transition: all 0.2s;}
.btn-unclaim:hover{border-color:#3c89e8;color:#3c89e8;}.btn-unclaim:active{border-color:#1554ad;color:#1554ad;}
.btn-exp {height:36px; border-radius:8px; border:1px solid #424242; background:#141414; color:rgba(255,255,255,0.85);padding:6px 10px; transition: all 0.2s;}
.btn-exp:hover{border-color:#3c89e8;color:#3c89e8;}.btn-exp:active{border-color:#1554ad;color:#1554ad;}
.hint{color:#1668dc; font-size:12px}

/* Full width container */
.wrap{ width:100%; max-width:none; margin:16px 0; padding:0 14px 60px; }

/* Summary rows */
.cards-row{display:flex; gap:10px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin;min-width:0;}
.card{background:#141414;border:1px solid #424242; border-radius:14px; padding:12px;min-width:0; flex:1 1 220px;}
.card h4{margin:0 0 2px; font-size:12px; color:rgba(255,255,255,0.85); font-weight:600}
.card .val{font-size:14px; font-weight:700}

/* Ellipsis khusus kartu */
.card .val{display:block;max-width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:#008000;}
.val.red{color:var(--red)} .val.green{color:var(--green)} .val.cyan{color:#008000;}

/* Toolbar di atas tabel */
@media (max-width: 1400px){.spacer{ flex-basis:100%; height:0; }}
.toolbar .btn{flex-shrink:0;white-space: nowrap;}
.toolbar{display:flex;align-items:center;gap:12px;row-gap:8px;margin:10px 0 6px;overflow: hidden;white-space: nowrap;}
.badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#111; color:#ccc; font-size:12px}

/* Mini-cards (Month & Site) di kiri tombol */
.mini-cards{display:flex; gap:8px; min-width:0;flex: 1 1 auto;overflow: hidden; }
.mini-card{
  height:36px; display:flex; align-items:center; gap:8px;
  padding:0 12px; border-radius:8px;
  border:1px solid #2a2a2a; background:#141414; min-width:160px;flex: 1 1 160px;min-width: 120px;max-width: 260px;overflow: hidden;
}
.mini-label{font-size:12px; color:#1668dc}
.mini-value{
  font-weight:700; max-width:260px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
}

/* ====== TABLE ====== */
.table{background:#101010; border:1px solid #222; border-radius:14px;position: relative;overflow:hidden; }
.table-scroller{max-height:560px;overflow:auto;scrollbar-gutter: stable;}
.table-scroller::-webkit-scrollbar{ width:10px; }
.table-scroller::-webkit-scrollbar-track{ background:#141414; }
.table-scroller::-webkit-scrollbar-thumb{background:#424242; border-radius:8px;border:2px solid transparent; background-clip:content-box;}
.table thead{background:linear-gradient(180deg,#161616,#131313)}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #303030;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;vertical-align:middle;text-align:center;color:#008000;}

/* Kolom khusus */
.table th:first-child, .table td:first-child,
.table th:last-child,  .table td:last-child { text-align:center; }

/* Footer */
.table tfoot td { background:#0f0f0f; font-weight:800 }

/* Layout fixed + batas kolom */
.table table { table-layout: fixed; width: 100% }
.table th, .table td { max-width: 140px }
.table th:first-child, .table td:first-child { max-width: 180px;color:rgba(255, 255, 255, 0.85); }
.table th:last-child,  .table td:last-child  { max-width: 180px }

/* Tengah‑kan angka (kolom 3–12) */
.table thead th:nth-child(n+3):nth-child(-n+12),
.table tbody td:nth-child(n+3):nth-child(-n+12),
.table tfoot td:nth-child(n+3):nth-child(-n+12){ text-align:center; }

/* Angka rapi */
.table td:nth-child(n+3):nth-child(-n+12){
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum";
}

/* Guard .num */
.table td.num{ display:table-cell !important; }
.table td .num{ display:inline !important; }

/* Warna angka */
.num.red { color: var(--red) }
.num.green { color: var(--green) }
.num.cyan { color:#008000;}

/* Aksi */
.actions { display:flex; gap:8px; justify-content:center }
.iconbtn { height:28px; padding:0 10px; border-radius:6px;transition: all 0.2s; border:1px solid #1668dc; background:#141414; color:#1668dc; cursor:pointer; font-weight:600 }
.iconbtn:hover { border-color:#3c89e8;color:#3c89e8;}.iconbtn:active { border-color:#1554ad;color:#1554ad;}
.iconbtn-del { height:28px; padding:0 10px; border-radius:6px;transition: all 0.2s; border:1px solid #dc4446; background:#191111; color:#dc4446; cursor:pointer; font-weight:600 }
.iconbtn-del:hover {border-color:#e86e6b; color:#e86e6b;}.iconbtn-del:active {border-color:#ad393a; color:#ad393a;}

/* Pill */
.pill { padding: 2px 8px; border-radius:999px; border:1px solid #2d2d2d; background:#121212;}
.pill.site-5g88 { color:#1668dc; background:#000; border-color:#1668dc;font-size:13px;}
.pill.site-spm888 { color:#ff2638; background:#000; border-color:#bf0010;font-size:13px; }

/* Empty state */
.empty {
  padding:24px; text-align:center; color:#9f9f9f;
  border-top:1px solid #222;
  background:repeating-linear-gradient(45deg,#0e0e0e 0 8px,#0c0c0c 8px 16px)
}

/* DataTable guard */
#dataTable { table-layout: fixed; width: 100%;border-spacing: 0;border-collapse: separate !important; }
#dataTable th, #dataTable td { padding: 10px 12px; }
#dataTable td:last-child .actions { justify-content:center !important; }
#dataTable tfoot td{position: sticky;bottom: 0;z-index: 1;background:#0f0f0f;text-align:center !important;}
#dataTable thead th{position: sticky;top: 0;z-index: 2;background: linear-gradient(180deg,#161616,#131313);}
/* Sejajarkan kolom Actions */
#dataTable thead th:last-child { text-align: center !important; }
#dataTable tbody td:last-child { text-align: center !important; }
#dataTable td:last-child .actions{display:flex; width:100%; justify-content:center !important; align-items:center;}
#dataTable tfoot td:first-child {text-align: center !important; vertical-align: middle !important;font-weight: bold; letter-spacing: 0.3px; color: white;}
#dataTable thead th{ box-shadow: 0 2px 0 rgba(0,0,0,.35);color:white;}
#dataTable tfoot td{ box-shadow: 0 -2px 0 rgba(0,0,0,.35);}

/* Modal */
.modal{
  position: fixed; inset: 0; z-index: 2147483646;
  display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
  pointer-events: auto!important;
  isolation:isolate;
}
.modal.show{display:flex}
.modal[aria-hidden="true"]{ display:none !important; }
.modal .overlay{
  position:absolute; inset:0;
  background: rgba(0,0,0,.55);
  z-index: 2147483646;
  pointer-events: auto
}
.modal .dialog{
  position: relative;
  z-index: 2147483647;
  width: min(980px, calc(100% - 24px));
  background:#111; border:1px solid #2a2a2a; border-radius:16px; padding:14px;
  box-shadow: 0 30px 80px rgba(0,0,0,.55);
  max-height: 85vh; overflow: auto;
  display: flex; flex-direction: column;
  pointer-events: auto !important; /* isi dialog bisa diklik/fokus */
}
.dialog h3{margin:0 0 10px; font-size:18px}
.modal-close{
  position:absolute; top:10px; right:12px;
  background:transparent; border:none; cursor:pointer;
  color: rgb(255 255 255 / 45%); font-size:22px; z-index: 2147483647;
}
.modal-close:hover {color:white;z-index: 2147483647;}
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
@media (max-width:680px){ .grid{grid-template-columns:1fr} }
.group{display:flex; flex-direction:column; gap:6px}
.group label{font-size:12px; color:#cfcfcf}
.input[type="number"]{text-align:left}
.dialog .foot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

/* Tier editor */
.tier-head{font-weight:700; margin-top:8px; margin-bottom:4px}
.tier-list{
  border:1px solid #2a2a2a; border-radius:10px; padding:0 8px; background:#101010;
  max-height:150px; overflow:auto; padding-right:6px;padding-bottom: 5px;
}
.tier-list .tier-row:first-child{
  position:sticky; top:0; z-index:1; background:#101010;
  border-bottom:1px solid #2a2a2a; margin-bottom:6px; padding-top:8px; padding-bottom:6px;
}
.tier-row{display:grid; grid-template-columns:1fr 1fr auto; gap:8px; margin-bottom:6px}
.tier-row:last-child{margin-bottom:0}
.tier-row .rm{border:1px solid #3a2222; background:#1a1111; color:#ffb4b4; border-radius:8px; height:36px; padding:0 10px; cursor:pointer}
.addline{margin-top:8px}

/* Scrollbar tipis */
.tier-list::-webkit-scrollbar{height:8px; width:8px}
.tier-list::-webkit-scrollbar-thumb{background:#2a2a2a; border-radius:6px}
.cards-row::-webkit-scrollbar{height:8px}
.cards-row::-webkit-scrollbar-thumb{background:#2a2a2a; border-radius:6px}

/* Unclaim list styles */
.uc-item > :nth-child(3){
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.uc-claimed{ white-space:nowrap; overflow:visible; }
.uc-item > *{ min-width:0; }
.uc-list{
  display:flex; flex-direction:column; gap:8px;
  max-height:60vh; padding-right:6px;
  overflow-y:auto; overflow-x:hidden;
}
.uc-item{
  display:grid;
  grid-template-columns:150px 90px minmax(0,1fr) 110px max-content auto;
  gap:8px; align-items:center;
  border:1px solid #424242; background:#0f0f0f; padding:8px; border-radius:10px;
  min-height:44px;
}
.uc-item .uc-amt{font-weight:700;color:#008000;}
.uc-item .uc-amt.red{color:var(--red)}
.uc-tabs{display:flex; gap:8px; margin:6px 0 10px}
.uc-tab{height:32px;transition: all 0.2s;padding:0 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#ddd; cursor:pointer}
.uc-tab.active{border-color:#1668dc; color:#1668dc;}.uc-tab:hover{border:1px solid #3c89e8;color:#3c89e8;}.uc-tab:active{border:1px solid #1554ad;color:#1554ad;}
.dialog .uc-list {flex: 1 1 auto; min-height: 0; }
.clipnum{cursor: pointer;white-space: nowrap;}
/* tombol delete di Unclaim Center */
.btn-del{background:#191111; color:#dc4446;border:1px solid #dc4446; border-radius:8px;height:32px; padding:0 10px; cursor:pointer;transition:filter .2s, border-color .2s, background .2s;}
.btn-del:hover{ background:#210f0f; border-color:#6b3434; }
.btn-del:active{ background:#160b0b; }
.uc-actions{ display:flex; gap:8px; justify-content:flex-end; }
/* buang spinner number input (Chrome/Edge/Safari) */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{-webkit-appearance: none;margin: 0;}
input[type="number"]{-moz-appearance: textfield;appearance: textfield;}

/* tombol Edit di baris tier */
.tier-row .edit{border:1px solid #424242; background:#141414; color:rgba(255,255,255,0.85);border-radius:8px; height:36px; padding:0 10px; cursor:pointer;transition:filter 0.2s, border-color .2s;margin-right:6px;}
.tier-row .edit:hover{ border-color:#3c89e8;color:white;background:#3c89e8;transition:all 0.2s;}
.tier-row .edit:active{ border-color:#1554ad;color:white;background:#1554ad;transition:all 0.2s;}
.tier-row .edit.active{background:#1668dc;color:white;border:1px solid #1668dc;}
.bg-inert {
  pointer-events: none !important;
  user-select: none !important;
  -webkit-user-select: none !important;
  touch-action: none !important;
  filter: none !important;          /* jaga-jaga polyfill yang aneh */
}
.btn:disabled { opacity:.5; cursor:not-allowed; }
.input:disabled, .select:disabled { opacity:.7;cursor: not-allowed;}
</style>
</head>
<body>
  <!-- Header filters -->
  <div class="header">
    <div class="brand"><span class="dot"></span><span>Bonus Recorder</span></div>
    <select id="siteFilter" class="select"><option value="ALL">All Sites</option><option value="5G88">5G88</option><option value="SPM888">SPM888</option></select>
    <select id="monthFilter" class="select"></select>

    <!-- NEW: Unclaim button -->
    <button id="unclaimBtn" class="btn-unclaim" title="Kelola Unclaim">Unclaim</button>

    <div class="spacer"></div>
    <button id="exportBtn" class="btn-exp">Export CSV</button>
  </div>

  <div class="wrap">
    <!-- Row 1 summary -->
    <div class="cards-row" id="summaryRowTop"></div>
    <!-- Row 2 summary -->
    <div class="cards-row" id="summaryRowBottom" style="margin-top:8px;"></div>

    <!-- Toolbar above table -->
    <div class="toolbar">
      <div id="miniInfo" class="mini-cards">
        <div class="mini-card">
          <span class="mini-label">Month</span>
          <span id="miniMonth" class="mini-value"></span>
        </div>
        <div class="mini-card">
          <span class="mini-label">Site</span>
          <span id="miniSite" class="mini-value"></span>
        </div>
      </div>

      <div class="spacer"></div>

      <button id="targetBtn" class="btn">Set Target</button>
      <button id="createBtn" class="btn">Create</button>
    </div>

    <div id="archiveBanner" class="badge" style="display:none; margin:8px 0">Anda sedang melihat bulan <b id="bannerMonth" style="margin-left:6px"></b></div>

<!-- Table -->
<div class="table">
  <div class="table-scroller">
  <table id="dataTable">
<colgroup>
  <col style="width:150px"><!-- Date/Time -->
  <col style="width:92px"><!-- Site -->
  <col style="width:120px"><!-- Deposit -->
  <col style="width:120px"><!-- Withdrawal -->
  <col style="width:120px"><!-- Resit In -->
  <col style="width:120px"><!-- Bonus -->
  <col style="width:110px"><!-- Forfeit -->
  <col style="width:110px"><!-- Member -->
  <col style="width:120px"><!-- Sales -->
  <col style="width:120px"><!-- Unclaim (NEW) -->
  <col style="width:120px"><!-- Bonus Deposit -->
  <col style="width:120px"><!-- Bonus Resit -->
  <col style="width:180px"><!-- Actions -->
</colgroup>

<thead>
  <tr>
    <th>Date & Time</th>
    <th>Site</th>
    <th>Deposit</th>
    <th>Withdrawal</th>
    <th>Resit In</th>
    <th>Bonus</th>
    <th>Forfeit</th>
    <th>Member</th>
    <th>Sales</th>
    <th>Unclaim</th>
    <th>Bonus Deposit</th>
    <th>Bonus Resit</th>
    <th>Actions</th>
  </tr>
</thead>

    <tbody id="tbody"></tbody>

 <tfoot>
  <tr>
    <td>TOTAL (Filtered)</td>
    <td></td>
    <td id="ft_deposit">0</td>
    <td id="ft_withdrawal">0</td>
    <td id="ft_resit">0</td>
    <td id="ft_bonus">0</td>
    <td id="ft_forfeit">0</td>
    <td id="ft_member">0</td>
    <td id="ft_sales">0</td>
    <td id="ft_unclaim">0</td>
    <td id="ft_bonDep">0</td>
    <td id="ft_bonRes">0</td>
    <td></td>
  </tr>
</tfoot>
  </table>

  <div id="emptyState" class="empty" style="display:none">
    Belum ada data. Klik <b>Create</b> untuk tambah data.
  </div>
</div>
</div>

  <!-- Modal Create/Edit -->
  <div id="modal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
    <button class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
    <h3 id="modalTitle">Create Record</h3>
      <div class="grid">
        <div class="group"><label for="m_site">Site</label>
          <select id="m_site" class="select"><option value="" selected disabled>Select Site…</option><option value="5G88">5G88</option><option value="SPM888">SPM888</option>
        </select>
        </div>
        <div class="group"><label for="m_dt">Date & Time</label><input id="m_dt" class="input" type="datetime-local" step="1"></div>
        <div class="group"><label for="m_deposit">Total Deposit</label><input id="m_deposit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_withdrawal">Total Withdrawal</label><input id="m_withdrawal" class="input" type="number" step="0.01"></div>
        <div class="group"><label for="m_bonus">Total Bonus</label><input id="m_bonus" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_forfeit">Total Forfeit</label><input id="m_forfeit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_member">Total Member</label><input id="m_member" class="input" type="number" step="1" min="0"></div>
        <div class="group"><label for="m_resit">Total Resit In</label><input id="m_resit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_sales">Total Sales (auto)</label><input id="m_sales" class="input" type="number" step="0.01" readonly title="Auto = Deposit − Withdrawal"></div>
        <div class="group"><label>&nbsp;</label><div class="hint">Sales auto: <b>Deposit − Withdrawal</b></div></div>

        <!-- NEW: Unclaim Amount (disimpan pending) -->
        <div class="group"><label for="m_unclaim">Unclaim Amount</label><input id="m_unclaim" class="input" type="number" step="0.01" min="0" placeholder="0.00"></div>
        <div class="group"><label>&nbsp;</label><div class="hint">Unclaim tidak langsung masuk Deposit; akan tampil di popup Unclaim & kolom Unclaim.</div></div>
      </div>
      <div class="foot"><button class="btn-cancel" onclick="closeModal()">Cancel</button><button id="saveBtn" class="btn">Save</button></div>
    </div>
  </div>

  <!-- Modal Set Target -->
 <div id="targetModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeTargetModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="targetTitle" tabindex="-1">
    <button class="modal-close" onclick="closeTargetModal()" aria-label="Close">&times;</button>
    <h3 id="targetTitle">Set Target Bonus (Multi-Tier)</h3>

      <div class="tier-head">Deposit Tiers</div>
      <div id="depTierList" class="tier-list"></div>
      <button class="btn addline" id="addDepTier">+ Add Deposit Tier</button>

      <div class="tier-head" style="margin-top:12px">Resit Tiers</div>
      <div id="resTierList" class="tier-list"></div>
      <button class="btn addline" id="addResTier">+ Add Resit Tier</button>

      <div class="tier-head" style="margin-top:12px">Sales Tiers</div>
      <div id="salesTierList" class="tier-list"></div>
      <button class="btn addline" id="addSalesTier">+ Add Sales Tier</button>

      <div class="foot"><button class="btn-cancel" onclick="closeTargetModal()">Cancel</button><button id="saveTargetBtn" class="btn">Save Target</button></div>
    </div>
  </div>

  <!-- NEW: Modal Unclaim Center -->
  <div id="unclaimModal" class="modal" aria-hidden="true">
  <div class="overlay" onclick="closeUnclaimModal()"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="unclaimTitle" tabindex="-1">
    <button class="modal-close" onclick="closeUnclaimModal()" aria-label="Close">&times;</button>
    <h3 id="unclaimTitle">Unclaim Center</h3>
      <div class="uc-tabs">
        <button class="uc-tab active" id="tabPending">Pending</button>
        <button class="uc-tab" id="tabHistory">History</button>
      </div>
      <div id="ucList" class="uc-list"></div>
      <div class="foot"><button class="btn-cancel" onclick="closeUnclaimModal()">Cancel</button></div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const fmtNum = n => (Number.isFinite(n)?n:parseFloat(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtInt = n => (parseInt(n||0,10)).toLocaleString();
  const fmtNumNoGroup = (n) => {const v = Number.isFinite(n) ? n : parseFloat(n || 0);if (!Number.isFinite(v)) return '0';const isWhole = Math.abs(v - Math.round(v)) < 1e-10;return v.toLocaleString(undefined, {useGrouping: false,minimumFractionDigits: isWhole ? 0 : 2,maximumFractionDigits: isWhole ? 0 : 2,});};
  const fmtIntNoGroup = (n) =>(parseInt(n || 0, 10)).toLocaleString(undefined, { useGrouping: false });
  const pad2 = n => String(n).padStart(2,'0');
  const toYYYYMM = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const parseLocalDT = v => v? new Date(v.replace('T',' ')) : new Date();
  const dt24 = d =>new Date(d).toLocaleString(undefined, {year: 'numeric',month: '2-digit',day: '2-digit',hour: '2-digit',minute: '2-digit',second: '2-digit',hour12: false,hourCycle: 'h23',});
  const safe = v => Number.isFinite(+v) ? +v : 0;
  const two = n => String(n).padStart(2,'0');
  const fmtDMYHMS = d => {
  const x = new Date(d);return `${two(x.getDate())}/${two(x.getMonth()+1)}/${x.getFullYear()} ` +`${two(x.getHours())}:${two(x.getMinutes())}:${two(x.getSeconds())}`;};
  const fmtDMY = d => {const x = new Date(d);return `${two(x.getDate())}/${two(x.getMonth()+1)}/${x.getFullYear()}`;};

  const LS_KEY='bonusRecords.v1';
  const LS_LAST_MONTH='bonusRecords.lastOpenedMonth';
  const LS_LAST_SITE = 'bonusRecords.lastSite';
  const LS_TARGET='bonusTargets.v3';
  const LS_UNCLAIM='bonusUnclaims.v1';   // NEW

  const readStore=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]}};
  const writeStore=a=>localStorage.setItem(LS_KEY,JSON.stringify(a));

  const readUnclaims=()=>{try{return JSON.parse(localStorage.getItem(LS_UNCLAIM))||[]}catch{return[]}};
  const writeUnclaims=a=>localStorage.setItem(LS_UNCLAIM,JSON.stringify(a));

function readTarget(){
  // Kalau sudah ada v3, pakai apa adanya (jangan timpa)
  try {
    const t = JSON.parse(localStorage.getItem(LS_TARGET));
    if (t && Array.isArray(t.depositTiers) && Array.isArray(t.resitTiers) && Array.isArray(t.salesTiers)) {
      return t;
    }
  } catch {}

  // (Opsional) migrasi sekali dari v2 -> v3
  try {
    const old = JSON.parse(localStorage.getItem('bonusTargets.v2'));
    if (old) {
      const upgraded = {
        depositTiers: old.depositTiers || [{threshold:8000, bonus:20}],
        resitTiers:   old.resitTiers   || [{threshold:250,  bonus:30}],
        salesTiers:   old.salesTiers   || [{threshold:30000, bonus:300}],
      };
      localStorage.setItem(LS_TARGET, JSON.stringify(upgraded));
      return upgraded;
    }
  } catch {}

  // First-run default (hanya sekali)
  const def = {
    depositTiers:[{threshold:8000, bonus:20},{threshold:10000, bonus:25}],
    resitTiers:[{threshold:250, bonus:30},{threshold:500, bonus:60}],
    salesTiers:[{threshold:30000, bonus:300}]
  };
  localStorage.setItem(LS_TARGET, JSON.stringify(def));
  return def;
}
  const writeTarget=t=>localStorage.setItem(LS_TARGET, JSON.stringify(t));
  const pickTierBonus=(v,tiers)=>Array.isArray(tiers)?tiers.reduce((m,t)=>v>=+t.threshold?Math.max(m,+t.bonus||0):m,0):0;

  let editingId = null;
  let ucActiveTab = 'pending';

  window.addEventListener('DOMContentLoaded',()=>{
    buildMonthOptions();
    autoSwitchToCurrentMonth();
    const savedSite = localStorage.getItem(LS_LAST_SITE);
    $('#siteFilter').value = (savedSite === '5G88' || savedSite === 'SPM888' || savedSite === 'ALL')
    ? savedSite
    : 'ALL';
    render();
    $('#createBtn').addEventListener('click',()=>openModal());
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#siteFilter').addEventListener('change', () => {localStorage.setItem(LS_LAST_SITE, $('#siteFilter').value);render();});
    $('#monthFilter').addEventListener('change', ()=>{localStorage.setItem(LS_LAST_MONTH,$('#monthFilter').value); render();});
    $('#targetBtn').addEventListener('click', openTargetModal);

    // NEW: Unclaim center
    $('#unclaimBtn').addEventListener('click', openUnclaimModal);
    $('#tabPending').addEventListener('click', ()=>switchUcTab('pending'));
    $('#tabHistory').addEventListener('click', ()=>switchUcTab('history'));
  });

  function buildMonthOptions(){
    const sel=$('#monthFilter'); sel.innerHTML='';
    const months=new Set(readStore().map(r=>r.month)); months.add(toYYYYMM(new Date()));
    [...months].sort().reverse().forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=prettyMonth(m);sel.appendChild(o);});
    const last=localStorage.getItem(LS_LAST_MONTH);
    sel.value=(last && months.has(last))? last : toYYYYMM(new Date());
  }
  function autoSwitchToCurrentMonth(){
    const cur=toYYYYMM(new Date()); const last=localStorage.getItem(LS_LAST_MONTH);
    if(last!==cur){ $('#monthFilter').value=cur; localStorage.setItem(LS_LAST_MONTH,cur); }
  }
  const prettyMonth=yyyyMM=>{const [y,m]=yyyyMM.split('-').map(Number);return new Date(y,m-1,1).toLocaleDateString(undefined,{month:'long',year:'numeric'})};

// ===== D. Create/Edit Modal (id="modal") =====
function openModal(rec = null) {
  editingId = rec?.id ?? null;
  $('#modalTitle').textContent = editingId ? 'Edit Record' : 'Create Record';

  if (editingId) {
    $('#m_site').value = rec.site;
  } else {
    $('#m_site').value = ''; // kosongkan untuk create
  }

  const dt = rec ? new Date(rec.datetime) : new Date();
  $('#m_dt').value = `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}` +
                     `T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;

  $('#m_deposit').value    = rec?.deposit ?? '';
  $('#m_withdrawal').value = rec?.withdrawal ?? '';
  $('#m_bonus').value      = rec?.bonus ?? '';
  $('#m_forfeit').value    = rec?.forfeit ?? '';
  $('#m_member').value     = rec?.member ?? '';
  $('#m_resit').value      = rec?.resit ?? '';
  $('#m_unclaim').value    = '';

  const autoCalc = () => {
    $('#m_sales').value = (
      parseFloat($('#m_deposit').value || 0) -
      parseFloat($('#m_withdrawal').value || 0)
    ).toFixed(2);
  };
  $('#m_deposit').oninput = autoCalc;
  $('#m_withdrawal').oninput = autoCalc;
  autoCalc();

  // 💡 Pastikan urutan ini tepat
  lockFormBySite();                       // kunci field dulu
  $('#m_site').onchange = lockFormBySite; // buka saat dipilih

  openModalA11y('#modal', false);        // buka tanpa auto-focus
  $('#saveBtn').onclick = saveModal;
}
const closeModal = () => closeModalA11y('#modal', '#createBtn');

function lockFormBySite() {
  const hasSite = !!$('#m_site').value;
  // Ambil semua kontrol dalam modal KECUALI #m_site
  const ctrls = Array.from(document.querySelectorAll('#modal .dialog input, #modal .dialog select, #modal .dialog textarea'))
    .filter(el => el.id !== 'm_site');

  // enable/disable
  ctrls.forEach(el => {
    // sales readonly tetap readonly; hanya ubah disabled
    if (el.id !== 'm_sales') el.disabled = !hasSite;
    else el.disabled = !hasSite; // biar konsisten (dia memang readonly)
  });

  // tombol Save juga ikut
  $('#saveBtn').disabled = !hasSite;
}

  function collectModal(){
    const dt=parseLocalDT($('#m_dt').value);
    return{
      id: editingId ?? ('id_'+Date.now()+Math.random().toString(36).slice(2,7)),
      site: $('#m_site').value,
      datetime: dt.toISOString(), month: toYYYYMM(dt),
      deposit:+($('#m_deposit').value||0), withdrawal:+($('#m_withdrawal').value||0),
      bonus:+($('#m_bonus').value||0), forfeit:+($('#m_forfeit').value||0),
      member:parseInt($('#m_member').value||0,10), resit:+($('#m_resit').value||0),
      sales:+($('#m_sales').value||0),
      // NOTE: unclaim disimpan terpisah di LS_UNCLAIM
    };
  }

  function saveModal(){
    if (!$('#m_site').value) return;
    const rec=collectModal();
    const arr=readStore(); const i=arr.findIndex(x=>x.id===rec.id);
    if(i>=0) arr[i]=rec; else arr.push(rec);
    writeStore(arr);

    // NEW: jika user isi Unclaim Amount -> simpan pending item
    const ucAmt = safe($('#m_unclaim').value);
    if (ucAmt > 0) {
      const uc = readUnclaims();
      uc.push({
        id: 'uc_'+Date.now()+Math.random().toString(36).slice(2,6),
        recordId: rec.id,
        site: rec.site,
        month: rec.month,
        createdAt: new Date().toISOString(),
        amount: ucAmt,
        claimed: false,
        claimedAt: null
      });
      writeUnclaims(uc);
    }

    buildMonthOptions();
    if(rec.month===toYYYYMM(new Date())){ $('#monthFilter').value=rec.month; localStorage.setItem(LS_LAST_MONTH,rec.month); }
    closeModal(); render();
  }
// ===== A. Helper inert background + toggle modal =====
function setBackgroundInert(enable, exceptTarget){
  const except = (exceptTarget instanceof Element)
    ? exceptTarget
    : document.querySelector(exceptTarget);
  if (!except) return;

  document.querySelectorAll('body > *').forEach(el => {
    if (el === except) return;
    if (enable) el.classList.add('bg-inert');
    else el.classList.remove('bg-inert');
  });
}

function openModalA11y(modalSel, focusSel) {
  const m = document.querySelector(modalSel);
  if (!m) return;
  m.classList.add('debug-no-overlay');
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
  setBackgroundInert(true, m);       // <— kirim ELEMENT, bukan string

  const first = m.querySelector(
    focusSel || 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
  );
  first?.focus();
}
function closeModalA11y(modalSel, returnFocusSel) {
  const m = document.querySelector(modalSel);
  if (!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
  setBackgroundInert(false, m);         // <— kirim element
  if (returnFocusSel) document.querySelector(returnFocusSel)?.focus();
}


// (opsional) Trap TAB & Esc untuk semua modal yg sedang .show
document.addEventListener('keydown', (e) => {
  const openModal = document.querySelector('.modal.show');
  if (!openModal) return;

  if (e.key === 'Escape') {
    // tutup modal yang terbuka (tentukan prioritas sesuai id)
    if (openModal.id === 'targetModal') closeTargetModal();
    else if (openModal.id === 'unclaimModal') closeUnclaimModal();
    else if (openModal.id === 'modal') closeModal();
    return;
  }

  if (e.key === 'Tab') {
    const focusables = openModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const list = Array.from(focusables).filter(el => !el.disabled && el.offsetParent !== null);
    if (!list.length) return;
    const first = list[0], last = list[list.length-1];
    if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
  }
});
function openTargetModal(){
  const t = readTarget();
  renderTierEditor('#depTierList', t.depositTiers, 'Bonus Deposit');
  renderTierEditor('#resTierList', t.resitTiers, 'Bonus Resit');
  renderTierEditor('#salesTierList', t.salesTiers, 'Bonus Sales');
  $('#addDepTier').onclick = () => addTierRow('#depTierList');
  $('#addResTier').onclick = () => addTierRow('#resTierList');
  $('#addSalesTier').onclick = () => addTierRow('#salesTierList');
  $('#saveTargetBtn').onclick = saveTarget;
  openModalA11y('#targetModal', '#addDepTier');
}
const closeTargetModal = () => closeModalA11y('#targetModal', '#targetBtn');

  function renderTierEditor(sel, tiers, label){
    const box=$(sel); box.innerHTML='';
    const head=document.createElement('div'); head.className='tier-row';
    head.innerHTML=`<div class="hint" style="align-self:center">Threshold (≥)</div><div class="hint" style="align-self:center">${label}</div><div></div>`;
    box.appendChild(head);
    (tiers||[]).forEach(t=>addTierRow(sel,t.threshold,t.bonus));
  }
function addTierRow(sel, threshold='', bonus=''){
  const box = $(sel);
  const row = document.createElement('div');
  row.className = 'tier-row';

  row.innerHTML = `
    <input type="number" min="0" step="0.01" class="input" placeholder="e.g. 30000" value="${threshold}" disabled>
    <input type="number" min="0" step="1"    class="input" placeholder="e.g. 300"    value="${bonus}"     disabled>
    <div style="display:flex; gap:6px; justify-content:flex-end">
      <button type="button" class="edit">Edit</button>
      <button type="button" class="rm">Remove</button>
    </div>
  `;

  const [th, bo] = row.querySelectorAll('input');
  const btnEdit  = row.querySelector('.edit');
  const btnRm    = row.querySelector('.rm');

  // Toggle Edit ↔ Save (+ simpan saat kembali ke mode terkunci)
  btnEdit.onclick = () => {
    const willEnable = th.disabled;   // kalau tadinya disabled, sekarang enable
    th.disabled = bo.disabled = !willEnable;

    if (willEnable){
      // Masuk mode edit
      btnEdit.textContent = 'Save';
      btnEdit.classList.add('active');
      th.focus();
      th.select?.();
    } else {
      // Keluar mode edit → simpan
      btnEdit.textContent = 'Edit';
      btnEdit.classList.remove('active');
      saveTiersLive();   // ⬅️ simpan ke localStorage tanpa menutup modal
    }
  };

  // Hapus baris + simpan langsung
  btnRm.onclick = () => {
    row.remove();
    saveTiersLive();
  };

  box.appendChild(row);
}
function readRowsFromEditor(sel){
  const rows = [...document.querySelectorAll(sel+' .tier-row')].slice(1); // skip header
  const out = [];
  for(const r of rows){
    const [th, bo] = r.querySelectorAll('input');
    const thr = +th.value || 0;
    const bon = +bo.value || 0;
    if (thr > 0 && bon > 0) out.push({ threshold: thr, bonus: bon });
  }
  out.sort((a,b)=>a.threshold - b.threshold);
  return out;
}

// Simpan langsung ke localStorage (tanpa tutup modal)
function saveTiersLive(){
  const t = {
    depositTiers: readRowsFromEditor('#depTierList'),
    resitTiers:   readRowsFromEditor('#resTierList'),
    salesTiers:   readRowsFromEditor('#salesTierList'),
  };
  // fallback minimal agar tidak kosong total
  if(!t.depositTiers.length) t.depositTiers=[{threshold:8000,bonus:20}];
  if(!t.resitTiers.length)   t.resitTiers=[{threshold:250, bonus:30}];
  if(!t.salesTiers.length)   t.salesTiers=[{threshold:30000, bonus:300}];
  writeTarget(t);
}
  function saveTarget(){
    const readRows=sel=>{
      const rows=[...document.querySelectorAll(sel+' .tier-row')].slice(1);
      const out=[]; for(const r of rows){ const [th,bo]=r.querySelectorAll('input'); const thr=+th.value||0; const bon=+bo.value||0; if(thr>0&&bon>0) out.push({threshold:thr,bonus:bon}); }
      out.sort((a,b)=>a.threshold-b.threshold); return out;
    };
    const t={depositTiers:readRows('#depTierList'), resitTiers:readRows('#resTierList'), salesTiers:readRows('#salesTierList')};
    if(!t.depositTiers.length) t.depositTiers=[{threshold:8000,bonus:20}];
    if(!t.resitTiers.length)   t.resitTiers=[{threshold:250, bonus:30}];
    if(!t.salesTiers.length)   t.salesTiers=[{threshold:30000, bonus:300}];
    writeTarget(t);
    closeTargetModal();
    render();
  }

  /* ----- Render ----- */
function render(){
  const site   = $('#siteFilter').value;
  const month  = $('#monthFilter').value;
  const targets= readTarget();

  const data = readStore()
    .filter(r => r.month === month)
    .filter(r => site === 'ALL' ? true : r.site === site)
    .sort((a,b) => new Date(b.datetime) - new Date(a.datetime));

  // map unclaim per record
  const uc = readUnclaims();
  const ucByRecord = {};
  for (const u of uc.filter(x => x.month === month && (site === 'ALL' || x.site === site))) {
    if (!ucByRecord[u.recordId]) ucByRecord[u.recordId] = { pending:0, claimed:0 };
    if (u.claimed) ucByRecord[u.recordId].claimed += safe(u.amount);
    else           ucByRecord[u.recordId].pending += safe(u.amount);
  }

  const cur = toYYYYMM(new Date());
  const isArchive = month !== cur;
  $('#archiveBanner').style.display = isArchive ? 'inline-flex' : 'none';
  $('#bannerMonth').textContent = prettyMonth(month);

  const tb = $('#tbody'); tb.innerHTML = '';
  let totals = { d:0,w:0,b:0,f:0,m:0,r:0,s:0, bd:0, br:0, bsBase:0, uDisp:0, uPending:0, uClaimed:0, uAll:0 };

  for (const r of data){
    const dt = fmtDMYHMS(r.datetime);

    // bonus
    const bonusDep       = pickTierBonus(safe(r.deposit), targets.depositTiers);
    const bonusRes       = pickTierBonus(safe(r.resit),   targets.resitTiers);
    const bonusSalesBase = pickTierBonus(safe(r.sales),   targets.salesTiers);

    const ucs = ucByRecord[r.id] || { pending:0, claimed:0 };
    const unclaimDisplay = safe(ucs.claimed) > 0 ? -safe(ucs.claimed) : safe(ucs.pending);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dt}</td>
      <td style="text-align:center"><span class="pill ${r.site==='5G88'?'site-5g88':'site-spm888'}">${r.site}</span></td>
      <td class="${r.deposit < 0 ? 'num red' : 'num green'}">${fmtNum(r.deposit)}</td>
      <td class="num ${r.withdrawal === 0 ? '' : 'red'}">
        ${ r.withdrawal === 0 ? fmtNum(0) : ('-' + fmtNum(Math.abs(r.withdrawal))) }
      </td>
      <td>${fmtNumNoGroup(r.resit)}</td>
      <td class="num cyan">${fmtNum(r.bonus)}</td>
      <td>${fmtNum(r.forfeit)}</td>
      <td>${fmtIntNoGroup(r.member)}</td>
      <td class="${r.sales < 0 ? 'num red' : 'num green'}">${fmtNum(r.sales)}</td>
      <td class="num ${unclaimDisplay<0?'red':''}">${fmtNum(unclaimDisplay)}</td>
      <td>${bonusDep.toLocaleString()}</td>
      <td>${bonusRes.toLocaleString()}</td>
      <td>
        <div class="actions">
          <button class="iconbtn" onclick="window.__edit('${r.id}')">Edit</button>
          <button class="iconbtn-del" onclick="window.__del('${r.id}')">Delete</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);

    // totals
    totals.uPending += safe(ucs.pending);
    totals.uClaimed += safe(ucs.claimed);
    totals.uAll     += safe(ucs.pending) + safe(ucs.claimed);

    totals.d  += safe(r.deposit);
    totals.w  += safe(r.withdrawal);
    totals.b  += safe(r.bonus);
    totals.f  += safe(r.forfeit);
    totals.m  += safe(r.member);
    totals.r  += safe(r.resit);
    totals.s  += safe(r.sales);

    totals.bd += safe(bonusDep);
    totals.br += safe(bonusRes);
    totals.bsBase += safe(bonusSalesBase);
  }

  $('#emptyState').style.display = data.length ? 'none' : 'block';
  totals.uDisp = safe(totals.uPending);

  // footer totals
  $('#ft_deposit').textContent    = fmtNum(totals.d);
  const wdTotalAbs = Math.abs(totals.w);
  $('#ft_withdrawal').textContent = wdTotalAbs === 0 ? fmtNum(0) : `-${fmtNum(wdTotalAbs)}`;
  $('#ft_bonus').textContent      = fmtNum(totals.b);
  $('#ft_forfeit').textContent    = fmtNum(totals.f);
  $('#ft_member').textContent     = fmtIntNoGroup(totals.m);
  $('#ft_resit').textContent      = fmtNumNoGroup(totals.r);
  $('#ft_sales').textContent      = fmtNum(totals.s);
  $('#ft_unclaim').textContent    = fmtNum(totals.uDisp);
  $('#ft_bonDep').textContent     = totals.bd.toLocaleString();
  $('#ft_bonRes').textContent     = totals.br.toLocaleString();

  const ftW = $('#ft_withdrawal');
  ftW.className = ''; ftW.classList.add('num');
  if (wdTotalAbs > 0) ftW.classList.add('red');

  const ftS = $('#ft_sales');
  ftS.className = ''; ftS.classList.add('num');
  if (totals.s < 0) ftS.classList.add('red'); else if (totals.s > 0) ftS.classList.add('green');

  const ftU = $('#ft_unclaim');
  ftU.className = 'num';

  renderSummaryRows(totals, data.length, site, month);
  applyNumberTitles(); // tooltip hover tetap ada
  NumberClipper.clip('#dataTable tbody td:nth-child(n+3):nth-child(-n+12)');
  NumberClipper.clip('#dataTable tfoot td:nth-child(n+3):nth-child(-n+12)');
  NumberClipper.clip('.card .val');
  applyTableScrollLimit();
}
function applyTableScrollLimit() {
  const wrap  = document.querySelector('.table');
  const head  = document.querySelector('#dataTable thead');
  const body  = document.querySelectorAll('#dataTable tbody tr');
  const foot  = document.querySelector('#dataTable tfoot');

  if (!wrap || !head) return;

  // ≤ 10 baris → biarkan tanpa scroll paksa
  if (body.length <= 10) {
    wrap.style.maxHeight = '';
    wrap.style.overflowY = 'visible';
    return;
  }

  // Hitung tinggi: header + 10 baris + footer
  const rowH  = (body[0]?.getBoundingClientRect().height) || 44;
  const headH = head.getBoundingClientRect().height || 44;
  const footH = foot?.getBoundingClientRect().height || 0;

  wrap.style.maxHeight = (headH + (rowH * 10) + footH) + 'px';
  wrap.style.overflowY = 'auto';
}

function renderSummaryRows(t, count, site, month){
  $('#miniMonth').textContent = prettyMonth(month);
  $('#miniSite').textContent  = (site === 'ALL' ? 'All Sites' : site);

  const top = $('#summaryRowTop');
  top.innerHTML = '';

  [
    { title: 'Total Deposit',        val: fmtNum(t.d),                                   cls: 'green' },
    { title: 'Total Withdrawal',     val: t.w === 0 ? fmtNum(0) : `-${fmtNum(Math.abs(t.w))}`, cls: 'red' },
    { title: 'Total Bonus',          val: fmtNum(t.b),                                   cls: 'cyan' },
    { title: 'Total Sales',          val: fmtNum(t.s),                                   cls: t.s < 0 ? 'red' : 'green' },
    { title: 'Total Forfeit',        val: fmtNum(t.f) },
    { title: 'Total Resit In',       val: fmtNumNoGroup(t.r) },     // ⬅️ no grouping
    { title: 'Total Unclaim (Σ)',    val: fmtNum(t.uDisp) },
    { title: 'Total Member',         val: fmtIntNoGroup(t.m) },     // ⬅️ no grouping
    { title: 'Records',              val: count.toLocaleString() },
  ].forEach(c => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls || ''}">${c.val}</div>`;
    top.appendChild(d);
  });

  const bottom = $('#summaryRowBottom');
  bottom.innerHTML = '';

  const halfDep   = t.bd / 2;
  const halfRes   = t.br / 2;
  const salesOnly = t.bsBase;
  const totalAmt  = halfDep + halfRes + salesOnly;

  const items = [
    { title: 'Unclaim Σ',             val: fmtNum(t.uAll),        cls: t.uAll > 0 ? 'green' : '' },
    { title: 'Claimed Σ',             val: fmtNum(t.uClaimed) },
    { title: 'Bonus Deposit ½ Σ',     val: halfDep.toLocaleString() },
    { title: 'Bonus Resit ½ Σ',       val: halfRes.toLocaleString() },
    { title: 'Bonus Sales Σ',         val: salesOnly.toLocaleString() },
    { title: 'Total Bonus Σ',         val: totalAmt.toLocaleString() },
  ];

  items.forEach(c => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls || ''}">${c.val}</div>`;
    bottom.appendChild(d);
  });
}

  function delRecord(id){
    if(!confirm('Delete this record?')) return;
    writeStore(readStore().filter(r=>r.id!==id));
    // Hapus unclaim terkait record
    writeUnclaims(readUnclaims().filter(u=>u.recordId!==id));
    render();
  }

  function exportCSV(){
    const site=$('#siteFilter').value, month=$('#monthFilter').value, t=readTarget();
    const data=readStore().filter(r=>r.month===month).filter(r=>site==='ALL'?true:r.site===site)
      .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
    const header=['datetime','site','deposit','withdrawal','bonus','forfeit','member','resit_in','sales','bonus_deposit','bonus_resit','bonus_sales_base'];
    const rows=[header.join(',')];
    for(const r of data){
      const bDep=pickTierBonus(r.deposit, t.depositTiers);
      const bRes=pickTierBonus(r.resit,   t.resitTiers);
      const bSales=pickTierBonus(r.sales, t.salesTiers);
      rows.push([new Date(r.datetime).toISOString(), r.site, r.deposit, r.withdrawal, r.bonus, r.forfeit, r.member, r.resit, r.sales, bDep, bRes, bSales].join(','));
    }
    const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`bonus-${month}-${site}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

 // ===== C. Unclaim Modal =====
function openUnclaimModal(){
  openModalA11y('#unclaimModal', '#tabPending');
  switchUcTab(ucActiveTab);
}
function closeUnclaimModal(){ closeModalA11y('#unclaimModal', '#unclaimBtn'); }

  function switchUcTab(which){
    ucActiveTab = which;
    $('#tabPending').classList.toggle('active', which==='pending');
    $('#tabHistory').classList.toggle('active', which==='history');
    renderUnclaimList(which);
  }

function renderUnclaimList(which = 'pending'){
  const site  = $('#siteFilter').value;
  const month = $('#monthFilter').value;

  const uc      = readUnclaims().filter(x => x.month === month && (site === 'ALL' || x.site === site));
  const records = Object.fromEntries(readStore().map(r => [r.id, r]));

  const list = $('#ucList');
  list.innerHTML = '';

  const items = (which === 'history' ? uc.filter(x => x.claimed) : uc.slice())
    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  if (!items.length){
    const e = document.createElement('div');
    e.className = 'empty';
    e.textContent = (which === 'history') ? 'Belum ada riwayat claim.' : 'Belum ada Unclaim.';
    list.appendChild(e);
    return;
  }

  for (const u of items){
    const rec      = records[u.recordId];
    const recDt     = rec ? fmtDMYHMS(rec.datetime) : '-';
    const created   = fmtDMYHMS(u.createdAt);
    const claimedAt = u.claimedAt ? fmtDMYHMS(u.claimedAt) : '-';

    // 👉 Atur tampilan berdasarkan TAB:
    // - Di PENDING: item yang sudah claimed TETAP tampil seperti pending (tanpa label "Claimed", amount positif)
    // - Di HISTORY: item claimed tampil merah & ada label "Claimed: ..."
    const isHistoryView = (which === 'history');
    const showClaimBtn  = (!u.claimed && !isHistoryView); // tombol hanya muncul di Pending & belum claimed
    const showClaimedLine = (u.claimed && isHistoryView);

    const displayAmount = (u.claimed && isHistoryView) ? ('-' + fmtNum(u.amount)) : fmtNum(u.amount);
    const amtCls = (u.claimed && isHistoryView) ? 'uc-amt red' : 'uc-amt';

    const row = document.createElement('div');
    row.className = 'uc-item';
row.innerHTML = `
  <div>${created}</div>
  <div><span class="pill ${u.site==='5G88' ? 'site-5g88' : 'site-spm888'}">${u.site}</span></div>
  <div>Record Date: ${recDt}</div>
  <div class="${amtCls}">${displayAmount}</div>
  <div class="uc-claimed">${showClaimedLine ? ('Claimed: ' + claimedAt) : ''}</div>
  <div class="uc-actions">
  ${showClaimBtn? `<button class="btn-del" onclick="deleteUnclaim('${u.id}')">Delete</button>
  <button class="btn" onclick="claimUnclaim('${u.id}')">Claim</button>`: ''}
  </div>
`;
    list.appendChild(row);
  }
}

// Claim logic: BUAT RECORD BARU DI BULAN SEKARANG + pindahkan unclaim ke bulan sekarang
function claimUnclaim(ucId){
  const ucAll = readUnclaims();
  const idx = ucAll.findIndex(x => x.id === ucId);
  if (idx < 0) return;

  const item = ucAll[idx];
  if (item.claimed) return;

  // ambil record asal (buat dapat site asal)
  const recs = readStore();
  const recOld = recs.find(r => r.id === item.recordId);

  // waktu sekarang (tanggal & bulan klaim)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const dd = String(now.getDate()).padStart(2,'0');
  const HH = String(now.getHours()).padStart(2,'0');
  const MM = String(now.getMinutes()).padStart(2,'0');
  const SS = String(now.getSeconds()).padStart(2,'0');
  const nowISO = new Date(`${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}`).toISOString();
  const nowMonth = `${yyyy}-${mm}`;

  // 1) BUAT RECORD BARU (masuk bulan sekarang)
  //    Deposit = amount klaim, Withdrawal = 0, Sales = Deposit - Withdrawal
  const newRec = {
    id: 'id_' + Date.now() + Math.random().toString(36).slice(2,7),
    site: (recOld?.site || item.site || '5G88'),
    datetime: nowISO,
    month: nowMonth,
    deposit: safe(item.amount),
    withdrawal: 0,
    bonus: 0,
    forfeit: 0,
    member: 0,
    resit: 0,
    sales: safe(item.amount) - 0
  };
  recs.push(newRec);
  writeStore(recs);

  // 2) TANDAI UNCLAIM SUDAH DI‑CLAIM & PINDAHKAN KE BULAN SEKARANG
  //    Link ke record BARU supaya kolom "Unclaim" di baris record baru tampil negatif (-amount)
  item.claimed   = true;
  item.claimedAt = nowISO;
  item.recordId  = newRec.id;
  item.month     = nowMonth;              // ⬅️ penting agar muncul di bulan sekarang
  item.site      = newRec.site || item.site;
  ucAll[idx]     = item;
  writeUnclaims(ucAll);

  // 3) Pindahkan tampilan ke bulan sekarang (opsional tapi sesuai permintaan)
  $('#monthFilter').value = nowMonth;
  localStorage.setItem(LS_LAST_MONTH, nowMonth);

  // 4) Render ulang
  render();

  // Jika Unclaim modal lagi terbuka, langsung switch ke History & scroll atas
  if ($('#unclaimModal').classList.contains('show')) {
    switchUcTab('history');
    const list = $('#ucList');
    if (list) list.scrollTop = 0;
  }
}

function deleteUnclaim(ucId){
  const ucAll = readUnclaims();
  const idx = ucAll.findIndex(x => x.id === ucId);
  if (idx < 0) return;

  const item = ucAll[idx];
  if (item.claimed) {
    alert('Item sudah claimed dan tidak bisa dihapus.');
    return;
  }

  if (!confirm('Hapus unclaim pending ini?')) return;

  ucAll.splice(idx, 1);
  writeUnclaims(ucAll);

  // refresh tampilan + tetap di tab Pending
  render();
  if ($('#unclaimModal').classList.contains('show')) {
    switchUcTab('pending');
  }
}
window.deleteUnclaim = deleteUnclaim; // expose ke inline onclick
function applyNumberTitles() {
  document.querySelectorAll('#dataTable td, #dataTable th, .card .val')
    .forEach(el => { const t = (el.textContent||'').trim(); if (t) el.title = t; });
}
const MAX_DISPLAY = 15;

// Util kecil
const makeShort = (text, maxLen = MAX_DISPLAY) => {
  const s = String(text || '').trim();
  if (s.length <= maxLen) return s;
  return s.slice(0, maxLen) + '...';
};

// Terapkan ke satu elemen
function clipApply(el, raw){
  const full = String(raw ?? el.textContent ?? '').trim();
  const short = makeShort(full);
  el.classList.add('clipnum');
  el.dataset.full = full;
  el.dataset.short = short;
  // mulai dari short jika memang melebihi batas, kalau tidak langsung full
  el.dataset.state = (full.length > MAX_DISPLAY) ? 'short' : 'full';
  el.textContent = (el.dataset.state === 'short') ? short : full;
  el.title = (el.dataset.state === 'short') ? full : '';
  el.onclick = () => {
    const state = el.dataset.state === 'short' ? 'full' : 'short';
    el.dataset.state = state;
    el.textContent = (state === 'short') ? el.dataset.short : el.dataset.full;
    el.title = (state === 'short') ? el.dataset.full : '';
  };
}

// Terapkan ke NodeList/selector
function clipMany(selector){
  const nodes = (typeof selector === 'string') ? document.querySelectorAll(selector) : selector;
  nodes.forEach(el => clipApply(el));
}

// Ekspor (kalau mau dipanggil manual sesudah update)
window.NumberClipper = { clip: clipMany, apply: clipApply };
  // SAFE edit/delete (hindari JSON di onclick)
window.__edit = (id) => {
  const rec = readStore().find(x => x.id === id);
  if (rec) openModal(rec);
};
window.__del  = (id) => delRecord(id);
  // helpers exposed
  window.openModal=openModal; window.closeModal=closeModal; window.delRecord=delRecord;
  window.openTargetModal=openTargetModal; window.closeTargetModal=closeTargetModal;
  window.openUnclaimModal=openUnclaimModal; window.closeUnclaimModal=closeUnclaimModal;
  window.claimUnclaim=claimUnclaim;
</script>
</body>
</html>
