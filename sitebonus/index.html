<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monthly Bonus Recorder</title>
<style>
:root{
  --bg:#0a0a0a; --card:#121212; --text:#e6e6e6; --sub:#a7a7a7;
  --gold:#ffd166; --gold-2:#ffcf4d; --red:#ff0000; --green:#008000; --cyan:#60a5fa; --ring:rgba(255,209,102,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial;
}

/* Header */
.header{
  position:sticky; top:0; z-index:50;
  background:linear-gradient(180deg,#111,#0c0c0c);
  border-bottom:1px solid #242424; padding:12px 14px;
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.brand{
  display:flex; gap:10px; align-items:center; font-weight:700;
  padding:6px 10px; border-radius:10px; background:#0f0f0f; border:1px solid #222;
}
.brand .dot{width:8px; height:8px; border-radius:50%; background:var(--gold); box-shadow:0 0 12px var(--gold)}
.spacer{flex:1}
.select,.input,.btn{
  height:36px; border-radius:8px; border:1px solid #2a2a2a; background:#121212; color:var(--text);
  padding:0 10px; outline:none; transition:border .15s, box-shadow .2s;
}
.select:hover,.input:hover{border-color:#3a3a3a}
.select:focus,.input:focus{border-color:var(--gold); box-shadow:0 0 0 4px var(--ring)}
.btn{
  background:linear-gradient(180deg,var(--gold),var(--gold-2));
  border:1px solid #8a6b1a; color:#000; font-weight:700; cursor:pointer;
}
.btn:hover{filter:brightness(1.04)} .btn:active{transform:translateY(1px)}
.btn.ghost{background:#141414; color:#e6e6e6; border:1px solid #2d2d2d}
.hint{color:var(--sub); font-size:12px}

/* Full width container */
.wrap{ width:100%; max-width:none; margin:16px 0; padding:0 14px 60px; }

/* Summary rows */
.cards-row{
  display:flex; gap:10px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin;
  min-width:0;
}
.card{
  background:linear-gradient(180deg,#141414,#0e0e0e);
  border:1px solid #232323; border-radius:14px; padding:12px;
  min-width:0; flex:1 1 220px;
}
.card h4{margin:0 0 2px; font-size:12px; color:#cfcfcf; font-weight:600}
.card .val{font-size:15px; font-weight:800}

/* Ellipsis khusus kartu */
.card .val{
  display:block;
  max-width:100%;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}
.val.red{color:var(--red)} .val.green{color:var(--green)} .val.cyan{color:var(--cyan)}

/* Toolbar di atas tabel */
.toolbar{
  display:flex; gap:8px; align-items:center; margin:10px 0 6px;
  flex-wrap:nowrap; overflow-x:auto; padding-bottom:2px;
}
.badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #2a2a2a; background:#111; color:#ccc; font-size:12px}

/* Mini-cards (Month & Site) di kiri tombol */
.mini-cards{display:flex; gap:8px; min-width:0;}
.mini-card{
  height:36px; display:flex; align-items:center; gap:8px;
  padding:0 12px; border-radius:8px;
  border:1px solid #2a2a2a; background:#141414; min-width:160px;
}
.mini-label{font-size:12px; color:#cfcfcf}
.mini-value{
  font-weight:800; max-width:260px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
}

/* ====== TABLE ====== */
.table{
  background:#101010; border:1px solid #222; border-radius:14px;
  overflow:hidden; overflow-x:auto;
}
.table thead{background:linear-gradient(180deg,#161616,#131313)}
.table th,.table td{
  padding:10px 12px;
  border-bottom:1px dashed #222;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  vertical-align:middle;
  text-align:center;
}

/* Kolom khusus */
.table th:first-child, .table td:first-child,
.table th:last-child,  .table td:last-child { text-align:center; }

/* Footer */
.table tfoot td { background:#0f0f0f; font-weight:800 }

/* Layout fixed + batas kolom */
.table table { table-layout: fixed; width: 100% }
.table th, .table td { max-width: 140px }
.table th:first-child, .table td:first-child { max-width: 180px } /* Date/Time */
.table th:last-child,  .table td:last-child  { max-width: 180px } /* Actions */

/* Tengah‑kan angka (kolom 3–12) */
.table thead th:nth-child(n+3):nth-child(-n+12),
.table tbody td:nth-child(n+3):nth-child(-n+12),
.table tfoot td:nth-child(n+3):nth-child(-n+12){ text-align:center; }

/* Angka rapi */
.table td:nth-child(n+3):nth-child(-n+12){
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum";
}

/* Guard .num */
.table td.num{ display:table-cell !important; }
.table td .num{ display:inline !important; }

/* Warna angka */
.num.red { color: var(--red) }
.num.green { color: var(--green) }
.num.cyan { color: var(--cyan) }

/* Aksi */
.actions { display:flex; gap:8px; justify-content:center }
.iconbtn { height:28px; padding:0 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#ddd; cursor:pointer; font-weight:600 }
.iconbtn:hover { border-color:#3a3a3a }
.iconbtn.del { border-color:#3a2222; background:#191111; color:#ffb4b4 }

/* Pill */
.pill { padding: 2px 8px; border-radius:999px; border:1px solid #2d2d2d; background:#121212; font-weight:700 }
.pill.site-5g88 { color:#111; background:var(--gold); border-color:#8a6b1a }
.pill.site-spm888 { color:#eee; background:#273142; border-color:#3a4b66 }

/* Empty state */
.empty {
  padding:24px; text-align:center; color:#9f9f9f;
  border-top:1px dashed #222;
  background:repeating-linear-gradient(45deg,#0e0e0e 0 8px,#0c0c0c 8px 16px)
}

/* DataTable guard */
#dataTable { table-layout: fixed; width: 100%; }
#dataTable th, #dataTable td { padding: 10px 12px; }
#dataTable td:last-child .actions { justify-content:center !important; }
#dataTable tfoot td { text-align:center !important; }

/* Sejajarkan kolom Actions */
#dataTable thead th:last-child { text-align: center !important; }
#dataTable tbody td:last-child { text-align: center !important; }
#dataTable td:last-child .actions{
  display:flex; width:100%; justify-content:center !important; align-items:center;
}

/* Center TOTAL label */
#dataTable tfoot td:first-child {
  text-align: center !important; vertical-align: middle !important;
  font-weight: bold; letter-spacing: 0.3px; color: white;
}

/* Modal */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:blur(3px)}
.modal.show{display:flex}
.overlay{position:absolute; inset:0; background:rgba(0,0,0,.55)}
.dialog{
  position:relative; z-index:1; width:min(980px,calc(100% - 24px));
  background:#111; border:1px solid #2a2a2a; border-radius:16px; padding:14px;
  box-shadow:0 30px 80px rgba(0,0,0,.55);
  max-height:85vh; overflow:hidden; display:flex; flex-direction:column;
}
.dialog h3{margin:0 0 10px; font-size:18px}
.grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
@media (max-width:680px){ .grid{grid-template-columns:1fr} }
.group{display:flex; flex-direction:column; gap:6px}
.group label{font-size:12px; color:#cfcfcf}
.input[type="number"]{text-align:left}
.dialog .foot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

/* Tier editor */
.tier-head{font-weight:700; margin-top:8px; margin-bottom:4px}
.tier-list{
  border:1px solid #2a2a2a; border-radius:10px; padding:8px; background:#101010;
  max-height:150px; overflow:auto; padding-right:6px;
}
.tier-list .tier-row:first-child{
  position:sticky; top:0; z-index:1; background:#101010;
  border-bottom:1px solid #2a2a2a; margin-bottom:6px; padding-top:2px; padding-bottom:6px;
}
.tier-row{display:grid; grid-template-columns:1fr 1fr auto; gap:8px; margin-bottom:6px}
.tier-row:last-child{margin-bottom:0}
.tier-row .rm{border:1px solid #3a2222; background:#1a1111; color:#ffb4b4; border-radius:8px; height:36px; padding:0 10px; cursor:pointer}
.addline{margin-top:8px}

/* Scrollbar tipis */
.tier-list::-webkit-scrollbar{height:8px; width:8px}
.tier-list::-webkit-scrollbar-thumb{background:#2a2a2a; border-radius:6px}
.cards-row::-webkit-scrollbar{height:8px}
.cards-row::-webkit-scrollbar-thumb{background:#2a2a2a; border-radius:6px}

/* Unclaim list styles */
.uc-list{display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:60vh; padding-right:6px;}
.uc-item{display:grid; grid-template-columns:150px 90px 1fr 110px 120px auto; gap:8px; align-items:center; border:1px solid #242424; background:#0f0f0f; padding:8px; border-radius:10px}
.uc-item .uc-amt{font-weight:800}
.uc-item .uc-amt.red{color:var(--red)}
.uc-tabs{display:flex; gap:8px; margin:6px 0 10px}
.uc-tab{height:32px; padding:0 10px; border-radius:8px; border:1px solid #2a2a2a; background:#151515; color:#ddd; cursor:pointer}
.uc-tab.active{border-color:var(--gold); color:#000; background:linear-gradient(180deg,var(--gold),var(--gold-2))}
.dialog .uc-list {flex: 1 1 auto; min-height: 0; }
</style>
</head>
<body>
  <!-- Header filters -->
  <div class="header">
    <div class="brand"><span class="dot"></span><span>Bonus Recorder</span></div>
    <select id="siteFilter" class="select"><option value="ALL">All Sites</option><option value="5G88">5G88</option><option value="SPM888">SPM888</option></select>
    <select id="monthFilter" class="select"></select>

    <!-- NEW: Unclaim button -->
    <button id="unclaimBtn" class="btn ghost" title="Kelola Unclaim">Unclaim</button>

    <div class="spacer"></div>
    <button id="exportBtn" class="btn ghost">Export CSV</button>
  </div>

  <div class="wrap">
    <!-- Row 1 summary -->
    <div class="cards-row" id="summaryRowTop"></div>
    <!-- Row 2 summary -->
    <div class="cards-row" id="summaryRowBottom" style="margin-top:8px;"></div>

    <!-- Toolbar above table -->
    <div class="toolbar">
      <div id="miniInfo" class="mini-cards">
        <div class="mini-card">
          <span class="mini-label">Month</span>
          <span id="miniMonth" class="mini-value"></span>
        </div>
        <div class="mini-card">
          <span class="mini-label">Site</span>
          <span id="miniSite" class="mini-value"></span>
        </div>
      </div>

      <div class="spacer"></div>

      <button id="targetBtn" class="btn ghost">Set Target</button>
      <button id="createBtn" class="btn">Create</button>
    </div>

    <div id="archiveBanner" class="badge" style="display:none; margin:8px 0">Anda sedang melihat bulan <b id="bannerMonth" style="margin-left:6px"></b></div>

<!-- Table -->
<div class="table">
  <table id="dataTable" style="width:100%; border-collapse:collapse">
<colgroup>
  <col style="width:150px"><!-- Date/Time -->
  <col style="width:92px"><!-- Site -->
  <col style="width:120px"><!-- Deposit -->
  <col style="width:120px"><!-- Withdrawal -->
  <col style="width:120px"><!-- Resit In -->
  <col style="width:120px"><!-- Bonus -->
  <col style="width:110px"><!-- Forfeit -->
  <col style="width:110px"><!-- Member -->
  <col style="width:120px"><!-- Sales -->
  <col style="width:120px"><!-- Unclaim (NEW) -->
  <col style="width:120px"><!-- Bonus Deposit -->
  <col style="width:120px"><!-- Bonus Resit -->
  <col style="width:180px"><!-- Actions -->
</colgroup>

<thead>
  <tr>
    <th>Date/Time</th>
    <th>Site</th>
    <th>Deposit</th>
    <th>Withdrawal</th>
    <th>Resit In</th>
    <th>Bonus</th>
    <th>Forfeit</th>
    <th>Member</th>
    <th>Sales</th>
    <th>Unclaim</th>
    <th>Bonus Deposit</th>
    <th>Bonus Resit</th>
    <th>Actions</th>
  </tr>
</thead>

    <tbody id="tbody"></tbody>

 <tfoot>
  <tr>
    <td>TOTAL (Filtered)</td>
    <td></td>
    <td id="ft_deposit">0</td>
    <td id="ft_withdrawal">0</td>
    <td id="ft_resit">0</td>
    <td id="ft_bonus">0</td>
    <td id="ft_forfeit">0</td>
    <td id="ft_member">0</td>
    <td id="ft_sales">0</td>
    <td id="ft_unclaim">0</td>
    <td id="ft_bonDep">0</td>
    <td id="ft_bonRes">0</td>
    <td></td>
  </tr>
</tfoot>
  </table>

  <div id="emptyState" class="empty" style="display:none">
    Belum ada data. Klik <b>Create</b> untuk tambah data.
  </div>
</div>

  <!-- Modal Create/Edit -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="overlay" onclick="closeModal()"></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Create Record</h3>
      <div class="grid">
        <div class="group"><label for="m_site">Site</label>
          <select id="m_site" class="select"><option value="5G88">5G88</option><option value="SPM888">SPM888</option></select>
        </div>
        <div class="group"><label for="m_dt">Date & Time</label><input id="m_dt" class="input" type="datetime-local"></div>
        <div class="group"><label for="m_deposit">Total Deposit</label><input id="m_deposit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_withdrawal">Total Withdrawal</label><input id="m_withdrawal" class="input" type="number" step="0.01"></div>
        <div class="group"><label for="m_bonus">Total Bonus</label><input id="m_bonus" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_forfeit">Total Forfeit</label><input id="m_forfeit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_member">Total Member</label><input id="m_member" class="input" type="number" step="1" min="0"></div>
        <div class="group"><label for="m_resit">Total Resit In</label><input id="m_resit" class="input" type="number" step="0.01" min="0"></div>
        <div class="group"><label for="m_sales">Total Sales (auto)</label><input id="m_sales" class="input" type="number" step="0.01" readonly title="Auto = Deposit − Withdrawal"></div>
        <div class="group"><label>&nbsp;</label><div class="hint">Sales auto: <b>Deposit − Withdrawal</b></div></div>

        <!-- NEW: Unclaim Amount (disimpan pending) -->
        <div class="group"><label for="m_unclaim">Unclaim Amount</label><input id="m_unclaim" class="input" type="number" step="0.01" min="0" placeholder="0.00"></div>
        <div class="group"><label>&nbsp;</label><div class="hint">Unclaim tidak langsung masuk Deposit; akan tampil di popup Unclaim & kolom Unclaim.</div></div>
      </div>
      <div class="foot"><button class="btn ghost" onclick="closeModal()">Cancel</button><button id="saveBtn" class="btn">Save</button></div>
    </div>
  </div>

  <!-- Modal Set Target -->
  <div id="targetModal" class="modal" aria-hidden="true">
    <div class="overlay" onclick="closeTargetModal()"></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <h3>Set Target Bonus (Multi-Tier)</h3>

      <div class="tier-head">Deposit Tiers</div>
      <div id="depTierList" class="tier-list"></div>
      <button class="btn addline" id="addDepTier">+ Add Deposit Tier</button>

      <div class="tier-head" style="margin-top:12px">Resit Tiers</div>
      <div id="resTierList" class="tier-list"></div>
      <button class="btn addline" id="addResTier">+ Add Resit Tier</button>

      <div class="tier-head" style="margin-top:12px">Sales Tiers</div>
      <div id="salesTierList" class="tier-list"></div>
      <button class="btn addline" id="addSalesTier">+ Add Sales Tier</button>

      <div class="foot"><button class="btn ghost" onclick="closeTargetModal()">Cancel</button><button id="saveTargetBtn" class="btn">Save Target</button></div>
    </div>
  </div>

  <!-- NEW: Modal Unclaim Center -->
  <div id="unclaimModal" class="modal" aria-hidden="true">
    <div class="overlay" onclick="closeUnclaimModal()"></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <h3>Unclaim Center</h3>
      <div class="uc-tabs">
        <button class="uc-tab active" id="tabPending">Pending</button>
        <button class="uc-tab" id="tabHistory">History</button>
      </div>
      <div id="ucList" class="uc-list"></div>
      <div class="foot"><button class="btn ghost" onclick="closeUnclaimModal()">Close</button></div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const fmtNum = n => (Number.isFinite(n)?n:parseFloat(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
  const fmtInt = n => (parseInt(n||0,10)).toLocaleString();
  const pad2 = n => String(n).padStart(2,'0');
  const toYYYYMM = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const parseLocalDT = v => v? new Date(v.replace('T',' ')) : new Date();
  const dt24 = d =>new Date(d).toLocaleString(undefined, {year: 'numeric',month: '2-digit',day: '2-digit',hour: '2-digit',minute: '2-digit',hour12: false,hourCycle: 'h23',});
  const safe = v => Number.isFinite(+v) ? +v : 0;

  const LS_KEY='bonusRecords.v1';
  const LS_LAST_MONTH='bonusRecords.lastOpenedMonth';
  const LS_TARGET='bonusTargets.v3';
  const LS_UNCLAIM='bonusUnclaims.v1';   // NEW

  const readStore=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch{return[]}};
  const writeStore=a=>localStorage.setItem(LS_KEY,JSON.stringify(a));

  const readUnclaims=()=>{try{return JSON.parse(localStorage.getItem(LS_UNCLAIM))||[]}catch{return[]}};
  const writeUnclaims=a=>localStorage.setItem(LS_UNCLAIM,JSON.stringify(a));

  function readTarget(){
    let t; try{ t=JSON.parse(localStorage.getItem(LS_TARGET)); }catch{ t=null; }
    if (t && t.depositTiers && t.resitTiers && t.salesTiers) return t;

    try{
      const old = JSON.parse(localStorage.getItem('bonusTargets.v2'));
      if (old) {
        const upgraded = {depositTiers: old.depositTiers||[{threshold:8000,bonus:20}],
                          resitTiers: old.resitTiers||[{threshold:250,bonus:30}],
                          salesTiers:[{threshold:30000, bonus:300}]};
        localStorage.setItem(LS_TARGET, JSON.stringify(upgraded));
        return upgraded;
      }
    }catch{}

    const def={depositTiers:[{threshold:8000,bonus:20},{threshold:10000,bonus:25}],
               resitTiers:[{threshold:250,bonus:30},{threshold:500,bonus:60}],
               salesTiers:[{threshold:30000,bonus:300}]};
    localStorage.setItem(LS_TARGET, JSON.stringify(def));
    return def;
  }
  const writeTarget=t=>localStorage.setItem(LS_TARGET, JSON.stringify(t));
  const pickTierBonus=(v,tiers)=>Array.isArray(tiers)?tiers.reduce((m,t)=>v>=+t.threshold?Math.max(m,+t.bonus||0):m,0):0;

  let editingId = null;
  let ucActiveTab = 'pending';

  window.addEventListener('DOMContentLoaded',()=>{
    buildMonthOptions();
    autoSwitchToCurrentMonth();
    render();
    $('#createBtn').addEventListener('click',()=>openModal());
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#siteFilter').addEventListener('change', render);
    $('#monthFilter').addEventListener('change', ()=>{localStorage.setItem(LS_LAST_MONTH,$('#monthFilter').value); render();});
    $('#targetBtn').addEventListener('click', openTargetModal);

    // NEW: Unclaim center
    $('#unclaimBtn').addEventListener('click', openUnclaimModal);
    $('#tabPending').addEventListener('click', ()=>switchUcTab('pending'));
    $('#tabHistory').addEventListener('click', ()=>switchUcTab('history'));
  });

  function buildMonthOptions(){
    const sel=$('#monthFilter'); sel.innerHTML='';
    const months=new Set(readStore().map(r=>r.month)); months.add(toYYYYMM(new Date()));
    [...months].sort().reverse().forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=prettyMonth(m);sel.appendChild(o);});
    const last=localStorage.getItem(LS_LAST_MONTH);
    sel.value=(last && months.has(last))? last : toYYYYMM(new Date());
  }
  function autoSwitchToCurrentMonth(){
    const cur=toYYYYMM(new Date()); const last=localStorage.getItem(LS_LAST_MONTH);
    if(last!==cur){ $('#monthFilter').value=cur; localStorage.setItem(LS_LAST_MONTH,cur); }
  }
  const prettyMonth=yyyyMM=>{const [y,m]=yyyyMM.split('-').map(Number);return new Date(y,m-1,1).toLocaleDateString(undefined,{month:'long',year:'numeric'})};

  /* ----- Create/Edit ----- */
  function openModal(rec=null){
    editingId=rec?.id ?? null;
    $('#modalTitle').textContent=editingId?'Edit Record':'Create Record';
    $('#m_site').value=rec?.site || ($('#siteFilter').value==='ALL'?'5G88':$('#siteFilter').value);
    const dt=rec?new Date(rec.datetime):new Date();
    $('#m_dt').value=`${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
    $('#m_deposit').value=rec?.deposit ?? '';
    $('#m_withdrawal').value=rec?.withdrawal ?? '';
    $('#m_bonus').value=rec?.bonus ?? '';
    $('#m_forfeit').value=rec?.forfeit ?? '';
    $('#m_member').value=rec?.member ?? '';
    $('#m_resit').value=rec?.resit ?? '';
    $('#m_unclaim').value='';

    const autoCalc=()=>{$('#m_sales').value=(parseFloat($('#m_deposit').value||0)-parseFloat($('#m_withdrawal').value||0)).toFixed(2);};
    $('#m_deposit').oninput=autoCalc; $('#m_withdrawal').oninput=autoCalc; autoCalc();

    $('#modal').classList.add('show'); $('#saveBtn').onclick=saveModal;
  }
  const closeModal=()=>$('#modal').classList.remove('show');

  function collectModal(){
    const dt=parseLocalDT($('#m_dt').value);
    return{
      id: editingId ?? ('id_'+Date.now()+Math.random().toString(36).slice(2,7)),
      site: $('#m_site').value,
      datetime: dt.toISOString(), month: toYYYYMM(dt),
      deposit:+($('#m_deposit').value||0), withdrawal:+($('#m_withdrawal').value||0),
      bonus:+($('#m_bonus').value||0), forfeit:+($('#m_forfeit').value||0),
      member:parseInt($('#m_member').value||0,10), resit:+($('#m_resit').value||0),
      sales:+($('#m_sales').value||0),
      // NOTE: unclaim disimpan terpisah di LS_UNCLAIM
    };
  }

  function saveModal(){
    const rec=collectModal();
    const arr=readStore(); const i=arr.findIndex(x=>x.id===rec.id);
    if(i>=0) arr[i]=rec; else arr.push(rec);
    writeStore(arr);

    // NEW: jika user isi Unclaim Amount -> simpan pending item
    const ucAmt = safe($('#m_unclaim').value);
    if (ucAmt > 0) {
      const uc = readUnclaims();
      uc.push({
        id: 'uc_'+Date.now()+Math.random().toString(36).slice(2,6),
        recordId: rec.id,
        site: rec.site,
        month: rec.month,
        createdAt: new Date().toISOString(),
        amount: ucAmt,
        claimed: false,
        claimedAt: null
      });
      writeUnclaims(uc);
    }

    buildMonthOptions();
    if(rec.month===toYYYYMM(new Date())){ $('#monthFilter').value=rec.month; localStorage.setItem(LS_LAST_MONTH,rec.month); }
    closeModal(); render();
  }

  /* ----- Target Modal (Deposit, Resit, Sales) ----- */
  function openTargetModal(){
    const t=readTarget();
    renderTierEditor('#depTierList', t.depositTiers, 'Bonus Deposit');
    renderTierEditor('#resTierList', t.resitTiers, 'Bonus Resit');
    renderTierEditor('#salesTierList', t.salesTiers, 'Bonus Sales');
    $('#targetModal').classList.add('show');
    $('#addDepTier').onclick=()=>addTierRow('#depTierList');
    $('#addResTier').onclick=()=>addTierRow('#resTierList');
    $('#addSalesTier').onclick=()=>addTierRow('#salesTierList');
    $('#saveTargetBtn').onclick=saveTarget;
  }
  const closeTargetModal=()=>$('#targetModal').classList.remove('show');
  function renderTierEditor(sel, tiers, label){
    const box=$(sel); box.innerHTML='';
    const head=document.createElement('div'); head.className='tier-row';
    head.innerHTML=`<div class="hint" style="align-self:center">Threshold (≥)</div><div class="hint" style="align-self:center">${label}</div><div></div>`;
    box.appendChild(head);
    (tiers||[]).forEach(t=>addTierRow(sel,t.threshold,t.bonus));
  }
  function addTierRow(sel, threshold='', bonus=''){
    const box=$(sel); const row=document.createElement('div'); row.className='tier-row';
    row.innerHTML=`<input type="number" min="0" step="0.01" class="input" placeholder="e.g. 30000" value="${threshold}">
                   <input type="number" min="0" step="1" class="input" placeholder="e.g. 300" value="${bonus}">
                   <button class="rm">Remove</button>`;
    row.querySelector('.rm').onclick=()=>row.remove(); box.appendChild(row);
  }
  function saveTarget(){
    const readRows=sel=>{
      const rows=[...document.querySelectorAll(sel+' .tier-row')].slice(1);
      const out=[]; for(const r of rows){ const [th,bo]=r.querySelectorAll('input'); const thr=+th.value||0; const bon=+bo.value||0; if(thr>0&&bon>0) out.push({threshold:thr,bonus:bon}); }
      out.sort((a,b)=>a.threshold-b.threshold); return out;
    };
    const t={depositTiers:readRows('#depTierList'), resitTiers:readRows('#resTierList'), salesTiers:readRows('#salesTierList')};
    if(!t.depositTiers.length) t.depositTiers=[{threshold:8000,bonus:20}];
    if(!t.resitTiers.length)   t.resitTiers=[{threshold:250, bonus:30}];
    if(!t.salesTiers.length)   t.salesTiers=[{threshold:30000, bonus:300}];
    writeTarget(t);
    closeTargetModal();
    render();
  }

  /* ----- Render ----- */
  function render(){
    const site=$('#siteFilter').value, month=$('#monthFilter').value, targets=readTarget();
    const data=readStore().filter(r=>r.month===month).filter(r=>site==='ALL'?true:r.site===site)
      .sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));

    const uc = readUnclaims();
    const ucByRecord = {};
    for (const u of uc.filter(x=>x.month===month && (site==='ALL'||x.site===site))) {
  if (!ucByRecord[u.recordId]) ucByRecord[u.recordId] = {pending:0, claimed:0};
  if (u.claimed) ucByRecord[u.recordId].claimed += safe(u.amount);
  else           ucByRecord[u.recordId].pending += safe(u.amount);
}

    const cur=toYYYYMM(new Date()); const isArchive=month!==cur;
    $('#archiveBanner').style.display=isArchive?'inline-flex':'none';
    $('#bannerMonth').textContent=prettyMonth(month);

    const tb=$('#tbody'); tb.innerHTML='';
    let totals = {d:0,w:0,b:0,f:0,m:0,r:0,s:0,bd:0, br:0, bsBase:0,uDisp:0, uPending:0, uClaimed:0, uAll:0};

for (const r of data){
  const dt = dt24(r.datetime);

  // HITUNG BONUS DULU
  const bonusDep       = pickTierBonus(safe(r.deposit), targets.depositTiers);
  const bonusRes       = pickTierBonus(safe(r.resit),   targets.resitTiers);
  const bonusSalesBase = pickTierBonus(safe(r.sales),   targets.salesTiers);

  const ucs = ucByRecord[r.id] || {pending:0, claimed:0};
  const unclaimDisplay = safe(ucs.claimed) > 0 ? -safe(ucs.claimed) : safe(ucs.pending);

  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td>${dt}</td>
    <td style="text-align:center"><span class="pill ${r.site==='5G88'?'site-5g88':'site-spm888'}">${r.site}</span></td>
    <td class="${r.deposit < 0 ? 'num red' : 'num green'}">${fmtNum(r.deposit)}</td>
    <td class="num ${r.withdrawal === 0 ? '' : 'red'}">
      ${ r.withdrawal === 0 ? fmtNum(0) : ('-' + fmtNum(Math.abs(r.withdrawal))) }
    </td>
    <td>${fmtNum(r.resit)}</td>
    <td class="num cyan">${fmtNum(r.bonus)}</td>
    <td>${fmtNum(r.forfeit)}</td>
    <td>${fmtInt(r.member)}</td>
    <td class="${r.sales < 0 ? 'num red' : 'num green'}">${fmtNum(r.sales)}</td>
    <td class="num ${unclaimDisplay<0?'red':''}">${fmtNum(unclaimDisplay)}</td>
    <td>${bonusDep.toLocaleString()}</td>
    <td>${bonusRes.toLocaleString()}</td>
    <td>
      <div class="actions">
        <button class="iconbtn" onclick="window.__edit('${r.id}')">Edit</button>
        <button class="iconbtn del" onclick="window.__del('${r.id}')">Delete</button>
      </div>
    </td>`;
  tb.appendChild(tr);

  // totals
  totals.uPending += safe(ucs.pending);
  totals.uClaimed += safe(ucs.claimed);
  totals.uAll     += safe(ucs.pending) + safe(ucs.claimed);

  totals.d  += safe(r.deposit);
  totals.w  += safe(r.withdrawal);
  totals.b  += safe(r.bonus);
  totals.f  += safe(r.forfeit);
  totals.m  += safe(r.member);
  totals.r  += safe(r.resit);
  totals.s  += safe(r.sales);

  totals.bd += safe(bonusDep);
  totals.br += safe(bonusRes);
  totals.bsBase += safe(bonusSalesBase);
}
    $('#emptyState').style.display=data.length?'none':'block';
    totals.uDisp = safe(totals.uPending);
    // footer totals
    $('#ft_deposit').textContent   = fmtNum(totals.d);
    const wdTotalAbs = Math.abs(totals.w);
    $('#ft_withdrawal').textContent = wdTotalAbs === 0 ? fmtNum(0) : `-${fmtNum(wdTotalAbs)}`;
    $('#ft_bonus').textContent     = fmtNum(totals.b);
    $('#ft_forfeit').textContent   = fmtNum(totals.f);
    $('#ft_member').textContent    = fmtInt(totals.m);
    $('#ft_resit').textContent     = fmtNum(totals.r);
    $('#ft_sales').textContent     = fmtNum(totals.s);
    $('#ft_unclaim').textContent   = fmtNum(totals.uDisp);
    $('#ft_bonDep').textContent    = totals.bd.toLocaleString();
    $('#ft_bonRes').textContent    = totals.br.toLocaleString();

    const ftW = $('#ft_withdrawal');
    ftW.className=''; ftW.classList.add('num'); if (wdTotalAbs > 0) ftW.classList.add('red');

    const ftS = $('#ft_sales');
    ftS.className=''; ftS.classList.add('num'); if (totals.s < 0) ftS.classList.add('red'); else if (totals.s > 0) ftS.classList.add('green');

    const ftU = $('#ft_unclaim');
    ftU.className = 'num';

    renderSummaryRows(totals, data.length, site, month);
  }

function renderSummaryRows(t, count, site, month){
  $('#miniMonth').textContent = prettyMonth(month);
  $('#miniSite').textContent  = (site === 'ALL' ? 'All Sites' : site);

  const top = $('#summaryRowTop');
  top.innerHTML = '';

  [
    { title: 'Total Deposit',  val: fmtNum(t.d), cls: 'green' },
    { title: 'Total Withdrawal', val: t.w === 0 ? fmtNum(0) : `-${fmtNum(Math.abs(t.w))}`, cls: 'red' },
    { title: 'Total Bonus',    val: fmtNum(t.b), cls: 'cyan' },
    { title: 'Total Sales',    val: fmtNum(t.s), cls: t.s < 0 ? 'red' : 'green' },
    { title: 'Total Forfeit',  val: fmtNum(t.f) },
    { title: 'Total Resit In', val: fmtNum(t.r) },
    { title: 'Total Unclaim (Σ)', val: fmtNum(t.uDisp) },
    { title: 'Total Member',   val: fmtInt(t.m) },
    { title: 'Records',        val: count.toLocaleString() },
  ].forEach(c => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls || ''}">${c.val}</div>`;
    top.appendChild(d);
  });

  const bottom = $('#summaryRowBottom');
  bottom.innerHTML = '';

  const halfDep   = t.bd / 2;
  const halfRes   = t.br / 2;
  const salesOnly = t.bsBase;
  const totalAmt  = halfDep + halfRes + salesOnly;

 const items = [
  { title: 'Unclaim Σ',  val: fmtNum(t.uAll),     cls: t.uAll > 0 ? 'green' : '' },
  { title: 'Claimed Σ',  val: fmtNum(t.uClaimed), cls: '' },

  { title: 'Bonus Deposit ½ Σ', val: halfDep.toLocaleString() },
  { title: 'Bonus Resit ½ Σ',   val: halfRes.toLocaleString() },
  { title: 'Bonus Sales Σ',     val: salesOnly.toLocaleString() },
  { title: 'Total Bonus Σ',     val: totalAmt.toLocaleString() },
];

  items.forEach(c => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<h4>${c.title}</h4><div class="val ${c.cls || ''}">${c.val}</div>`;
    bottom.appendChild(d);
  });
}

  function delRecord(id){
    if(!confirm('Delete this record?')) return;
    writeStore(readStore().filter(r=>r.id!==id));
    // Hapus unclaim terkait record
    writeUnclaims(readUnclaims().filter(u=>u.recordId!==id));
    render();
  }

  function exportCSV(){
    const site=$('#siteFilter').value, month=$('#monthFilter').value, t=readTarget();
    const data=readStore().filter(r=>r.month===month).filter(r=>site==='ALL'?true:r.site===site)
      .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
    const header=['datetime','site','deposit','withdrawal','bonus','forfeit','member','resit_in','sales','bonus_deposit','bonus_resit','bonus_sales_base'];
    const rows=[header.join(',')];
    for(const r of data){
      const bDep=pickTierBonus(r.deposit, t.depositTiers);
      const bRes=pickTierBonus(r.resit,   t.resitTiers);
      const bSales=pickTierBonus(r.sales, t.salesTiers);
      rows.push([new Date(r.datetime).toISOString(), r.site, r.deposit, r.withdrawal, r.bonus, r.forfeit, r.member, r.resit, r.sales, bDep, bRes, bSales].join(','));
    }
    const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`bonus-${month}-${site}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* ---------------- UNCLAIM CENTER ---------------- */
  function openUnclaimModal(){
    $('#unclaimModal').classList.add('show');
    switchUcTab(ucActiveTab);
  }
  function closeUnclaimModal(){ $('#unclaimModal').classList.remove('show'); }

  function switchUcTab(which){
    ucActiveTab = which;
    $('#tabPending').classList.toggle('active', which==='pending');
    $('#tabHistory').classList.toggle('active', which==='history');
    renderUnclaimList(which);
  }

function renderUnclaimList(which = 'pending'){
  const site  = $('#siteFilter').value;
  const month = $('#monthFilter').value;

  const uc      = readUnclaims().filter(x => x.month === month && (site === 'ALL' || x.site === site));
  const records = Object.fromEntries(readStore().map(r => [r.id, r]));

  const list = $('#ucList');
  list.innerHTML = '';

  // Pending: tampilkan SEMUA item (pending + claimed)
  // History: hanya item yang sudah claimed
  const items = (which === 'history' ? uc.filter(x => x.claimed) : uc.slice())
    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  if (!items.length){
    const e = document.createElement('div');
    e.className = 'empty';
    e.textContent = (which === 'history') ? 'Belum ada riwayat claim.' : 'Belum ada Unclaim.';
    list.appendChild(e);
    return;
  }

  for (const u of items){
    const rec      = records[u.recordId];
    const recDt    = rec ? dt24(rec.datetime) : '-';
    const created  = dt24(u.createdAt);
    const claimedAt= u.claimedAt ? dt24(u.claimedAt) : '-';

    // 👉 Atur tampilan berdasarkan TAB:
    // - Di PENDING: item yang sudah claimed TETAP tampil seperti pending (tanpa label "Claimed", amount positif)
    // - Di HISTORY: item claimed tampil merah & ada label "Claimed: ..."
    const isHistoryView = (which === 'history');
    const showClaimBtn  = (!u.claimed && !isHistoryView); // tombol hanya muncul di Pending & belum claimed
    const showClaimedLine = (u.claimed && isHistoryView);

    const displayAmount = (u.claimed && isHistoryView) ? ('-' + fmtNum(u.amount)) : fmtNum(u.amount);
    const amtCls = (u.claimed && isHistoryView) ? 'uc-amt red' : 'uc-amt';

    const row = document.createElement('div');
    row.className = 'uc-item';
    row.innerHTML = `
      <div>${created}</div>
      <div><span class="pill ${u.site==='5G88' ? 'site-5g88' : 'site-spm888'}">${u.site}</span></div>
      <div>Record Date: ${recDt}</div>
      <div class="${amtCls}">${displayAmount}</div>
      <div>${showClaimedLine ? ('Claimed: ' + claimedAt) : ''}</div>
      <div style="text-align:right">
        ${showClaimBtn ? `<button class="btn" style="height:32px" onclick="claimUnclaim('${u.id}')">Claim</button>` : ''}
      </div>
    `;
    list.appendChild(row);
  }
}

  // Claim logic: tambah ke Deposit record, update Sales, tandai unclaim claimed & timestamp
function claimUnclaim(ucId){
  const ucAll = readUnclaims();
  const idx = ucAll.findIndex(x=>x.id===ucId);
  if (idx < 0) return;

  const item = ucAll[idx];
  if (item.claimed) return;

  // update record (pakai safe)
  const recs = readStore();
  const ri = recs.findIndex(r=>r.id===item.recordId);
  if (ri >= 0){
    recs[ri].deposit = safe(recs[ri].deposit) + safe(item.amount);
    recs[ri].sales   = safe(recs[ri].deposit) - safe(recs[ri].withdrawal);
    writeStore(recs);
  }

  // tandai claimed
  item.claimed = true;
  item.claimedAt = new Date().toISOString();
  ucAll[idx] = item;
  writeUnclaims(ucAll);

  // refresh ringkasan + list
  render();

 // ⬇️ Tambahkan blok ini (gantikan blok lama yang cuma switchUcTab('history'))
  if ($('#unclaimModal').classList.contains('show')) {
    switchUcTab('history');     // langsung tampil di tab History
    const list = $('#ucList');  // scroll ke atas biar item baru kelihatan
    if (list) list.scrollTop = 0;
  }
}
  // SAFE edit/delete (hindari JSON di onclick)
window.__edit = (id) => {
  const rec = readStore().find(x => x.id === id);
  if (rec) openModal(rec);
};
window.__del  = (id) => delRecord(id);
  // helpers exposed
  window.openModal=openModal; window.closeModal=closeModal; window.delRecord=delRecord;
  window.openTargetModal=openTargetModal; window.closeTargetModal=closeTargetModal;
  window.openUnclaimModal=openUnclaimModal; window.closeUnclaimModal=closeUnclaimModal;
  window.claimUnclaim=claimUnclaim;
</script>
</body>
</html>
