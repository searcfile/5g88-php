<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bonus-Login</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --bg1:#0a0f1d; --bg2:#0d1326; --card:#0b1220cc;
  --text:#e5e7eb; --muted:#9fb2d0; --sub:#cbd5e1;
  --ok:#10b981; --danger:#ef4444;
  --primary:#1668dc; --primary-2:#3c89e8; --primary-3:#1554ad;
  --ring: 0 0 0 3px rgba(22,104,220,.25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1200px 800px at 10% -10%, #1b2a55 0%, transparent 60%),
    radial-gradient(900px 700px at 110% 10%, #2b134f 0%, transparent 55%),
    linear-gradient(160deg, var(--bg1), var(--bg2));
  /* center penuh */
  min-height:100svh;
  display:grid; place-items:center;
  padding:24px;
}

/* ====== LAYOUT ====== */
.wrap{
  width:100%;
  max-width: 520px;                  /* agar tidak terlalu lebar di layar besar */
  height:100%;
  display:flex;
  justify-content:center;
  align-items:center;                /* pusat vertikal */
  margin-inline:auto;
}
/* === Actions: Back + Request (rapi, match lebar input) === */
.row-split{
  display:flex;
  gap:12px;                /* jarak antar tombol */
  align-items:stretch;     /* tinggi konsisten */
}

.row-split > *{
  flex:1 1 0;              /* bagi rata, sama lebar, penuh mengikuti form */
  min-width:140px;         /* jaga agar tidak terlalu kecil */
}

/* Mobile: kalau sempit, tombol turun jadi 2 baris, full width */
@media (max-width: 480px){
  .row-split{
    flex-direction:column;
  }
  .row-split > *{
    width:100%;
    min-width:0;
  }
}
/* ====== KARTU LOGIN ====== */
.card{
  width:100%;
  max-width:420px;
  border:1px solid #223049;
  background:linear-gradient(180deg,#0e1629,#0a1020);
  border-radius:16px;
  padding:22px;
  position:relative;
  overflow:hidden;
  box-shadow:
    0 12px 40px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.03);
}

/* ====== FORM ====== */
form{ display:grid; gap:12px; }
.row{ display:grid; gap:8px; }
label{ font-size:13px; color:var(--sub); }
input{
  height:44px;
  border-radius:8px;
  border:1px solid #2b3653;
  background:#0e1728;
  color:#e5e7eb;
  padding:0 12px;
  outline:none;
  transition:border-color .2s, box-shadow .2s, background-color .2s;
}
input::placeholder{ color:var(--muted); opacity:.95; }
input:hover{ border-color: var(--primary-2); }
input:focus{
  border-color: var(--primary);
  box-shadow: var(--ring);
  background:#0f1a2f;
}

/* input + tombol mata */
.field{ position:relative; }
.field input{ width:100%; padding-right:44px; }
.eye{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:32px; height:32px; display:grid; place-items:center;
  background:transparent; border:0; color:#ffffff; cursor:pointer;
}
.eye:hover{ color:#ffffff; }
.eye svg{ display:block; }

/* helper baris bawah */
.helper{
  display:flex; justify-content:space-between; align-items:center;
  gap:10px; flex-wrap:wrap;
}
.helper a{ color:var(--primary); text-decoration:none; font-size:13px }
.helper a:hover{ text-decoration:underline; color:var(--primary-2); }
.helper a:active{ color:var(--primary-3); }

/* tombol */
.btn{
  height:44px; border-radius:8px;
  background: var(--primary); color:#fff;
  font-weight:700; letter-spacing:.3px; cursor:pointer;
  border:none; transition:transform .06s ease, background .15s ease;
}
.btn:hover{ background: var(--primary-2); }
.btn:active{ background: var(--primary-3); transform: translateY(1px); }

.btn-ghost{
  height:44px; border-radius:8px;
  border:1px solid #2b3653; background:#0e1728; color:#cbd5e1;
  cursor:pointer; transition:border-color .15s, background .15s;
}
.btn-ghost:hover{ border-color:#3c89e8; background:#102036;color:#3c89e8; }.btn-ghost:active{ border-color:#1554ad;color:#1554ad; }

/* util */
.small{ font-size:12px; color:var(--muted) }
.hidden{ display:none !important }

/* toast */
.toast{
  position:fixed; bottom:26px; left:50%; transform:translateX(-50%);
  background:#0b1220f0; border:1px solid #2b3653; color:#dbe7ff;
  padding:12px 16px; border-radius:10px; box-shadow:0 10px 40px rgba(0,0,0,.4);
  opacity:0; transition:opacity .3s ease; z-index:9999; min-width:260px; text-align:center;
}
.toast.show{ opacity:1 }
</style>
</head>
<body>
<div class="wrap">
  <!-- Right: auth card -->
  <section class="card">
    <!-- LOGIN -->
    <form id="form-login" data-panel="login" autocomplete="on">
      <div class="row">
        <label for="u">Username</label>
        <input id="u" name="u" type="text" placeholder="Username" required>
      </div>
<div class="row">
  <label for="password">Password</label>
  <div class="field">
    <input id="password"
           name="password"
           type="password"
           placeholder="Password"
           minlength="6"
           required>
    <button type="button"
            id="togglePw"
            class="eye"
            aria-label="Tampilkan password"
            aria-pressed="false"></button>
  </div>
</div>
      <div class="helper">
        <span class="small">Login with you username password.</span>
        <a href="#" data-goto="forgot">Lupa password?</a>
      </div>
      <button class="btn" type="submit">Login</button>
    </form>

    <!-- FORGOT (tanpa email) -->
    <form id="form-forgot" class="hidden" data-panel="forgot" autocomplete="off">
      <div class="row">
        <label for="fu">Username</label>
        <input id="fu" type="text" placeholder="Username" required>
      </div>
      <div class="row">
        <label for="fnotes">Notes (optional)</label>
        <input id="fnotes" type="text" placeholder="(optional)">
        <span class="small">Click button request.</span>
      </div>
      <div class="row-split">
        <button type="button" class="btn-ghost" data-goto="login">Back</button>
        <button class="btn" type="submit">Request</button>
      </div>
    </form>

    <!-- CHANGE PASSWORD (setelah login) -->
    <form id="form-changepw" class="hidden" data-panel="changepw" autocomplete="off">
      <div class="row">
        <label for="cp-old">Wrong password</label>
        <input id="cp-old" type="password" placeholder="old password" required>
      </div>
      <div class="row-split">
        <div class="row">
          <label for="cp-new">New password</label>
          <input id="cp-new" type="password" placeholder="min 6 letter" minlength="6" required>
        </div>
        <div class="row">
          <label for="cp-re">Confirm password</label>
          <input id="cp-re" type="password" placeholder="confirm password" minlength="6" required>
        </div>
      </div>
      <div class="row-split">
        <button type="button" class="btn-ghost" data-goto="login">Back</button>
        <button class="btn" type="submit">Save password</button>
      </div>
      <div id="cp-user" class="small" style="margin-top:8px"></div>
    </form>

  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script type="text/javascript">
"use strict";
var REDIRECT_URL = "https://searcfile.github.io/5g88-php/sitebonus/";
var USER_DOMAIN  = "@5g88.local";

var firebaseConfig = {
  apiKey: "AIzaSyAvuHrjMwlz3cnTa9eTqDQaAPasjtFa4us",
  authDomain: "bonus-5c5e0.firebaseapp.com",
  projectId: "bonus-5c5e0",
  storageBucket: "bonus-5c5e0.appspot.com",
  messagingSenderId: "781993203912",
  appId: "1:781993203912:web:704d36f814c6247bf62dfd",
  databaseURL: "https://bonus-5c5e0-default-rtdb.asia-southeast1.firebasedatabase.app"
};

if (!firebase.apps || !firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
var auth = firebase.auth();
var db   = firebase.database();

/* =========================
   HELPERS UI
========================= */
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }

function toast(msg, type){
  if (type === void 0) type = "info";
  var el = $("#toast");
  if (!el) { alert(msg); return; }
  el.textContent = msg;
  el.style.borderColor = (type === "error") ? "#ef4444" : (type === "success" ? "#10b981" : "#2b3653");
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(function(){ el.classList.remove("show"); }, 2600);
}

function gotoTab(name){
  $all("[data-panel]").forEach(function(p){ p.classList.toggle("hidden", p.getAttribute("data-panel") !== name); });
  $all(".tab").forEach(function(t){ t.setAttribute("aria-selected", (t.getAttribute("data-tab") === name) ? "true" : "false"); });
}
$all(".tab").forEach(function(btn){ btn.addEventListener("click", function(){ gotoTab(btn.getAttribute("data-tab")); }); });
$all("[data-goto]").forEach(function(a){ a.addEventListener("click", function(e){ e.preventDefault(); gotoTab(a.getAttribute("data-goto")); }); });

/* =========================
   USERNAME SANITIZE & PSEUDO EMAIL
========================= */
var USER_RE = /^[a-z0-9_-]{3,30}$/;
function sanitizeUsername(u){
  u = (u || "").toLowerCase();
  return u.replace(/\s+/g,'').replace(/[^a-z0-9_-]/g,'');
}
function toPseudoEmail(username){
  var u = sanitizeUsername(username);
  return u ? (u + USER_DOMAIN) : "";
}
function getUsernameFromUser(u){
  var em = (u && u.email) ? u.email : "";
  return em.slice(-USER_DOMAIN.length) === USER_DOMAIN
    ? em.slice(0, -USER_DOMAIN.length)
    : (u && u.displayName) ? u.displayName : em;
}

/* =========================
   BRUTE FORCE LIMIT (persist)
========================= */
var failCount = Number(localStorage.getItem('login.fails') || 0);
var lockUntil = Number(localStorage.getItem('login.lockUntil') || 0);

function canTry(){
  var now = Date.now();
  if (now < lockUntil){
    var sec = Math.ceil((lockUntil - now)/1000);
    toast("Too many attempts. Try again in " + sec + "s.", "error");
    return false;
  }
  return true;
}
function registerFail(){
  failCount++; localStorage.setItem('login.fails', String(failCount));
  if (failCount % 5 === 0){
    lockUntil = Date.now() + 30000;
    localStorage.setItem('login.lockUntil', String(lockUntil));
    toast("Too many attempts. Try again in 30 seconds.", "error");
  }
}
function clearFail(){
  failCount = 0; lockUntil = 0;
  localStorage.removeItem('login.fails');
  localStorage.removeItem('login.lockUntil');
}

/* =========================
   URL PARAM ?tab=...
========================= */
var urlTab = null;
try { urlTab = new URLSearchParams(location.search).get("tab"); }
catch(_e){
  var qs = location.search.replace(/^\?/,'').split('&');
  for (var i=0;i<qs.length;i++){
    var kv = qs[i].split('=');
    if (decodeURIComponent(kv[0]||'') === 'tab'){ urlTab = decodeURIComponent(kv[1]||''); break; }
  }
}
if (urlTab && ["login","forgot","changepw"].indexOf(urlTab) >= 0) gotoTab(urlTab);

/* =========================
   AUTH STATE (tanpa write ke /uids /usernames)
========================= */
auth.onAuthStateChanged(function(user){
  var tabChange = document.querySelector('.tab[data-tab="changepw"]');
  var isLogged  = !!user;
  if (tabChange) tabChange.classList.toggle('hidden', !isLogged);

  if (isLogged){
    var cpUser = $("#cp-user");
    if (cpUser) cpUser.textContent = "Log in as: " + getUsernameFromUser(user);
    if (urlTab === 'changepw') gotoTab('changepw');
  }else{
    var curBtn = document.querySelector('.tab[aria-selected="true"]');
    var curTab = curBtn ? curBtn.getAttribute('data-tab') : 'login';
    if (curTab === 'changepw') gotoTab('login');
  }
});

/* =========================
   INPUT (lowercase otomatis)
========================= */
var uEl = $("#u");
if (uEl){
  uEl.addEventListener("input", function(e){
    var pos = e.target.selectionStart||0;
    e.target.value = sanitizeUsername(e.target.value);
    try { e.target.setSelectionRange(pos, pos); } catch(_e){}
  });
}
var fuEl = $("#fu");
if (fuEl){
  fuEl.addEventListener("input", function(e){
    var pos = e.target.selectionStart||0;
    e.target.value = sanitizeUsername(e.target.value);
    try { e.target.setSelectionRange(pos, pos); } catch(_e){}
  });
}

/* =========================
   LOGIN (tanpa tulis /uids & /usernames)
========================= */
var loginForm = $("#form-login");
if (loginForm){
  loginForm.addEventListener("submit", async function(e){
    e.preventDefault();
    if (!canTry()) return;
    if (!navigator.onLine){ toast("Offline. Check your internet connection.", "error"); return; }

    var btn = e.submitter || e.target.querySelector('button[type="submit"]');
    var old = btn ? btn.textContent : '';
    if (btn){ btn.disabled = true; btn.textContent = 'Processing…'; }

    try{
      var u = sanitizeUsername(($("#u") && $("#u").value) || "");
      var p = ($("#password") && $("#password").value) || "";

      if (!u || !p) throw { code:"missing" };
      if (!USER_RE.test(u)) throw { code:"bad-username" };

      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithEmailAndPassword(toPseudoEmail(u), p);

      clearFail();
      toast("Login successful. Redirecting…", "success");
      setTimeout(function(){ location.href = REDIRECT_URL; }, 200);
    } catch(err){
      registerFail();
      var code = String(err && err.code || "");
      var msg="Login failed.";
      if (code === "missing") msg="Lengkapi username & password.";
      else if (code === "bad-username") msg="Format username salah (3–30: a–z 0–9 . _ -).";
      else if (code.indexOf("user-not-found")>=0) msg="Username not found.";
      else if (code.indexOf("wrong-password")>=0 || code.indexOf("invalid-credential")>=0) msg="Incorrect password.";
      else if (code.indexOf("too-many-requests")>=0) msg="Too many attempts. Please try again later.";
      else if (code.indexOf("network-request-failed")>=0) msg="Network problem. Please try again.";
      console.error(err);
      toast(msg, "error");
    } finally {
      if (btn){ btn.disabled=false; btn.textContent=old; }
    }
  });
}

/* =========================
   LUPA PASSWORD (request ke admin) — pakai waktu server
========================= */
var forgotForm = $("#form-forgot");
if (forgotForm){
  forgotForm.addEventListener("submit", function(e){
    e.preventDefault();
    var u = sanitizeUsername(($("#fu") && $("#fu").value) || "");
    var notes = (($("#fnotes") && $("#fnotes").value) || "").trim();

    if (!u){ toast("Isi username.", "error"); return; }
    if (!USER_RE.test(u)){ toast("Format username salah (3–30: a–z 0–9 . _ -).", "error"); return; }

    var payload = {
      username: u,
      pseudoEmail: toPseudoEmail(u),
      notes: notes || null,
      ts: firebase.database.ServerValue.TIMESTAMP, // ⬅ waktu server
      status: "pending"
    };
    var key = String(Date.now()) + "_" + u;

    db.ref("reset_requests").child(key).set(payload).then(function(){
      toast("Reset request has been sent to admin.", "success");
      if ($("#fu")) $("#fu").value="";
      if ($("#fnotes")) $("#fnotes").value="";
    }).catch(function(){
      toast("Unable to send request. Please try again.", "error");
    });
  });
}

/* =========================
   GANTI PASSWORD (reauth)
========================= */
var changeForm = $("#form-changepw");
if (changeForm){
  changeForm.addEventListener("submit", function(e){
    e.preventDefault();
    var user = auth.currentUser;
    if (!user){ toast("Please login first.", "error"); return; }

    var btn = e.submitter || e.target.querySelector('button[type="submit"]');
    var old = btn ? btn.textContent : '';
    if (btn){ btn.disabled = true; btn.textContent = 'Save…'; }

    var oldP = ($("#cp-old") && $("#cp-old").value) || "";
    var newP = ($("#cp-new") && $("#cp-new").value) || "";
    var reP  = ($("#cp-re")  && $("#cp-re").value)  || "";

    if (newP !== reP){ toast("Konfirmasi password baru tidak sama.", "error"); if(btn){btn.disabled=false;btn.textContent=old;} return; }
    if (newP.length < 8){ toast("Password baru minimal 8 karakter.", "error"); if(btn){btn.disabled=false;btn.textContent=old;} return; }

    var cred = firebase.auth.EmailAuthProvider.credential(user.email, oldP);
    user.reauthenticateWithCredential(cred).then(function(){
      return user.updatePassword(newP);
    }).then(function(){
      return auth.signOut();
    }).then(function(){
      toast("Password changed successfully. Please log in again.", "success");
      if ($("#cp-old")) $("#cp-old").value = "";
      if ($("#cp-new")) $("#cp-new").value = "";
      if ($("#cp-re"))  $("#cp-re").value  = "";
      gotoTab("login");
    }).catch(function(err){
      var code = String(err && err.code || "");
      var msg = "Error change password.";
      if (code.indexOf("wrong-password")>=0 || code.indexOf("invalid-credential")>=0) msg = "Password wrong.";
      toast(msg, "error");
    }).finally(function(){
      if (btn){ btn.disabled=false; btn.textContent=old; }
    });
  });
}

/* =========================
   PASSWORD INPUT (validasi + eye toggle)
========================= */
var pw  = document.getElementById('password');
if (pw){
  pw.addEventListener('invalid', function(){
    if (pw.validity.valueMissing) pw.setCustomValidity('Please fill password.');
    else if (pw.validity.tooShort) pw.setCustomValidity('Password minimum 6 letter.');
    else pw.setCustomValidity('');
  });
  pw.addEventListener('input', function(){ pw.setCustomValidity(''); });
}

var btnEye = document.getElementById('togglePw');
if (pw && btnEye) {
  // ❗ Ikut warna dari CSS: .eye { color: ... }
  var eyeOpen =
    '<svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" fill="currentColor" focusable="false">' +
      '<path d="M15 12c0 1.654-1.346 3-3 3s-3-1.346-3-3 1.346-3 3-3 3 1.346 3 3zm9-.449s-4.252 8.449-11.985 8.449c-7.18 0-12.015-8.449-12.015-8.449s4.446-7.551 12.015-7.551c7.694 0 11.985 7.551 11.985 7.551zm-7 .449c0-2.757-2.243-5-5-5s-5 2.243-5 5 2.243 5 5 5 5-2.243 5-5z"></path>' +
    '</svg>';

  var eyeOff =
    '<svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" fill="currentColor" focusable="false">' +
      '<path d="M11.885 14.988l3.104-3.098.011.11c0 1.654-1.346 3-3 3l-.115-.012zm8.048-8.032l-3.274 3.268c.212.554.341 1.149.341 1.776 0 2.757-2.243 5-5 5-.631 0-1.229-.13-1.785-.344l-2.377 2.372c1.276.588 2.671.972 4.177.972 7.733 0 11.985-8.449 11.985-8.449s-1.415-2.478-4.067-4.595zm1.431-3.536l-18.619 18.58-1.382-1.422 3.455-3.447c-3.022-2.45-4.818-5.58-4.818-5.58s4.446-7.551 12.015-7.551c1.825 0 3.456.426 4.886 1.075l3.081-3.075 1.382 1.42zm-13.751 10.922l1.519-1.515c-.077-.264-.132-.538-.132-.827 0-1.654 1.346-3 3-3 .291 0 .567.055.833.134l1.518-1.515c-.704-.382-1.496-.619-2.351-.619-2.757 0-5 2.243-5 5 0 .852.235 1.641.613 2.342z"></path>' +
    '</svg>';

  function refreshIcon(){
    var showing = (pw.type === 'text');
    btnEye.innerHTML = showing ? eyeOff : eyeOpen;
    btnEye.setAttribute('aria-pressed', String(showing));
    btnEye.setAttribute('aria-label', showing ? 'Sembunyikan password' : 'Tampilkan password');
    btnEye.classList.toggle('showing', showing); // optional: buat state warna
  }

  btnEye.addEventListener('click', function(){
    pw.type = (pw.type === 'password') ? 'text' : 'password';
    refreshIcon();
  });

  refreshIcon();
}
</script>
</body>
</html>
