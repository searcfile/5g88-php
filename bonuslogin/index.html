<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Secure Login â€” Username Only</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg1:#0a0f1d; --bg2:#0d1326; --card:#0b1220cc;
    --text:#e5e7eb; --muted:#9fb2d0; --sub:#cbd5e1;
    --gold:#ffd166; --gold-2:#ffcf4d; --ok:#10b981; --danger:#ef4444;
    --ring:0 0 0 3px rgba(255,209,102,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 800px at 10% -10%, #1b2a55 0%, transparent 60%),
      radial-gradient(900px 700px at 110% 10%, #2b134f 0%, transparent 55%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    display:grid; place-items:center; padding:24px;
  }
  .wrap{ width:min(980px,100%); display:grid; grid-template-columns: 1.05fr .95fr; gap:18px; }
  @media (max-width:860px){ .wrap{ grid-template-columns:1fr; } }

  .brand{
    border:1px solid #1f2937; background:linear-gradient(180deg,#0e1629,#0a1020);
    border-radius:16px; padding:26px 26px 16px; position:relative; overflow:hidden;
    box-shadow:0 15px 50px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
  }
  .brand .glow{
    position:absolute; inset:-40%; background:
      radial-gradient(closest-side, rgba(34,211,238,.12), transparent 70%) top left/60% 60% no-repeat,
      radial-gradient(closest-side, rgba(167,139,250,.14), transparent 70%) 90% 10%/45% 45% no-repeat;
    filter: blur(16px); pointer-events:none;
  }
  .brand h1{
    margin:0 0 8px; font-size:28px; letter-spacing:.4px; font-weight:800;
    background: linear-gradient(90deg, #fff, #ffe9a6);
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .brand p{ margin:0; color:var(--muted) }
  .badge{
    margin-top:14px; display:inline-flex; align-items:center; gap:8px;
    border:1px solid #2a2a2a; background:#0f172acc; padding:8px 12px; border-radius:999px; font-size:13px;
  }

  .card{
    border:1px solid #223049; background:var(--card);
    border-radius:16px; padding:22px; position:relative; overflow:hidden;
    box-shadow:0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
  }

  .tabs{ display:flex; gap:6px; margin-bottom:14px; }
  .tab{
    height:38px; padding:0 12px; border-radius:10px; border:1px solid #2a3550; background:#0f172a;
    color:#cbd5e1; cursor:pointer; display:inline-flex; align-items:center; gap:8px; user-select:none;
  }
  .tab[aria-selected="true"]{
    color:#0a0a0a; border-color:#b58900; background: linear-gradient(180deg,var(--gold),var(--gold-2));
    font-weight:700;
  }

  form{ display:grid; gap:12px; }
  .row{ display:grid; gap:8px; }
  label{ font-size:13px; color:var(--sub); }
  input{
    height:44px; border-radius:8px; border:1px solid #2b3653; background:#0e1728;
    color:#e5e7eb; padding:0 12px; outline:none;transition: all 0.2s
  }
  input:hover{ border-color:#3c89e8 }input:focus{ border-color:#1668dc }input:active{ border-color:#1554ad }

  .btn{
    height:44px; border-radius:8px;
    background: #1668dc; color:#fff;
    font-weight:700; letter-spacing:.3px; cursor:pointer; transition:.15s;border:none;
  }
  .btn:hover{ background:#3c89e8; }.btn:active{ background:#1554ad; }

  .btn-ghost{
    height:44px; border-radius:8px; border:1px solid #2b3653; background:#0e1728; color:#cbd5e1;
    cursor:pointer;
  }

  .row-split{ display:flex; gap:10px }
  .row-split > *{ flex:1 }
  .helper{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .helper a{ color:#1668dc; text-decoration:none; font-size:13px }
  .helper a:hover{ text-decoration:underline;color:#3c89e8; }.helper a:active{ text-decoration:underline;color:#1554ad; }

  .hint{ font-size:12px; color:var(--muted) }
  .small{ font-size:12px; color:var(--muted) }
  .hidden{ display:none !important }

  .toast{
    position:fixed; bottom:26px; left:50%; transform:translateX(-50%);
    background:#0b1220f0; border:1px solid #2b3653; color:#dbe7ff;
    padding:12px 16px; border-radius:10px; box-shadow:0 10px 40px rgba(0,0,0,.4);
    opacity:0; transition:opacity .3s ease; z-index:9999; min-width:260px; text-align:center;
  }
  .toast.show{ opacity:1 }
.field{ position:relative; }
.field input{
  width:100%;
  padding-right:44px;          /* ruang untuk tombol mata di kanan */
}
.field input::placeholder{ color: var(--muted); opacity:.95; }
#u::placeholder { color: var(--muted); opacity:.95; }

/* tombol mata (ini boleh tetap) */
.eye{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:32px; height:32px; display:grid; place-items:center;
  background:transparent; border:0; color:#1668dc; cursor:pointer;
}
.eye:hover{ color:#ffffff; }
.eye svg{ display:block; }
</style>
</head>
<body>
<div class="wrap">
  <!-- Left: brand -->
  <section class="brand">
    <div class="glow"></div>
    <h1>Selamat datang ðŸ‘‹</h1>
    <p>Login dengan <b>Username & Password</b> untuk masuk ke halaman admin.</p>
    <div class="badge">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z" stroke="#ffd166" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="#ffd166" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Protected by Firebase Authentication</span>
    </div>
  </section>

  <!-- Right: auth card -->
  <section class="card">
    <!-- LOGIN -->
    <form id="form-login" data-panel="login" autocomplete="on">
      <div class="row">
        <label for="u">Username</label>
        <input id="u" name="u" type="text" placeholder="Username" required>
      </div>
<div class="row">
  <label for="password">Password</label>
  <div class="field">
    <input id="password"
           name="password"
           type="password"
           placeholder="Password"
           minlength="6"
           required>
    <button type="button"
            id="togglePw"
            class="eye"
            aria-label="Tampilkan password"
            aria-pressed="false"></button>
  </div>
</div>
      <div class="helper">
        <span class="small">Login with you username password.</span>
        <a href="#" data-goto="forgot">Lupa password?</a>
      </div>
      <button class="btn" type="submit">Login</button>
    </form>

    <!-- FORGOT (tanpa email) -->
    <form id="form-forgot" class="hidden" data-panel="forgot" autocomplete="off">
      <div class="row">
        <label for="fu">Username</label>
        <input id="fu" type="text" placeholder="username register" required>
      </div>
      <div class="row">
        <label for="fnotes">Catatan (opsional)</label>
        <input id="fnotes" type="text" placeholder="Caption.">
        <label for="fu">aaaaa</label>
      </div>
      <div class="row-split">
        <button type="button" class="btn-ghost" data-goto="login">Back</button>
        <button class="btn" type="submit">Request</button>
      </div>
    </form>

    <!-- CHANGE PASSWORD (setelah login) -->
    <form id="form-changepw" class="hidden" data-panel="changepw" autocomplete="off">
      <div class="row">
        <label for="cp-old">Password Saat Ini</label>
        <input id="cp-old" type="password" placeholder="password lama" required>
      </div>
      <div class="row-split">
        <div class="row">
          <label for="cp-new">Password Baru</label>
          <input id="cp-new" type="password" placeholder="min 8 karakter" minlength="8" required>
        </div>
        <div class="row">
          <label for="cp-re">Ulangi Password Baru</label>
          <input id="cp-re" type="password" placeholder="ulangi lagi" minlength="8" required>
        </div>
      </div>
      <div class="row-split">
        <button type="button" class="btn-ghost" data-goto="login">Kembali</button>
        <button class="btn" type="submit">Simpan Password</button>
      </div>
      <div id="cp-user" class="small" style="margin-top:8px"></div>
    </form>

  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script type="text/javascript">
"use strict";
var REDIRECT_URL = "https://searcfile.github.io/5g88-php/sitebonus/";
var USER_DOMAIN  = "@5g88.local";

var firebaseConfig = {
  apiKey: "AIzaSyAvuHrjMwlz3cnTa9eTqDQaAPasjtFa4us",
  authDomain: "bonus-5c5e0.firebaseapp.com",
  projectId: "bonus-5c5e0",
  storageBucket: "bonus-5c5e0.appspot.com",
  messagingSenderId: "781993203912",
  appId: "1:781993203912:web:704d36f814c6247bf62dfd",
  databaseURL: "https://bonus-5c5e0-default-rtdb.asia-southeast1.firebasedatabase.app"
};

if (!firebase.apps || !firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
var auth = firebase.auth();
var db   = firebase.database();

/* =========================
   HELPERS UI
========================= */
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }

function toast(msg, type){
  if (type === void 0) type = "info";
  var el = $("#toast");
  if (!el) { alert(msg); return; }
  el.textContent = msg;
  el.style.borderColor = (type === "error") ? "#ef4444" : (type === "success" ? "#10b981" : "#2b3653");
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(function(){ el.classList.remove("show"); }, 2600);
}

function gotoTab(name){
  $all("[data-panel]").forEach(function(p){ p.classList.toggle("hidden", p.getAttribute("data-panel") !== name); });
  $all(".tab").forEach(function(t){ t.setAttribute("aria-selected", (t.getAttribute("data-tab") === name) ? "true" : "false"); });
}
$all(".tab").forEach(function(btn){ btn.addEventListener("click", function(){ gotoTab(btn.getAttribute("data-tab")); }); });
$all("[data-goto]").forEach(function(a){ a.addEventListener("click", function(e){ e.preventDefault(); gotoTab(a.getAttribute("data-goto")); }); });

/* =========================
   USERNAME SANITIZE & PSEUDO EMAIL
========================= */
var USER_RE = /^[a-z0-9_-]{3,30}$/;
function sanitizeUsername(u){
  u = (u || "").toLowerCase();
  return u.replace(/\s+/g,'').replace(/[^a-z0-9_-]/g,'');
}
function toPseudoEmail(username){
  var u = sanitizeUsername(username);
  return u ? (u + USER_DOMAIN) : "";
}
function getUsernameFromUser(u){
  var em = (u && u.email) ? u.email : "";
  return em.slice(-USER_DOMAIN.length) === USER_DOMAIN
    ? em.slice(0, -USER_DOMAIN.length)
    : (u && u.displayName) ? u.displayName : em;
}

/* =========================
   BRUTE FORCE LIMIT (persist)
========================= */
var failCount = Number(localStorage.getItem('login.fails') || 0);
var lockUntil = Number(localStorage.getItem('login.lockUntil') || 0);

function canTry(){
  var now = Date.now();
  if (now < lockUntil){
    var sec = Math.ceil((lockUntil - now)/1000);
    toast("Terlalu banyak percobaan. Coba lagi dalam " + sec + "s.", "error");
    return false;
  }
  return true;
}
function registerFail(){
  failCount++; localStorage.setItem('login.fails', String(failCount));
  if (failCount % 5 === 0){
    lockUntil = Date.now() + 30000;
    localStorage.setItem('login.lockUntil', String(lockUntil));
    toast("Terlalu banyak percobaan. Coba lagi dalam 30 detik.", "error");
  }
}
function clearFail(){
  failCount = 0; lockUntil = 0;
  localStorage.removeItem('login.fails');
  localStorage.removeItem('login.lockUntil');
}

/* =========================
   URL PARAM ?tab=...
========================= */
var urlTab = null;
try { urlTab = new URLSearchParams(location.search).get("tab"); }
catch(_e){
  var qs = location.search.replace(/^\?/,'').split('&');
  for (var i=0;i<qs.length;i++){
    var kv = qs[i].split('=');
    if (decodeURIComponent(kv[0]||'') === 'tab'){ urlTab = decodeURIComponent(kv[1]||''); break; }
  }
}
if (urlTab && ["login","forgot","changepw"].indexOf(urlTab) >= 0) gotoTab(urlTab);

/* =========================
   AUTH STATE (tanpa write ke /uids /usernames)
========================= */
auth.onAuthStateChanged(function(user){
  var tabChange = document.querySelector('.tab[data-tab="changepw"]');
  var isLogged  = !!user;
  if (tabChange) tabChange.classList.toggle('hidden', !isLogged);

  if (isLogged){
    var cpUser = $("#cp-user");
    if (cpUser) cpUser.textContent = "Masuk sebagai: " + getUsernameFromUser(user);
    if (urlTab === 'changepw') gotoTab('changepw');
  }else{
    var curBtn = document.querySelector('.tab[aria-selected="true"]');
    var curTab = curBtn ? curBtn.getAttribute('data-tab') : 'login';
    if (curTab === 'changepw') gotoTab('login');
  }
});

/* =========================
   INPUT (lowercase otomatis)
========================= */
var uEl = $("#u");
if (uEl){
  uEl.addEventListener("input", function(e){
    var pos = e.target.selectionStart||0;
    e.target.value = sanitizeUsername(e.target.value);
    try { e.target.setSelectionRange(pos, pos); } catch(_e){}
  });
}
var fuEl = $("#fu");
if (fuEl){
  fuEl.addEventListener("input", function(e){
    var pos = e.target.selectionStart||0;
    e.target.value = sanitizeUsername(e.target.value);
    try { e.target.setSelectionRange(pos, pos); } catch(_e){}
  });
}

/* =========================
   LOGIN (tanpa tulis /uids & /usernames)
========================= */
var loginForm = $("#form-login");
if (loginForm){
  loginForm.addEventListener("submit", async function(e){
    e.preventDefault();
    if (!canTry()) return;
    if (!navigator.onLine){ toast("Offline. Periksa koneksi internet.", "error"); return; }

    var btn = e.submitter || e.target.querySelector('button[type="submit"]');
    var old = btn ? btn.textContent : '';
    if (btn){ btn.disabled = true; btn.textContent = 'Memprosesâ€¦'; }

    try{
      var u = sanitizeUsername(($("#u") && $("#u").value) || "");
      var p = ($("#password") && $("#password").value) || "";

      if (!u || !p) throw { code:"missing" };
      if (!USER_RE.test(u)) throw { code:"bad-username" };

      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await auth.signInWithEmailAndPassword(toPseudoEmail(u), p);

      clearFail();
      toast("Login berhasil. Mengalihkanâ€¦", "success");
      setTimeout(function(){ location.href = REDIRECT_URL; }, 200);
    } catch(err){
      registerFail();
      var code = String(err && err.code || "");
      var msg="Gagal login.";
      if (code === "missing") msg="Lengkapi username & password.";
      else if (code === "bad-username") msg="Format username salah (3â€“30: aâ€“z 0â€“9 . _ -).";
      else if (code.indexOf("user-not-found")>=0) msg="Username tidak ditemukan.";
      else if (code.indexOf("wrong-password")>=0 || code.indexOf("invalid-credential")>=0) msg="Password salah.";
      else if (code.indexOf("too-many-requests")>=0) msg="Terlalu banyak percobaan. Coba lagi nanti.";
      else if (code.indexOf("network-request-failed")>=0) msg="Jaringan bermasalah. Coba lagi.";
      console.error(err);
      toast(msg, "error");
    } finally {
      if (btn){ btn.disabled=false; btn.textContent=old; }
    }
  });
}

/* =========================
   LUPA PASSWORD (request ke admin) â€” pakai waktu server
========================= */
var forgotForm = $("#form-forgot");
if (forgotForm){
  forgotForm.addEventListener("submit", function(e){
    e.preventDefault();
    var u = sanitizeUsername(($("#fu") && $("#fu").value) || "");
    var notes = (($("#fnotes") && $("#fnotes").value) || "").trim();

    if (!u){ toast("Isi username.", "error"); return; }
    if (!USER_RE.test(u)){ toast("Format username salah (3â€“30: aâ€“z 0â€“9 . _ -).", "error"); return; }

    var payload = {
      username: u,
      pseudoEmail: toPseudoEmail(u),
      notes: notes || null,
      ts: firebase.database.ServerValue.TIMESTAMP, // â¬… waktu server
      status: "pending"
    };
    var key = String(Date.now()) + "_" + u;

    db.ref("reset_requests").child(key).set(payload).then(function(){
      toast("Permintaan reset sudah terkirim ke admin.", "success");
      if ($("#fu")) $("#fu").value="";
      if ($("#fnotes")) $("#fnotes").value="";
    }).catch(function(){
      toast("Tidak bisa mengirim permintaan. Coba lagi.", "error");
    });
  });
}

/* =========================
   GANTI PASSWORD (reauth)
========================= */
var changeForm = $("#form-changepw");
if (changeForm){
  changeForm.addEventListener("submit", function(e){
    e.preventDefault();
    var user = auth.currentUser;
    if (!user){ toast("Silakan login dulu.", "error"); return; }

    var btn = e.submitter || e.target.querySelector('button[type="submit"]');
    var old = btn ? btn.textContent : '';
    if (btn){ btn.disabled = true; btn.textContent = 'Menyimpanâ€¦'; }

    var oldP = ($("#cp-old") && $("#cp-old").value) || "";
    var newP = ($("#cp-new") && $("#cp-new").value) || "";
    var reP  = ($("#cp-re")  && $("#cp-re").value)  || "";

    if (newP !== reP){ toast("Konfirmasi password baru tidak sama.", "error"); if(btn){btn.disabled=false;btn.textContent=old;} return; }
    if (newP.length < 8){ toast("Password baru minimal 8 karakter.", "error"); if(btn){btn.disabled=false;btn.textContent=old;} return; }

    var cred = firebase.auth.EmailAuthProvider.credential(user.email, oldP);
    user.reauthenticateWithCredential(cred).then(function(){
      return user.updatePassword(newP);
    }).then(function(){
      return auth.signOut();
    }).then(function(){
      toast("Password berhasil diubah. Silakan login ulang.", "success");
      if ($("#cp-old")) $("#cp-old").value = "";
      if ($("#cp-new")) $("#cp-new").value = "";
      if ($("#cp-re"))  $("#cp-re").value  = "";
      gotoTab("login");
    }).catch(function(err){
      var code = String(err && err.code || "");
      var msg = "Gagal mengubah password.";
      if (code.indexOf("wrong-password")>=0 || code.indexOf("invalid-credential")>=0) msg = "Password saat ini salah.";
      toast(msg, "error");
    }).finally(function(){
      if (btn){ btn.disabled=false; btn.textContent=old; }
    });
  });
}

/* =========================
   PASSWORD INPUT (validasi + eye toggle)
========================= */
var pw  = document.getElementById('password');
if (pw){
  pw.addEventListener('invalid', function(){
    if (pw.validity.valueMissing) pw.setCustomValidity('Sila masukkan password.');
    else if (pw.validity.tooShort) pw.setCustomValidity('Password minimal 6 karakter.');
    else pw.setCustomValidity('');
  });
  pw.addEventListener('input', function(){ pw.setCustomValidity(''); });
}

var btnEye = document.getElementById('togglePw');
if (pw && btnEye) {
  var eyeOpen = '<svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">'
              + '<path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7z"></path>'
              + '<circle cx="12" cy="12" r="5" fill="none"></circle>'
              + '<circle cx="12" cy="12" r="3"></circle>'
              + '</svg>';
  var eyeOff  = '<svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">'
              + '<path d="M2 2l20 20-1.41 1.41L16.73 19A10.9 10.9 0 0 1 12 20c-5 0-9.27-3.11-11-7a12.86 12.86 0 0 1 5.07-5.7L.59 3.41 2 2zM12 7a5 5 0 0 1 5 5 4.94 4.94 0 0 1-.53 2.22L9.78 7.53A4.94 4.94 0 0 1 12 7z"></path>'
              + '</svg>';

  function refreshIcon(){
    var showing = (pw.type === 'text');
    btnEye.innerHTML = showing ? eyeOff : eyeOpen;
    btnEye.setAttribute('aria-pressed', String(showing));
    btnEye.setAttribute('aria-label', showing ? 'Sembunyikan password' : 'Tampilkan password');
  }
  btnEye.addEventListener('click', function(){
    pw.type = (pw.type === 'password') ? 'text' : 'password';
    refreshIcon();
  });
  refreshIcon();
}
</script>
</body>
</html>
