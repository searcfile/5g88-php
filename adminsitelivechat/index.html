<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LiveChat - Admin</title>
  <style>
    :root {
  --bg-color: #29858f;
  --text-color: #f1f1f1;
  --primary-color: #facc15;
}
body {
  background: #111;
  color: #111;
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
}

/* ===== Header ===== */
.header {
  background-color: #1668dc;
  font-size: 30px;
  height: 90px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-weight: bold;
}

/* ===== Container Chat Box ===== */
#containerChatBox {
  background: #f9f9f9;
  border-radius: 12px;
  box-shadow: 0 0 10px #1668dc;
  padding: 15px;
  max-width: 640px;
  margin: 0 auto;
  border: 1px solid #1668dc;
}

/* ===== Chat Header ===== */
#chatHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to right, #1668dc, #c5ff4a);
  padding: 12px 18px;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  font-size: 1rem;
  color: #333;
  margin-bottom: 10px;
}

#chatUserName {
  font-weight: bold;
  font-size: 16px;
  color: black;
}

/* ===== Search Message ===== */
#searchMessage {
  border: 1px solid #ccc;
  padding: 6px 12px 6px 36px;
  border-radius: 6px;
  font-size: 14px;
  background: url('https://cdn-icons-png.flaticon.com/512/622/622669.png') no-repeat 10px center;
  background-size: 16px;
  background-color: #fff8dc;
  color: #333;
  width: 50%;
  transition: 0.3s;
}

#searchMessage:focus {
  outline: none;
  border-color: #d4af37;
  background-color: #fff9e3;
}

/* ===== Chat Box ===== */
.chat-box {
  height: 60vh;
  overflow-y: auto;
  border: 1px solid #1668dc;
  padding: 15px;
  background: #000;
  color: white;
  border-radius: 10px;
  box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.05);
  scroll-behavior: smooth;
}

.chat-box::-webkit-scrollbar {
  width: 6px;
}

.chat-box::-webkit-scrollbar-thumb {
  background: #1668dc;
  border-radius: 6px;
}

.chat-box::-webkit-scrollbar-track {
  background: transparent;
}

/* ===== Message Bubble ===== */
.message {
  padding: 0.5rem;
  margin: 0.5rem 0;
  border-radius: 10px;
  max-width: 70%;
  white-space: normal;
  word-wrap: break-word;
  overflow-wrap: break-word;
  color:black;
  font-weight: bold;
}

.mine {
  background-image: linear-gradient(to bottom, #1668dc, #d7e9ff, #c5ff4a);
  color: #000;
  margin-left: auto;
}

.theirs {
  background-image: linear-gradient(to bottom, #1668dc, white);
}

/* ===== Send Box ===== */
.send-box {
  display: flex;
  width: 100%;
  margin: 10px auto 0;
  border: 2px solid #3c89e8;
  border-radius: 6px;
  overflow: hidden;
  background: white;
}

#msg {
  flex: 1;
  padding: 10px;
  font-size: 14px;
  border: none;
  outline: none;
  resize: none;
  font-family: 'Segoe UI', sans-serif;
}
#msg:focus {
 border: 1px solid #1668dc;
 outline: none;
}

.send-box button {
  padding: 0 16px;
  font-size: 14px;
  background: #1668dc;
  border: none;
  color: white;
  cursor: pointer;
  transition: background 0.3s ease;
}

.send-box button:hover {
  background: #3c89e8;
}

.send-box button:active {
  background: #1554ad;
}

/* ===== User List ===== */
.user-item {
  border: 1px solid #424242;
  border-radius: 6px;
  padding: 8px 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  background: #141414;
  color: rgba(255, 255, 255, 0.85);
}

.user-item:hover {
  background: rgba(255, 255, 255, 0.25);
  color: white;
}

.user-item.active {
  background-color: #1668dc;
  color: white;
  border: 1px solid #1668dc;
}

/* ===== Date Label ===== */
.date-label {
  text-align: center;
  margin: 20px 0;
}

.date-label-inner {
  display: inline-block;
  background-color: lightgreen;
  padding: 2px 22px;
  border-radius: 30px;
  font-size: 14px;
  color: #333;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-align: center;
  line-height: 1;
  white-space: nowrap;
}

.date-label-inner .day-label {
  font-weight: bold;
  display: block;
  font-size: 16px;
}

.date-label-inner .full-date-label {
  font-size: 14px;
  color: #555;
  display: block;
  margin-top: 2px;
  text-transform: capitalize;
}

/* ===== Panel Optional ===== */
.chat-panel {
  flex: 1;
  max-width: 400px;
  padding: 1rem;
}
    #chatHeaderUser img {
  object-fit: cover;
  border: 1px solid #ccc;
}
#searchUser {
 padding: 10px 5px; margin-bottom: 10px; border-radius: 6px;
 border:1px solid #424242;
 background: #141414;
 color: rgba(255, 255, 255, 0.85);
 width: 100%;
 transition: border 0.2s ease;
}
#searchUser:hover {
 border: 1px solid #3c89e8;
 transition: border 0.2s ease;
}
#searchUser:focus {
 border: 1px solid #1668dc;
 transition: border 0.2s ease;
 outline: none;
}
.user-list-header {
  position: sticky;
  top: 0;
  background: #111;
  z-index: 10;
  padding-top: 1rem;
  padding-bottom: 1rem;
}
.user-list-panel {
  width: 500px;
  border-right: 1px solid #424242;
  padding: 0;
  display: flex;
  flex-direction: column;
  color: white; 
  background: #111;
}
.user-list-header {
  padding: 1rem;
  background: #111;
  position: sticky;
  top: 0;
  z-index: 10;
}
.user-scroll-box {
  overflow-y: auto;
  max-height: calc(80vh - 140px);
  padding: 1rem;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.user-scroll-box::-webkit-scrollbar {
  display: none;
}
#filterAll, #filterUnread {
  border:1px solid #424242;
  background-color: #141414;     /* warna latar */
  color: white;                  /* warna teks */
  padding: 6px 14px;
  border-radius: 6px;            /* buat lengkung */
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s ease;
  transition: border 0.2s ease;
}

#filterAll:hover,
#filterUnread:hover {
  border:1px solid #3c89e8 !important;
  background-color: #141414;
  color: #3c89e8;   /* warna hover */
  transition: border 0.2s ease !important;
}
#filterAll:active,
#filterUnread:active {
  border:1px solid #1554ad !important;
  background-color: #141414;
  color: #1554ad;   /* warna hover */
  transition: border 0.2s ease !important;
}
.active-filter {
  border:1px solid #1668dc !important;
  background-color: #141414 !important;
  color: #1668dc !important;
  transition: border 0.2s ease !important;
}
.online-indicator {
  float: right;
  margin-left: auto;
}
#chatUserStatus {
  display: block;             /* ⬅️ Ganti jadi block agar tidak terlalu dipaksa horizontal */
  white-space: nowrap;        /* Tetap cegah baris baru */
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  line-height: 1;
}

.status-main {
  font-size: 12px;
  font-weight: bold;
  color: #0f0;
}

.status-sub {
  font-size: 12px;
  color: #bbb;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1;
}
.status-main {
  color: #00ff00;
  font-weight: bold;
}
.status-sub {
  color: #aaa;
  font-size: 12px;
}
.status-typing {
  color: orange;
  font-weight: bold;
}
  </style>
</head>
<body>
<div class="header">Admin LiveChat</div>

<main style="display: flex;">
  <!-- Panel User -->
  <div id="userList" class="user-list-panel">
    <div class="user-list-header">
      <h3>User List</h3>
      <input type="text" id="searchUser" placeholder="Search user..." />
      <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
        <button id="filterAll" class="active-filter">All</button>
        <button id="filterUnread">Unread</button>
        
        <div style="margin-left: auto; color:#fff; font-size: 14px;">
          Total Users: <span id="totalUsers">0</span> | Online: <span id="onlineUsers">0</span>
        </div>
      </div>
    </div>

  <div id="userListBox" class="user-scroll-box"></div>
</div>

 <div style="flex: 0.5; padding: 1rem;">
  <div id="containerChatBox">
    <!-- Header Chat -->
    <div id="chatHeader">
 <div id="chatHeaderUser" style="display: flex; flex-direction: column;">
  <div style="display: flex; align-items: center; gap: 10px;">
    <img id="chatUserAvatar" src="" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; display: none;" />
    <div>
      <strong id="chatUserName">Select a user</strong>
      <div id="chatUserStatus" style="font-size: 12px; color: #aaa;">Offline</div>
    </div>
  </div>
</div>
  <input
    type="text"
    id="searchMessage"
    placeholder="Search messages..."
  />
</div>

    <!-- Chat Box -->
    <div class="chat-box" id="chatBox"></div>

    <!-- Send Box -->
    <div class="send-box">
      <textarea id="msg" placeholder="Type your message" rows="2"></textarea>
      <button id="sendBtn" disabled>Send</button>
    </div>
  </div>
</div>
</main>

<audio id="notifSound" src="https://searcfile.github.io/5G88-audio/notifsound/notification.wav" preload="auto"></audio>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
"use strict";

/* ======================= STATE GLOBAL ======================= */
let isLoadingUserList = true;
let renderedUserIds = new Set();
let justOpenedChat = false;            // dipakai di listenToChat / onclick
let initialUserListLoaded = false;     // keamanan di loadUserList
let userHasInteracted = false;         // untuk play sound notif
let currentFilterMode = 'all';

let activeUserIdSanitized = '';
let activeUserIdEmail = '';
let selectedUserId = null;

let allUsersData = [];                 // [ [id, data, lastTime], ... ]
let lastMessageTimestamps = {};
let allMessages = [];
let isInitialChatLoad = true;

let lastPresenceId = null;             // untuk matiin presence listener lama

/* ======================= INIT FIREBASE ======================= */
const firebaseConfig = {
  apiKey: "AIzaSyCKmrlS4qrZCrMNRIfIRCWCbNgZT1uQ3ZI",
  authDomain: "blurphp.firebaseapp.com",
  databaseURL: "https://blurphp-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "blurphp",
  storageBucket: "blurphp.appspot.com",
  messagingSenderId: "593904200464",
  appId: "1:593904200464:web:cea7bc1360532c20d99395",
  measurementId: "G-R494S2DPZ5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ======================= HELPERS ======================= */
function sanitizeUserId(email){ return String(email||'').toLowerCase().replace(/\./g,'_'); }
function desanitizeUserId(sanitized){
  const str = String(sanitized || '');
  const at = str.indexOf('@');
  if (at === -1) return str.replace(/_/g, '.'); // fallback kalau bukan email
  const local  = str.slice(0, at);                  // biarkan underscore di local-part
  const domain = str.slice(at + 1).replace(/_/g,'.'); // hanya domain yang diubah
  return `${local}@${domain}`;
}
function dedupeName(str){
  const s = String(str || '').trim().replace(/\s+/g, ' ');
  const parts = s.split(' ');
  // Jika tepat 2 kata dan sama (abaikan huruf besar/kecil), ambil satu saja
  if (parts.length === 2 && parts[0].toLowerCase() === parts[1].toLowerCase()) {
    return parts[0];
  }
  return s;
}
function formatUserName(name){
  if(!name) return 'Unknown';
  const words = String(name).trim().split(' ');
  if (words.length === 2 && words[0] === words[1]) return words[0];
  return name;
}

function getLabelParts(id, data){
  const tryEmailFromId = desanitizeUserId(id);

  // email: dari data > dari id (jika id memang email yang disanitasi)
  const email = (data?.email || '').trim() || (tryEmailFromId.includes('@') ? tryEmailFromId : '');

  const rawName  = (data?.name || '').trim();
  const photoURL = data?.photoURL || '';

  // displayName: name > local-part email > Guest-XXXXX
  let displayName = rawName || (email ? email.split('@')[0] : '');
  displayName = dedupeName(displayName); // ⬅️ hilangkan duplikasi "A A"

  if (!displayName){
    const code = String(id).slice(-5).toUpperCase();
    displayName = `Guest-${code}`;
  }

  const label = email ? `${displayName} (${email})` : displayName;
  return { displayName, email, photoURL, label };
}

function playNotificationSound(){
  const audio = document.getElementById("notifSound");
  if (audio && userHasInteracted){
    audio.currentTime = 0;
    audio.play().catch(()=>{});
  }
}

document.addEventListener('click', () => { userHasInteracted = true; });
document.addEventListener('touchstart', () => { userHasInteracted = true; });
document.addEventListener('keydown', () => { userHasInteracted = true; });

/* ======================= COUNTERS (opsional) ======================= */
function updateUserCounts(){
  const totalUsersElem  = document.getElementById('totalUsers');
  const onlineUsersElem = document.getElementById('onlineUsers');
  if (!totalUsersElem || !onlineUsersElem) return; // kalau ga ada elemennya, skip

  db.ref('users').on('value', snapshot => {
    const users = snapshot.val() || {};
    const totalUsers = Object.keys(users).length;
    const onlineUsers = Object.values(users).filter(u => u && u.online).length;
    totalUsersElem.textContent = totalUsers;
    onlineUsersElem.textContent = onlineUsers;
  });
}

/* ======================= TANGGAL LABEL ======================= */
function formatDateLabel(dateInput){
  const today = new Date();
  const date  = new Date(dateInput);
  const reset = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff  = reset(today) - reset(date);

  const cap = s => s.charAt(0).toUpperCase() + s.slice(1);

  if (diff === 0){
    return {
      day: "Today",
      full: date.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})
    };
  } else if (diff === 86400000){
    return {
      day: "Yesterday",
      full: date.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})
    };
  } else {
    return {
      day: cap(date.toLocaleDateString("en-GB",{weekday:"long"})),
      full: date.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})
    };
  }
}

/* ======================= RENDER PESAN ======================= */
function renderChatMessages(messages){
  const chatBox = document.getElementById("chatBox");
  if (!chatBox) return;
  chatBox.innerHTML = "";

  let lastDate = null;

  messages.forEach(msg => {
    const msgDate = new Date(msg.time);
    const dateLabels = formatDateLabel(msgDate);
    const dateStr = dateLabels.day + ', ' + dateLabels.full;

    if (lastDate !== dateStr){
      lastDate = dateStr;
      const dateLabelDiv = document.createElement("div");
      dateLabelDiv.className = "date-label";
      dateLabelDiv.innerHTML = `
        <div class="date-label-inner">
          <span class="day-label">${dateLabels.day}</span>
          <span class="full-date-label">${dateLabels.full}</span>
        </div>`;
      chatBox.appendChild(dateLabelDiv);
    }

    const div = document.createElement("div");
    div.className = 'message ' + (msg.from === 'admin' ? 'mine' : 'theirs');

    const timeStr = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const isUser = msg.from !== 'admin';
    const rawName = isUser ? (msg.name || msg.email || 'User') : 'Admin';
    const senderName = formatUserName(rawName);
    const avatarURL = msg.photoURL || (isUser ? 'https://i.pravatar.cc/40' : 'https://i.imgur.com/UhV9EWa.png');

    let html = `
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
        <img src="${avatarURL}" alt="Avatar"
             style="width:24px;height:24px;object-fit:cover;border-radius:50%;border:1px solid white;margin-right:6px;background-color:currentcolor;">
        <div style="font-weight:bold;">
          ${senderName}
          <small style="font-size:.75rem;color:#0b6906;">${timeStr}</small>
        </div>
      </div>`;

    if (msg.text)  html += `<div>${msg.text}</div>`;
    if (msg.image) html += `<img src="${msg.image}" alt="Image" style="max-width:100%;border-radius:8px;margin-top:4px;">`;

    div.innerHTML = html;
    chatBox.appendChild(div);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ======================= STREAM CHAT AKTIF ======================= */
function listenToChat(){
  if (!activeUserIdSanitized) return;
  const chatRef = db.ref('chats/' + activeUserIdSanitized);
  isInitialChatLoad = true;
  const chatBox = document.getElementById('chatBox');
  if (chatBox) chatBox.innerHTML = '<p style="text-align:center;color:white;">Loading...</p>';

  chatRef.off();
  chatRef.on('value', snapshot => {
    const chats = snapshot.val();
    if (!chats){
      if (chatBox) chatBox.innerHTML = '<p style="text-align:center;color:white;">Start Message.</p>';
      allMessages = [];
      return;
    }

    const chatEntries = Object.entries(chats).sort((a,b)=>(a[1].time||0)-(b[1].time||0));
    let shouldUpdatePosition = false;
    let messagesToMarkRead = [];

    allMessages = chatEntries.map(([key, msg])=>{
      const isUnread = msg.from === 'user' && !msg.readByAdmin;
      const isFromUserAndNew = isUnread && !justOpenedChat;
      if (isFromUserAndNew) shouldUpdatePosition = true;

      if (isUnread){
        messagesToMarkRead.push(key);
        if (!lastMessageTimestamps[activeUserIdSanitized] || msg.time > lastMessageTimestamps[activeUserIdSanitized]){
          lastMessageTimestamps[activeUserIdSanitized] = msg.time;
          if (!isInitialChatLoad) playNotificationSound();
        }
      }
      return msg;
    });

    renderChatMessages(allMessages);
    isInitialChatLoad = false;

    // tandai sudah dibaca saat chat dibuka
    if (justOpenedChat){
      justOpenedChat = false;
      messagesToMarkRead.forEach(key=>{
        db.ref(`chats/${activeUserIdSanitized}/${key}/readByAdmin`).set(true);
      });
      if (messagesToMarkRead.length > 0) updateUserListFlags();
    }
    // ✅ kalau admin sedang view chat ini, pastikan semua msg user jadi read
if (!justOpenedChat && selectedUserId === activeUserIdSanitized && messagesToMarkRead.length){
  const updates = {};
  messagesToMarkRead.forEach(key=>{
    updates[`${key}/readByAdmin`] = true;
  });
  db.ref(`chats/${activeUserIdSanitized}`).update(updates).catch(()=>{});
  updateUserListFlags();
}
    // jika ada pesan user baru, naikkan posisinya
    if (shouldUpdatePosition){
      const userIndex = allUsersData.findIndex(([id])=> id === activeUserIdSanitized);
      if (userIndex !== -1){
        const lastMsg = allMessages[allMessages.length - 1];
        const lastTime = lastMsg?.time || 0;
        allUsersData[userIndex][2] = lastTime;
        allUsersData.sort((a,b)=> b[2]-a[2]);
        const displayList = allUsersData.map(([s,d])=>[s,d]);
        renderUserList(displayList, 'all', document.getElementById('searchUser')?.value || '');
      }
    }
  });
}

/* ======================= RENDER LIST USER ======================= */
function renderUserList(userList, filter='all', searchTerm=''){
  const userListBox = document.getElementById('userListBox');
  if (!userListBox) return;
  userListBox.innerHTML = '';
  renderedUserIds.clear();

  userList.forEach(([sanitized, userData])=>{
    // ambil chat untuk cek unread + fallback identitas
    db.ref(`chats/${sanitized}`).once('value', snapshot => {
      const chatEntries = Object.values(snapshot.val() || []);
      const hasUnread = chatEntries.some(m => m.from === 'user' && !m.readByAdmin);
      if (filter === 'unread' && !hasUnread) return;

      const firstMsg = chatEntries.find(m => m.from === 'user') || {};
      const mergedIdentity = {
        name:     userData?.name     ?? firstMsg.name,
        email:    userData?.email    ?? firstMsg.email,
        photoURL: userData?.photoURL ?? firstMsg.photoURL
      };
      const { label, displayName, email, photoURL } = getLabelParts(sanitized, mergedIdentity);

      // filter DI SINI (pakai label final)
      if (searchTerm && !label.toLowerCase().includes(String(searchTerm).toLowerCase())) return;

      const userDiv = document.createElement('div');
      userDiv.className = 'user-item';
      if (sanitized === activeUserIdSanitized) userDiv.classList.add('active');
      userDiv.setAttribute('data-sanitized', sanitized);

      const userLabel = document.createElement('span');
      userLabel.innerHTML = `
        <span class="label-text">${label}</span>
        ${hasUnread ? '<svg class="unread-icon" width="14" height="14" viewBox="0 0 24 24" fill="red" style="margin-left:4px;"><path d="M12 2a10 10 0 1 1 0 20A10 10 0 0 1 12 2zm0 4a1 1 0 0 0-1 1v6a1 1 0 1 0 2 0V7a1 1 0 0 0-1-1zm0 10a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0-3z"/></svg>' : ''}
        <svg class="online-indicator" width="10" height="10" viewBox="0 0 24 24" fill="#00ff00" style="margin-left:6px;display:none;">
          <circle cx="12" cy="12" r="10"/>
        </svg>`;
      userLabel.style.fontWeight = hasUnread ? 'bold' : 'normal';
      userDiv.appendChild(userLabel);

      userDiv.onclick = ()=>{
        justOpenedChat = true;
        activeUserIdSanitized = sanitized;
        selectedUserId = sanitized;
        activeUserIdEmail = email || '';

        document.getElementById("chatUserName") && (document.getElementById("chatUserName").textContent = displayName);
        const avatarImg = document.getElementById("chatUserAvatar");
        if (avatarImg){ avatarImg.src = photoURL || 'https://i.pravatar.cc/40'; avatarImg.style.display='block'; }

        document.querySelectorAll('.user-item').forEach(el=> el.classList.remove('active'));
        userDiv.classList.add('active');

        const searchMsg = document.getElementById("searchMessage");
        if (searchMsg) searchMsg.value = '';

        updateUserPresenceById(sanitized);
        listenToChat();
      };

      userListBox.appendChild(userDiv);
      renderedUserIds.add(sanitized);
      db.ref("users/" + sanitized + "/online").once('value').then(s => {
  const indicator = userDiv.querySelector('.online-indicator');
  if (indicator) indicator.style.display = s.val() ? 'inline-block' : 'none';
});
    });
  });
}

/* ======================= LOAD LIST USER AWAL ======================= */
function loadUserList(){
  const userListBox = document.getElementById('userListBox');
  if (userListBox){ userListBox.innerHTML = '<p style="text-align:center;color:gray;">Memuat...</p>'; }
  renderedUserIds.clear();

  db.ref('users').once('value', snapshot=>{
    const users = snapshot.val() || {};
    const entries = Object.entries(users); // [ [id, data], ... ]

    // === KASUS: /users KOSONG → fallback dari /chats ===
    if (entries.length === 0){
      // JANGAN lupa matikan "loading" supaya listener child_added jalan
      isLoadingUserList = false;
      initialUserListLoaded = true;

      db.ref('chats').once('value').then(s=>{
        const chats = s.val() || {};
        const ids = Object.keys(chats);
        if (ids.length === 0){
          if (userListBox) userListBox.innerHTML = '<p style="text-align:center;color:gray;">Belum ada user</p>';
          return;
        }

        const jobs = ids.map(id =>
          db.ref(`chats/${id}`).orderByChild('time').limitToLast(1).once('value')
            .then(s2=>{
              let lastTime = 0, lastMsg = {};
              s2.forEach(m => { lastTime = m.val()?.time || 0; lastMsg = m.val() || {}; });
              const identity = { name:lastMsg.name, email:lastMsg.email, photoURL:lastMsg.photoURL };
              return { sanitized:id, data: identity, lastTime };
            })
        );

        Promise.all(jobs).then(results=>{
          results.sort((a,b)=> b.lastTime - a.lastTime);
          allUsersData = results.map(u => [u.sanitized, u.data, u.lastTime]);

          if (userListBox) userListBox.innerHTML = '';
          renderUserList(allUsersData.map(([s,d])=>[s,d]));

          allUsersData.forEach(([sid])=> renderedUserIds.add(sid));
          updateUserListFlags();
        });
      });
      return; // selesai di fallback
    }

    // === KASUS NORMAL: /users ADA ===
    const jobs = entries.map(([sanitized, data])=>
      db.ref(`chats/${sanitized}`).orderByChild('time').limitToLast(1).once('value')
        .then(snap=>{
          let lastTime = 0;
          snap.forEach(msg => { lastTime = msg.val()?.time || 0; });
          return { sanitized, data, lastTime };
        })
        .catch(()=>({ sanitized, data, lastTime: 0 }))
    );

    Promise.all(jobs).then(results=>{
      results.sort((a,b)=> b.lastTime - a.lastTime);
      allUsersData = results.map(u => [u.sanitized, u.data, u.lastTime]);

      if (userListBox) userListBox.innerHTML = '';
      renderUserList(allUsersData.map(([s,d])=>[s,d]));

      allUsersData.forEach(([sanitized])=> renderedUserIds.add(sanitized));
      isLoadingUserList = false;           // ⬅️ penting
      initialUserListLoaded = true;        // ⬅️ penting
      updateUserListFlags();
    });
  });
}

/* ======================= PERUBAHAN CHATS (posisi list) ======================= */
db.ref("chats").on("child_changed", snapshot=>{
  const sanitizedId = snapshot.key;
  const messages = snapshot.val() || {};
  const entries = Object.entries(messages);
  if (entries.length === 0) return;

  const latest = entries.reduce((a,b)=> (a[1].time > b[1].time ? a : b), [null,{time:0}]);
  const latestTime = latest[1]?.time || 0;

  const idx = allUsersData.findIndex(([id])=> id === sanitizedId);
  if (idx !== -1){
    allUsersData[idx][2] = latestTime;
    allUsersData.sort((a,b)=> b[2]-a[2]);

    const displayList = allUsersData.map(([s,d])=>[s,d]);
    renderUserList(displayList, currentFilterMode, document.getElementById('searchUser')?.value || '');
  }
});

/* ======================= UNREAD BADGE & LABEL REFRESH ======================= */
function updateUserListFlags(){
  const items = document.querySelectorAll('.user-item');
  items.forEach(item=>{
    const sanitized = item.getAttribute('data-sanitized');
    const span = item.querySelector('span');
    if (!sanitized || !span) return;

    db.ref(`chats/${sanitized}`).once('value', snapshot=>{
      const chatEntries = Object.values(snapshot.val() || []);
      const hasUnread = chatEntries.some(m => m.from === 'user' && !m.readByAdmin);

      // fallback identitas dari pesan user pertama
      const firstMsg = chatEntries.find(m => m.from === 'user') || {};
      const { label } = getLabelParts(sanitized, { name:firstMsg.name, email:firstMsg.email });

      // update hanya teks label (biar ikon online tetap ada)
      const labelTextEl = span.querySelector('.label-text');
      if (labelTextEl) labelTextEl.textContent = label;

      // toggle ikon unread
      let unreadIcon = span.querySelector('.unread-icon');
      if (hasUnread){
        if (!unreadIcon){
          span.insertAdjacentHTML('beforeend',
            '<svg class="unread-icon" width="14" height="14" viewBox="0 0 24 24" fill="red" style="margin-left:4px;"><path d="M12 2a10 10 0 1 1 0 20A10 10 0 0 1 12 2zm0 4a1 1 0 0 0-1 1v6a1 1 0 1 0 2 0V7a1 1 0 0 0-1-1zm0 10a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0-3z"/></svg>'
          );
        }
      } else if (unreadIcon){
        unreadIcon.remove();
      }

      span.style.fontWeight = hasUnread ? 'bold' : 'normal';
    });
  });
}

/* ======================= PENCARIAN PESAN ======================= */
function filterMessages(query){
  if (!query){ renderChatMessages(allMessages); return; }
  const q = String(query).toLowerCase();
  const filtered = allMessages.filter(m => String(m.text || '').toLowerCase().includes(q));
  renderChatMessages(filtered);
}

/* ======================= KIRIM PESAN ADMIN ======================= */
function sendMessage(){
  const msgInput = document.getElementById('msg');
  const msg = msgInput?.value.trim();
  if (!selectedUserId || !msg) return alert("Pilih user dan tulis pesan dulu!");

  const now = Date.now();
const newMsg = {
  from: 'admin',
  name: 'Admin',
  email: 'admin@domain.com',
  photoURL: 'https://i.imgur.com/qiZFOs9.png',
  text: msg,
  time: now,
  readByAdmin: true,
  seenByUser: false,
  deliveredAt: now,
  readAt: null
};

  db.ref(`chats/${selectedUserId}`).push(newMsg, err=>{
    if (!err){
      if (msgInput){ msgInput.value = ''; updateSendButtonState(); }

      // notifikasi ke user
      db.ref(`notifications/${selectedUserId}`).set({
        from: 'admin', text: msg, time: now, unread: true
      });

      // update posisi user di list
      const idx = allUsersData.findIndex(([id])=> id === selectedUserId);
      if (idx !== -1){
        allUsersData[idx][2] = now;
        allUsersData.sort((a,b)=> b[2]-a[2]);
        const displayList = allUsersData.map(([s,d])=>[s,d]);
        renderUserList(displayList, 'all', document.getElementById('searchUser')?.value || '');
      }
    } else {
      alert('Gagal mengirim pesan');
    }
  });
}

/* ======================= STATUS HEADER (ONLINE / TYPING) ======================= */
function updateUserPresenceById(id){
  // matikan listener lama
  const prev = lastPresenceId;
  if (prev && prev !== id){
    db.ref('users/' + prev).off();
    db.ref('users/' + prev + '/typing').off();
  }
  lastPresenceId = id;

  const userRef   = db.ref('users/' + id);
  const typingRef = db.ref('users/' + id + '/typing');
  const statusElem = document.getElementById('chatUserStatus');
  if (!statusElem) return;

  userRef.on('value', snap=>{
    const data = snap.val() || {};
    if (data.typing) return; // biar typing handler yang render
    if (data.online){
      statusElem.innerHTML = `<span class="status-main">Online</span>`;
    } else {
      const t = data.lastLoginTime;
      if (!t){ statusElem.innerHTML = ``; return; }
      const d = new Date(t), now = new Date();
      const isToday = d.toDateString() === now.toDateString();
      const h = d.getHours(), m = String(d.getMinutes()).padStart(2,'0');
      const ampm = h >= 12 ? 'PM' : 'AM';
      const hh = h % 12 || 12;
      statusElem.innerHTML = `<span class="status-sub">Last seen ${isToday ? 'today' : d.toLocaleDateString()} at ${hh}:${m} ${ampm}</span>`;
    }
  });

  typingRef.on('value', snap=>{
    const isTyping = !!snap.val();
    if (isTyping){
      statusElem.innerHTML = `<span class="status-typing">Typing...</span>`;
    } else {
      userRef.once('value').then(s=>{
        const d = s.val() || {};
        if (d.online){
          statusElem.innerHTML = `<span class="status-main">Online</span>`;
        } else if (d.lastLoginTime){
          const dt = new Date(d.lastLoginTime), now = new Date();
          const isToday = dt.toDateString() === now.toDateString();
          const h = dt.getHours(), m = String(dt.getMinutes()).padStart(2,'0');
          const ampm = h >= 12 ? 'PM' : 'AM';
          const hh = h % 12 || 12;
          statusElem.innerHTML = `<span class="status-sub">Last seen ${isToday ? 'today' : dt.toLocaleDateString()} at ${hh}:${m} ${ampm}</span>`;
        } else {
          statusElem.innerHTML = ``;
        }
      });
    }
  });
}

/* ======================= LISTENER GLOBAL ONLINE (tanpa numpuk) ======================= */
db.ref('users').on('child_changed', snap=>{
  const id = snap.key;
  const isOnline = !!(snap.val() || {}).online;
  const item = document.querySelector(`.user-item[data-sanitized="${id}"]`);
  if (item) {
    const indicator = item.querySelector('.online-indicator');
    if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
  }
  updateUserListFlags(); 
});

/* ======================= UTIL KECIL ======================= */
let msgInput, sendBtn;
function updateSendButtonState(){
  const msg = msgInput?.value.trim();
  const isUserSelected = !!selectedUserId;
  if (sendBtn) sendBtn.disabled = !(isUserSelected && msg);
}

function addOrUpdateUser(sanitized, data){
  if (renderedUserIds.has(sanitized)) return;
  if (allUsersData.some(([id])=> id === sanitized)) return;

  db.ref(`chats/${sanitized}`).orderByChild('time').limitToLast(1).once('value')
    .then(lastSnap=>{
      let lastTime = 0;
      lastSnap.forEach(m => { lastTime = m.val()?.time || 0; });
      if (lastTime === 0) lastTime = Date.now();

      const existingIndex = allUsersData.findIndex(([id])=> id === sanitized);
      if (existingIndex !== -1) allUsersData.splice(existingIndex, 1);

      allUsersData.push([sanitized, data, lastTime]);
      allUsersData.sort((a,b)=> b[2]-a[2]);

      const displayList = allUsersData.map(([id,user])=> [id, user]);
      renderUserList(displayList, 'all', document.getElementById("searchUser")?.value || '');
      renderedUserIds.add(sanitized);
    });
}

function updateUserLastTime(sanitizedId, messages){
  const messageEntries = Object.entries(messages || {});
  if (messageEntries.length === 0) return;
  const latest = messageEntries.reduce((a,b)=> (a[1].time > b[1].time ? a : b), [null,{time:0}]);
  const latestTime = latest[1]?.time || 0;

  const idx = allUsersData.findIndex(([id])=> id === sanitizedId);
  if (idx !== -1){
    allUsersData[idx][2] = latestTime;
    allUsersData.sort((a,b)=> b[2]-a[2]);

    const displayList = allUsersData.map(([s,d])=>[s,d]);
    renderUserList(displayList, currentFilterMode, document.getElementById('searchUser')?.value || '');
  }
}

/* ======================= BOOTSTRAP ======================= */
window.onload = ()=>{
  // init list
  selectedUserId = null;
  activeUserIdSanitized = '';
  activeUserIdEmail = '';

  loadUserList();
  updateUserCounts();

  // UI refs
  msgInput = document.getElementById('msg');
  sendBtn  = document.getElementById('sendBtn');

  // input message
  if (msgInput){
    msgInput.addEventListener('input', updateSendButtonState);
    msgInput.addEventListener('keydown', e=>{
      if (e.key === 'Enter' && !(e.shiftKey || e.ctrlKey)){
        e.preventDefault();
        const text = msgInput.value.trim();
        if (!selectedUserId || !text) return;
        sendMessage();
      }
    });
  }
  if (sendBtn){
    sendBtn.addEventListener('click', sendMessage);
    updateSendButtonState();
  }

  // filter tombol
  const btnAll    = document.getElementById('filterAll');
  const btnUnread = document.getElementById('filterUnread');
  btnAll?.addEventListener('click', ()=>{
    currentFilterMode = 'all';
    btnAll.classList.add('active-filter');
    btnUnread?.classList.remove('active-filter');
    renderUserList(allUsersData, 'all', document.getElementById('searchUser')?.value || '');
  });
  btnUnread?.addEventListener('click', ()=>{
    currentFilterMode = 'unread';
    btnUnread.classList.add('active-filter');
    btnAll?.classList.remove('active-filter');
    renderUserList(allUsersData, 'unread', document.getElementById('searchUser')?.value || '');
  });

  // search user
  const searchUserInput = document.getElementById('searchUser');
  searchUserInput?.addEventListener('input', e=>{
    const filterType = currentFilterMode;
    const box = document.getElementById('userListBox');
    if (box) box.innerHTML = '';
    renderUserList(allUsersData, filterType, e.target.value);
  });

  // search message
  const searchMessageInput = document.getElementById('searchMessage');
  searchMessageInput?.addEventListener('input', e=> filterMessages(e.target.value) );

  // watchers untuk users (tambah/perubahan data)
  db.ref('users').on('child_added', snap=>{
    const sanitized = snap.key;
    const data = snap.val();
    if (!renderedUserIds.has(sanitized)){
      addOrUpdateUser(sanitized, data);
      renderedUserIds.add(sanitized);
    }
  });
  db.ref('users').on('child_changed', snap=>{
    const sanitized = snap.key;
    const data = snap.val();
    addOrUpdateUser(sanitized, data);
  });

  // watchers untuk chats -> update urutan
  db.ref("chats").on("child_changed", snapshot=>{
    updateUserLastTime(snapshot.key, snapshot.val());
  });
  db.ref("chats").on("child_added", snapshot=>{
    updateUserLastTime(snapshot.key, snapshot.val());
  });
};
</script>
</body>
</html>
