<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transfer Receipt Builder</title>
  <style>
    :root{
      --green:#3b9b73;          /* dekat macam screenshot */
      --bg:#e7e7e7;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --danger:#e11d48;         /* amount merah */
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:10px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Lato", "Calibri", Helvetica, Arial, sans-serif;
      background: var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 1050px;
      margin: 18px auto;
      padding: 0 14px 26px;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items:start;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    /* ====== LEFT: BUILDER PANEL ====== */
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
    }
    .panel .ph h3{
      margin:0; font-size:14px; letter-spacing:.2px;
    }
    .panel .pb{ padding: 14px; }

    .field{ margin-bottom: 12px; }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    select,input{
      width:100%;
      height:40px;
      border:1px solid var(--line);
      border-radius:10px;
      padding: 0 12px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    input:focus,select:focus{
      border-color:#9ca3af;
      box-shadow: 0 0 0 3px rgba(17,24,39,.08);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .hint{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      line-height:1.3;
    }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 8px;
    }
    button{
      height:42px;
      border-radius:12px;
      border:1px solid var(--line);
      padding: 0 14px;
      font-weight:700;
      cursor:pointer;
      background:#fff;
    }
    .btn-create{
      flex:1;
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .btn-reset{
      width:120px;
      background:#fff;
      color:#111827;
    }
    button:active{ transform: translateY(1px); }

    .mini{
      margin-top:10px;
      padding:10px 12px;
      background:#f9fafb;
      border:1px dashed #e5e7eb;
      border-radius:12px;
      font-size:12px;
      color:#374151;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* ====== RIGHT: RECEIPT ====== */
    .receipt{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
    }

    .topbar{
      background:#389a6e;
      color:#fff;
      padding: 14px 15px 35px;
      position:relative;
    }
    .topgrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:start;
    }
    .leftTitle{
      display:flex;
      gap:4px;
      align-items:flex-start;
    }
.check{
  width:18px;
  height:18px;
  border-radius:50%;
  background: #389a6e;
  display:flex;
  align-items:center;
  justify-content:center;
}

.check-icon{
  width:12px;
  height:11px;
  display:block;
}
    .t1{
      font-size:12px;
      line-height:1.2;
      margin:0;
    }
    #accountNumber{font-size: 12px;}
    #holderNameTitle{
    font-weight:600;
    }
    .sub{
      font-size:13px;
      opacity:.95;
    }
    .sub .acc{ display:block;margin-top: 3px; }
    .sub .amtTop{ font-weight:400; display:block; margin-top:2px;font-size: 14px; }

    .fav{
      background:#fff;
      color:#373737;
      border-radius: 4px;
      padding: 10px 14px;
      font-weight:500;
      border:1px solid #adadad;
      display:flex;
      gap:3px;
      font-size:12px;
      align-items:center;
      user-select:none;
      white-space:nowrap;
    }
    .fav .star{ color:#f59e0b; font-size:16px; margin-top:-1px; }
    .divider{
      height:1px; border: 1px solid #F5A623;
      margin: 0;
    }

    .rows{
      padding: 10px 15px 12px;
    }
    .r{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding: 6px 0;
      font-size:14px;
    }
    .r .l{ color:#171717; }
    .r .v{ color:#7d7d7d; }
    .r .v.strong{ color:#7d7d7d;}

    .footer{
      border-top: 1px solid var(--line);
      padding: 15px 16px;
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      font-size:14px;
      border-top: 6px solid #efefef;
    }
    .footer .totalLabel{ color:#171717; }
    .footer .totalVal{ font-weight:400; color:#da4747; }

    /* Holder masking (blur) */
    .maskWrap{ display:inline-flex; align-items:baseline; gap:0; }
    .maskFirst{
      letter-spacing:.2px;
    }
    .maskBlur{
      display:inline-block;
      filter: blur(4px);
      opacity:.9;
      transform: translateZ(0);
    }
    .fav-star{
  width:22px;
  height:21px;
  display:block;
}
    .nameRow{
  display:flex;
  gap:10px;
  align-items:center;
}

.nameRow input{
  flex:1;
}

.autoBtn{
  height:40px;
  padding:0 12px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:800;
  cursor:pointer;
  white-space:nowrap;
}

.autoBtn.on{
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(245,166,35,.18);
}
    .dateRow{
  display:flex;
  gap:10px;
  align-items:center;
}

.dateRow input{
  flex:1;
}

.dateBtn{
  height:40px;
  padding:0 12px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:700;
  cursor:pointer;
}
  .completedBar{
  background:#e7e7e7;
  padding: 10px 5px;
  display:grid;
  grid-template-columns: 1fr auto;
  align-items:center;
}

.completedText{
  font-size:12.5px;
  color:#9b9b9b;
  text-align:right;
}
    /* hide native select */
.nativeSelectHidden{
  position:absolute !important;
  left:-9999px !important;
  width:1px !important;
  height:1px !important;
  overflow:hidden !important;
}

/* custom dropdown */
.cselect{ position:relative; }

.cselect-btn{
  width:100%;
  height:40px;
  border:1px solid var(--line);
  border-radius:10px;
  background:#fff;
  padding:0 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  font-size:14px;
}

.cselect-caret{ color:#6b7280; }

.cselect-menu{
  position:absolute;
  top:calc(100% + 8px);
  left:0;
  right:0;
  background:#111;
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  box-shadow:0 18px 40px rgba(0,0,0,.25);
  padding:6px;
  display:none;
  z-index:9999;
  max-height:260px;
  overflow:auto;
}
.cselect.open .cselect-menu{ display:block; }

.cselect-item{
  padding:10px 10px;
  border-radius:10px;
  color:#fff;
  cursor:pointer;
  user-select:none;
  font-size:14px;
}
.cselect-item:hover{
  background: rgba(245,166,35,.22);
}
.cselect-item.active{
  background: rgba(245,166,35,.38);
  outline: 1px solid rgba(245,166,35,.55);
}

/* remove number input arrows (spinner) */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{
  -webkit-appearance: none;
  margin: 0;
}
input[type="number"]{
  -moz-appearance: textfield;
  appearance: textfield;
}
  </style>
</head>

<body>
  <div class="wrap">
    <!-- LEFT BUILDER -->
    <div class="panel">
      <div class="ph">
        <h3>Receipt Builder</h3>
        <span class="mono" style="font-size:12px;color:#6b7280;">localStorage ✅</span>
      </div>
      <div class="pb">
<div class="field">
  <label>Recipient’s bank</label>

  <!-- hidden select untuk simpan value + guna event change yg kau sudah ada -->
  <select id="bankSelect" class="nativeSelectHidden" aria-hidden="true" tabindex="-1"></select>

  <!-- custom dropdown -->
  <div class="cselect" id="bankCSelect">
    <button type="button" class="cselect-btn" id="bankCBtn" aria-haspopup="listbox" aria-expanded="false">
      <span id="bankCLabel">Select bank</span>
      <span class="cselect-caret">▾</span>
    </button>
    <div class="cselect-menu" id="bankCMenu" role="listbox"></div>
  </div>
</div>
        
        <div class="field">
  <label>Holder name</label>

  <div class="nameRow">
    <input id="holderInput" type="text" placeholder="CHRISTINA SHANDIE ANAK WILLIAM" />
    <button type="button" class="autoBtn" id="autoNameBtn" aria-pressed="false">
      Auto: OFF
    </button>
  </div>

  <div class="hint">Auto ON: tekan Create → nama random A–Z. Auto OFF: kau boleh edit manual.</div>
</div>

<div class="field">
  <label>Effective date (text)</label>
  <div class="dateRow">
    <input id="dateInput" type="text" placeholder="Today 06 Jan 2026" />
  </div>
</div>
      <div class="field">
  <label>Completed date & time (text)</label>

<div class="dateRow">
  <input id="completedInput" type="text" placeholder="Tuesday 06 January 2026 at 16:16:36" />
  <button type="button" class="dateBtn" id="nowBtn">Now</button>
</div>

  <div class="hint">Akan muncul di bawah sebagai: Completed on [text]</div>
</div>

        <div class="row2">
          <div class="field">
            <label>Reference ID prefix (4 digits)</label>
            <input id="refPrefix" type="text" inputmode="numeric" maxlength="4" placeholder="8292" />
            <div class="hint">Masuk 4 angka. Sistem auto buat jadi 10 angka bila Create.</div>
          </div>

          <div class="field">
            <label>Amount (RM)</label>
            <input id="amountInput" type="text" inputmode="decimal" placeholder="100.00" autocomplete="off" />
            <div class="hint">Amount atas & bawah ikut sama.</div>
          </div>
        </div>

        <div class="btns">
          <button class="btn-create" id="createBtn">Create</button>
          <button class="btn-reset" id="resetBtn">Reset</button>
        </div>

        <div class="mini">
          <div><b>Info:</b></div>
          <div>• Bank CIMB → auto generate <b>10 account number random</b> (10 digit) & pilih 1 untuk paparan.</div>
          <div>• Holder name auto: <b>CHRISTINA SHANDIE ANAK WILLIAM</b> (blur lepas Create).</div>
          <div>• Reference ID: <span class="mono">prefix4 + random6</span> → total 10 digit.</div>
        </div>
      </div>
    </div>

    <!-- RIGHT RECEIPT -->
    <div class="receipt" id="receiptCard">
      <div class="topbar">
        <div class="topgrid">
          <div>
            <div class="leftTitle">
              <div class="check">
  <svg class="check-icon" viewBox="128 346 18 16" xmlns="http://www.w3.org/2000/svg">
    <path
      d="M135.311038,356.608328 L132.870751,354.010733
      C132.441066,353.553349 131.751949,353.553349 131.322264,354.010733
      C130.892579,354.468117 130.892579,355.201657 131.322264,355.659041
      L134.540848,359.085104
      C134.751637,359.309481 135.035391,359.430299 135.311038,359.430299
      C135.586685,359.430299 135.87044,359.318111 136.081229,359.085104
      L143.677736,350.998904
      C144.107421,350.54152 144.107421,349.80798 143.677736,349.350597
      C143.256158,348.884583 142.558934,348.884583 142.129249,349.341967
      L135.311038,356.608328 Z"
      fill="#ffffff"
    />
  </svg>
</div>
              <div>
                <p class="t1">Transfer To <span id="holderNameTitle">CHRISTINA SHANDIE ANAK WILLIAM</span></p>
                <div class="sub">
                  <span class="acc mono" id="accountNumber">7656696146</span>
                  <span class="amtTop" id="topAmount">RM 100.00</span>
                </div>
              </div>
            </div>
          </div>

<div class="fav">
  <svg class="fav-star" viewBox="470 340 30 25" xmlns="http://www.w3.org/2000/svg">
    <path
      d="M491.4446,348.998603 L485.870003,348.220873 L483.361434,343.270045
      C483.277081,343.104417 483.104709,343 482.917666,343
      C482.730624,343 482.558252,343.104417 482.473899,343.273646
      L479.998338,348.238876 L474.42374,349.052612
      C474.236698,349.081417 474.082663,349.207438 474.023983,349.383867
      C473.965303,349.560297 474.016648,349.754729 474.152346,349.88075
      L478.197596,353.729794 L477.262384,359.181105
      C477.229377,359.364736 477.306394,359.548366 477.460429,359.656384
      C477.544781,359.717595 477.647471,359.75 477.750161,359.75
      C477.830846,359.75 477.907864,359.731997 477.981214,359.69239
      L482.958009,357.103558 L487.949474,359.663586
      C488.022824,359.699592 488.099842,359.717595 488.176859,359.717595
      C488.448254,359.717595 488.671971,359.497958 488.671971,359.231513
      C488.671971,359.191907 488.668304,359.155901 488.657301,359.119895
      L487.692749,353.700989 L491.712327,349.830342
      C491.85536,349.70072 491.903037,349.506288 491.844357,349.329858
      C491.785677,349.153429 491.631642,349.027408 491.4446,348.998603 Z"
      fill="none"
      stroke="#F5A623"
      stroke-width="1"
      stroke-linejoin="round"
    />
  </svg>
  <span>Add to Favourite</span>
</div>
        </div>
      </div>

      <div class="body">
        <hr class="divider">

        <div class="rows">
          <div class="r">
            <div class="l">Recipient's bank</div>
            <div class="v strong" id="bankValue">CIMB BANK BERHAD</div>
          </div>
          <div class="r">
            <div class="l">Transaction Type</div>
            <div class="v">Funds Transfer</div>
          </div>
          <div class="r">
            <div class="l">Transfer Mode</div>
            <div class="v">DuitNow Transfer</div>
          </div>
          <div class="r">
            <div class="l">Effective date</div>
            <div class="v" id="dateValue">Today 06 Jan 2026</div>
          </div>
          <div class="r">
            <div class="l">Recipient Reference</div>
            <div class="v">Payment</div>
          </div>
          <div class="r">
            <div class="l">Status</div>
            <div class="v">Successful</div>
          </div>
          <div class="r">
            <div class="l">Reference ID</div>
            <div class="v" id="refValue">8292256805</div>
          </div>
        </div>

        <div class="footer">
          <div class="totalLabel">Total Amount</div>
          <div class="totalVal" id="bottomAmount">RM 100.00</div>
        </div>
        <div class="completedBar">
  <div></div>
  <div class="completedText" id="completedText">
    Completed on Tuesday 06 January 2026 at 16:16:36
  </div>
</div>
      </div>
    </div>
  </div>

  <script>
    // ============================
    //  FULL RECEIPT BUILDER v1
    // ============================
    const LS_KEY = "receipt.builder.v1";
const BANK_CONFIG = {
  "CIMB BANK BERHAD": { len: 10, prefix: "76" },
  "MAYBANK":         { len: 12, prefix: "1" },
  "PUBLIC BANK":     { len: 10, prefix: "6" },
  "RHB BANK":        { len: 10, start: "2" },
  "HONG LEONG BANK": { len: 10, start: "3" },
  "AMBANK":          { len: 10, start: "5" },
  "BANK ISLAM":      { len: 10, start: "4" },
  "HSBC BANK":       { len: 12, start: "1" },
  "OCBC BANK":       { len: 12, start: "1" },
  "UOB BANK":        { len: 12, start: "1" }
  // Tambah bank baru kat sini sahaja
};
    const DEFAULT_STATE = {
      bank: "CIMB BANK BERHAD",
      effectiveDate: "Today 06 Jan 2026",
      amount: 100.00,
      amountText: "100.00",
      refPrefix4: "8292",
      referenceId10: "8292256805",
      holderName: "CHRISTINA SHANDIE ANAK WILLIAM",
      autoName: false,
      completedText: "Tuesday 06 January 2026 at 16:16:36",
      created: false,
      // store generated accounts per bank
      accountsByBank: {
        "CIMB BANK BERHAD": []
      },
      selectedAccountByBank: {}
    };

    // Elements
    const bankSelect   = document.getElementById("bankSelect");
    const dateInput    = document.getElementById("dateInput");
    const refPrefix    = document.getElementById("refPrefix");
    const amountInput  = document.getElementById("amountInput");
    const createBtn    = document.getElementById("createBtn");
    const resetBtn     = document.getElementById("resetBtn");

    const bankValue    = document.getElementById("bankValue");
    const dateValue    = document.getElementById("dateValue");
    const refValue     = document.getElementById("refValue");
    const accountNumber= document.getElementById("accountNumber");

    const holderNameTitle = document.getElementById("holderNameTitle");
    const topAmount    = document.getElementById("topAmount");
    const bottomAmount = document.getElementById("bottomAmount");
    const holderInput = document.getElementById("holderInput");
    const autoNameBtn = document.getElementById("autoNameBtn");
    const completedInput = document.getElementById("completedInput");
    const completedTextEl = document.getElementById("completedText");

    // Helpers
function rm(n){
  const v = Number(n || 0);
  return "RM " + format2(v); // ✅ akan jadi 1,000.00
}
    function formatMoneyInput(raw){
  raw = String(raw || "").replace(/,/g, "").trim();
  if(raw === "") return "";

  // keep digits + one dot
  raw = raw.replace(/[^\d.]/g, "");
  const parts = raw.split(".");
  const intPart = parts[0] || "0";
  const decPart = (parts[1] || "").slice(0, 2);

  const intFormatted = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  // kalau user sedang taip decimal
  if(parts.length > 1) return intFormatted + "." + decPart;

  return intFormatted;
}

function normalizeMoney(raw){
  const s = String(raw || "").replace(/,/g, "").trim();
  const v = Number(s);
  return isNaN(v) ? 0 : v;
}

function format2(v){
  return Number(v || 0).toLocaleString("en-US", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

   function formatToday(){
  const d = new Date();
  const m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `Today ${String(d.getDate()).padStart(2,"0")} ${m[d.getMonth()]} ${d.getFullYear()}`;
}
    function formatCompletedNow(){
  const d = new Date();
  const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  const dayName = days[d.getDay()];
  const dd = String(d.getDate()).padStart(2,"0");
  const monthName = months[d.getMonth()];
  const yyyy = d.getFullYear();

  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");

  return `${dayName} ${dd} ${monthName} ${yyyy} at ${hh}:${mm}:${ss}`;
}
    function onlyDigits(str){ return String(str || "").replace(/\D/g, ""); }

    function randomDigits(len){
      let out = "";
      for(let i=0;i<len;i++) out += Math.floor(Math.random()*10);
      return out;
    }

    function makeReferenceId(prefix4){
      const p = onlyDigits(prefix4).slice(0,4).padEnd(4, "0");
      return p + randomDigits(6);
    }
function getBankCfg(bank){
  return BANK_CONFIG[bank] || { len: 10, prefix: "" };
}

function makeAccountDigits(bank){
  const cfg = getBankCfg(bank);
  const len = cfg.len || 10;

  // ✅ prefix boleh 1-4 digit (atau lebih), akan kekal di depan
  let prefix = (cfg.prefix ?? cfg.start ?? "").toString().replace(/\D/g, "");
  if(prefix.length === 0){
    prefix = String(Math.floor(Math.random() * 9) + 1); // fallback 1-9
  }

  // kalau prefix lebih panjang dari len, potong
  if(prefix.length > len) prefix = prefix.slice(0, len);

  const remaining = Math.max(0, len - prefix.length);
  return prefix + randomDigits(remaining);
}

function genAccountsForBank(bank, count = 10){
  const cfg = getBankCfg(bank);
  const expectedLen = cfg.len || 10;

  const set = new Set();
  while(set.size < count){
    const acc = makeAccountDigits(bank);
    if(String(acc).length === expectedLen) set.add(acc);
  }
  return Array.from(set);
}
    function randLetter(){
  return String.fromCharCode(65 + Math.floor(Math.random() * 26)); // A-Z
}

function randomWord(min=3, max=8){
  const len = Math.floor(Math.random() * (max - min + 1)) + min;
  let w = "";
  for(let i=0;i<len;i++) w += randLetter();
  return w;
}

function randomHolderName(){
  // contoh: 3-5 perkataan huruf besar semua
  const parts = Math.floor(Math.random()*3) + 3; // 3..5
  const arr = [];
  for(let i=0;i<parts;i++) arr.push(randomWord());
  return arr.join(" ");
}

    function saveState(s){
      localStorage.setItem(LS_KEY, JSON.stringify(s));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);

        // merge with defaults to avoid missing keys
        return {
          ...structuredClone(DEFAULT_STATE),
          ...parsed,
          accountsByBank: { ...(structuredClone(DEFAULT_STATE).accountsByBank), ...(parsed.accountsByBank || {}) },
          selectedAccountByBank: { ...(parsed.selectedAccountByBank || {}) }
        };
      }catch(e){
        return structuredClone(DEFAULT_STATE);
      }
    }

    function setHolderMasked(isMasked, fullName){
      const name = fullName || "";
      if(!isMasked){
        holderNameTitle.textContent = name;
        return;
      }
      // show first 2 letters, rest blur
      const first2 = name.trim().slice(0,2) || "Ch";
      const rest   = name.trim().slice(2) || "";

      holderNameTitle.innerHTML =
        `<span class="maskWrap">
          <span class="maskFirst">${escapeHtml(first2)}</span>
          <span class="maskBlur">${escapeHtml(rest)}</span>
        </span>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
function maskAccountFront2Back1(acc){
  const s = String(acc || "").trim();
  if(!s) return { head:"", mid:"", tail:"" };

  const head = s.slice(0, 2);      // 2 digit depan
  const tail = s.slice(-1);        // 1 digit belakang
  const mid  = s.slice(2, -1);     // yang tengah blur
  return { head, mid, tail };
}
function setAccountMasked(isMasked, acc){
  if(!isMasked){
    accountNumber.textContent = acc;
    return;
  }

  const m = maskAccountFront2Back1(acc);
  accountNumber.innerHTML =
    `<span class="maskWrap">
      <span class="maskFirst mono">${escapeHtml(m.head)}</span>
      <span class="maskBlur mono">${escapeHtml(m.mid)}</span>
      <span class="maskFirst mono">${escapeHtml(m.tail)}</span>
    </span>`;
}
function ensureAccountsForBank(state, bank){
  state.accountsByBank ||= {};
  state.selectedAccountByBank ||= {};

  const cfg = getBankCfg(bank);
  const expectedLen = cfg.len || 10;

  const list = state.accountsByBank[bank] || [];
  const badLen = list.some(a => String(a).length !== expectedLen);

  if(list.length !== 10 || badLen){
    state.accountsByBank[bank] = genAccountsForBank(bank, 10);
  }

  if(!state.selectedAccountByBank[bank]){
    state.selectedAccountByBank[bank] = state.accountsByBank[bank][0];
  }

  return state;
}

    function render(state){
      // Inputs
      bankSelect.value = state.bank;
      dateInput.value  = state.effectiveDate;
      refPrefix.value  = state.refPrefix4;
      amountInput.value = (state.amountText != null ? state.amountText : format2(state.amount));
      completedInput.value = state.completedText || "";
      
      holderInput.value = state.holderName || "";
      autoNameBtn.classList.toggle("on", !!state.autoName);
      autoNameBtn.textContent = state.autoName ? "Auto: ON" : "Auto: OFF";
      autoNameBtn.setAttribute("aria-pressed", state.autoName ? "true" : "false");

      // Receipt values
      bankValue.textContent = state.bank;
      dateValue.textContent = state.effectiveDate;

      topAmount.textContent = rm(state.amount);
      bottomAmount.textContent = rm(state.amount);

      refValue.textContent = state.referenceId10;
      completedTextEl.textContent = `Completed on ${state.completedText || ""}`;

      // account number (from bank)
      state = ensureAccountsForBank(state, state.bank);
      const acc = state.selectedAccountByBank[state.bank];
      setAccountMasked(!!state.created, acc);

      // holder name mask only after Create
      setHolderMasked(!!state.created, state.holderName);

      saveState(state);
      return state;
    }

function initBanks(){
  const banks = Object.keys(BANK_CONFIG);

  // hidden select options
  bankSelect.innerHTML = banks
    .map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`)
    .join("");

  // custom UI elements
  const wrapEl  = document.getElementById("bankCSelect");
  const btnEl   = document.getElementById("bankCBtn");
  const labelEl = document.getElementById("bankCLabel");
  const menuEl  = document.getElementById("bankCMenu");

  function renderMenu(active){
    menuEl.innerHTML = "";
    banks.forEach(b => {
      const item = document.createElement("div");
      item.className = "cselect-item" + (b === active ? " active" : "");
      item.textContent = b;
      item.addEventListener("click", () => {
        bankSelect.value = b;
        bankSelect.dispatchEvent(new Event("change", { bubbles:true }));
        closeMenu();
      });
      menuEl.appendChild(item);
    });
  }

  function openMenu(){
    wrapEl.classList.add("open");
    btnEl.setAttribute("aria-expanded","true");
  }
  function closeMenu(){
    wrapEl.classList.remove("open");
    btnEl.setAttribute("aria-expanded","false");
  }

  btnEl.addEventListener("click", (e) => {
    e.preventDefault();
    wrapEl.classList.contains("open") ? closeMenu() : openMenu();
  });

  document.addEventListener("click", (e) => {
    if(!wrapEl.contains(e.target)) closeMenu();
  });

  // sync label bila select berubah (render() akan set bankSelect.value)
  bankSelect.addEventListener("change", () => {
    labelEl.textContent = bankSelect.value || banks[0] || "Select bank";
    renderMenu(bankSelect.value);
  });

  // init label/menu
  labelEl.textContent = bankSelect.value || banks[0] || "Select bank";
  renderMenu(bankSelect.value || banks[0] || "");
}

// Live update amount/date/bank (but "mask name" only after Create)
function attachLiveHandlers(){

  bankSelect.addEventListener("change", () => {
    state.bank = bankSelect.value;

    // regenerate accounts when bank changed
    state = ensureAccountsForBank(state, state.bank);

    // pick random 1
    const list = state.accountsByBank[state.bank] || [];
    state.selectedAccountByBank[state.bank] = list[Math.floor(Math.random() * list.length)] || "";

    state.created = false; // switch bank -> uncreated view
    state = render(state);
  });

  dateInput.addEventListener("input", () => {
    state.effectiveDate = dateInput.value.trim() || DEFAULT_STATE.effectiveDate;
    state = render(state);
  });

  // ✅ Amount: auto comma on typing, keep editable
  amountInput.addEventListener("input", () => {
    const formatted = formatMoneyInput(amountInput.value);
    amountInput.value = formatted;

    state.amountText = formatted;
    state.amount = Math.max(0, normalizeMoney(formatted));

    // update receipt amounts without full render
    topAmount.textContent = rm(state.amount);
    bottomAmount.textContent = rm(state.amount);

    saveState(state);
  });

  // ✅ Amount: on blur, force 2 decimals + comma
  amountInput.addEventListener("blur", () => {
    state.amount = Math.max(0, normalizeMoney(amountInput.value));
    state.amountText = format2(state.amount);
    amountInput.value = state.amountText;

    topAmount.textContent = rm(state.amount);
    bottomAmount.textContent = rm(state.amount);

    saveState(state);
  });

  holderInput.addEventListener("input", () => {
    state.holderName = holderInput.value;
    state = render(state);
  });

  autoNameBtn.addEventListener("click", () => {
    state.autoName = !state.autoName;
    state = render(state);
  });

  completedInput.addEventListener("input", () => {
    state.completedText = completedInput.value.trim() || DEFAULT_STATE.completedText;
    state = render(state);
  });

  document.getElementById("nowBtn").addEventListener("click", () => {
    state.effectiveDate = formatToday();
    state.completedText = formatCompletedNow();
    state = render(state);
  });

  refPrefix.addEventListener("input", () => {
    const d = onlyDigits(refPrefix.value).slice(0,4);
    refPrefix.value = d;
    state.refPrefix4 = d || DEFAULT_STATE.refPrefix4;
    saveState(state);
  });

  createBtn.addEventListener("click", () => {
    // Build referenceId10
    state.referenceId10 = makeReferenceId(state.refPrefix4);

    // Ensure accounts exist
    state = ensureAccountsForBank(state, state.bank);

    // pick random account
    const list = state.accountsByBank[state.bank] || [];
    if(list.length){
      state.selectedAccountByBank[state.bank] = list[Math.floor(Math.random() * list.length)];
    }

    // auto name (if ON)
    if(state.autoName){
      state.holderName = randomHolderName();
      holderInput.value = state.holderName;
    }

    // ✅ sync + force format amount on create
    state.amount = Math.max(0, normalizeMoney(amountInput.value));
    state.amountText = format2(state.amount);
    amountInput.value = state.amountText;

    // completed now every create
    state.completedText = formatCompletedNow();
    completedInput.value = state.completedText;

    state.created = true;
    state = render(state);
  });

  resetBtn.addEventListener("click", () => {
    localStorage.removeItem(LS_KEY);
    state = structuredClone(DEFAULT_STATE);
    state = ensureAccountsForBank(state, state.bank);
    state = render(state);
  });
}

    // Boot
    initBanks();
    let state = loadState();
    bankSelect.value = state.bank; // ✅ sync awal untuk custom label/menu
    // Ensure accounts for saved bank
    state = ensureAccountsForBank(state, state.bank);

    // If user already created before refresh, keep mask
    state = render(state);
    attachLiveHandlers();
  </script>
</body>
</html>
